<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Edit Property - BahAI Real Estate</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #0b2e52;
      --primary-dark: #001F3F;
      --primary-light: #002f3f;
      --secondary: #1976d2;
      --accent: #ff9800;
      --text-dark: #1a202c;
      --text-light: #718096;
      --bg-light: #f8fafc;
      --bg-white: #ffffff;
      --border: #e2e8f0;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', Arial, sans-serif;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      color: var(--text-dark);
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar Container */
    #sidebar-container {
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      z-index: 100;
    }

    /* Main Content */
    .container {
      flex: 1;
      margin-left: 280px;
      padding: 30px;
      transition: margin-left 0.3s ease;
    }

    /* Mobile Menu Toggle */
    .mobile-menu-toggle {
      display: none;
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1001;
      background: var(--primary);
      color: white;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 12px;
      font-size: 24px;
      cursor: pointer;
      box-shadow: var(--shadow-lg);
    }

    /* Header Section */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      text-decoration: none;
      border-radius: 10px;
      font-weight: 500;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
      box-shadow: var(--shadow);
    }

    .back-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      background: linear-gradient(135deg, var(--primary-dark), var(--primary));
    }

    .page-header h1 {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-dark);
      margin: 0;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .page-header p {
      color: var(--text-light);
      font-size: 16px;
      margin-top: 8px;
    }

    /* Grid Layout */
    .grid {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 30px;
    }

    /* Card Styles */
    .card {
      background: var(--bg-white);
      padding: 30px;
      border-radius: 16px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--border);
    }

    .card-header strong {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-dark);
    }

    .card-header-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
    }

    /* Form Styles */
    form .field {
      margin-bottom: 20px;
    }

    .field label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-dark);
      font-size: 14px;
    }

    .field-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    input[type="text"], input[type="number"], textarea, select {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 15px;
      font-family: 'Inter', sans-serif;
      transition: all 0.3s ease;
      background: var(--bg-white);
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(11, 46, 82, 0.1);
    }

    textarea {
      min-height: 140px;
      resize: vertical;
      line-height: 1.6;
    }

    /* Listing Type Selector */
    .listing-type-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .type-btn {
      flex: 1;
      padding: 12px;
      border: 2px solid var(--border);
      background: var(--bg-white);
      border-radius: 10px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .type-btn:hover {
      border-color: var(--primary);
      transform: translateY(-1px);
    }

    .type-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* Price Input Container */
    .price-input-container {
      position: relative;
    }

    .price-input-container::before {
      content: '‚Ç±';
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-weight: 600;
      color: var(--primary);
      z-index: 1;
    }

    #pricing, #monthlyRent, #annualRent {
      padding-left: 40px;
    }

    /* Hidden fields */
    .price-field {
      display: none;
    }

    .price-field.show {
      display: block;
    }

    /* Actions Section */
    .actions {
      display: flex;
      gap: 15px;
      align-items: center;
      margin-top: 25px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .update-btn {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: #fff;
      padding: 16px 32px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      transition: all 0.3s ease;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .update-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      background: linear-gradient(135deg, var(--primary-dark), var(--primary));
    }

    .update-btn[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    #saveMsg {
      color: var(--primary);
      font-size: 14px;
      font-weight: 500;
    }

    /* Photos Section */
    .photos-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .photo-card {
      width: 100%;
      aspect-ratio: 4/3;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      border: 2px solid var(--border);
      background: var(--bg-light);
      transition: all 0.3s ease;
    }

    .photo-card:hover {
      transform: scale(1.05);
      border-color: var(--primary);
      box-shadow: var(--shadow-lg);
    }

    .photo-card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .photo-actions {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 6px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .photo-card:hover .photo-actions {
      opacity: 1;
    }

    .icon-btn {
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .icon-btn:hover {
      background: rgba(0, 0, 0, 0.9);
      transform: scale(1.1);
    }

    /* Upload Area */
    .upload-area {
      border: 2px dashed var(--border);
      padding: 25px;
      border-radius: 12px;
      text-align: center;
      background: var(--bg-light);
      transition: all 0.3s ease;
    }

    .upload-area:hover {
      border-color: var(--primary);
      background: rgba(11, 46, 82, 0.05);
    }

    .upload-area p {
      margin: 0 0 15px 0;
      color: var(--text-dark);
      font-weight: 500;
    }

    .upload-area input {
      display: none;
    }

    #uploadBtn {
      background: var(--primary);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    #uploadBtn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .upload-info {
      font-size: 13px;
      color: var(--text-light);
      margin-top: 12px;
    }

    /* Amenities */
    .amenities-container {
      margin-top: 10px;
    }

    .amenity-input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    #amenityInput {
      flex: 1;
    }

    #addAmenityBtn {
      background: var(--secondary);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      white-space: nowrap;
    }

    #addAmenityBtn:hover {
      background: #1565c0;
      transform: translateY(-2px);
    }

    .amenities {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    .chip {
      background: var(--bg-white);
      border: 1px solid var(--primary);
      padding: 8px 16px;
      border-radius: 20px;
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 14px;
      font-weight: 500;
      color: var(--primary);
      transition: all 0.3s ease;
    }

    .chip:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-2px);
    }

    .chip .remove {
      cursor: pointer;
      color: inherit;
      font-weight: 700;
      margin-left: 4px;
      opacity: 0.7;
      transition: opacity 0.3s ease;
    }

    .chip .remove:hover {
      opacity: 1;
    }

    /* Loading Overlay */
    .overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      backdrop-filter: blur(5px);
    }

    .spinner {
      width: 100px;
      height: 100px;
      border-radius: 16px;
      background: var(--bg-white);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 12px;
      box-shadow: var(--shadow-lg);
      padding: 20px;
    }

    .loader {
      border: 4px solid var(--bg-light);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Success Badge */
    .success-badge {
      position: fixed;
      right: 30px;
      bottom: 30px;
      background: linear-gradient(135deg, #34d399, #10b981);
      color: #fff;
      padding: 16px 24px;
      border-radius: 12px;
      display: none;
      align-items: center;
      gap: 12px;
      z-index: 10000;
      box-shadow: var(--shadow-lg);
      animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
      from { transform: translateX(100px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .success-badge.show {
      display: flex;
      animation: pop 0.5s ease;
    }

    @keyframes pop {
      0% { transform: scale(0.8); opacity: 0 }
      100% { transform: scale(1); opacity: 1 }
    }

    /* Error Message */
    .error-message {
      background-color: #fed7d7;
      border: 1px solid #feb2b2;
      color: #c53030;
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: none;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from { transform: translateY(-10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .error-message strong {
      display: block;
      margin-bottom: 5px;
    }

    /* Empty States */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-light);
      grid-column: 1 / -1;
    }

    .empty-state::before {
      content: "üè†";
      font-size: 48px;
      display: block;
      margin-bottom: 15px;
      opacity: 0.5;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .container {
        margin-left: 0;
        padding: 25px;
      }
      
      .mobile-menu-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .photos-section {
        order: -1;
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }
      
      .topbar {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
      }
      
      .field-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .card {
        padding: 20px;
      }
      
      .photo-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      }
      
      .listing-type-selector {
        flex-direction: column;
      }
      
      .actions {
        flex-direction: column;
        align-items: stretch;
      }
      
      .update-btn {
        width: 100%;
        justify-content: center;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 15px;
      }
      
      .amenity-input-group {
        flex-direction: column;
      }
      
      #addAmenityBtn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Mobile Menu Toggle -->
  <button class="mobile-menu-toggle" id="mobileMenuToggle">‚ò∞</button>

  <!-- Include Sidebar -->
  <div id="sidebar-container"></div>

  <!-- Main Content -->
  <div class="container">
    <div class="topbar">
      <a class="back-btn" href="broker_listings.html">
        <span>‚Üê</span> Back to Listings
      </a>
      <div class="page-header">
        <h1>Edit Property</h1>
        <p>Update your property listing details</p>
      </div>
    </div>

    <!-- Error Alert -->
    <div class="error-message" id="errorAlert">
      <strong>‚ö†Ô∏è Error</strong>
      <p id="errorText"></p>
    </div>

    <div class="grid">
      <!-- LEFT: Property Details Form -->
      <div class="card">
        <div class="card-header">
          <div class="card-header-icon">üìù</div>
          <strong>Property Details</strong>
        </div>
        <form id="editForm">
          <div class="field">
            <label for="title">Property Title</label>
            <input id="title" type="text" placeholder="Enter property title" required />
          </div>

          <div class="field">
            <label>Listing Type</label>
            <div class="listing-type-selector">
              <button type="button" class="type-btn" data-type="sale">For Sale</button>
              <button type="button" class="type-btn" data-type="rent">For Rent</button>
              <button type="button" class="type-btn" data-type="lease">For Lease</button>
            </div>
          </div>

          <div class="field">
            <label for="location">Location</label>
            <input id="location" type="text" placeholder="Full property address" required />
          </div>

          <!-- Sale Price Field -->
          <div class="field price-field show" id="salePriceField">
            <label for="pricing">Sale Price (‚Ç±)</label>
            <div class="price-input-container">
              <input id="pricing" type="number" placeholder="0" required />
            </div>
          </div>

          <!-- Monthly Rent Field -->
          <div class="field price-field" id="monthlyRentField">
            <label for="monthlyRent">Monthly Rent (‚Ç±)</label>
            <div class="price-input-container">
              <input id="monthlyRent" type="number" placeholder="0" />
            </div>
          </div>

          <!-- Annual Rent Field -->
          <div class="field price-field" id="annualRentField">
            <label for="annualRent">Annual Rent (‚Ç±)</label>
            <div class="price-input-container">
              <input id="annualRent" type="number" placeholder="0" />
            </div>
          </div>

          <div class="field-grid">
            <div class="field">
              <label for="propertyType">Property Type</label>
              <select id="propertyType" required>
                <option value="">Select Property Type</option>
                <option value="House">House</option>
                <option value="Condo">Condo</option>
                <option value="Apartment">Apartment</option>
                <option value="Land">Land</option>
                <option value="Commercial">Commercial</option>
              </select>
            </div>
            <div class="field">
              <label for="status">Listing Status</label>
              <select id="status">
                <option value="active">Active</option>
                <option value="pending">Pending Review</option>
                <option value="sold">Sold</option>
                <option value="rejected">Rejected</option>
              </select>
            </div>
          </div>

          <div class="field-grid">
            <div class="field">
              <label for="bedrooms">Bedrooms</label>
              <input id="bedrooms" type="number" min="0" placeholder="0" required />
            </div>
            <div class="field">
              <label for="bathrooms">Bathrooms</label>
              <input id="bathrooms" type="number" min="0" placeholder="0" required />
            </div>
          </div>

          <div class="field">
            <label for="floorArea">Floor Area (sqm)</label>
            <input id="floorArea" type="number" placeholder="e.g., 120" required />
          </div>

          <div class="field">
            <label for="description">Property Description</label>
            <textarea id="description" placeholder="Describe the property features, location advantages, and unique selling points..." required></textarea>
          </div>

          <div class="field">
            <label>Amenities & Features</label>
            <div class="amenity-input-group">
              <input id="amenityInput" type="text" placeholder="Add amenity (e.g., Swimming Pool, Garden)" />
              <button id="addAmenityBtn" type="button">Add Feature</button>
            </div>
            <div class="amenities-container">
              <div class="amenities" id="amenitiesContainer"></div>
            </div>
          </div>

          <div class="actions">
            <button id="saveBtn" class="update-btn" type="submit">
              <span>üíæ</span> Save Changes
            </button>
            <div id="saveMsg"></div>
          </div>
        </form>
      </div>

      <!-- RIGHT: Photos Section -->
      <div class="card photos-section">
        <div class="card-header">
          <div class="card-header-icon">üñºÔ∏è</div>
          <strong>Property Photos</strong>
        </div>
        
        <div class="photo-grid" id="photoGrid">
          <div class="empty-state">
            Loading property photos...
          </div>
        </div>

        <div class="upload-area">
          <p>Upload New Property Photos</p>
          <input id="photoInput" type="file" accept="image/*" multiple />
          <button id="uploadBtn" type="button">
            <span>üìÅ</span> Choose & Upload
          </button>
          <div class="upload-info">Supported: JPG, PNG, WebP (Max 5MB each)</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden file input for operations -->
  <input id="replaceInput" type="file" accept="image/*" style="display:none" />

  <!-- Loading Overlay -->
  <div class="overlay" id="overlay">
    <div class="spinner">
      <div class="loader"></div>
      <div style="font-size:14px;color:#333;font-weight:500;">Processing...</div>
    </div>
  </div>

  <!-- Success Badge -->
  <div class="success-badge" id="successBadge">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
      <path d="M20 6L9 17l-5-5" stroke="white" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <div>Changes saved successfully!</div>
  </div>

  <!-- Sidebar Loader Script -->
  <script>
    // Mobile menu functionality
    document.getElementById('mobileMenuToggle').addEventListener('click', function() {
      const sidebar = document.querySelector('.sidebar');
      if (sidebar) {
        sidebar.style.transform = sidebar.style.transform === 'translateX(0px)' ? 
          'translateX(-100%)' : 'translateX(0px)';
      }
    });

    // Load sidebar
    fetch('sidebar.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('sidebar-container').innerHTML = html;
        const links = document.querySelectorAll('.sidebar-link');
        links.forEach(link => {
          if (link.getAttribute('href') === 'broker_listings.html') {
            link.classList.add('active');
          }
        });
      })
      .catch(error => console.error('Error loading sidebar:', error));
  </script>

  <!-- Firebase and JavaScript -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCIfzneDzWVveG8p_0mywoA9D9F5AyzZX4",
      authDomain: "bahai-1b76d.firebaseapp.com",
      projectId: "bahai-1b76d",
      storageBucket: "bahai-1b76d.appspot.com",
      messagingSenderId: "646878644941",
      appId: "1:646878644941:web:5b4ccc3412250337587784"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    // DOM refs
    const form = document.getElementById("editForm");
    const titleInput = document.getElementById("title");
    const locationInput = document.getElementById("location");
    const pricingInput = document.getElementById("pricing");
    const monthlyRentInput = document.getElementById("monthlyRent");
    const annualRentInput = document.getElementById("annualRent");
    const propertyTypeInput = document.getElementById("propertyType");
    const bedroomsInput = document.getElementById("bedrooms");
    const bathroomsInput = document.getElementById("bathrooms");
    const floorAreaInput = document.getElementById("floorArea");
    const descriptionInput = document.getElementById("description");
    const statusInput = document.getElementById("status");

    const amenityInput = document.getElementById("amenityInput");
    const addAmenityBtn = document.getElementById("addAmenityBtn");
    const amenitiesContainer = document.getElementById("amenitiesContainer");

    const typeButtons = document.querySelectorAll('.type-btn');
    const salePriceField = document.getElementById('salePriceField');
    const monthlyRentField = document.getElementById('monthlyRentField');
    const annualRentField = document.getElementById('annualRentField');

    const photoGrid = document.getElementById("photoGrid");
    const photoInput = document.getElementById("photoInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const replaceInput = document.getElementById("replaceInput");

    const overlay = document.getElementById("overlay");
    const successBadge = document.getElementById("successBadge");
    const saveMsg = document.getElementById("saveMsg");
    const errorAlert = document.getElementById("errorAlert");
    const errorText = document.getElementById("errorText");

    // Get propertyId from URL
    const urlParams = new URLSearchParams(window.location.search);
    const propertyId = urlParams.get("id");
    if (!propertyId) {
      showError("Invalid property ID");
      setTimeout(() => window.location.href = "broker_listings.html", 2000);
    }

    // Local data
    let photos = [];
    let amenities = [];
    let listingType = 'sale';

    // Helper functions
    function showLoading(flag = true) {
      overlay.style.display = flag ? "flex" : "none";
    }

    function showSuccess() {
      successBadge.classList.add("show");
      setTimeout(() => successBadge.classList.remove("show"), 2000);
    }

    function showError(message) {
      errorText.textContent = message;
      errorAlert.style.display = 'block';
      setTimeout(() => errorAlert.style.display = 'none', 5000);
    }

    // Listing Type Selection
    typeButtons.forEach(button => {
      button.addEventListener('click', function() {
        typeButtons.forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        listingType = this.dataset.type;
        
        // Show/hide price fields based on listing type
        salePriceField.classList.remove('show');
        monthlyRentField.classList.remove('show');
        annualRentField.classList.remove('show');
        
        if (listingType === 'sale') {
          salePriceField.classList.add('show');
          pricingInput.required = true;
          monthlyRentInput.required = false;
          annualRentInput.required = false;
        } else if (listingType === 'rent') {
          monthlyRentField.classList.add('show');
          pricingInput.required = false;
          monthlyRentInput.required = true;
          annualRentInput.required = false;
        } else if (listingType === 'lease') {
          annualRentField.classList.add('show');
          pricingInput.required = false;
          monthlyRentInput.required = false;
          annualRentInput.required = true;
        }
      });
    });

    // Extract storage path from URL
    function extractStoragePathFromUrl(url) {
      try {
        const parts = url.split('/o/');
        if (parts.length < 2) return null;
        const remainder = parts[1];
        const encPath = remainder.split('?')[0];
        const path = decodeURIComponent(encPath);
        return path;
      } catch (e) {
        console.warn("Could not extract path from URL:", url);
        return null;
      }
    }

    // Render photos grid
    function renderPhotos() {
      photoGrid.innerHTML = "";
      
      if (photos.length === 0) {
        photoGrid.innerHTML = `
          <div class="empty-state">
            No photos uploaded yet
          </div>
        `;
        return;
      }
      
      photos.forEach((p, idx) => {
        const pc = document.createElement("div");
        pc.className = "photo-card";
        pc.innerHTML = `
          <img src="${p}" alt="Property photo ${idx + 1}" loading="lazy" />
          <div class="photo-actions">
            <button title="Delete" class="icon-btn del" data-idx="${idx}">‚úï</button>
            <button title="View" class="icon-btn view" data-idx="${idx}">üîç</button>
          </div>
        `;
        photoGrid.appendChild(pc);
      });

      // Add event listeners
      photoGrid.querySelectorAll(".del").forEach(btn => {
        btn.addEventListener("click", async (evt) => {
          evt.stopPropagation();
          const idx = Number(btn.dataset.idx);
          if (!confirm("Delete this photo?")) return;
          await deletePhotoAtIndex(idx);
        });
      });

      photoGrid.querySelectorAll(".view").forEach(btn => {
        btn.addEventListener("click", (evt) => {
          evt.stopPropagation();
          const idx = Number(btn.dataset.idx);
          window.open(photos[idx], "_blank");
        });
      });
    }

    // Delete photo at index
    async function deletePhotoAtIndex(index) {
      try {
        showLoading(true);
        const url = photos[index];
        
        // Update local array
        photos.splice(index, 1);
        
        // Update Firestore
        await updateDoc(doc(db, "properties", propertyId), { photos: photos });
        
        // Try to delete from storage
        const path = extractStoragePathFromUrl(url);
        if (path) {
          try {
            const storageRef = ref(storage, path);
            await deleteObject(storageRef);
          } catch (storageError) {
            console.warn("Could not delete from storage:", storageError);
          }
        }
        
        renderPhotos();
        showSuccess();
      } catch (err) {
        console.error("Delete error:", err);
        showError("Failed to delete photo: " + err.message);
      } finally {
        showLoading(false);
      }
    }

    // Upload multiple files
    uploadBtn.addEventListener("click", () => photoInput.click());
    
    photoInput.addEventListener("change", async (e) => {
      const files = Array.from(e.target.files);
      if (files.length === 0) return;
      
      showLoading(true);
      try {
        for (const file of files) {
          // Validate file
          if (file.size > 5 * 1024 * 1024) {
            showError(`File "${file.name}" is too large. Max 5MB.`);
            continue;
          }
          if (!file.type.startsWith('image/')) {
            showError(`File "${file.name}" is not an image.`);
            continue;
          }

          const filename = `${Date.now()}_${Math.random().toString(36).substring(2)}_${file.name.replace(/\s+/g, "_")}`;
          const storagePath = `properties/${filename}`;
          const storageRef = ref(storage, storagePath);
          
          await uploadBytes(storageRef, file);
          const url = await getDownloadURL(storageRef);
          photos.push(url);
        }
        
        // Save to Firestore
        await updateDoc(doc(db, "properties", propertyId), { photos: photos });
        renderPhotos();
        showSuccess();
      } catch (err) {
        console.error("Upload error:", err);
        showError("Upload failed: " + err.message);
      } finally {
        photoInput.value = "";
        showLoading(false);
      }
    });

    // Amenities UI
    function renderAmenities() {
      amenitiesContainer.innerHTML = "";
      if (amenities.length === 0) {
        amenitiesContainer.innerHTML = '<div class="empty-state" style="padding: 20px; font-size: 14px;">No amenities added yet</div>';
        return;
      }
      
      amenities.forEach((a, idx) => {
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.innerHTML = `<span>${a}</span><span class="remove" data-idx="${idx}">‚úï</span>`;
        amenitiesContainer.appendChild(chip);
      });
      
      // Add remove listeners
      amenitiesContainer.querySelectorAll(".remove").forEach(el => {
        el.addEventListener("click", (e) => {
          const idx = Number(e.target.dataset.idx);
          amenities.splice(idx, 1);
          renderAmenities();
        });
      });
    }

    addAmenityBtn.addEventListener("click", () => {
      const v = amenityInput.value.trim();
      if (!v) {
        showError("Please enter an amenity name");
        return;
      }
      amenities.push(v);
      amenityInput.value = "";
      renderAmenities();
    });

    amenityInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        addAmenityBtn.click();
      }
    });

    // Load property data and pre-fill form fields
    async function loadData() {
      showLoading(true);
      try {
        const propertyRef = doc(db, "properties", propertyId);
        const snap = await getDoc(propertyRef);
        
        if (!snap.exists()) {
          showError("Property not found");
          setTimeout(() => window.location.href = "broker_listings.html", 2000);
          return;
        }
        
        const data = snap.data();
        console.log("Loaded property data:", data);
        
        // Populate form fields with existing data
        titleInput.value = data.title || "";
        locationInput.value = data.location || "";
        propertyTypeInput.value = data.propertyType || "";
        bedroomsInput.value = data.bedrooms || "";
        bathroomsInput.value = data.bathrooms || "";
        floorAreaInput.value = data.floorArea || data.totalArea || "";
        descriptionInput.value = data.description || "";
        statusInput.value = data.status || "active";
        
        // Handle listing type and pricing
        const type = data.type || data.listingType || 'sale';
        listingType = type;
        
        // Activate correct type button
        typeButtons.forEach(btn => {
          if (btn.dataset.type === type) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });
        
        // Show correct price field and populate value
        if (type === 'sale') {
          salePriceField.classList.add('show');
          pricingInput.value = data.pricing || data.salePrice || "";
        } else if (type === 'rent') {
          monthlyRentField.classList.add('show');
          monthlyRentInput.value = data.monthlyRent || data.rent || "";
        } else if (type === 'lease') {
          annualRentField.classList.add('show');
          annualRentInput.value = data.annualRent || "";
        }
        
        // Set arrays
        photos = Array.isArray(data.photos) ? [...data.photos] : [];
        amenities = Array.isArray(data.amenities) ? [...data.amenities] : [];
        
        // Update page title with property name
        document.title = `Edit ${data.title || 'Property'} - BahAI Real Estate`;
        
        renderPhotos();
        renderAmenities();
        
        // Show success message for loaded data
        setTimeout(() => {
          showSuccess();
          setTimeout(() => {
            successBadge.innerHTML = `
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                <path d="M20 6L9 17l-5-5" stroke="white" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <div>Property data loaded successfully!</div>
            `;
          }, 100);
        }, 500);
        
      } catch (err) {
        console.error("Load error:", err);
        showError("Failed to load property data: " + err.message);
      } finally {
        showLoading(false);
      }
    }

    // Save/Update form
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      showLoading(true);
      saveMsg.textContent = "";
      
      try {
        // Prepare data based on listing type
        const updatedData = {
          title: titleInput.value.trim(),
          location: locationInput.value.trim(),
          propertyType: propertyTypeInput.value.trim(),
          bedrooms: Number(bedroomsInput.value) || 0,
          bathrooms: Number(bathroomsInput.value) || 0,
          floorArea: Number(floorAreaInput.value) || 0,
          description: descriptionInput.value.trim(),
          status: statusInput.value,
          type: listingType,
          amenities: amenities,
          photos: photos,
          updatedAt: new Date()
        };

        // Add pricing based on listing type
        if (listingType === 'sale') {
          updatedData.pricing = Number(pricingInput.value) || 0;
          updatedData.salePrice = Number(pricingInput.value) || 0;
        } else if (listingType === 'rent') {
          updatedData.monthlyRent = Number(monthlyRentInput.value) || 0;
          updatedData.rent = Number(monthlyRentInput.value) || 0;
        } else if (listingType === 'lease') {
          updatedData.annualRent = Number(annualRentInput.value) || 0;
        }

        // Validate required fields
        if (!updatedData.title || !updatedData.location) {
          showError("Please fill in all required fields");
          showLoading(false);
          return;
        }

        if (listingType === 'sale' && (!updatedData.pricing || updatedData.pricing <= 0)) {
          showError("Please enter a valid sale price");
          showLoading(false);
          return;
        }

        if (listingType === 'rent' && (!updatedData.monthlyRent || updatedData.monthlyRent <= 0)) {
          showError("Please enter a valid monthly rent");
          showLoading(false);
          return;
        }

        if (listingType === 'lease' && (!updatedData.annualRent || updatedData.annualRent <= 0)) {
          showError("Please enter a valid annual rent");
          showLoading(false);
          return;
        }

        await updateDoc(doc(db, "properties", propertyId), updatedData);
        saveMsg.textContent = "‚úì Changes saved successfully!";
        saveMsg.style.color = "var(--primary)";
        showSuccess();
        
        // Reset success badge to original state after a delay
        setTimeout(() => {
          successBadge.innerHTML = `
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
              <path d="M20 6L9 17l-5-5" stroke="white" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <div>Changes saved successfully!</div>
          `;
        }, 2500);
        
      } catch (err) {
        console.error("Save error:", err);
        showError("Failed to save changes: " + err.message);
        saveMsg.textContent = "‚úó Save failed";
        saveMsg.style.color = "#c53030";
      } finally {
        showLoading(false);
        setTimeout(() => {
          saveMsg.textContent = "";
          saveMsg.style.color = "";
        }, 5000);
      }
    });

    // Check authentication and initialize
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        loadData();
      }
    });

  </script>
</body>
</html>