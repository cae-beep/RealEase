<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Edit Property - BahAI Real Estate</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    /* ===== BASE STYLES (BROKER DASHBOARD THEME) ===== */
    :root {
      --primary: #0b2e52;
      --primary-dark: #001F3F;
      --primary-light: #002f3f;
      --secondary: #1976d2;
      --accent: #ff9800;
      --text-dark: #1a202c;
      --text-light: #718096;
      --bg-light: #f8fafc;
      --bg-white: #ffffff;
      --border: #e2e8f0;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
    }
    
    body {
      font-family: 'Inter', Arial, sans-serif;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      color: var(--text-dark);
      min-height: 100vh;
    }

    /* ===== SIDEBAR STYLES ===== */
    .sidebar {
      width: 280px;
      background: var(--primary);
      color: white;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      z-index: 1000;
      transition: all 0.3s ease;
      left: 0;
      top: 0;
    }

    .sidebar.collapsed {
      transform: translateX(-280px);
    }

    .sidebar-header {
      padding: 25px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .sidebar-header h2 {
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sidebar-menu {
      padding: 20px 0;
    }

    .menu-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px 20px;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      transition: all 0.3s ease;
      border-left: 4px solid transparent;
    }

    .menu-item:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border-left-color: var(--accent);
    }

    .menu-item.active {
      background: rgba(255, 255, 255, 0.15);
      color: white;
      border-left-color: var(--accent);
    }

    .menu-item i {
      font-size: 18px;
      width: 24px;
      text-align: center;
    }

    .sidebar-footer {
      padding: 20px;
      position: absolute;
      bottom: 0;
      width: 100%;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .logout-btn {
      width: 100%;
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      border-radius: 8px;
      font-family: 'Inter', sans-serif;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* ===== MAIN CONTENT CONTAINER ===== */
    .main-content {
      flex: 1;
      padding: 30px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      transition: all 0.3s ease;
      min-height: 100vh;
      width: calc(100% - 280px);
      margin-left: 280px;
    }

    /* When sidebar is collapsed */
    .sidebar.collapsed + .main-content {
      margin-left: 0;
      width: 100%;
    }

    /* Mobile Toggle */
    .mobile-toggle {
      display: none;
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-dark);
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      background: var(--bg-white);
      box-shadow: var(--shadow);
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 999;
    }

    /* ===== PAGE HEADER ===== */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      gap: 20px;
    }

    .page-title h1 {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 8px;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1.2;
    }

    .page-title p {
      color: var(--text-light);
      font-size: 16px;
      line-height: 1.4;
    }

    .header-actions {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    /* ===== KYC BADGE ===== */
    .kyc-badge {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .kyc-badge.pending {
      background: #feebc8;
      color: #744210;
    }

    .kyc-badge.approved {
      background: #c6f6d5;
      color: #22543d;
    }

    .kyc-badge.rejected {
      background: #fed7d7;
      color: #742a2a;
    }

    /* ===== CARD STYLES ===== */
    .card {
      background: var(--bg-white);
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 25px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--primary-light));
    }

    /* ===== TYPE SELECTION ===== */
    .type-selection {
      text-align: center;
      margin-bottom: 30px;
    }

    .type-selection h2 {
      color: var(--text-dark);
      margin-bottom: 25px;
      font-size: 24px;
      font-weight: 600;
    }

    .type-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .type-card {
      background: var(--bg-white);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .type-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary);
    }

    .type-card.active {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(11, 46, 82, 0.05), rgba(0, 47, 63, 0.05));
    }

    .type-icon {
      font-size: 48px;
      margin-bottom: 15px;
      display: block;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .type-card h3 {
      color: var(--text-dark);
      margin: 10px 0;
      font-size: 20px;
      font-weight: 600;
    }

    .type-card .description {
      color: var(--text-light);
      font-size: 14px;
      line-height: 1.5;
    }

    /* ===== FORM SECTION STYLES ===== */
    .property-details {
      display: none;
    }

    .property-details.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-dark);
      margin: 25px 0 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title i {
      color: var(--primary);
    }

    /* ===== FORM GRID & INPUTS ===== */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-dark);
      font-size: 14px;
    }

    .required::after {
      content: " *";
      color: #e53e3e;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      font-family: 'Inter', sans-serif;
      transition: all 0.3s ease;
      background: var(--bg-white);
      color: var(--text-dark);
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(11, 46, 82, 0.1);
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    /* ===== INPUT WITH ICON ===== */
    .input-with-icon {
      position: relative;
    }

    .input-with-icon i {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-light);
      font-size: 16px;
    }

    .input-with-icon input,
    .input-with-icon select {
      padding-left: 45px;
    }

    /* ===== AMENITIES GRID ===== */
    .amenities-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 10px;
    }

    .amenity-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 15px;
      background: var(--bg-light);
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .amenity-item:hover {
      background: rgba(11, 46, 82, 0.05);
      transform: translateY(-2px);
    }

    .amenity-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin: 0;
      accent-color: var(--primary);
    }

    /* ===== SALE TYPE GRID ===== */
    .sale-type-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-top: 10px;
    }

    .sale-option {
      background: var(--bg-white);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .sale-option:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .sale-option.active {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(11, 46, 82, 0.05), rgba(0, 47, 63, 0.05));
    }

    /* ===== BANK FINANCING OPTIONS ===== */
    .bank-options-section {
      margin-top: 20px;
      padding: 20px;
      background: var(--bg-light);
      border-radius: 12px;
      border: 2px solid var(--border);
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .bank-options-section.active {
      display: block;
    }

    .bank-options-section h4 {
      color: var(--text-dark);
      margin-bottom: 15px;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .bank-options-section h4 i {
      color: var(--primary);
    }

    .bank-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
    }

    .bank-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 15px;
      background: var(--bg-white);
      border-radius: 8px;
      border: 2px solid var(--border);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .bank-item:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .bank-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin: 0;
      accent-color: var(--primary);
      cursor: pointer;
    }

    .bank-item label {
      margin: 0;
      font-weight: 500;
      color: var(--text-dark);
      cursor: pointer;
      flex: 1;
    }

    .bank-item label {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }

    .bank-logo {
      width: 32px;
      height: 32px;
      object-fit: contain;
    }

    .other-banks-input {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--border);
    }

    .other-banks-input label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-dark);
      font-size: 14px;
    }

    .other-banks-input input {
      width: 100%;
      padding: 10px 15px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
    }

    .other-banks-input small {
      display: block;
      margin-top: 5px;
      color: var(--text-light);
      font-size: 12px;
    }

    /* ===== IMAGE UPLOAD ===== */
    .image-upload-area {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      background: var(--bg-light);
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 20px;
      position: relative;
    }

    .image-upload-area:hover {
      border-color: var(--primary);
      background: rgba(11, 46, 82, 0.05);
      transform: translateY(-2px);
    }

    .image-upload-area i {
      font-size: 48px;
      color: var(--text-light);
      margin-bottom: 15px;
      display: block;
    }

    .image-upload-area p {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-dark);
      margin: 10px 0;
    }

    .image-upload-area .upload-info {
      color: var(--text-light);
      font-size: 13px;
      margin: 5px 0;
    }

    .selected-count {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--primary);
      color: white;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    /* ===== IMAGE PREVIEW ===== */
    .preview-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .preview-item {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }

    .preview-item:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-lg);
    }

    .preview-item img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      display: block;
    }

    .remove-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #e53e3e;
      color: white;
      border: none;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .remove-btn:hover {
      background: #c53030;
      transform: scale(1.1);
    }

    /* ===== BUTTONS ===== */
    .form-actions {
      display: flex;
      gap: 15px;
      justify-content: flex-end;
      margin-top: 30px;
      padding-top: 25px;
      border-top: 2px solid var(--border);
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: var(--shadow);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary));
    }

    .btn-secondary {
      background: var(--bg-light);
      color: var(--text-dark);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--border);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }

    /* ===== MESSAGES ===== */
    .message {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
      display: none;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.success {
      background: #c6f6d5;
      color: #22543d;
      border: 1px solid #9ae6b4;
    }

    .message.error {
      background: #fed7d7;
      color: #742a2a;
      border: 1px solid #fc8181;
    }

    .message.warning {
      background: #feebc8;
      color: #744210;
      border: 1px solid #fbd38d;
    }

    /* ===== KYC WARNING ===== */
    .kyc-warning {
      background: linear-gradient(135deg, #feebc8, #fbd38d);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      text-align: center;
      border: none;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }

    .kyc-warning h2 {
      color: #744210;
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .kyc-warning a {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      margin-top: 15px;
      transition: all 0.3s ease;
    }

    .kyc-warning a:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    /* ===== MAP STYLES ===== */
    #saleMapPicker, #leaseMapPicker {
      width: 100%;
      height: 300px;
      border: 2px solid var(--border);
      border-radius: 12px;
      margin-top: 10px;
      margin-bottom: 15px;
    }

    .coordinates-display {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 15px;
    }

    .coord-box {
      background: var(--bg-light);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      border: 1px solid var(--border);
    }

    .coord-box label {
      font-size: 12px;
      color: var(--text-light);
      margin: 0 0 5px 0;
      font-weight: 500;
    }

    .coord-box span {
      display: block;
      font-size: 16px;
      font-weight: 600;
      color: var(--primary);
      font-family: 'Courier New', monospace;
    }

    /* ===== LEASE SPECIFIC STYLES ===== */
    .lease-term-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-top: 10px;
    }

    .lease-option {
      background: var(--bg-white);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .lease-option:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .lease-option.active {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(11, 46, 82, 0.05), rgba(0, 47, 63, 0.05));
    }

    /* ===== UPLOAD PROGRESS ===== */
    .upload-progress {
      background: var(--bg-light);
      border: 2px solid var(--primary);
      border-radius: 12px;
      padding: 25px;
      margin-top: 20px;
      display: none;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }

    .upload-progress.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 15px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--primary-light));
      transition: width 0.3s ease;
      border-radius: 4px;
    }

    /* ===== RESPONSIVE DESIGN ===== */
    @media (max-width: 1024px) {
      .sidebar {
        transform: translateX(-280px);
      }
      
      .sidebar.active {
        transform: translateX(0);
      }
      
      .main-content {
        margin-left: 0;
        width: 100%;
        padding: 25px;
      }
      
      .mobile-toggle {
        display: block;
      }
      
      .type-grid {
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      }
      
      .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      
      .header-actions {
        width: 100%;
        justify-content: space-between;
      }
    }

    @media (max-width: 768px) {
      .main-content {
        padding: 20px;
      }
      
      .card {
        padding: 20px;
      }
      
      .type-grid {
        grid-template-columns: 1fr;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .amenities-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }
      
      .sale-type-grid,
      .lease-term-grid,
      .bank-grid {
        grid-template-columns: 1fr;
      }
      
      .form-actions {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
      }
      
      .coordinates-display {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .main-content {
        padding: 15px;
      }
      
      .card {
        padding: 20px;
      }
      
      .page-title h1 {
        font-size: 24px;
      }
      
      .section-title {
        font-size: 20px;
      }
      
      .amenities-grid {
        grid-template-columns: 1fr;
      }
      
      .image-upload-area {
        padding: 25px;
      }
      
      .preview-container {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }
    }

    /* ===== EDIT SPECIFIC STYLES ===== */
    .existing-images-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-dark);
      margin: 25px 0 15px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .existing-images-title i {
      color: var(--primary);
    }

    .image-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }

    .loading-spinner {
      background: white;
      padding: 30px;
      border-radius: 12px;
      text-align: center;
      box-shadow: var(--shadow-lg);
    }

    .loading-spinner i {
      font-size: 36px;
      color: var(--primary);
      margin-bottom: 15px;
      display: block;
    }
  </style>
</head>
<body>
  <!-- Mobile Toggle -->
  <button class="mobile-toggle" id="mobileToggle">
    <i class="bi bi-list"></i>
  </button>
  
  <!-- Sidebar will be loaded here -->
  <div id="sidebar-container"></div>
  
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">
      <i class="bi bi-hourglass-split"></i>
      <p>Loading Property Data...</p>
    </div>
  </div>
  
  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <!-- Page Header -->
    <div class="page-header">
      <div class="page-title">
        <h1>Edit Property</h1>
        <p>Update your property listing details</p>
      </div>
      <div class="header-actions">
        <div id="kycBadge" class="kyc-badge" style="display: none;">
          <i class="bi bi-shield-check"></i>
          <span id="kycBadgeText">KYC Status</span>
        </div>
      </div>
    </div>

    <!-- KYC Warning -->
    <div id="kycWarning" class="kyc-warning" style="display: none;">
      <h2><i class="bi bi-exclamation-triangle"></i> KYC Verification Required</h2>
      <p id="kycStatusText"></p>
      <p id="kycMessage"></p>
      <a href="../kyc.html">
        <i class="bi bi-shield-lock"></i> Complete KYC Verification
      </a>
    </div>

    <!-- Success/Error Messages -->
    <div id="messageBox" class="message" style="display: none;"></div>

    <!-- Type Selection -->
    <div class="card">
      <div class="type-selection">
        <h2>Listing Type</h2>
        <div class="type-grid">
          <div class="type-card" id="saleTypeCard" onclick="selectType('sale')">
            <span class="type-icon"><i class="bi bi-cash-coin"></i></span>
            <h3>FOR SALE</h3>
            <div class="description">
              Perfect for properties available for outright purchase with full ownership transfer.
            </div>
          </div>
          <div class="type-card" id="leaseTypeCard" onclick="selectType('lease')">
            <span class="type-icon"><i class="bi bi-file-text"></i></span>
            <h3>FOR LEASE</h3>
            <div class="description">
              Ideal for commercial spaces, land, or special purpose properties for long-term lease.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- SALE Form -->
    <div id="saleForm" class="card property-details">
      <h2 style="color: var(--text-dark); margin-top: 0; margin-bottom: 30px; display: flex; align-items: center; gap: 12px;">
        <i class="bi bi-cash-coin"></i> Edit Property For Sale
      </h2>
      
      <form id="saleFormData">
        <!-- Basic Information -->
        <h3 class="section-title"><i class="bi bi-info-circle"></i> Basic Information</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="saleTitle" class="required">Property Title</label>
            <input type="text" id="saleTitle" placeholder="e.g., Modern 3-Bedroom House in Alabang" required>
          </div>
          
          <div class="form-group">
            <label for="salePropertyCategory" class="required">Property Category</label>
            <select id="salePropertyCategory" required onchange="updateSalePropertyTypes()">
              <option value="">-- Select Category --</option>
              <option value="residential">Residential Property</option>
              <option value="commercial">Commercial Property</option>
              <option value="land">Land / Lot</option>
              <option value="condo">Condominium</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="salePropertyType" class="required">Property Type</label>
            <select id="salePropertyType" required>
              <option value="">-- Select Type --</option>
              <!-- Options populated by JavaScript -->
            </select>
          </div>
        </div>

        <!-- Property Specifications -->
        <h3 class="section-title"><i class="bi bi-rulers"></i> Property Specifications</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="saleBedrooms" class="required">Bedrooms</label>
            <select id="saleBedrooms" required>
              <option value="">-- Select --</option>
              <option value="studio">Studio</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5+</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="saleBathrooms" class="required">Bathrooms</label>
            <select id="saleBathrooms" required>
              <option value="">-- Select --</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4+</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="saleFloorArea" class="required">Floor Area (sqm)</label>
            <div class="input-with-icon">
              <i class="bi bi-rulers"></i>
              <input type="number" id="saleFloorArea" placeholder="e.g., 120" min="1" required>
            </div>
          </div>
          
          <div class="form-group">
            <label for="saleLotArea">Lot Area (sqm)</label>
            <div class="input-with-icon">
              <i class="bi bi-map"></i>
              <input type="number" id="saleLotArea" placeholder="e.g., 300" min="1">
            </div>
          </div>
          
          <div class="form-group">
            <label for="saleFurnishing">Furnishing</label>
            <select id="saleFurnishing">
              <option value="">-- Select --</option>
              <option value="furnished">Fully Furnished</option>
              <option value="semi-furnished">Semi-Furnished</option>
              <option value="unfurnished">Unfurnished</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="saleYearBuilt">Year Built</label>
            <div class="input-with-icon">
              <i class="bi bi-calendar"></i>
              <input type="number" id="saleYearBuilt" placeholder="e.g., 2015" min="1900" max="2024">
            </div>
          </div>
        </div>

        <!-- Sale Information -->
        <h3 class="section-title"><i class="bi bi-currency-exchange"></i> Sale Information</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="salePrice" class="required">Asking Price (‚Ç±)</label>
            <div class="input-with-icon">
              <i class="bi bi-cash-stack"></i>
              <input type="number" id="salePrice" placeholder="e.g., 5,000,000" min="100000" step="10000" required>
            </div>
          </div>
          
          <div class="form-group">
            <label for="priceNegotiable">Price Negotiable?</label>
            <select id="priceNegotiable">
              <option value="yes">Yes</option>
              <option value="no" selected>No</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="saleType" class="required">Sale Type</label>
            <div class="sale-type-grid">
              <div class="sale-option" onclick="selectSaleType('outright')">
                <h4>Outright Sale</h4>
                <p style="font-size: 13px; color: var(--text-light);">Full payment upon closing</p>
              </div>
              <div class="sale-option" onclick="selectSaleType('installment')">
                <h4>Installment</h4>
                <p style="font-size: 13px; color: var(--text-light);">Payment in installments</p>
              </div>
              <div class="sale-option" onclick="selectSaleType('bank_financing')">
                <h4>Bank Financing</h4>
                <p style="font-size: 13px; color: var(--text-light);">With bank loan option</p>
              </div>
            </div>
            <input type="hidden" id="saleTypeInput" name="saleType" required>
          </div>
        </div>
        
        <!-- Bank Financing Options -->
        <div id="bankOptionsSection" class="bank-options-section">
          <h4><i class="bi bi-bank"></i> Available Bank Financing Options</h4>

          <div class="bank-grid">
            <div class="bank-item">
              <input type="checkbox" id="bank_bdo" name="bankOptions" value="Bank Financing - BDO">
              <label for="bank_bdo">
                <img src="../../financing_logo/3.png" alt="BDO Logo" class="bank-logo">
                BDO Unibank
              </label>
            </div>

            <div class="bank-item">
              <input type="checkbox" id="bank_metrobank" name="bankOptions" value="Bank Financing - Metrobank">
              <label for="bank_metrobank">
                <img src="../../financing_logo/1.png" alt="Metrobank Logo" class="bank-logo">
                Metrobank
              </label>
            </div>

            <div class="bank-item">
              <input type="checkbox" id="bank_unionbank" name="bankOptions" value="Bank Financing - UnionBank">
              <label for="bank_unionbank">
                <img src="../../financing_logo/2.png" alt="UnionBank Logo" class="bank-logo">
                UnionBank
              </label>
            </div>

            <div class="bank-item">
              <input type="checkbox" id="bank_rcbc" name="bankOptions" value="Bank Financing - RCBC">
              <label for="bank_rcbc">
                <img src="../../financing_logo/4.png" alt="RCBC Logo" class="bank-logo">
                RCBC
              </label>
            </div>

            <div class="bank-item">
              <input type="checkbox" id="bank_pagibig" name="bankOptions" value="Pag-IBIG Housing Loan">
              <label for="bank_pagibig">
                <img src="../../financing_logo/5.png" alt="Pag-IBIG Logo" class="bank-logo">
                Pag-IBIG Fund
              </label>
            </div>
          </div>

          <div class="other-banks-input">
            <label for="otherBanks">Other Financing Options</label>
            <input type="text" id="otherBanks" placeholder="e.g., Developer financing, Other banks (comma-separated)">
            <small>List any other financing options not included above</small>
          </div>
        </div>
        
        <!-- Commission Information -->
        <h3 class="section-title"><i class="bi bi-briefcase"></i> Broker Commission</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="commissionType" class="required">Commission Type</label>
            <select id="commissionType" required>
              <option value="">-- Select --</option>
              <option value="percentage">Percentage of Sale Price</option>
              <option value="fixed">Fixed Amount</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="commissionValue" class="required">Commission Value</label>
            <div class="input-with-icon">
              <i class="bi bi-percent"></i>
              <input type="number" id="commissionValue" placeholder="e.g., 3 or 50000" min="0" step="0.1" required>
            </div>
            <small style="color: var(--text-light); display: block; margin-top: 5px;">
              Enter percentage (e.g., 3 for 3%) or fixed amount in ‚Ç±
            </small>
          </div>
        </div>

        <!-- Location -->
        <h3 class="section-title"><i class="bi bi-geo-alt"></i> Location Details</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="saleAddress" class="required">Full Address</label>
            <input type="text" id="saleAddress" placeholder="Complete address" required>
          </div>
          
          <div class="form-group">
            <label for="saleCity" class="required">City/Municipality</label>
            <input type="text" id="saleCity" placeholder="e.g., Muntinlupa City" required>
          </div>
          
          <div class="form-group">
            <label for="saleProvince" class="required">Province</label>
            <input type="text" id="saleProvince" placeholder="e.g., Metro Manila" required>
          </div>
        </div>
        
        <div class="form-group">
          <label>üìç Pin Location on Map</label>
          <input type="text" id="saleLocationSearch" placeholder="Search address or click on map..." style="margin-bottom: 10px;">
          <div id="saleMapPicker"></div>
          <div class="coordinates-display">
            <div class="coord-box">
              <label>Latitude</label>
              <span id="saleLatDisplay">Not set</span>
            </div>
            <div class="coord-box">
              <label>Longitude</label>
              <span id="saleLngDisplay">Not set</span>
            </div>
          </div>
          <input type="hidden" id="saleLatitude" name="saleLatitude">
          <input type="hidden" id="saleLongitude" name="saleLongitude">
        </div>

        <!-- Property Features -->
        <h3 class="section-title"><i class="bi bi-house-door"></i> Property Features</h3>
        <div class="amenities-grid">
          <div class="amenity-item">
            <input type="checkbox" id="sale_wifi" name="saleAmenities" value="WiFi">
            <label for="sale_wifi"><i class="bi bi-wifi"></i> WiFi</label>
          </div>
          <div class="amenity-item">
            <input type="checkbox" id="sale_ac" name="saleAmenities" value="Air Conditioning">
            <label for="sale_ac"><i class="bi bi-snow"></i> Air Conditioning</label>
          </div>
          <div class="amenity-item">
            <input type="checkbox" id="sale_parking" name="saleAmenities" value="Parking">
            <label for="sale_parking"><i class="bi bi-car-front"></i> Parking</label>
          </div>
          <div class="amenity-item">
            <input type="checkbox" id="sale_garden" name="saleAmenities" value="Garden">
            <label for="sale_garden"><i class="bi bi-flower1"></i> Garden</label>
          </div>
          <div class="amenity-item">
            <input type="checkbox" id="sale_swimming_pool" name="saleAmenities" value="Swimming Pool">
            <label for="sale_swimming_pool"><i class="bi bi-water"></i> Swimming Pool</label>
          </div>
          <div class="amenity-item">
            <input type="checkbox" id="sale_gym" name="saleAmenities" value="Gym">
            <label for="sale_gym"><i class="bi bi-activity"></i> Gym</label>
          </div>
          <div class="amenity-item">
            <input type="checkbox" id="sale_security" name="saleAmenities" value="24/7 Security">
            <label for="sale_security"><i class="bi bi-shield-check"></i> 24/7 Security</label>
          </div>
          <div class="amenity-item">
            <input type="checkbox" id="sale_elevator" name="saleAmenities" value="Elevator">
            <label for="sale_elevator"><i class="bi bi-arrow-up-circle"></i> Elevator</label>
          </div>
          <div class="amenity-item">
            <input type="checkbox" id="sale_balcony" name="saleAmenities" value="Balcony">
            <label for="sale_balcony"><i class="bi bi-building"></i> Balcony</label>
          </div>
          <div class="amenity-item">
            <input type="checkbox" id="sale_fireplace" name="saleAmenities" value="Fireplace">
            <label for="sale_fireplace"><i class="bi bi-fire"></i> Fireplace</label>
          </div>
        </div>
        <div class="form-group" style="margin-top: 15px;">
          <label for="saleOtherAmenities">Other Features (comma-separated)</label>
          <input type="text" id="saleOtherAmenities" placeholder="e.g., Smart Home, Solar Panels, CCTV">
        </div>

        <!-- Property Description -->
        <div class="form-group">
          <label for="saleDescription" class="required">Property Description</label>
          <textarea id="saleDescription" placeholder="Describe your property in detail, include unique selling points, neighborhood features, etc..." rows="6" required></textarea>
        </div>

        <!-- Existing Images -->
        <h3 class="existing-images-title"><i class="bi bi-image"></i> Existing Property Images</h3>
        <div class="preview-container" id="saleExistingImagesContainer"></div>
        
        <div class="image-actions">
          <button type="button" class="btn btn-secondary" onclick="removeAllSaleImages()">
            <i class="bi bi-trash"></i> Remove All
          </button>
        </div>

        <!-- Upload New Images -->
        <h3 class="section-title"><i class="bi bi-cloud-arrow-up"></i> Upload New Images</h3>
        <div class="image-upload-area" onclick="document.getElementById('saleNewImages').click()">
          <i class="bi bi-cloud-arrow-up"></i>
          <p>Upload Additional Images</p>
          <p class="upload-info">Drag & drop or click to browse</p>
          <p class="upload-info">Max 10 images total ‚Ä¢ 5MB per image ‚Ä¢ JPG, PNG</p>
          <div id="saleNewImageCount" class="selected-count" style="display: none;">0 new images</div>
        </div>
        <input type="file" id="saleNewImages" accept="image/*" multiple style="display: none;" onchange="handleSaleNewImageSelection(event)">
        <div class="preview-container" id="saleNewPreviewContainer"></div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="window.location.href='broker_listings.html'">
            <i class="bi bi-x-circle"></i> Cancel
          </button>
          <button type="submit" class="btn btn-primary" id="updateSaleBtn">
            <i class="bi bi-check-circle"></i> Update Property for Sale
          </button>
        </div>
      </form>
    </div>

    <!-- LEASE Form -->
    <div id="leaseForm" class="card property-details">
      <h2 style="color: var(--text-dark); margin-top: 0; margin-bottom: 30px; display: flex; align-items: center; gap: 12px;">
        <i class="bi bi-file-text"></i> Edit Property For Lease
      </h2>
      
      <form id="leasePropertyForm">
        <!-- Property Category Selection -->
        <h3 class="section-title"><i class="bi bi-buildings"></i> Property Category</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="leasePropertyCategory" class="required">Select Category</label>
            <select id="leasePropertyCategory" required onchange="updateLeasePropertyTypes()">
              <option value="">-- Select Category --</option>
              <option value="commercial">Commercial Property</option>
              <option value="land">Land / Lot</option>
              <option value="special">Special Purpose Property</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="leasePropertyType" class="required">Property Type</label>
            <select id="leasePropertyType" required>
              <option value="">-- Select Type --</option>
              <!-- Options populated by JavaScript -->
            </select>
          </div>
        </div>

        <!-- Basic Information -->
        <h3 class="section-title"><i class="bi bi-info-circle"></i> Basic Information</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="leaseTitle" class="required">Property Title</label>
            <input type="text" id="leaseTitle" placeholder="e.g., Commercial Office Floor in Makati CBD" required>
          </div>
          
          <div class="form-group">
            <label for="totalArea" class="required">Total Area (sqm)</label>
            <div class="input-with-icon">
              <i class="bi bi-rulers"></i>
              <input type="number" id="totalArea" placeholder="e.g., 500" min="1" required step="0.01">
            </div>
          </div>
          
          <div class="form-group">
            <label for="usableArea">Usable Area (sqm)</label>
            <div class="input-with-icon">
              <i class="bi bi-square"></i>
              <input type="number" id="usableArea" placeholder="Optional" min="1" step="0.01">
            </div>
          </div>
          
          <div class="form-group">
            <label for="zoning">Zoning Classification</label>
            <select id="zoning">
              <option value="">-- Select Zoning --</option>
              <option value="commercial">Commercial</option>
              <option value="industrial">Industrial</option>
              <option value="residential">Residential</option>
              <option value="agricultural">Agricultural</option>
              <option value="mixed_use">Mixed Use</option>
              <option value="tourism">Tourism</option>
            </select>
          </div>
        </div>

        <!-- Lease Terms -->
        <h3 class="section-title"><i class="bi bi-calendar-check"></i> Lease Terms</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="leaseType" class="required">Lease Type</label>
            <div class="lease-term-grid">
              <div class="lease-option" onclick="selectLeaseType('gross')">
                <h4>Gross Lease</h4>
                <p style="font-size: 13px; color: var(--text-light);">Rent includes all operating expenses</p>
              </div>
              <div class="lease-option" onclick="selectLeaseType('net')">
                <h4>Net Lease</h4>
                <p style="font-size: 13px; color: var(--text-light);">Tenant pays rent + some expenses</p>
              </div>
              <div class="lease-option" onclick="selectLeaseType('triple-net')">
                <h4>Triple Net (NNN)</h4>
                <p style="font-size: 13px; color: var(--text-light);">Tenant pays all expenses</p>
              </div>
            </div>
            <input type="hidden" id="leaseTypeInput" name="leaseType" required>
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label for="leaseDuration" class="required">Lease Duration</label>
              <select id="leaseDuration" required>
                <option value="">-- Select Duration --</option>
                <option value="1">1 Year</option>
                <option value="2">2 Years</option>
                <option value="3">3 Years</option>
                <option value="5">5 Years</option>
                <option value="10">10 Years</option>
                <option value="15">15+ Years</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="renewalOption">Renewal Option</label>
              <select id="renewalOption">
                <option value="">-- Select Option --</option>
                <option value="automatic">Automatic Renewal</option>
                <option value="negotiable">Negotiable</option>
                <option value="none">No Renewal Option</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Pricing -->
        <h3 class="section-title"><i class="bi bi-cash-stack"></i> Pricing Information</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="annualRent" class="required">Annual Rent (‚Ç±)</label>
            <div class="input-with-icon">
              <i class="bi bi-currency-exchange"></i>
              <input type="number" id="annualRent" placeholder="e.g., 1,200,000" min="10000" step="1000" required>
            </div>
          </div>
          
          <div class="form-group">
            <label for="paymentTerms">Payment Terms</label>
            <select id="paymentTerms">
              <option value="">-- Select Terms --</option>
              <option value="monthly">Monthly</option>
              <option value="quarterly">Quarterly</option>
              <option value="semi-annual">Semi-Annual</option>
              <option value="annual">Annual</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="securityBond">Security Bond (‚Ç±)</label>
            <div class="input-with-icon">
              <i class="bi bi-bank"></i>
              <input type="number" id="securityBond" placeholder="e.g., 300,000" min="0" step="1000">
            </div>
          </div>
          
          <div class="form-group">
            <label for="advancePayment">Advance Payment (months)</label>
            <div class="input-with-icon">
              <i class="bi bi-calendar-month"></i>
              <input type="number" id="advancePayment" placeholder="e.g., 3" min="1" value="1">
            </div>
          </div>
        </div>
        
        <!-- Broker Commission -->
        <div class="form-grid">
          <div class="form-group">
            <label for="leaseCommissionType" class="required">Commission Type</label>
            <select id="leaseCommissionType" required>
              <option value="">-- Select --</option>
              <option value="percentage">Percentage of Annual Rent</option>
              <option value="fixed">Fixed Amount</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="leaseCommissionValue" class="required">Commission Value</label>
            <div class="input-with-icon">
              <i class="bi bi-percent"></i>
              <input type="number" id="leaseCommissionValue" placeholder="e.g., 10 or 50000" min="0" step="0.1" required>
            </div>
            <small style="color: var(--text-light); display: block; margin-top: 5px;">
              Enter percentage (e.g., 10 for 10%) or fixed amount in ‚Ç±
            </small>
          </div>
        </div>

        <!-- Location Details -->
        <h3 class="section-title"><i class="bi bi-geo-alt"></i> Location Details</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="leaseAddress" class="required">Full Address</label>
            <input type="text" id="leaseAddress" placeholder="Complete address including street, barangay, city" required>
          </div>
          
          <div class="form-group">
            <label for="leaseCity" class="required">City/Municipality</label>
            <input type="text" id="leaseCity" placeholder="e.g., Makati City" required>
          </div>
          
          <div class="form-group">
            <label for="leaseProvince" class="required">Province</label>
            <input type="text" id="leaseProvince" placeholder="e.g., Metro Manila" required>
          </div>
        </div>
        
        <!-- Map -->
        <div class="form-group">
          <label>üìç Pin Location on Map</label>
          <input type="text" id="leaseLocationSearch" placeholder="Search address or click on map..." style="margin-bottom: 10px;">
          <div id="leaseMapPicker"></div>
          <div class="coordinates-display">
            <div class="coord-box">
              <label>Latitude</label>
              <span id="leaseLatDisplay">Not set</span>
            </div>
            <div class="coord-box">
              <label>Longitude</label>
              <span id="leaseLngDisplay">Not set</span>
            </div>
          </div>
          <input type="hidden" id="leaseLatitude" name="leaseLatitude">
          <input type="hidden" id="leaseLongitude" name="leaseLongitude">
        </div>

        <!-- Property Features -->
        <h3 class="section-title"><i class="bi bi-tools"></i> Property Features</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="accessRoad">Access Road Type</label>
            <select id="accessRoad">
              <option value="">-- Select --</option>
              <option value="concrete">Concrete</option>
              <option value="asphalt">Asphalt</option>
              <option value="gravel">Gravel</option>
              <option value="dirt">Dirt Road</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="frontage">Frontage (meters)</label>
            <div class="input-with-icon">
              <i class="bi bi-arrows-expand"></i>
              <input type="number" id="frontage" placeholder="e.g., 20" min="1" step="0.1">
            </div>
          </div>
          
          <div class="form-group">
            <label for="topography">Topography</label>
            <select id="topography">
              <option value="">-- Select --</option>
              <option value="flat">Flat</option>
              <option value="sloping">Sloping</option>
              <option value="hilly">Hilly</option>
              <option value="mountainous">Mountainous</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="utilities">Available Utilities</label>
            <input type="text" id="utilities" placeholder="e.g., Electricity, Water, Internet">
          </div>
        </div>

        <!-- Amenities & Infrastructure -->
        <h3 class="section-title"><i class="bi bi-lightning-charge"></i> Amenities & Infrastructure</h3>
        <div class="amenities-grid">
          <div class="amenity-item">
            <input type="checkbox" id="parking_lease" name="leaseAmenities" value="Parking Area">
            <label for="parking_lease"><i class="bi bi-p-square"></i> Parking Area</label>
          </div>
          <div class="amenity-item">
            <input type="checkbox" id="loading_dock" name="leaseAmenities" value="Loading Dock">
            <label for="loading_dock"><i class="bi bi-truck"></i> Loading Dock</label>
          </div>
          <div class="amenity-item">
            <input type="checkbox" id="security_system" name="leaseAmenities" value="Security System">
            <label for="security_system"><i class="bi bi-shield-lock"></i> Security System</label>
          </div>
          <div class="amenity-item">
            <input type="checkbox" id="fire_safety" name="leaseAmenities" value="Fire Safety System">
            <label for="fire_safety"><i class="bi bi-fire"></i> Fire Safety System</label>
          </div>
          <div class="amenity-item">
            <input type="checkbox" id="backup_power" name="leaseAmenities" value="Backup Power">
            <label for="backup_power"><i class="bi bi-lightning"></i> Backup Power</label>
          </div>
          <div class="amenity-item">
            <input type="checkbox" id="cctv" name="leaseAmenities" value="CCTV">
            <label for="cctv"><i class="bi bi-camera-video"></i> CCTV Surveillance</label>
          </div>
          <div class="amenity-item">
            <input type="checkbox" id="warehouse" name="leaseAmenities" value="Warehouse Space">
            <label for="warehouse"><i class="bi bi-box-seam"></i> Warehouse Space</label>
          </div>
          <div class="amenity-item">
            <input type="checkbox" id="office_space" name="leaseAmenities" value="Office Space">
            <label for="office_space"><i class="bi bi-building"></i> Office Space</label>
          </div>
          <div class="amenity-item">
            <input type="checkbox" id="landscaping" name="leaseAmenities" value="Landscaping">
            <label for="landscaping"><i class="bi bi-tree"></i> Landscaping</label>
          </div>
          <div class="amenity-item">
            <input type="checkbox" id="drainage" name="leaseAmenities" value="Drainage System">
            <label for="drainage"><i class="bi bi-droplet"></i> Drainage System</label>
          </div>
        </div>
        
        <div class="form-group" style="margin-top: 15px;">
          <label for="otherFeatures">Other Features (comma-separated)</label>
          <input type="text" id="otherFeatures" placeholder="e.g., High ceilings, Sprinkler system, Truck access">
        </div>

        <!-- Restrictions & Conditions -->
        <h3 class="section-title"><i class="bi bi-file-earmark-lock"></i> Restrictions & Conditions</h3>
        <div class="form-group">
          <label for="restrictions">Use Restrictions</label>
          <textarea id="restrictions" placeholder="Describe any use restrictions, zoning limitations, or special conditions..." rows="4"></textarea>
        </div>
        
        <div class="form-group">
          <label for="maintenance">Maintenance Responsibility</label>
          <select id="maintenance">
            <option value="">-- Select Responsibility --</option>
            <option value="landlord">Landlord</option>
            <option value="tenant">Tenant</option>
            <option value="shared">Shared</option>
          </select>
        </div>

        <!-- Property Description -->
        <div class="form-group">
          <label for="leaseDescription" class="required">Property Description</label>
          <textarea id="leaseDescription" placeholder="Describe the property in detail, including development potential, nearby landmarks, transportation access, etc." rows="6" required></textarea>
        </div>

        <!-- Existing Images -->
        <h3 class="existing-images-title"><i class="bi bi-image"></i> Existing Property Images</h3>
        <div class="preview-container" id="leaseExistingImagesContainer"></div>
        
        <div class="image-actions">
          <button type="button" class="btn btn-secondary" onclick="removeAllLeaseImages()">
            <i class="bi bi-trash"></i> Remove All
          </button>
        </div>

        <!-- Upload New Images -->
        <h3 class="section-title"><i class="bi bi-cloud-arrow-up"></i> Upload New Images</h3>
        <div class="image-upload-area" onclick="document.getElementById('leaseNewImages').click()">
          <i class="bi bi-cloud-arrow-up"></i>
          <p>Upload Additional Images</p>
          <p class="upload-info">Drag & drop or click to browse</p>
          <p class="upload-info">Max 10 images total ‚Ä¢ 5MB per image ‚Ä¢ JPG, PNG</p>
          <div id="leaseNewImageCount" class="selected-count" style="display: none;">0 new images</div>
        </div>
        <input type="file" id="leaseNewImages" accept="image/*" multiple style="display: none;" onchange="handleLeaseNewImageSelection(event)">
        <div class="preview-container" id="leaseNewPreviewContainer"></div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="window.location.href='broker_listings.html'">
            <i class="bi bi-x-circle"></i> Cancel
          </button>
          <button type="submit" class="btn btn-primary" id="updateLeaseBtn">
            <i class="bi bi-check-circle"></i> Update Property for Lease
          </button>
        </div>
      </form>
    </div>

    <!-- Update Progress for Sale -->
    <div id="saleUpdateProgress" class="upload-progress" style="display: none;">
      <h3 style="margin-top: 0; color: var(--text-dark); display: flex; align-items: center; gap: 10px;">
        <i class="bi bi-cloud-arrow-up"></i> Updating Sale Property...
      </h3>
      <p id="saleProgressText">Preparing update...</p>
      <div class="progress-bar">
        <div id="saleProgressFill" class="progress-fill" style="width: 0%;"></div>
      </div>
    </div>

    <!-- Update Progress for Lease -->
    <div id="leaseUpdateProgress" class="upload-progress" style="display: none;">
      <h3 style="margin-top: 0; color: var(--text-dark); display: flex; align-items: center; gap: 10px;">
        <i class="bi bi-cloud-arrow-up"></i> Updating Lease Property...
      </h3>
      <p id="leaseProgressText">Preparing update...</p>
      <div class="progress-bar">
        <div id="leaseProgressFill" class="progress-fill" style="width: 0%;"></div>
      </div>
    </div>
  </div>
</div>

<!-- Firebase & Maps Scripts -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBwwAkIEixeUysaGrMb9BtTsMwz_C9Noxk&libraries=places" async defer></script>

<script>
  // ===== CONFIGURATION =====
  const firebaseConfig = {
    apiKey: "AIzaSyCIfzneDzWVveG8p_0mywoA9D9F5AyzZX4",
    authDomain: "bahai-1b76d.firebaseapp.com",
    projectId: "bahai-1b76d",
    storageBucket: "bahai-1b76d.firebasestorage.app",
    messagingSenderId: "646878644941",
    appId: "1:646878644941:web:5b4ccc3412250337587784"
  };

  // ===== LOAD SIDEBAR =====
  async function loadSidebar() {
    try {
      const response = await fetch('sidebar.html');
      const sidebarHtml = await response.text();
      document.getElementById('sidebar-container').innerHTML = sidebarHtml;
      
      // Initialize sidebar after loading
      initializeSidebar();
    } catch (error) {
      console.error('Error loading sidebar:', error);
      // Fallback to basic sidebar if loading fails
      document.getElementById('sidebar-container').innerHTML = `
        <div class="sidebar" id="sidebar">
          <div class="sidebar-header">
            <h2><i class="bi bi-house"></i> PropHub</h2>
          </div>
          
          <div class="sidebar-menu">
            <a href="broker_dashboard.html" class="menu-item">
              <i class="bi bi-speedometer2"></i>
              <span class="menu-text">Dashboard</span>
            </a>
            <a href="broker_listings.html" class="menu-item">
              <i class="bi bi-list-ul"></i>
              <span class="menu-text">My Listings</span>
            </a>
            <a href="#" class="menu-item active">
              <i class="bi bi-pencil-square"></i>
              <span class="menu-text">Edit Property</span>
            </a>
            <a href="../kyc.html" class="menu-item">
              <i class="bi bi-shield-check"></i>
              <span class="menu-text">KYC Verification</span>
            </a>
          </div>
          
          <div class="sidebar-footer">
            <button class="logout-btn" id="sidebarLogoutBtn">
              <i class="bi bi-box-arrow-right"></i> Logout
            </button>
          </div>
        </div>
      `;
      initializeSidebar();
    }
  }

  function initializeSidebar() {
    // Setup logout button
    const logoutBtn = document.getElementById('sidebarLogoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', function() {
        firebase.auth().signOut().then(() => {
          window.location.href = "../login.html";
        });
      });
    }
    
    // Mark current page as active
    const currentPage = window.location.pathname.split('/').pop();
    const menuItems = document.querySelectorAll('.menu-item');
    menuItems.forEach(item => {
      const href = item.getAttribute('href');
      if (href && href.includes(currentPage)) {
        item.classList.add('active');
      } else {
        item.classList.remove('active');
      }
    });
  }

  // ===== SIDEBAR FUNCTIONS =====
  function toggleMobileSidebar() {
    const sidebar = document.getElementById('sidebar');
    if (sidebar) {
      sidebar.classList.toggle('active');
    }
  }

  function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    if (sidebar) {
      sidebar.classList.toggle('collapsed');
    }
  }

  // ===== INITIALIZE =====
  document.addEventListener('DOMContentLoaded', function() {
    // Load sidebar first
    loadSidebar();
    
    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    
    // Check authentication
    firebase.auth().onAuthStateChanged(async function(user) {
      if (!user) {
        window.location.href = "../login.html";
        return;
      }
      currentUser = user;
      await loadUserProfile();
      await checkKYCStatus();
      await loadPropertyData();
    });
    
    // Setup mobile toggle
    document.getElementById('mobileToggle').addEventListener('click', toggleMobileSidebar);
  });

  // ===== SALE PROPERTY TYPE MAPPING =====
  const salePropertyTypes = {
    residential: [
      { value: "house", label: "House" },
      { value: "townhouse", label: "Townhouse" },
      { value: "bungalow", label: "Bungalow" },
      { value: "duplex", label: "Duplex" },
      { value: "village_lot", label: "Village Lot" }
    ],
    commercial: [
      { value: "commercial_building", label: "Commercial Building" },
      { value: "office_space", label: "Office Space" },
      { value: "retail_space", label: "Retail Space" },
      { value: "warehouse", label: "Warehouse" },
      { value: "showroom", label: "Showroom" }
    ],
    land: [
      { value: "residential_lot", label: "Residential Lot" },
      { value: "commercial_lot", label: "Commercial Lot" },
      { value: "agricultural_land", label: "Agricultural Land" },
      { value: "industrial_lot", label: "Industrial Lot" },
      { value: "beachfront", label: "Beachfront Property" }
    ],
    condo: [
      { value: "condo_unit", label: "Condominium Unit" },
      { value: "penthouse", label: "Penthouse" },
      { value: "studio", label: "Studio Unit" },
      { value: "loft", label: "Loft Unit" }
    ]
  };

  // ===== LEASE PROPERTY TYPE MAPPING =====
  const leasePropertyTypes = {
    commercial: [
      { value: "office_floor", label: "Office Floor" },
      { value: "retail_space_lease", label: "Retail Space" },
      { value: "building_lease", label: "Building Lease" },
      { value: "commercial_unit", label: "Commercial Unit" },
      { value: "showroom_lease", label: "Showroom" },
      { value: "warehouse_lease", label: "Warehouse" }
    ],
    land: [
      { value: "commercial_lot", label: "Commercial Lot" },
      { value: "agricultural_land", label: "Agricultural Land" },
      { value: "development_land", label: "Development Land" },
      { value: "industrial_lot", label: "Industrial Lot" },
      { value: "residential_lot", label: "Residential Lot" },
      { value: "vacant_lot", label: "Vacant Lot" }
    ],
    special: [
      { value: "resort_property", label: "Resort Property" },
      { value: "event_venue", label: "Event Venue" },
      { value: "parking_area", label: "Parking Area" },
      { value: "school_property", label: "School Property" },
      { value: "hospitality", label: "Hospitality Property" },
      { value: "sports_facility", label: "Sports Facility" }
    ]
  };

  // ===== GLOBAL VARIABLES =====
  let currentUser = null;
  let kycStatus = null;
  let saleMap, saleMarker, saleAutocomplete;
  let leaseMap, leaseMarker, leaseAutocomplete;
  let selectedSaleNewImages = [];
  let selectedLeaseNewImages = [];
  let existingSaleImages = [];
  let existingLeaseImages = [];
  let selectedSaleType = null;
  let selectedLeaseType = null;
  let propertyId = null;
  let propertyData = null;
  let currentListingType = null;

  // ===== USER PROFILE =====
  async function loadUserProfile() {
    try {
      const userDoc = await firebase.firestore().collection('users').doc(currentUser.uid).get();
      if (userDoc.exists) {
        const userData = userDoc.data();
        // You can use user data if needed
      }
    } catch (error) {
      console.error('Error loading user profile:', error);
    }
  }

  // ===== LOAD PROPERTY DATA =====
  async function loadPropertyData() {
    showLoading(true);
    
    // Get property ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    propertyId = urlParams.get('id');
    
    if (!propertyId) {
      showMessage('Invalid property ID', 'error');
      setTimeout(() => window.location.href = 'broker_listings.html', 2000);
      return;
    }
    
    try {
      const propertyDoc = await firebase.firestore().collection('properties').doc(propertyId).get();
      
      if (!propertyDoc.exists) {
        showMessage('Property not found', 'error');
        setTimeout(() => window.location.href = 'broker_listings.html', 2000);
        return;
      }
      
      propertyData = propertyDoc.data();
      propertyData.id = propertyId;
      
      currentListingType = propertyData.type || propertyData.listingType || 'sale';
      
      // Pre-populate form based on listing type
      if (currentListingType === 'sale') {
        await populateSaleForm(propertyData);
        selectType('sale');
      } else if (currentListingType === 'lease') {
        await populateLeaseForm(propertyData);
        selectType('lease');
      }
      
      // Initialize forms
      initializeSaleForm();
      initializeLeaseForm();
      
      showMessage('Property data loaded successfully!', 'success');
      
    } catch (error) {
      console.error('Error loading property:', error);
      showMessage('Error loading property data: ' + error.message, 'error');
    } finally {
      showLoading(false);
    }
  }

  // ===== POPULATE SALE FORM =====
  async function populateSaleForm(data) {
    // Basic Information
    document.getElementById('saleTitle').value = data.title || '';
    document.getElementById('salePropertyCategory').value = data.propertyCategory || '';
    updateSalePropertyTypes();
    setTimeout(() => {
      document.getElementById('salePropertyType').value = data.propertyType || '';
    }, 100);
    
    // Specifications
    document.getElementById('saleBedrooms').value = data.bedrooms || '';
    document.getElementById('saleBathrooms').value = data.bathrooms || '';
    document.getElementById('saleFloorArea').value = data.floorArea || '';
    document.getElementById('saleLotArea').value = data.lotArea || '';
    document.getElementById('saleFurnishing').value = data.furnishing || '';
    document.getElementById('saleYearBuilt').value = data.yearBuilt || '';
    
    // Sale Information
    document.getElementById('salePrice').value = data.salePrice || data.pricing || '';
    document.getElementById('priceNegotiable').value = data.priceNegotiable || 'no';
    
    // Sale Type
    selectedSaleType = data.saleType || 'outright';
    document.getElementById('saleTypeInput').value = selectedSaleType;
    document.querySelectorAll('.sale-option').forEach(option => {
      option.classList.remove('active');
    });
    setTimeout(() => {
      if (selectedSaleType === 'outright') {
        document.querySelector('.sale-option:nth-child(1)').classList.add('active');
      } else if (selectedSaleType === 'installment') {
        document.querySelector('.sale-option:nth-child(2)').classList.add('active');
      } else if (selectedSaleType === 'bank_financing') {
        document.querySelector('.sale-option:nth-child(3)').classList.add('active');
        document.getElementById('bankOptionsSection').classList.add('active');
      }
    }, 100);
    
    // Bank Financing Options
    if (data.financingOptions && Array.isArray(data.financingOptions)) {
      data.financingOptions.forEach(option => {
        // Check standard bank options
        const bankCheckboxes = document.querySelectorAll('input[name="bankOptions"]');
        bankCheckboxes.forEach(checkbox => {
          if (option.includes(checkbox.value.split(' - ')[1])) {
            checkbox.checked = true;
          }
        });
        
        // Check for other banks
        if (!option.includes('Bank Financing -') && !option.includes('Pag-IBIG')) {
          document.getElementById('otherBanks').value = option;
        }
      });
    }
    
    // Commission
    document.getElementById('commissionType').value = data.commissionType || '';
    document.getElementById('commissionValue').value = data.commissionValue || '';
    
    // Location
    document.getElementById('saleAddress').value = data.address || data.location || '';
    document.getElementById('saleCity').value = data.city || '';
    document.getElementById('saleProvince').value = data.province || '';
    
    if (data.latitude && data.longitude) {
      document.getElementById('saleLatitude').value = data.latitude;
      document.getElementById('saleLongitude').value = data.longitude;
      document.getElementById('saleLatDisplay').textContent = data.latitude.toFixed(6);
      document.getElementById('saleLngDisplay').textContent = data.longitude.toFixed(6);
      
      // Initialize map with property location
      setTimeout(() => {
        if (window.google && window.google.maps && !saleMap) {
          initSaleMapPicker();
        }
      }, 500);
    }
    
    // Amenities
    if (data.amenities && Array.isArray(data.amenities)) {
      data.amenities.forEach(amenity => {
        // Check predefined amenities
        const checkbox = document.querySelector(`input[name="saleAmenities"][value="${amenity}"]`);
        if (checkbox) {
          checkbox.checked = true;
        } else {
          // Add to other amenities
          const currentOther = document.getElementById('saleOtherAmenities').value;
          document.getElementById('saleOtherAmenities').value = currentOther ? 
            currentOther + ', ' + amenity : amenity;
        }
      });
    }
    
    // Description
    document.getElementById('saleDescription').value = data.description || '';
    
    // Existing Images
    existingSaleImages = data.imageUrls || data.photos || [];
    updateSaleExistingImages();
  }

  // ===== POPULATE LEASE FORM =====
  async function populateLeaseForm(data) {
    // Property Category
    document.getElementById('leasePropertyCategory').value = data.propertyCategory || '';
    updateLeasePropertyTypes();
    setTimeout(() => {
      document.getElementById('leasePropertyType').value = data.propertyType || '';
    }, 100);
    
    // Basic Information
    document.getElementById('leaseTitle').value = data.title || '';
    document.getElementById('totalArea').value = data.totalArea || data.floorArea || '';
    document.getElementById('usableArea').value = data.usableArea || '';
    document.getElementById('zoning').value = data.zoning || '';
    
    // Lease Terms
    selectedLeaseType = data.leaseType || 'gross';
    document.getElementById('leaseTypeInput').value = selectedLeaseType;
    document.querySelectorAll('.lease-option').forEach(option => {
      option.classList.remove('active');
    });
    setTimeout(() => {
      if (selectedLeaseType === 'gross') {
        document.querySelector('.lease-option:nth-child(1)').classList.add('active');
      } else if (selectedLeaseType === 'net') {
        document.querySelector('.lease-option:nth-child(2)').classList.add('active');
      } else if (selectedLeaseType === 'triple-net') {
        document.querySelector('.lease-option:nth-child(3)').classList.add('active');
      }
    }, 100);
    
    document.getElementById('leaseDuration').value = data.leaseDuration || '';
    document.getElementById('renewalOption').value = data.renewalOption || '';
    
    // Pricing
    document.getElementById('annualRent').value = data.annualRent || '';
    document.getElementById('paymentTerms').value = data.paymentTerms || '';
    document.getElementById('securityBond').value = data.securityBond || '';
    document.getElementById('advancePayment').value = data.advancePayment || 1;
    
    // Commission
    document.getElementById('leaseCommissionType').value = data.commissionType || '';
    document.getElementById('leaseCommissionValue').value = data.commissionValue || '';
    
    // Location
    document.getElementById('leaseAddress').value = data.address || data.location || '';
    document.getElementById('leaseCity').value = data.city || '';
    document.getElementById('leaseProvince').value = data.province || '';
    
    if (data.latitude && data.longitude) {
      document.getElementById('leaseLatitude').value = data.latitude;
      document.getElementById('leaseLongitude').value = data.longitude;
      document.getElementById('leaseLatDisplay').textContent = data.latitude.toFixed(6);
      document.getElementById('leaseLngDisplay').textContent = data.longitude.toFixed(6);
      
      // Initialize map with property location
      setTimeout(() => {
        if (window.google && window.google.maps && !leaseMap) {
          initLeaseMapPicker();
        }
      }, 500);
    }
    
    // Property Features
    document.getElementById('accessRoad').value = data.accessRoad || '';
    document.getElementById('frontage').value = data.frontage || '';
    document.getElementById('topography').value = data.topography || '';
    document.getElementById('utilities').value = data.utilities || '';
    
    // Amenities
    if (data.amenities && Array.isArray(data.amenities)) {
      data.amenities.forEach(amenity => {
        // Check predefined amenities
        const checkbox = document.querySelector(`input[name="leaseAmenities"][value="${amenity}"]`);
        if (checkbox) {
          checkbox.checked = true;
        } else {
          // Add to other features
          const currentOther = document.getElementById('otherFeatures').value;
          document.getElementById('otherFeatures').value = currentOther ? 
            currentOther + ', ' + amenity : amenity;
        }
      });
    }
    
    // Restrictions & Conditions
    document.getElementById('restrictions').value = data.restrictions || '';
    document.getElementById('maintenance').value = data.maintenance || '';
    
    // Description
    document.getElementById('leaseDescription').value = data.description || '';
    
    // Existing Images
    existingLeaseImages = data.imageUrls || data.photos || [];
    updateLeaseExistingImages();
  }

  // ===== TYPE SELECTION =====
  function selectType(type) {
    // Update UI
    document.querySelectorAll('.type-card').forEach(card => {
      card.classList.remove('active');
    });
    
    if (type === 'sale') {
      document.getElementById('saleTypeCard').classList.add('active');
      document.getElementById('saleForm').classList.add('active');
      document.getElementById('leaseForm').classList.remove('active');
      
      // Initialize sale map if not already done
      if (window.google && window.google.maps && !saleMap) {
        setTimeout(() => initSaleMapPicker(), 100);
      }
    } else {
      document.getElementById('leaseTypeCard').classList.add('active');
      document.getElementById('saleForm').classList.remove('active');
      document.getElementById('leaseForm').classList.add('active');
      
      // Initialize lease map if not already done
      if (window.google && window.google.maps && !leaseMap) {
        setTimeout(() => initLeaseMapPicker(), 100);
      }
    }
  }

  // ===== SALE FORM FUNCTIONS =====
  function initializeSaleForm() {
    // Update property types when category changes
    document.getElementById('salePropertyCategory').addEventListener('change', updateSalePropertyTypes);
    
    // Initialize sale type selection
    document.querySelectorAll('.sale-option').forEach(option => {
      option.addEventListener('click', function() {
        selectSaleType(this.querySelector('h4').textContent.toLowerCase().replace(/\s+/g, '_'));
      });
    });
    
    // Initialize bank options checkboxes
    document.querySelectorAll('.bank-item').forEach(item => {
      item.addEventListener('click', function(e) {
        if (e.target.type !== 'checkbox') {
          const checkbox = this.querySelector('input[type="checkbox"]');
          checkbox.checked = !checkbox.checked;
        }
      });
    });
    
    // Initialize map when Google Maps loads
    if (window.google && window.google.maps) {
      initSaleMapPicker();
    } else {
      window.addEventListener('load', function() {
        if (window.google && window.google.maps && !saleMap) {
          initSaleMapPicker();
        }
      });
    }
    
    // Form submission
    document.getElementById('saleFormData').addEventListener('submit', handleSaleUpdate);
  }

  function updateSalePropertyTypes() {
    const category = document.getElementById('salePropertyCategory').value;
    const typeSelect = document.getElementById('salePropertyType');
    
    // Clear existing options
    typeSelect.innerHTML = '<option value="">-- Select Type --</option>';
    
    // Add new options based on category
    if (category && salePropertyTypes[category]) {
      salePropertyTypes[category].forEach(type => {
        const option = document.createElement('option');
        option.value = type.value;
        option.textContent = type.label;
        typeSelect.appendChild(option);
      });
    }
  }

  function selectSaleType(type) {
    selectedSaleType = type;
    document.getElementById('saleTypeInput').value = type;
    
    // Update UI
    document.querySelectorAll('.sale-option').forEach(option => {
      option.classList.remove('active');
    });
    
    event.currentTarget.classList.add('active');
    
    // Show/hide bank financing options
    const bankOptionsSection = document.getElementById('bankOptionsSection');
    if (type === 'bank_financing') {
      bankOptionsSection.classList.add('active');
    } else {
      bankOptionsSection.classList.remove('active');
    }
  }

  // ===== LEASE FORM FUNCTIONS =====
  function initializeLeaseForm() {
    // Update property types when category changes
    document.getElementById('leasePropertyCategory').addEventListener('change', updateLeasePropertyTypes);
    
    // Initialize lease type selection
    document.querySelectorAll('.lease-option').forEach(option => {
      option.addEventListener('click', function() {
        selectLeaseType(this.querySelector('h4').textContent.toLowerCase().replace(/\s+/g, '_'));
      });
    });
    
    // Form submission
    document.getElementById('leasePropertyForm').addEventListener('submit', handleLeaseUpdate);
  }

  function updateLeasePropertyTypes() {
    const category = document.getElementById('leasePropertyCategory').value;
    const typeSelect = document.getElementById('leasePropertyType');
    
    // Clear existing options
    typeSelect.innerHTML = '<option value="">-- Select Type --</option>';
    
    // Add new options based on category
    if (category && leasePropertyTypes[category]) {
      leasePropertyTypes[category].forEach(type => {
        const option = document.createElement('option');
        option.value = type.value;
        option.textContent = type.label;
        typeSelect.appendChild(option);
      });
    }
  }

  function selectLeaseType(type) {
    selectedLeaseType = type;
    document.getElementById('leaseTypeInput').value = type;
    
    // Update UI
    document.querySelectorAll('.lease-option').forEach(option => {
      option.classList.remove('active');
    });
    
    event.currentTarget.classList.add('active');
  }

  // ===== IMAGE HANDLING =====
  function handleSaleNewImageSelection(event) {
    const files = event.target.files;
    const countElement = document.getElementById('saleNewImageCount');
    
    // Add new files to existing array
    const newFiles = Array.from(files);
    const totalFiles = selectedSaleNewImages.length + newFiles.length + existingSaleImages.length;
    
    // Check if total exceeds 10
    if (totalFiles > 10) {
      showMessage(`Maximum 10 images allowed. You already have ${existingSaleImages.length} existing images and ${selectedSaleNewImages.length} new images.`, 'error');
      event.target.value = '';
      return;
    }
    
    // Check file size (5MB = 5 * 1024 * 1024 bytes)
    for (const file of newFiles) {
      if (file.size > 5 * 1024 * 1024) {
        showMessage(`File "${file.name}" exceeds 5MB limit. Please choose smaller files.`, 'error');
        event.target.value = '';
        return;
      }
    }
    
    // Add new files to the array
    selectedSaleNewImages.push(...newFiles);
    
    // Update UI
    updateSaleNewImagePreview();
    
    // Update count display
    if (selectedSaleNewImages.length > 0) {
      countElement.textContent = `${selectedSaleNewImages.length} new image(s)`;
      countElement.style.display = 'block';
    }
    
    // Reset file input so same files can be selected again
    event.target.value = '';
  }

  function handleLeaseNewImageSelection(event) {
    const files = event.target.files;
    const countElement = document.getElementById('leaseNewImageCount');
    
    // Add new files to existing array
    const newFiles = Array.from(files);
    const totalFiles = selectedLeaseNewImages.length + newFiles.length + existingLeaseImages.length;
    
    // Check if total exceeds 10
    if (totalFiles > 10) {
      showMessage(`Maximum 10 images allowed. You already have ${existingLeaseImages.length} existing images and ${selectedLeaseNewImages.length} new images.`, 'error');
      event.target.value = '';
      return;
    }
    
    // Check file size (5MB = 5 * 1024 * 1024 bytes)
    for (const file of newFiles) {
      if (file.size > 5 * 1024 * 1024) {
        showMessage(`File "${file.name}" exceeds 5MB limit. Please choose smaller files.`, 'error');
        event.target.value = '';
        return;
      }
    }
    
    // Add new files to the array
    selectedLeaseNewImages.push(...newFiles);
    
    // Update UI
    updateLeaseNewImagePreview();
    
    // Update count display
    if (selectedLeaseNewImages.length > 0) {
      countElement.textContent = `${selectedLeaseNewImages.length} new image(s)`;
      countElement.style.display = 'block';
    }
    
    // Reset file input so same files can be selected again
    event.target.value = '';
  }

  function updateSaleExistingImages() {
    const container = document.getElementById('saleExistingImagesContainer');
    container.innerHTML = '';
    
    if (existingSaleImages.length === 0) {
      container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No existing images</p>';
      return;
    }
    
    // Create preview for each existing image
    existingSaleImages.forEach((url, index) => {
      const div = document.createElement('div');
      div.className = 'preview-item';
      div.innerHTML = `
        <img src="${url}" alt="Existing image ${index + 1}">
        <button type="button" class="remove-btn" onclick="removeSaleExistingImage(${index})">√ó</button>
      `;
      container.appendChild(div);
    });
  }

  function updateLeaseExistingImages() {
    const container = document.getElementById('leaseExistingImagesContainer');
    container.innerHTML = '';
    
    if (existingLeaseImages.length === 0) {
      container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No existing images</p>';
      return;
    }
    
    // Create preview for each existing image
    existingLeaseImages.forEach((url, index) => {
      const div = document.createElement('div');
      div.className = 'preview-item';
      div.innerHTML = `
        <img src="${url}" alt="Existing image ${index + 1}">
        <button type="button" class="remove-btn" onclick="removeLeaseExistingImage(${index})">√ó</button>
      `;
      container.appendChild(div);
    });
  }

  function updateSaleNewImagePreview() {
    const container = document.getElementById('saleNewPreviewContainer');
    const countElement = document.getElementById('saleNewImageCount');
    
    // Clear existing preview
    container.innerHTML = '';
    
    if (selectedSaleNewImages.length === 0) {
      countElement.style.display = 'none';
      return;
    }
    
    // Create preview for each image
    selectedSaleNewImages.forEach((file, index) => {
      const reader = new FileReader();
      reader.onload = function(e) {
        const div = document.createElement('div');
        div.className = 'preview-item';
        div.innerHTML = `
          <img src="${e.target.result}" alt="New image ${index + 1}">
          <button type="button" class="remove-btn" onclick="removeSaleNewImage(${index})">√ó</button>
        `;
        container.appendChild(div);
      };
      reader.readAsDataURL(file);
    });
    
    // Update count
    countElement.textContent = `${selectedSaleNewImages.length} new image(s)`;
    countElement.style.display = 'block';
  }

  function updateLeaseNewImagePreview() {
    const container = document.getElementById('leaseNewPreviewContainer');
    const countElement = document.getElementById('leaseNewImageCount');
    
    // Clear existing preview
    container.innerHTML = '';
    
    if (selectedLeaseNewImages.length === 0) {
      countElement.style.display = 'none';
      return;
    }
    
    // Create preview for each image
    selectedLeaseNewImages.forEach((file, index) => {
      const reader = new FileReader();
      reader.onload = function(e) {
        const div = document.createElement('div');
        div.className = 'preview-item';
        div.innerHTML = `
          <img src="${e.target.result}" alt="New image ${index + 1}">
          <button type="button" class="remove-btn" onclick="removeLeaseNewImage(${index})">√ó</button>
        `;
        container.appendChild(div);
      };
      reader.readAsDataURL(file);
    });
    
    // Update count
    countElement.textContent = `${selectedLeaseNewImages.length} new image(s)`;
    countElement.style.display = 'block';
  }

  function removeSaleExistingImage(index) {
    if (confirm('Are you sure you want to remove this image?')) {
      existingSaleImages.splice(index, 1);
      updateSaleExistingImages();
    }
  }

  function removeLeaseExistingImage(index) {
    if (confirm('Are you sure you want to remove this image?')) {
      existingLeaseImages.splice(index, 1);
      updateLeaseExistingImages();
    }
  }

  function removeSaleNewImage(index) {
    selectedSaleNewImages.splice(index, 1);
    updateSaleNewImagePreview();
  }

  function removeLeaseNewImage(index) {
    selectedLeaseNewImages.splice(index, 1);
    updateLeaseNewImagePreview();
  }

  function removeAllSaleImages() {
    if (confirm('Are you sure you want to remove all images? This cannot be undone.')) {
      existingSaleImages = [];
      updateSaleExistingImages();
    }
  }

  function removeAllLeaseImages() {
    if (confirm('Are you sure you want to remove all images? This cannot be undone.')) {
      existingLeaseImages = [];
      updateLeaseExistingImages();
    }
  }

  // ===== MAP FUNCTIONS =====
  window.initSaleMapPicker = function() {
    const defaultLocation = { lat: 14.5995, lng: 120.9842 };
    
    // Use existing location if available
    const existingLat = document.getElementById('saleLatitude').value;
    const existingLng = document.getElementById('saleLongitude').value;
    const initialLocation = existingLat && existingLng ? 
      { lat: parseFloat(existingLat), lng: parseFloat(existingLng) } : defaultLocation;
    
    saleMap = new google.maps.Map(document.getElementById('saleMapPicker'), {
      center: initialLocation,
      zoom: existingLat ? 15 : 12,
      mapTypeControl: true,
      streetViewControl: true,
      styles: [
        {
          "featureType": "administrative",
          "elementType": "geometry",
          "stylers": [{"visibility": "off"}]
        },
        {
          "featureType": "poi",
          "stylers": [{"visibility": "off"}]
        },
        {
          "featureType": "road",
          "elementType": "labels.icon",
          "stylers": [{"visibility": "off"}]
        },
        {
          "featureType": "transit",
          "stylers": [{"visibility": "off"}]
        }
      ]
    });
    
    const input = document.getElementById('saleLocationSearch');
    saleAutocomplete = new google.maps.places.Autocomplete(input);
    saleAutocomplete.bindTo('bounds', saleMap);
    
    saleAutocomplete.addListener('place_changed', function() {
      const place = saleAutocomplete.getPlace();
      if (place.geometry) {
        saleMap.setCenter(place.geometry.location);
        saleMap.setZoom(17);
        placeSaleMarker(place.geometry.location);
        
        // Auto-fill address details
        autoFillAddressFromPlace(place, 'sale');
      }
    });
    
    saleMap.addListener('click', function(event) {
      placeSaleMarker(event.latLng);
      
      // Reverse geocode to get address
      reverseGeocode(event.latLng, 'sale');
    });
    
    // Place initial marker if location exists
    if (existingLat && existingLng) {
      const location = new google.maps.LatLng(parseFloat(existingLat), parseFloat(existingLng));
      placeSaleMarker(location);
      
      // Reverse geocode to update address
      setTimeout(() => reverseGeocode(location, 'sale'), 1000);
    } else {
      placeSaleMarker(new google.maps.LatLng(defaultLocation));
    }
  };

  window.initLeaseMapPicker = function() {
    const defaultLocation = { lat: 14.5995, lng: 120.9842 };
    
    // Use existing location if available
    const existingLat = document.getElementById('leaseLatitude').value;
    const existingLng = document.getElementById('leaseLongitude').value;
    const initialLocation = existingLat && existingLng ? 
      { lat: parseFloat(existingLat), lng: parseFloat(existingLng) } : defaultLocation;
    
    leaseMap = new google.maps.Map(document.getElementById('leaseMapPicker'), {
      center: initialLocation,
      zoom: existingLat ? 15 : 12,
      mapTypeControl: true,
      streetViewControl: true,
      styles: [
        {
          "featureType": "administrative",
          "elementType": "geometry",
          "stylers": [{"visibility": "off"}]
        },
        {
          "featureType": "poi",
          "stylers": [{"visibility": "off"}]
        },
        {
          "featureType": "road",
          "elementType": "labels.icon",
          "stylers": [{"visibility": "off"}]
        },
        {
          "featureType": "transit",
          "stylers": [{"visibility": "off"}]
        }
      ]
    });
    
    const input = document.getElementById('leaseLocationSearch');
    leaseAutocomplete = new google.maps.places.Autocomplete(input);
    leaseAutocomplete.bindTo('bounds', leaseMap);
    
    leaseAutocomplete.addListener('place_changed', function() {
      const place = leaseAutocomplete.getPlace();
      if (place.geometry) {
        leaseMap.setCenter(place.geometry.location);
        leaseMap.setZoom(17);
        placeLeaseMarker(place.geometry.location);
        
        // Auto-fill address details
        autoFillAddressFromPlace(place, 'lease');
      }
    });
    
    leaseMap.addListener('click', function(event) {
      placeLeaseMarker(event.latLng);
      
      // Reverse geocode to get address
      reverseGeocode(event.latLng, 'lease');
    });
    
    // Place initial marker if location exists
    if (existingLat && existingLng) {
      const location = new google.maps.LatLng(parseFloat(existingLat), parseFloat(existingLng));
      placeLeaseMarker(location);
      
      // Reverse geocode to update address
      setTimeout(() => reverseGeocode(location, 'lease'), 1000);
    } else {
      placeLeaseMarker(new google.maps.LatLng(defaultLocation));
    }
  };

  // ===== ADDRESS PARSING HELPER =====
  function parseAddressComponents(components) {
    let address = '';
    let city = '';
    let province = '';
    let streetNumber = '';
    let route = '';
    let sublocality = '';
    let barangay = '';
    
    for (const component of components) {
      const types = component.types;
      
      if (types.includes('street_number')) {
        streetNumber = component.long_name;
      } else if (types.includes('route')) {
        route = component.long_name;
      } else if (types.includes('locality')) {
        city = component.long_name;
      } else if (types.includes('administrative_area_level_2')) {
        if (!city) city = component.long_name;
      } else if (types.includes('administrative_area_level_1')) {
        province = component.long_name;
      } else if (types.includes('postal_town')) {
        if (!city) city = component.long_name;
      } else if (types.includes('sublocality') || types.includes('sublocality_level_1')) {
        sublocality = component.long_name;
      } else if (types.includes('neighborhood')) {
        barangay = component.long_name;
      }
    }
    
    // Build address
    if (streetNumber && route) {
      address = `${streetNumber} ${route}`;
    } else if (route) {
      address = route;
    } else if (streetNumber) {
      address = streetNumber;
    }
    
    // Add barangay/sublocality if available
    if (barangay || sublocality) {
      address += `, ${barangay || sublocality}`;
    }
    
    return { address, city, province };
  }

  function placeSaleMarker(location) {
    if (saleMarker) {
      saleMarker.setMap(null);
    }
    
    saleMarker = new google.maps.Marker({
      position: location,
      map: saleMap,
      draggable: true,
      animation: google.maps.Animation.DROP,
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 10,
        fillColor: "#e74c3c",
        fillOpacity: 1,
        strokeColor: "#ffffff",
        strokeWeight: 2
      }
    });
    
    updateSaleCoordinates(location.lat(), location.lng());
    
    saleMarker.addListener('dragend', function() {
      updateSaleCoordinates(saleMarker.getPosition().lat(), saleMarker.getPosition().lng());
      
      // Reverse geocode when marker is dragged
      reverseGeocode(saleMarker.getPosition(), 'sale');
    });
    
    // Reverse geocode initial marker position
    reverseGeocode(location, 'sale');
  }

  function placeLeaseMarker(location) {
    if (leaseMarker) {
      leaseMarker.setMap(null);
    }
    
    leaseMarker = new google.maps.Marker({
      position: location,
      map: leaseMap,
      draggable: true,
      animation: google.maps.Animation.DROP,
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 10,
        fillColor: "#9b59b6",
        fillOpacity: 1,
        strokeColor: "#ffffff",
        strokeWeight: 2
      }
    });
    
    updateLeaseCoordinates(location.lat(), location.lng());
    
    leaseMarker.addListener('dragend', function() {
      updateLeaseCoordinates(leaseMarker.getPosition().lat(), leaseMarker.getPosition().lng());
      
      // Reverse geocode when marker is dragged
      reverseGeocode(leaseMarker.getPosition(), 'lease');
    });
    
    // Reverse geocode initial marker position
    reverseGeocode(location, 'lease');
  }

  // ===== REVERSE GEOCODING =====
  function reverseGeocode(latlng, formType) {
    const geocoder = new google.maps.Geocoder();
    
    geocoder.geocode({ location: latlng }, function(results, status) {
      if (status === 'OK') {
        if (results[0]) {
          autoFillAddressFromGeocode(results[0], formType);
        }
      } else {
        console.log('Geocoder failed due to: ' + status);
      }
    });
  }

  // ===== AUTO-FILL ADDRESS FUNCTIONS =====
  function autoFillAddressFromPlace(place, formType) {
    const parsed = parseAddressComponents(place.address_components);
    let address = parsed.address;
    
    // Use formatted address if we couldn't parse street address
    if (!address && place.formatted_address) {
      address = place.formatted_address;
    }
    
    // Update form fields based on form type
    if (formType === 'sale') {
      if (address) document.getElementById('saleAddress').value = address;
      if (parsed.city) document.getElementById('saleCity').value = parsed.city;
      if (parsed.province) document.getElementById('saleProvince').value = parsed.province;
      
      // Also update the search input
      if (place.formatted_address) {
        document.getElementById('saleLocationSearch').value = place.formatted_address;
      }
    } else {
      if (address) document.getElementById('leaseAddress').value = address;
      if (parsed.city) document.getElementById('leaseCity').value = parsed.city;
      if (parsed.province) document.getElementById('leaseProvince').value = parsed.province;
      
      // Also update the search input
      if (place.formatted_address) {
        document.getElementById('leaseLocationSearch').value = place.formatted_address;
      }
    }
  }

  function autoFillAddressFromGeocode(result, formType) {
    const parsed = parseAddressComponents(result.address_components);
    let address = parsed.address;
    
    // Use formatted address if we couldn't parse street address
    if (!address && result.formatted_address) {
      address = result.formatted_address;
    }
    
    // Update form fields based on form type
    if (formType === 'sale') {
      if (address) document.getElementById('saleAddress').value = address;
      if (parsed.city) document.getElementById('saleCity').value = parsed.city;
      if (parsed.province) document.getElementById('saleProvince').value = parsed.province;
      
      // Update search input
      if (result.formatted_address) {
        document.getElementById('saleLocationSearch').value = result.formatted_address;
      }
    } else {
      if (address) document.getElementById('leaseAddress').value = address;
      if (parsed.city) document.getElementById('leaseCity').value = parsed.city;
      if (parsed.province) document.getElementById('leaseProvince').value = parsed.province;
      
      // Update search input
      if (result.formatted_address) {
        document.getElementById('leaseLocationSearch').value = result.formatted_address;
      }
    }
  }

  function updateSaleCoordinates(lat, lng) {
    document.getElementById('saleLatitude').value = lat;
    document.getElementById('saleLongitude').value = lng;
    document.getElementById('saleLatDisplay').textContent = lat.toFixed(6);
    document.getElementById('saleLngDisplay').textContent = lng.toFixed(6);
  }

  function updateLeaseCoordinates(lat, lng) {
    document.getElementById('leaseLatitude').value = lat;
    document.getElementById('leaseLongitude').value = lng;
    document.getElementById('leaseLatDisplay').textContent = lat.toFixed(6);
    document.getElementById('leaseLngDisplay').textContent = lng.toFixed(6);
  }

  // ===== KYC CHECK =====
  async function checkKYCStatus() {
    try {
      const userDoc = await firebase.firestore().collection('users').doc(currentUser.uid).get();
      
      if (!userDoc.exists) {
        showMessage('User profile not found', 'error');
        return;
      }
      
      const userData = userDoc.data();
      kycStatus = userData.kycStatus || 'not_submitted';
      
      const warning = document.getElementById('kycWarning');
      const badge = document.getElementById('kycBadge');
      const badgeText = document.getElementById('kycBadgeText');
      const statusText = document.getElementById('kycStatusText');
      const message = document.getElementById('kycMessage');
      
      // Update KYC badge
      badge.style.display = 'flex';
      badge.className = `kyc-badge ${kycStatus}`;
      
      switch(kycStatus) {
        case 'not_submitted':
          badgeText.textContent = 'KYC: Not Submitted';
          warning.style.display = 'block';
          statusText.textContent = 'Status: KYC Not Submitted';
          message.textContent = 'You must complete KYC verification before updating properties.';
          break;
          
        case 'pending':
          badgeText.textContent = 'KYC: Pending';
          warning.style.display = 'block';
          statusText.textContent = 'Status: KYC Pending Approval';
          message.textContent = 'Your KYC is under review. Please wait for approval.';
          break;
          
        case 'rejected':
          badgeText.textContent = 'KYC: Rejected';
          warning.style.display = 'block';
          statusText.textContent = 'Status: KYC Rejected';
          message.textContent = 'Your KYC was rejected. Please resubmit valid documents.';
          break;
          
        case 'approved':
          badgeText.textContent = 'KYC: Verified ‚úì';
          warning.style.display = 'none';
          break;
      }
      
    } catch (error) {
      console.error('KYC check error:', error);
      showMessage('Error checking verification status', 'error');
    }
  }

  // ===== SALE FORM UPDATE =====
  async function handleSaleUpdate(event) {
    event.preventDefault();
    
    if (kycStatus !== 'approved') {
      showMessage('KYC verification required', 'error');
      return;
    }
    
    if (!validateSaleForm()) return;
    
    const updateBtn = document.getElementById('updateSaleBtn');
    updateBtn.disabled = true;
    updateBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Updating...';
    
    const progress = document.getElementById('saleUpdateProgress');
    const progressText = document.getElementById('saleProgressText');
    const progressFill = document.getElementById('saleProgressFill');
    
    progress.style.display = 'block';
    progressText.textContent = 'Preparing update...';
    
    try {
      const formData = collectSaleFormData();
      
      progressText.textContent = 'Updating sale listing...';
      progressFill.style.width = '10%';
      
      // Upload new images first
      const newImageUrls = [];
      if (selectedSaleNewImages.length > 0) {
        progressText.textContent = `Uploading ${selectedSaleNewImages.length} new image(s)...`;
        progressFill.style.width = '30%';
        
        for (let i = 0; i < selectedSaleNewImages.length; i++) {
          const file = selectedSaleNewImages[i];
          const fileName = `${propertyId}_${Date.now()}_${i}`;
          const storageRef = firebase.storage().ref().child(`properties/${currentUser.uid}/${propertyId}/${fileName}`);
          
          const snapshot = await storageRef.put(file);
          const downloadURL = await snapshot.ref.getDownloadURL();
          newImageUrls.push(downloadURL);
          
          const progressPercent = 30 + ((i + 1) / selectedSaleNewImages.length) * 40;
          progressFill.style.width = `${progressPercent}%`;
        }
      }
      
      // Combine existing and new images
      const allImageUrls = [...existingSaleImages, ...newImageUrls];
      
      progressText.textContent = 'Finalizing update...';
      progressFill.style.width = '80%';
      
      // Update Firestore document
      await firebase.firestore().collection('properties').doc(propertyId).update({
        ...formData,
        imageUrls: allImageUrls,
        photos: allImageUrls,
        updatedAt: new Date()
      });
      
      progressFill.style.width = '100%';
      progressText.textContent = '‚úÖ Sale property updated successfully!';
      
      showMessage('‚úÖ Sale property updated successfully! Redirecting...', 'success');
      
      setTimeout(() => {
        window.location.href = 'broker_listings.html';
      }, 2000);
      
    } catch (error) {
      console.error('Sale update error:', error);
      showMessage(`Error: ${error.message}`, 'error');
      updateBtn.disabled = false;
      updateBtn.innerHTML = '<i class="bi bi-check-circle"></i> Update Property for Sale';
      progress.style.display = 'none';
    }
  }

  // ===== LEASE FORM UPDATE =====
  async function handleLeaseUpdate(event) {
    event.preventDefault();
    
    if (kycStatus !== 'approved') {
      showMessage('KYC verification required', 'error');
      return;
    }
    
    if (!validateLeaseForm()) return;
    
    const updateBtn = document.getElementById('updateLeaseBtn');
    updateBtn.disabled = true;
    updateBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Updating...';
    
    const progress = document.getElementById('leaseUpdateProgress');
    const progressText = document.getElementById('leaseProgressText');
    const progressFill = document.getElementById('leaseProgressFill');
    
    progress.style.display = 'block';
    progressText.textContent = 'Preparing update...';
    
    try {
      const formData = collectLeaseFormData();
      
      progressText.textContent = 'Updating lease listing...';
      progressFill.style.width = '10%';
      
      // Upload new images first
      const newImageUrls = [];
      if (selectedLeaseNewImages.length > 0) {
        progressText.textContent = `Uploading ${selectedLeaseNewImages.length} new image(s)...`;
        progressFill.style.width = '30%';
        
        for (let i = 0; i < selectedLeaseNewImages.length; i++) {
          const file = selectedLeaseNewImages[i];
          const fileName = `${propertyId}_${Date.now()}_${i}`;
          const storageRef = firebase.storage().ref().child(`properties/${currentUser.uid}/${propertyId}/${fileName}`);
          
          const snapshot = await storageRef.put(file);
          const downloadURL = await snapshot.ref.getDownloadURL();
          newImageUrls.push(downloadURL);
          
          const progressPercent = 30 + ((i + 1) / selectedLeaseNewImages.length) * 40;
          progressFill.style.width = `${progressPercent}%`;
        }
      }
      
      // Combine existing and new images
      const allImageUrls = [...existingLeaseImages, ...newImageUrls];
      
      progressText.textContent = 'Finalizing update...';
      progressFill.style.width = '80%';
      
      // Update Firestore document
      await firebase.firestore().collection('properties').doc(propertyId).update({
        ...formData,
        imageUrls: allImageUrls,
        photos: allImageUrls,
        updatedAt: new Date()
      });
      
      progressFill.style.width = '100%';
      progressText.textContent = '‚úÖ Lease property updated successfully!';
      
      showMessage('‚úÖ Lease property updated successfully! Redirecting...', 'success');
      
      setTimeout(() => {
        window.location.href = 'broker_listings.html';
      }, 2000);
      
    } catch (error) {
      console.error('Lease update error:', error);
      showMessage(`Error: ${error.message}`, 'error');
      updateBtn.disabled = false;
      updateBtn.innerHTML = '<i class="bi bi-check-circle"></i> Update Property for Lease';
      progress.style.display = 'none';
    }
  }

  // ===== FORM VALIDATION =====
  function validateSaleForm() {
    const requiredFields = [
      'saleTitle', 'salePropertyCategory', 'salePropertyType', 'saleBedrooms', 'saleBathrooms',
      'saleFloorArea', 'salePrice', 'saleAddress', 'saleCity', 'saleProvince',
      'commissionType', 'commissionValue', 'saleDescription'
    ];
    
    for (const fieldId of requiredFields) {
      const field = document.getElementById(fieldId);
      if (!field.value.trim()) {
        showMessage(`Please fill in ${field.previousElementSibling.textContent}`, 'error');
        field.focus();
        return false;
      }
    }
    
    if (!document.getElementById('saleLatitude').value) {
      showMessage('Please select location on map', 'error');
      return false;
    }
    
    if (!selectedSaleType) {
      showMessage('Please select a sale type', 'error');
      return false;
    }
    
    // Additional validation for bank financing
    if (selectedSaleType === 'bank_financing') {
      const selectedBanks = document.querySelectorAll('input[name="bankOptions"]:checked');
      const otherBanks = document.getElementById('otherBanks').value.trim();
      
      if (selectedBanks.length === 0 && !otherBanks) {
        showMessage('Please select at least one bank financing option or specify other options', 'error');
        return false;
      }
    }
    
    if (existingSaleImages.length + selectedSaleNewImages.length === 0) {
      showMessage('Please upload at least 1 property image', 'error');
      return false;
    }
    
    if (existingSaleImages.length + selectedSaleNewImages.length > 10) {
      showMessage('Maximum 10 images allowed', 'error');
      return false;
    }
    
    return true;
  }

  function validateLeaseForm() {
    const requiredFields = [
      'leaseTitle', 'leasePropertyCategory', 'leasePropertyType', 'totalArea',
      'leaseDuration', 'annualRent', 'leaseCommissionType', 'leaseCommissionValue',
      'leaseAddress', 'leaseCity', 'leaseProvince', 'leaseDescription'
    ];
    
    for (const fieldId of requiredFields) {
      const field = document.getElementById(fieldId);
      if (!field.value.trim()) {
        showMessage(`Please fill in ${field.previousElementSibling?.textContent || fieldId}`, 'error');
        field.focus();
        return false;
      }
    }
    
    if (!document.getElementById('leaseLatitude').value) {
      showMessage('Please select location on map', 'error');
      return false;
    }
    
    if (!selectedLeaseType) {
      showMessage('Please select a lease type', 'error');
      return false;
    }
    
    if (existingLeaseImages.length + selectedLeaseNewImages.length === 0) {
      showMessage('Please upload at least 1 property image', 'error');
      return false;
    }
    
    if (existingLeaseImages.length + selectedLeaseNewImages.length > 10) {
      showMessage('Maximum 10 images allowed', 'error');
      return false;
    }
    
    return true;
  }

  // ===== FORM DATA COLLECTION =====
  function collectSaleFormData() {
    const amenities = [];
    document.querySelectorAll('input[name="saleAmenities"]:checked').forEach(checkbox => {
      amenities.push(checkbox.value);
    });
    
    const otherAmenities = document.getElementById('saleOtherAmenities').value;
    if (otherAmenities) {
      otherAmenities.split(',').forEach(item => {
        const trimmed = item.trim();
        if (trimmed) amenities.push(trimmed);
      });
    }
    
    const commissionType = document.getElementById('commissionType').value;
    const commissionValue = parseFloat(document.getElementById('commissionValue').value);
    
    // Collect bank financing options if bank_financing is selected
    const financingOptions = [];
    if (selectedSaleType === 'bank_financing') {
      // Get selected banks
      document.querySelectorAll('input[name="bankOptions"]:checked').forEach(checkbox => {
        financingOptions.push(checkbox.value);
      });
      
      // Get other financing options
      const otherBanks = document.getElementById('otherBanks').value;
      if (otherBanks) {
        otherBanks.split(',').forEach(item => {
          const trimmed = item.trim();
          if (trimmed) financingOptions.push(trimmed);
        });
      }
    }
    
    return {
      title: document.getElementById('saleTitle').value,
      propertyCategory: document.getElementById('salePropertyCategory').value,
      propertyType: document.getElementById('salePropertyType').value,
      bedrooms: document.getElementById('saleBedrooms').value,
      bathrooms: document.getElementById('saleBathrooms').value,
      floorArea: parseFloat(document.getElementById('saleFloorArea').value),
      lotArea: document.getElementById('saleLotArea').value ? 
        parseFloat(document.getElementById('saleLotArea').value) : null,
      furnishing: document.getElementById('saleFurnishing').value || null,
      yearBuilt: document.getElementById('saleYearBuilt').value ? 
        parseInt(document.getElementById('saleYearBuilt').value) : null,
      salePrice: parseFloat(document.getElementById('salePrice').value),
      priceNegotiable: document.getElementById('priceNegotiable').value,
      saleType: document.getElementById('saleTypeInput').value,
      financingOptions: selectedSaleType === 'bank_financing' ? financingOptions : [],
      commissionType: commissionType,
      commissionValue: commissionValue,
      address: document.getElementById('saleAddress').value,
      location: document.getElementById('saleAddress').value,
      city: document.getElementById('saleCity').value,
      province: document.getElementById('saleProvince').value,
      latitude: parseFloat(document.getElementById('saleLatitude').value),
      longitude: parseFloat(document.getElementById('saleLongitude').value),
      amenities: amenities,
      description: document.getElementById('saleDescription').value,
      type: 'sale',
      listingType: 'sale',
      updatedAt: new Date()
    };
  }

  function collectLeaseFormData() {
    const amenities = [];
    document.querySelectorAll('input[name="leaseAmenities"]:checked').forEach(checkbox => {
      amenities.push(checkbox.value);
    });
    
    const otherFeatures = document.getElementById('otherFeatures').value;
    if (otherFeatures) {
      otherFeatures.split(',').forEach(item => {
        const trimmed = item.trim();
        if (trimmed) amenities.push(trimmed);
      });
    }
    
    const utilities = document.getElementById('utilities').value;
    if (utilities) {
      utilities.split(',').forEach(item => {
        const trimmed = item.trim();
        if (trimmed) amenities.push(trimmed);
      });
    }
    
    const commissionType = document.getElementById('leaseCommissionType').value;
    const commissionValue = parseFloat(document.getElementById('leaseCommissionValue').value);
    
    return {
      title: document.getElementById('leaseTitle').value,
      propertyCategory: document.getElementById('leasePropertyCategory').value,
      propertyType: document.getElementById('leasePropertyType').value,
      totalArea: parseFloat(document.getElementById('totalArea').value),
      usableArea: document.getElementById('usableArea').value ? 
        parseFloat(document.getElementById('usableArea').value) : null,
      zoning: document.getElementById('zoning').value || null,
      leaseType: document.getElementById('leaseTypeInput').value,
      leaseDuration: parseInt(document.getElementById('leaseDuration').value),
      renewalOption: document.getElementById('renewalOption').value || null,
      annualRent: parseFloat(document.getElementById('annualRent').value),
      paymentTerms: document.getElementById('paymentTerms').value || null,
      securityBond: document.getElementById('securityBond').value ? 
        parseFloat(document.getElementById('securityBond').value) : null,
      advancePayment: document.getElementById('advancePayment').value ? 
        parseInt(document.getElementById('advancePayment').value) : 1,
      commissionType: commissionType,
      commissionValue: commissionValue,
      address: document.getElementById('leaseAddress').value,
      location: document.getElementById('leaseAddress').value,
      city: document.getElementById('leaseCity').value,
      province: document.getElementById('leaseProvince').value,
      latitude: parseFloat(document.getElementById('leaseLatitude').value),
      longitude: parseFloat(document.getElementById('leaseLongitude').value),
      frontage: document.getElementById('frontage').value ? 
        parseFloat(document.getElementById('frontage').value) : null,
      topography: document.getElementById('topography').value || null,
      accessRoad: document.getElementById('accessRoad').value || null,
      restrictions: document.getElementById('restrictions').value || null,
      maintenance: document.getElementById('maintenance').value || null,
      amenities: amenities,
      description: document.getElementById('leaseDescription').value,
      type: 'lease',
      listingType: 'lease',
      updatedAt: new Date()
    };
  }

  // ===== UTILITY FUNCTIONS =====
  function showMessage(text, type) {
    const box = document.getElementById('messageBox');
    box.textContent = text;
    box.className = `message ${type}`;
    box.style.display = 'block';
    
    setTimeout(() => {
      box.style.display = 'none';
    }, 5000);
  }

  function showLoading(show) {
    const overlay = document.getElementById('loadingOverlay');
    overlay.style.display = show ? 'flex' : 'none';
  }
</script>
</body>
</html>