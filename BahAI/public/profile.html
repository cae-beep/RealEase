<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Profile - BahAI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      color: #333;
    }
    header {
      background: #2c3e50;
      padding: 15px 30px;
      color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      font-size: 1.5rem;
      font-weight: bold;
      color: white;
      text-decoration: none;
    }
    .back-link {
      color: white;
      text-decoration: none;
      padding: 8px 15px;
      border-radius: 6px;
      transition: background 0.3s;
    }
    .back-link:hover {
      background: #34495e;
    }
    .container {
      max-width: 1000px;
      margin: 30px auto;
      padding: 0 20px;
    }
    .profile-header {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      gap: 25px;
    }
    .profile-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      color: white;
      font-weight: bold;
      flex-shrink: 0;
    }
    .profile-info h1 {
      margin-bottom: 8px;
      color: #2c3e50;
    }
    .profile-info p {
      color: #7f8c8d;
      margin: 4px 0;
    }
    .role-badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-top: 8px;
      text-transform: capitalize;
    }
    .role-broker { background: #e3f2fd; color: #1976d2; }
    .role-agent { background: #f3e5f5; color: #7b1fa2; }
    .role-seller { background: #e8f5e9; color: #388e3c; }
    .role-landlord { background: #fff3e0; color: #f57c00; }
    
    .content-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 25px;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .card.full-width {
      grid-column: 1 / -1;
    }
    .card h2 {
      color: #2c3e50;
      margin-bottom: 20px;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .card h2 i {
      font-size: 1.4rem;
      color: #667eea;
    }
    
    .kyc-status {
      text-align: center;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    .kyc-status.not_submitted {
      background: #fff3cd;
      border: 2px solid #ffc107;
    }
    .kyc-status.pending {
      background: #cff4fc;
      border: 2px solid #0dcaf0;
    }
    .kyc-status.approved {
      background: #d1e7dd;
      border: 2px solid #198754;
    }
    .kyc-status.rejected {
      background: #f8d7da;
      border: 2px solid #dc3545;
    }
    .kyc-status h3 {
      margin-bottom: 10px;
      font-size: 1.2rem;
    }
    .kyc-status p {
      margin: 8px 0;
      line-height: 1.6;
    }
    
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #ecf0f1;
    }
    .info-row:last-child {
      border-bottom: none;
    }
    .info-label {
      font-weight: 600;
      color: #7f8c8d;
    }
    .info-value {
      color: #2c3e50;
      text-align: right;
    }
    
    .btn {
      display: inline-block;
      padding: 12px 24px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s;
      border: none;
      cursor: pointer;
      font-size: 1rem;
    }
    .btn-primary {
      background: #667eea;
      color: white;
    }
    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .btn-secondary {
      background: #95a5a6;
      color: white;
    }
    .btn-secondary:hover {
      background: #7f8c8d;
    }
    .btn-danger {
      background: #e74c3c;
      color: white;
    }
    .btn-danger:hover {
      background: #c0392b;
    }
    .btn-warning {
      background: #f39c12;
      color: white;
    }
    .btn-warning:hover {
      background: #e67e22;
    }
    .btn-block {
      width: 100%;
      text-align: center;
      margin-top: 15px;
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 15px;
    }
    .stat-box {
      text-align: center;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
    }
    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      color: #667eea;
    }
    .stat-label {
      color: #7f8c8d;
      font-size: 0.9rem;
      margin-top: 5px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #2c3e50;
    }
    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
    }
    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .message {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
      font-weight: 600;
    }
    .message.success {
      background: #d1e7dd;
      color: #0f5132;
    }
    .message.error {
      background: #f8d7da;
      color: #842029;
    }
    
    .hidden {
      display: none;
    }
    
    @media (max-width: 768px) {
      .content-grid {
        grid-template-columns: 1fr;
      }
      .profile-header {
        flex-direction: column;
        text-align: center;
      }
      .stats-grid {
        grid-template-columns: 1fr;
      }
      .action-buttons {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <a href="index.html" class="logo">BahAI</a>
      <a href="#" id="backToDashboard" class="back-link">
        <i class="bi bi-arrow-left"></i> Back to Dashboard
      </a>
    </div>
  </header>

  <div class="container">
    <div id="messageBox" class="message hidden"></div>

    <!-- Profile Header -->
    <div class="profile-header">
      <div class="profile-avatar" id="avatar">?</div>
      <div class="profile-info">
        <h1 id="userName">Loading...</h1>
        <p><i class="bi bi-envelope"></i> <span id="userEmail">-</span></p>
        <p><i class="bi bi-telephone"></i> <span id="userPhone">-</span></p>
        <span class="role-badge" id="userRole">-</span>
      </div>
    </div>

    <div class="content-grid">
      <!-- KYC Status Card -->
      <div class="card">
        <h2><i class="bi bi-shield-check"></i> KYC Verification Status</h2>
        <div class="kyc-status" id="kycStatusCard">
          <h3 id="kycStatusTitle">Loading...</h3>
          <p id="kycStatusMessage">-</p>
        </div>
        <a href="kyc.html" class="btn btn-primary btn-block" id="kycBtn">
          Manage KYC Documents
        </a>
      </div>

      <!-- Account Stats -->
      <div class="card">
        <h2><i class="bi bi-bar-chart"></i> My Statistics</h2>
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-number" id="totalProperties">0</div>
            <div class="stat-label">Properties Posted</div>
          </div>
          <div class="stat-box">
            <div class="stat-number" id="memberSince">-</div>
            <div class="stat-label">Member Since</div>
          </div>
        </div>
      </div>

      <!-- Account Information -->
      <div class="card full-width">
        <h2><i class="bi bi-person-circle"></i> Account Information</h2>
        <div class="info-row">
          <span class="info-label">Full Name</span>
          <span class="info-value" id="infoName">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">Email Address</span>
          <span class="info-value" id="infoEmail">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">Phone Number</span>
          <span class="info-value" id="infoPhone">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">Account Role</span>
          <span class="info-value" id="infoRole">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">Account Created</span>
          <span class="info-value" id="infoCreated">-</span>
        </div>
        <div class="info-row" id="prcRow" style="display: none;">
          <span class="info-label">PRC License Number</span>
          <span class="info-value" id="infoPRC">-</span>
        </div>
        
        <div class="action-buttons">
          <button class="btn btn-secondary" onclick="toggleEditMode()">
            <i class="bi bi-pencil"></i> Edit Profile
          </button>
          <button class="btn btn-warning" onclick="changePassword()">
            <i class="bi bi-key"></i> Change Password
          </button>
        </div>
      </div>

      <!-- Edit Profile Form (Hidden by default) -->
      <div class="card full-width hidden" id="editProfileCard">
        <h2><i class="bi bi-pencil-square"></i> Edit Profile</h2>
        <form id="editProfileForm">
          <div class="form-group">
            <label for="editName">Full Name</label>
            <input type="text" id="editName" required>
          </div>
          <div class="form-group">
            <label for="editPhone">Phone Number</label>
            <input type="tel" id="editPhone" required>
          </div>
          <div class="action-buttons">
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-check-circle"></i> Save Changes
            </button>
            <button type="button" class="btn btn-secondary" onclick="toggleEditMode()">
              <i class="bi bi-x-circle"></i> Cancel
            </button>
          </div>
        </form>
      </div>

      <!-- Danger Zone -->
      <div class="card full-width">
        <h2 style="color: #e74c3c;"><i class="bi bi-exclamation-triangle"></i> Danger Zone</h2>
        <p style="color: #7f8c8d; margin-bottom: 15px;">
          Once you delete your account, there is no going back. Please be certain.
        </p>
        <button class="btn btn-danger" onclick="deleteAccount()">
          <i class="bi bi-trash"></i> Delete My Account
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, db } from './firebase-common.js';
    import { onAuthStateChanged, signOut, updatePassword, deleteUser, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { doc, getDoc, updateDoc, collection, query, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    let currentUser = null;
    let userData = null;

    // Load user profile
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      currentUser = user;
      await loadUserProfile();
    });

    async function loadUserProfile() {
      try {
        const userDoc = await getDoc(doc(db, "users", currentUser.uid));
        
        if (!userDoc.exists()) {
          showMessage("User profile not found.", "error");
          return;
        }

        userData = userDoc.data();

        // Update UI
        const name = userData.fullName || "User";
        document.getElementById("avatar").textContent = name.charAt(0).toUpperCase();
        document.getElementById("userName").textContent = name;
        document.getElementById("userEmail").textContent = userData.email || currentUser.email;
        document.getElementById("userPhone").textContent = userData.phone || "Not provided";
        
        const role = userData.role || "user";
        const roleBadge = document.getElementById("userRole");
        roleBadge.textContent = role.charAt(0).toUpperCase() + role.slice(1);
        roleBadge.className = `role-badge role-${role}`;

        // Account info
        document.getElementById("infoName").textContent = name;
        document.getElementById("infoEmail").textContent = userData.email || currentUser.email;
        document.getElementById("infoPhone").textContent = userData.phone || "Not provided";
        document.getElementById("infoRole").textContent = role.charAt(0).toUpperCase() + role.slice(1);
        
        const createdDate = userData.createdAt?.toDate ? userData.createdAt.toDate() : new Date();
        document.getElementById("infoCreated").textContent = createdDate.toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric" });
        document.getElementById("memberSince").textContent = createdDate.getFullYear();

        // Show PRC for brokers
        if (role === "broker" && userData.prcLicenseNumber) {
          document.getElementById("prcRow").style.display = "flex";
          document.getElementById("infoPRC").textContent = userData.prcLicenseNumber;
        }

        // KYC Status
        updateKYCStatus(userData.kycStatus || "not_submitted");

        // Count properties
        const propertiesQuery = query(collection(db, "properties"), where("userId", "==", currentUser.uid));
        const propertiesSnapshot = await getDocs(propertiesQuery);
        document.getElementById("totalProperties").textContent = propertiesSnapshot.size;

        // Set back to dashboard link
        const dashboardMap = {
          broker: 'broker_dashboard.html',
          agent: 'agent_dashboard.html',
          seller: 'seller/seller_dashboard.html',
          landlord: 'landlord/landlord_dashboard.html'
        };
        document.getElementById("backToDashboard").href = dashboardMap[role] || 'index.html';

      } catch (error) {
        console.error("Error loading profile:", error);
        showMessage("Error loading profile data.", "error");
      }
    }

    function updateKYCStatus(status) {
      const statusCard = document.getElementById("kycStatusCard");
      const statusTitle = document.getElementById("kycStatusTitle");
      const statusMessage = document.getElementById("kycStatusMessage");
      
      statusCard.className = `kyc-status ${status}`;
      
      switch(status) {
        case "not_submitted":
          statusTitle.innerHTML = "⏺️ Not Submitted";
          statusMessage.textContent = "You haven't submitted your KYC documents yet. Complete verification to post properties.";
          break;
        case "pending":
          statusTitle.innerHTML = "⏳ Pending Review";
          statusMessage.textContent = "Your KYC documents are under review. We'll notify you once approved.";
          break;
        case "approved":
          statusTitle.innerHTML = "✅ Verified";
          statusMessage.textContent = "Your account is verified! You can post properties without restrictions.";
          document.getElementById("kycBtn").textContent = "View KYC Documents";
          break;
        case "rejected":
          statusTitle.innerHTML = "❌ Rejected";
          statusMessage.textContent = "Your KYC was rejected. Please resubmit valid documents.";
          break;
      }
    }

    // Toggle edit mode
    window.toggleEditMode = function() {
      const editCard = document.getElementById("editProfileCard");
      editCard.classList.toggle("hidden");
      
      if (!editCard.classList.contains("hidden")) {
        document.getElementById("editName").value = userData.fullName || "";
        document.getElementById("editPhone").value = userData.phone || "";
      }
    }

    // Edit profile form submission
    document.getElementById("editProfileForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const newName = document.getElementById("editName").value.trim();
      const newPhone = document.getElementById("editPhone").value.trim();

      try {
        await updateDoc(doc(db, "users", currentUser.uid), {
          fullName: newName,
          phone: newPhone
        });

        showMessage("✅ Profile updated successfully!", "success");
        await loadUserProfile();
        toggleEditMode();

      } catch (error) {
        console.error("Error updating profile:", error);
        showMessage("❌ Failed to update profile.", "error");
      }
    });

    // Change password
    window.changePassword = async function() {
      const currentPassword = prompt("Enter your current password:");
      if (!currentPassword) return;

      const newPassword = prompt("Enter your new password (min 8 characters):");
      if (!newPassword || newPassword.length < 8) {
        alert("Password must be at least 8 characters long.");
        return;
      }

      const confirmPassword = prompt("Confirm your new password:");
      if (newPassword !== confirmPassword) {
        alert("Passwords do not match.");
        return;
      }

      try {
        // Reauthenticate user
        const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
        await reauthenticateWithCredential(currentUser, credential);

        // Update password
        await updatePassword(currentUser, newPassword);
        
        showMessage("✅ Password changed successfully!", "success");
      } catch (error) {
        console.error("Error changing password:", error);
        if (error.code === "auth/wrong-password") {
          alert("Current password is incorrect.");
        } else {
          alert("Failed to change password: " + error.message);
        }
      }
    }

    // Delete account
    window.deleteAccount = async function() {
      const confirmed = confirm("⚠️ Are you sure you want to delete your account? This action cannot be undone!");
      if (!confirmed) return;

      const password = prompt("Enter your password to confirm deletion:");
      if (!password) return;

      try {
        // Reauthenticate
        const credential = EmailAuthProvider.credential(currentUser.email, password);
        await reauthenticateWithCredential(currentUser, credential);

        // Delete user properties
        const propertiesQuery = query(collection(db, "properties"), where("userId", "==", currentUser.uid));
        const propertiesSnapshot = await getDocs(propertiesQuery);
        for (const propertyDoc of propertiesSnapshot.docs) {
          await deleteDoc(propertyDoc.ref);
        }

        // Delete user document
        await deleteDoc(doc(db, "users", currentUser.uid));

        // Delete auth account
        await deleteUser(currentUser);

        alert("Your account has been deleted.");
        window.location.href = "login.html";

      } catch (error) {
        console.error("Error deleting account:", error);
        if (error.code === "auth/wrong-password") {
          alert("Incorrect password.");
        } else {
          alert("Failed to delete account: " + error.message);
        }
      }
    }

    function showMessage(text, type) {
      const messageBox = document.getElementById("messageBox");
      messageBox.textContent = text;
      messageBox.className = `message ${type}`;
      messageBox.classList.remove("hidden");
      
      setTimeout(() => {
        messageBox.classList.add("hidden");
      }, 5000);
    }
  </script>
</body>
</html>