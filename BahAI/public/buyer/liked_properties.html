<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Liked Properties - BahAI Real Estate</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0b2e52;
            --primary-dark: #001F3F;
            --primary-light: #002f3f;
            --secondary: #1976d2;
            --accent: #ff9800;
            --text-dark: #1a202c;
            --text-light: #718096;
            --bg-light: #f8fafc;
            --bg-white: #ffffff;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --rent-color: #10b981;
            --sale-color: #3b82f6;
            --lease-color: #8e44ad;
            --danger: #ef4444;
            --success: #10b981;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', Arial, sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: var(--text-dark);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        /* Header Styles */
        .liked-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 30px;
            background: var(--bg-white);
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
        }

        .liked-header-content h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .liked-header-content p {
            color: var(--text-light);
            font-size: 16px;
        }

        .recommendation-note {
            background: linear-gradient(135deg, #e8f4fc, #d4e7fa);
            padding: 20px;
            border-radius: 16px;
            border-left: 5px solid var(--secondary);
            max-width: 400px;
            box-shadow: var(--shadow);
        }

        .recommendation-note strong {
            color: var(--primary);
            display: block;
            margin-bottom: 8px;
            font-size: 16px;
        }

        /* Stats Section */
        .liked-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-white);
            padding: 25px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-light);
            font-weight: 500;
        }

        /* Listings Grid */
        .listings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .listing-card {
            background: var(--bg-white);
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            cursor: pointer;
        }

        .listing-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .listing-image-container {
            position: relative;
            height: 220px;
            overflow: hidden;
        }

        .listing-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .listing-card:hover .listing-image {
            transform: scale(1.05);
        }

        .listing-type-badge {
            position: absolute;
            top: 15px;
            left: 15px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: white;
            z-index: 2;
        }

        .type-rent { background: var(--rent-color); }
        .type-sale { background: var(--sale-color); }
        .type-lease { background: var(--lease-color); }

        .remove-saved-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--danger);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            z-index: 2;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .remove-saved-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .listing-content {
            padding: 20px;
        }

        .listing-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .listing-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 5px;
            line-height: 1.3;
        }

        .listing-price {
            font-size: 20px;
            font-weight: 700;
            white-space: nowrap;
        }

        .price-rent { color: var(--rent-color); }
        .price-sale { color: var(--sale-color); }
        .price-lease { color: var(--lease-color); }

        .listing-location {
            color: var(--text-light);
            font-size: 14px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .listing-details {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .detail {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: var(--text-light);
        }

        .listing-broker {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 12px;
            background: var(--bg-light);
            border-radius: 10px;
        }

        .broker-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }

        .broker-info {
            flex: 1;
            min-width: 0;
        }

        .broker-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .broker-role {
            font-size: 12px;
            color: var(--text-light);
        }

        .listing-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
        }

        .contact-btn {
            background: var(--secondary);
            color: white;
        }

        .contact-btn:hover {
            background: #1565c0;
            transform: translateY(-1px);
        }

        .view-btn {
            background: var(--bg-light);
            color: var(--text-dark);
            border: 1px solid var(--border);
        }

        .view-btn:hover {
            background: var(--border);
            transform: translateY(-1px);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            background: var(--bg-white);
            border-radius: 20px;
            box-shadow: var(--shadow);
            grid-column: 1 / -1;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h2 {
            font-size: 24px;
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        .empty-state p {
            color: var(--text-light);
            margin-bottom: 25px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .browse-btn {
            display: inline-block;
            padding: 14px 28px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            text-decoration: none;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 15px;
        }

        .browse-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Loading State */
        .loading-state {
            text-align: center;
            padding: 60px 20px;
            grid-column: 1 / -1;
        }

        .spinner {
            border: 4px solid var(--bg-light);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Similar Properties Section */
        .similar-properties {
            background: var(--bg-white);
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            padding: 20px;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-white);
            border-radius: 20px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 30px 40px;
            border-bottom: 1px solid var(--border);
            position: relative;
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            color: white;
        }

        .modal-title-section h2 {
            font-size: 24px;
            margin-bottom: 10px;
            color: white;
            line-height: 1.3;
        }

        .modal-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .modal-price-section {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .modal-price {
            font-size: 32px;
            font-weight: 700;
            color: white;
        }

        .modal-status {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .modal-body {
            padding: 30px 40px;
        }

        .modal-image-gallery {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .main-modal-image {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: 12px;
            cursor: pointer;
        }

        .modal-thumbnails {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .modal-thumbnail {
            width: 100%;
            height: 90px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .modal-thumbnail:hover,
        .modal-thumbnail.active {
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .modal-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .modal-section {
            margin-bottom: 25px;
        }

        .modal-section h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .detail-label {
            color: var(--text-light);
            font-size: 14px;
        }

        .detail-value {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 14px;
        }

        .amenities-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .amenity-tag {
            background: var(--bg-light);
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 13px;
            color: var(--text-dark);
            border: 1px solid var(--border);
        }

        .modal-description {
            background: var(--bg-light);
            padding: 20px;
            border-radius: 12px;
            line-height: 1.6;
            margin-bottom: 25px;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            padding-top: 25px;
            border-top: 1px solid var(--border);
        }

        .modal-action-btn {
            flex: 1;
            padding: 14px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .modal-contact-btn {
            background: var(--secondary);
            color: white;
        }

        .modal-contact-btn:hover {
            background: #1565c0;
            transform: translateY(-2px);
        }

        .modal-close-btn {
            background: var(--bg-light);
            color: var(--text-dark);
            border: 1px solid var(--border);
        }

        .modal-close-btn:hover {
            background: var(--border);
            transform: translateY(-2px);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            box-shadow: var(--shadow-lg);
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .listings-grid {
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .liked-header {
                flex-direction: column;
                gap: 20px;
                padding: 25px;
            }
            
            .listings-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .liked-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .recommendation-note {
                max-width: 100%;
            }
            
            .modal-content {
                max-width: 95%;
                margin: 10px;
            }
            
            .modal-header {
                padding: 20px;
            }
            
            .modal-body {
                padding: 20px;
            }
            
            .modal-image-gallery {
                grid-template-columns: 1fr;
            }
            
            .modal-thumbnails {
                flex-direction: row;
                overflow-x: auto;
                padding-bottom: 10px;
            }
            
            .modal-thumbnail {
                width: 100px;
                height: 70px;
                flex-shrink: 0;
            }
            
            .modal-details-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .modal-actions {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .liked-header {
                padding: 20px;
            }
            
            .liked-header-content h1 {
                font-size: 28px;
            }
            
            .liked-stats {
                grid-template-columns: 1fr;
            }
            
            .listing-actions {
                flex-direction: column;
            }
            
            .listing-content {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header Section -->
        <div class="liked-header">
            <div class="liked-header-content">
                <h1>‚ù§Ô∏è Your Liked Properties</h1>
                <p>Properties you've saved for later viewing</p>
            </div>
            <div class="recommendation-note">
                <strong>ü§ñ AI Insight:</strong> The more properties you like, 
                the better our recommendations become!
            </div>
        </div>

        <!-- Stats Section -->
        <div class="liked-stats">
            <div class="stat-card">
                <div class="stat-value" id="totalSaved">0</div>
                <div class="stat-label">Total Saved Properties</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="activeListings">0</div>
                <div class="stat-label">Currently Active</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="averagePrice">‚Ç±0</div>
                <div class="stat-label">Average Price</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="savedThisMonth">0</div>
                <div class="stat-label">Saved This Month</div>
            </div>
        </div>

        <!-- Saved Properties Grid -->
        <div class="listings-grid" id="likedPropertiesContainer">
            <div class="loading-state">
                <div class="spinner"></div>
                <p>Loading your liked properties...</p>
            </div>
        </div>

        <!-- Similar Properties Section -->
        <div class="similar-properties" id="similarSuggestions" style="display: none;">
            <h2 class="section-title">üîç Similar Properties You Might Like</h2>
            <div class="listings-grid" id="similarPropertiesContainer">
                <!-- Similar properties will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Modal for Property Details -->
    <div class="modal-overlay" id="propertyModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title-section">
                    <h2 id="modalTitle">Property Details</h2>
                    <div class="modal-subtitle">
                        <span>üìç</span>
                        <span id="modalLocation">Loading location...</span>
                    </div>
                </div>
                <div class="modal-price-section">
                    <div class="modal-price" id="modalPrice">‚Ç±0</div>
                    <div class="modal-status" id="modalStatus">Active</div>
                </div>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            
            <div class="modal-body" id="modalBody">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            signOut 
        } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import {
            getFirestore,
            collection,
            query,
            where,
            getDocs,
            getDoc,
            doc,
            deleteDoc,
            orderBy
        } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        // Firebase Configuration (same as your dashboard)
        const firebaseConfig = {
            apiKey: "AIzaSyCIfzneDzWVveG8p_0mywoA9D9F5AyzZX4",
            authDomain: "bahai-1b76d.firebaseapp.com",
            projectId: "bahai-1b76d",
            storageBucket: "bahai-1b76d.firebasestorage.app",
            messagingSenderId: "646878644941",
            appId: "1:646878644941:web:5b4ccc3412250337587784"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables
        let userSavedProperties = [];
        let userMap = new Map();
        let allProperties = [];
        let currentModalProperty = null;

        // Helper functions for listing types (same as dashboard)
        function getListingType(listing) {
            if (listing.listingType === 'lease' || listing.type === 'lease') return 'lease';
            if (listing.listingType === 'rent' || listing.type === 'rent') return 'rent';
            if (listing.listingType === 'sale' || listing.type === 'sale') return 'sale';
            if (listing.monthlyRent !== undefined && listing.monthlyRent !== null && listing.monthlyRent > 0) return 'rent';
            if (listing.annualRent !== undefined && listing.annualRent !== null && listing.annualRent > 0) return 'lease';
            if ((listing.pricing !== undefined && listing.pricing !== null && listing.pricing > 0) ||
                (listing.salePrice !== undefined && listing.salePrice !== null && listing.salePrice > 0)) return 'sale';
            return 'sale';
        }

        function getDisplayPrice(listing) {
            const type = getListingType(listing);
            switch (type) {
                case 'rent': return `‚Ç±${(listing.monthlyRent || 0).toLocaleString()}/month`;
                case 'lease': return `‚Ç±${(listing.annualRent || 0).toLocaleString()}/year`;
                case 'sale': default: return `‚Ç±${(listing.pricing || listing.salePrice || 0).toLocaleString()}`;
            }
        }

        function getPriceClass(listing) {
            const type = getListingType(listing);
            switch (type) {
                case 'rent': return 'price-rent';
                case 'lease': return 'price-lease';
                case 'sale': default: return 'price-sale';
            }
        }

        function getTypeBadgeClass(listing) {
            const type = getListingType(listing);
            switch (type) {
                case 'rent': return 'type-rent';
                case 'lease': return 'type-lease';
                case 'sale': default: return 'type-sale';
            }
        }

        function getTypeBadgeText(listing) {
            const type = getListingType(listing);
            switch (type) {
                case 'rent': return 'FOR RENT';
                case 'lease': return 'FOR LEASE';
                case 'sale': default: return 'FOR SALE';
            }
        }

        // Authentication check
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "login.html";
                return;
            }
            
            console.log('User authenticated:', user.uid);
            await loadLikedProperties(user.uid);
        });

        // Main function to load liked properties - FIXED VERSION
        async function loadLikedProperties(userId) {
            const container = document.getElementById('likedPropertiesContainer');
            
            try {
                console.log('Loading saved properties for user:', userId);
                
                // Try the ordered query first
                let savedQuery;
                try {
                    savedQuery = query(
                        collection(db, "savedProperties"),
                        where("userId", "==", userId),
                        orderBy("savedAt", "desc")
                    );
                } catch (indexError) {
                    console.log('Index not ready, using unordered query:', indexError);
                    // Fallback to unordered query
                    savedQuery = query(
                        collection(db, "savedProperties"),
                        where("userId", "==", userId)
                    );
                }
                
                const savedSnapshot = await getDocs(savedQuery);
                
                if (savedSnapshot.empty) {
                    showEmptyState();
                    updateStats([]);
                    return;
                }
                
                // DEBUG: Check what we got from Firestore
                console.log('Saved docs found:', savedSnapshot.docs.length);
                savedSnapshot.forEach((doc, index) => {
                    console.log(`Doc ${index}:`, doc.id, doc.data());
                });
                
                const propertyPromises = [];
                const savedDocsMap = new Map();
                
                savedSnapshot.forEach((savedDoc) => {
                    const savedData = savedDoc.data();
                    console.log('Processing saved data:', savedData);
                    
                    // FIX: Check if propertyId exists before adding to promises
                    if (savedData.propertyId) {
                        savedDocsMap.set(savedData.propertyId, savedDoc.id);
                        
                        propertyPromises.push(
                            getDoc(doc(db, "properties", savedData.propertyId))
                                .then(propertyDoc => {
                                    if (propertyDoc.exists()) {
                                        return {
                                            property: {
                                                id: propertyDoc.id,
                                                savedId: savedDoc.id,
                                                ...propertyDoc.data()
                                            },
                                            savedAt: savedData.savedAt
                                        };
                                    } else {
                                        console.warn(`Property ${savedData.propertyId} not found`);
                                        return null;
                                    }
                                })
                                .catch(error => {
                                    console.error(`Error fetching property ${savedData.propertyId}:`, error);
                                    return null;
                                })
                        );
                    } else {
                        console.warn('Saved document missing propertyId:', savedDoc.id);
                    }
                });
                
                console.log('Property promises created:', propertyPromises.length);
                
                // FIX: Check if we have any promises to wait for
                if (propertyPromises.length === 0) {
                    console.log('No valid property promises to process');
                    showEmptyState();
                    updateStats([]);
                    return;
                }
                
                // Wait for all property fetches WITH ERROR HANDLING
                let propertyResults;
                try {
                    propertyResults = await Promise.all(propertyPromises);
                    console.log('Property results received:', propertyResults);
                } catch (error) {
                    console.error('Error in Promise.all:', error);
                    propertyResults = [];
                }
                
                // FIX: Safely filter and map the results
                if (!propertyResults || !Array.isArray(propertyResults)) {
                    console.error('propertyResults is not an array:', propertyResults);
                    propertyResults = [];
                }
                
                // Filter out null results (deleted properties or failed fetches)
                userSavedProperties = propertyResults
                    .filter(result => result !== null && result.property !== null)
                    .map(result => result.property);
                
                console.log(`Found ${userSavedProperties.length} liked properties`);
                
                // If we used unordered query, sort manually
                if (!savedQuery._query || !savedQuery._query.orderBy || savedQuery._query.orderBy.length === 0) {
                    userSavedProperties.sort((a, b) => {
                        const dateA = a.savedAt?.toDate ? a.savedAt.toDate() : new Date(a.savedAt);
                        const dateB = b.savedAt?.toDate ? b.savedAt.toDate() : new Date(b.savedAt);
                        return dateB - dateA; // Descending order
                    });
                }
                
                // Load user data for brokers/owners
                if (userSavedProperties.length > 0) {
                    const userIds = new Set(userSavedProperties.map(p => p.userId));
                    for (const userId of userIds) {
                        await loadUserData(userId);
                    }
                    
                    // Display properties
                    displayLikedProperties(userSavedProperties);
                    updateStats(userSavedProperties);
                    
                    // Load similar properties
                    await loadSimilarProperties(userSavedProperties);
                } else {
                    showEmptyState();
                    updateStats([]);
                }
                
            } catch (error) {
                console.error("Error loading liked properties:", error);
                
                // Show user-friendly error message
                if (error.message && error.message.includes("requires an index")) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">‚öôÔ∏è</div>
                            <h2>Database Index Required</h2>
                            <p>Please create a Firestore index for your saved properties.</p>
                            <p style="font-size: 12px; background: rgba(0,0,0,0.1); padding: 10px; border-radius: 8px; margin: 15px 0;">
                                <strong>Quick fix:</strong><br>
                                1. Go to Firebase Console<br>
                                2. Click the Firestore Database<br>
                                3. Go to Indexes tab<br>
                                4. Create composite index for "savedProperties" collection<br>
                                Fields: userId (Asc), savedAt (Desc)
                            </p>
                            <button class="browse-btn" onclick="window.location.href='buyer_dashboard.html'">
                                ‚Üê Return to Dashboard
                            </button>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">‚ö†Ô∏è</div>
                            <h2>Error Loading Properties</h2>
                            <p>There was an error loading your liked properties. Please try again.</p>
                            <pre style="text-align: left; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; font-size: 12px; max-width: 100%; overflow: auto;">
${error.stack || error.message}
                            </pre>
                            <button class="browse-btn" onclick="window.location.reload()">üîÑ Retry</button>
                        </div>
                    `;
                }
            }
        }

        // Load user data (broker/owner info)
        async function loadUserData(userId) {
            if (userMap.has(userId)) return;
            
            try {
                const userDoc = await getDoc(doc(db, "users", userId));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    userMap.set(userId, {
                        displayName: userData.fullName || userData.email?.split('@')[0] || `User ${userId.substring(0, 8)}`,
                        email: userData.email || 'Email not available',
                        phone: userData.phone || 'Phone not available',
                        role: userData.role || 'user'
                    });
                    return;
                }
                
                // Try brokers collection as fallback
                const brokerDoc = await getDoc(doc(db, "brokers", userId));
                if (brokerDoc.exists()) {
                    const brokerData = brokerDoc.data();
                    userMap.set(userId, {
                        displayName: brokerData.fullName || `Broker ${userId.substring(0, 8)}`,
                        email: brokerData.email || 'Email not available',
                        phone: brokerData.phone || 'Phone not available',
                        role: 'broker'
                    });
                    return;
                }
                
                // Default fallback
                userMap.set(userId, {
                    displayName: `User ${userId.substring(0, 8)}`,
                    email: 'Email not available',
                    phone: 'Phone not available',
                    role: 'user'
                });
                
            } catch (error) {
                console.error(`Error loading user ${userId}:`, error);
                userMap.set(userId, {
                    displayName: `User ${userId.substring(0, 8)}`,
                    email: 'Email not available',
                    phone: 'Phone not available',
                    role: 'user'
                });
            }
        }

        // Display liked properties
        function displayLikedProperties(properties) {
            const container = document.getElementById('likedPropertiesContainer');
            
            if (!properties || properties.length === 0) {
                showEmptyState();
                return;
            }
            
            container.innerHTML = properties.map(property => {
                const userInfo = userMap.get(property.userId) || {
                    displayName: `User ${property.userId ? property.userId.substring(0, 8) : 'Unknown'}`,
                    email: 'N/A',
                    phone: 'N/A',
                    role: 'user'
                };
                
                const userInitials = userInfo.displayName.split(' ').map(n => n[0]).join('').toUpperCase() || 'UU';
                const listingType = getListingType(property);
                const displayPrice = getDisplayPrice(property);
                const priceClass = getPriceClass(property);
                const typeBadgeClass = getTypeBadgeClass(property);
                const typeBadgeText = getTypeBadgeText(property);
                
                // Get main photo
                let mainPhoto;
                if (property.photos && property.photos.length > 0) {
                    mainPhoto = property.photos[0];
                } else if (property.imageUrls && property.imageUrls.length > 0) {
                    mainPhoto = property.imageUrls[0];
                } else {
                    mainPhoto = 'https://via.placeholder.com/400x220/0b2e52/white?text=No+Image';
                }
                
                const bedrooms = property.bedrooms || (listingType === 'rent' && property.propertyType === 'studio' ? 'Studio' : 0);
                const bathrooms = property.bathrooms || 0;
                const squareFootage = property.floorArea || property.totalArea || property.squareFootage || 'N/A';
                
                return `
                <div class="listing-card" onclick="window.showPropertyModal('${property.id}')">
                    <div class="listing-image-container">
                        <img src="${mainPhoto}" alt="${property.title}" class="listing-image">
                        <div class="listing-type-badge ${typeBadgeClass}">${typeBadgeText}</div>
                        <button class="remove-saved-btn" 
                                onclick="event.stopPropagation(); removeFromLiked('${property.savedId}', '${property.id}')"
                                title="Remove from liked">
                            ‚úï
                        </button>
                    </div>
                    
                    <div class="listing-content">
                        <div class="listing-header">
                            <div>
                                <h3 class="listing-title">${property.title || 'Untitled Property'}</h3>
                                <div class="listing-location">
                                    <span>üìç</span> ${property.location || 'Location not specified'}
                                </div>
                            </div>
                            <div class="listing-price ${priceClass}">${displayPrice}</div>
                        </div>
                        
                        <div class="listing-details">
                            <div class="detail">
                                <span>üõèÔ∏è</span> ${bedrooms} ${bedrooms === 'Studio' ? '' : 'beds'}
                            </div>
                            <div class="detail">
                                <span>üöø</span> ${bathrooms} baths
                            </div>
                            <div class="detail">
                                <span>üìê</span> ${squareFootage} ${property.floorArea || property.totalArea ? 'sqm' : ''}
                            </div>
                        </div>
                        
                        <div class="listing-broker">
                            <div class="broker-avatar">${userInitials}</div>
                            <div class="broker-info">
                                <div class="broker-name">${userInfo.displayName}</div>
                                <div class="broker-role">
                                    ${userInfo.role === 'landlord' ? 'Property Owner' : 
                                      userInfo.role === 'broker' ? 'Licensed Broker' : 
                                      userInfo.role === 'agent' ? 'Property Agent' : 'Posted by'}
                                </div>
                            </div>
                        </div>
                        
                        <div class="listing-actions">
                            <button class="action-btn contact-btn" 
                                    onclick="event.stopPropagation(); contactBroker('${property.userId}')">
                                üìû Contact ${userInfo.role === 'landlord' ? 'Owner' : 'Broker'}
                            </button>
                            <button class="action-btn view-btn" 
                                    onclick="event.stopPropagation(); window.showPropertyModal('${property.id}')">
                                üëÄ View Details
                            </button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // Show property modal with full details
 window.showPropertyModal = async function(propertyId) {
    console.log('Opening modal for property:', propertyId);
    
    // First check in user's liked properties
    let property = userSavedProperties.find(p => p.id === propertyId);
    
    // If not found in liked properties, check in all properties (for similar properties)
    if (!property) {
        console.log('Property not in liked list, checking all properties...');
        property = allProperties.find(p => p.id === propertyId);
    }
    
    // If still not found, try to fetch directly from Firestore
    if (!property) {
        console.log('Property not in cache, fetching from Firestore...');
        try {
            const propertyDoc = await getDoc(doc(db, "properties", propertyId));
            if (propertyDoc.exists()) {
                property = {
                    id: propertyDoc.id,
                    ...propertyDoc.data()
                };
                
                // Add to allProperties cache for future use
                if (!allProperties.find(p => p.id === propertyId)) {
                    allProperties.push(property);
                }
                
                // Load user data if needed
                if (property.userId && !userMap.has(property.userId)) {
                    await loadUserData(property.userId);
                }
            }
        } catch (error) {
            console.error('Error fetching property from Firestore:', error);
        }
    }
    
    if (!property) {
        console.error('Property not found:', propertyId);
        showToast('Property not found or has been removed', 'error');
        return;
    }
    
    currentModalProperty = property;
    const userInfo = userMap.get(property.userId) || {
        displayName: `User ${property.userId ? property.userId.substring(0, 8) : 'Unknown'}`,
        email: 'N/A',
        phone: 'N/A',
        role: 'user'
    };
    
    // Rest of your modal code continues here...
    const listingType = getListingType(property);
    const displayPrice = getDisplayPrice(property);
    const typeBadgeText = getTypeBadgeText(property);
    
    // Update modal header
    document.getElementById('modalTitle').textContent = property.title || 'Untitled Property';
    document.getElementById('modalLocation').textContent = property.location || 'Location not specified';
    document.getElementById('modalPrice').textContent = displayPrice;
    document.getElementById('modalStatus').textContent = typeBadgeText;
    document.getElementById('modalStatus').style.background = 
        listingType === 'rent' ? 'var(--rent-color)' : 
        listingType === 'lease' ? 'var(--lease-color)' : 
        'var(--sale-color)';
            
            // Get photos
            const photos = property.photos || property.imageUrls || [];
            const mainPhoto = photos.length > 0 ? photos[0] : 
                            'https://via.placeholder.com/800x400/0b2e52/white?text=No+Image';
            
            // Prepare details
            const bedrooms = property.bedrooms || (listingType === 'rent' && property.propertyType === 'studio' ? 'Studio' : 0);
            const bathrooms = property.bathrooms || 0;
            const squareFootage = property.floorArea || property.totalArea || property.squareFootage || 'N/A';
            
            // Prepare pricing details
            let pricingDetails = '';
            if (listingType === 'rent') {
                pricingDetails = `
                    <div class="detail-row">
                        <span class="detail-label">Monthly Rent:</span>
                        <span class="detail-value" style="color: var(--rent-color);">‚Ç±${(property.monthlyRent || 0).toLocaleString()}</span>
                    </div>
                    ${property.securityDeposit ? `
                    <div class="detail-row">
                        <span class="detail-label">Security Deposit:</span>
                        <span class="detail-value">‚Ç±${property.securityDeposit.toLocaleString()}</span>
                    </div>
                    ` : ''}
                    ${property.minimumStay ? `
                    <div class="detail-row">
                        <span class="detail-label">Minimum Stay:</span>
                        <span class="detail-value">${property.minimumStay} month(s)</span>
                    </div>
                    ` : ''}
                `;
            } else if (listingType === 'lease') {
                pricingDetails = `
                    <div class="detail-row">
                        <span class="detail-label">Annual Rent:</span>
                        <span class="detail-value" style="color: var(--lease-color);">‚Ç±${(property.annualRent || 0).toLocaleString()}</span>
                    </div>
                    ${property.securityBond ? `
                    <div class="detail-row">
                        <span class="detail-label">Security Bond:</span>
                        <span class="detail-value">‚Ç±${property.securityBond.toLocaleString()}</span>
                    </div>
                    ` : ''}
                    ${property.leaseDuration ? `
                    <div class="detail-row">
                        <span class="detail-label">Lease Duration:</span>
                        <span class="detail-value">${property.leaseDuration} year(s)</span>
                    </div>
                    ` : ''}
                `;
            } else {
                pricingDetails = `
                    <div class="detail-row">
                        <span class="detail-label">Sale Price:</span>
                        <span class="detail-value" style="color: var(--sale-color);">‚Ç±${(property.pricing || property.salePrice || 0).toLocaleString()}</span>
                    </div>
                `;
            }
            
            // Prepare amenities
            let amenitiesHtml = '';
            if (property.amenities && property.amenities.length > 0) {
                amenitiesHtml = `
                    <div class="amenities-list">
                        ${property.amenities.map(amenity => `
                            <span class="amenity-tag">${amenity}</span>
                        `).join('')}
                    </div>
                `;
            } else {
                amenitiesHtml = '<p style="color: var(--text-light); font-style: italic;">No amenities listed</p>';
            }
            
            // Prepare thumbnail HTML if there are multiple photos
            let thumbnailsHtml = '';
            if (photos.length > 1) {
                thumbnailsHtml = photos.map((photo, index) => `
                    <img src="${photo}" 
                         class="modal-thumbnail ${index === 0 ? 'active' : ''}" 
                         onclick="changeModalImage('${photo}', this)"
                         alt="Property image ${index + 1}">
                `).join('');
            }
            
            // Set modal body content
            document.getElementById('modalBody').innerHTML = `
                <div class="modal-image-gallery">
                    <img src="${mainPhoto}" id="mainModalImage" class="main-modal-image" 
                         onclick="openFullscreenImage('${mainPhoto}')">
                    ${photos.length > 1 ? `
                    <div class="modal-thumbnails">
                        ${thumbnailsHtml}
                    </div>
                    ` : ''}
                </div>
                
                <div class="modal-description">
                    <p>${property.description || 'No description available for this property.'}</p>
                </div>
                
                <div class="modal-details-grid">
                    <div class="modal-section">
                        <h3>üìã Property Details</h3>
                        <div class="detail-row">
                            <span class="detail-label">Property Type:</span>
                            <span class="detail-value">${property.propertyType || 'Not specified'}</span>
                        </div>
                        ${property.propertyCategory ? `
                        <div class="detail-row">
                            <span class="detail-label">Category:</span>
                            <span class="detail-value">${property.propertyCategory}</span>
                        </div>
                        ` : ''}
                        <div class="detail-row">
                            <span class="detail-label">Bedrooms:</span>
                            <span class="detail-value">${bedrooms} ${bedrooms === 'Studio' ? '' : 'beds'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Bathrooms:</span>
                            <span class="detail-value">${bathrooms} baths</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Area:</span>
                            <span class="detail-value">${squareFootage} sqm</span>
                        </div>
                    </div>
                    
                    <div class="modal-section">
                        <h3>üí∞ Pricing Details</h3>
                        ${pricingDetails}
                    </div>
                </div>
                
                <div class="modal-section">
                    <h3>üéØ Amenities</h3>
                    ${amenitiesHtml}
                </div>
                
                ${property.leaseType || property.renewalOption || property.paymentTerms ? `
                <div class="modal-section">
                    <h3>üìù Lease Terms</h3>
                    ${property.leaseType ? `
                    <div class="detail-row">
                        <span class="detail-label">Lease Type:</span>
                        <span class="detail-value">${property.leaseType}</span>
                    </div>
                    ` : ''}
                    ${property.renewalOption ? `
                    <div class="detail-row">
                        <span class="detail-label">Renewal Option:</span>
                        <span class="detail-value">${property.renewalOption}</span>
                    </div>
                    ` : ''}
                    ${property.paymentTerms ? `
                    <div class="detail-row">
                        <span class="detail-label">Payment Terms:</span>
                        <span class="detail-value">${property.paymentTerms}</span>
                    </div>
                    ` : ''}
                </div>
                ` : ''}
                
                <div class="modal-section">
                    <h3>üë§ ${userInfo.role === 'landlord' ? 'Property Owner' : 'Broker'} Information</h3>
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <div class="broker-avatar" style="width: 50px; height: 50px; font-size: 18px;">
                            ${userInfo.displayName.split(' ').map(n => n[0]).join('').toUpperCase()}
                        </div>
                        <div>
                            <div style="font-weight: 600; color: var(--text-dark); font-size: 16px;">
                                ${userInfo.displayName}
                            </div>
                            <div style="color: var(--text-light); font-size: 14px;">
                                ${userInfo.role === 'landlord' ? 'Property Owner' : 
                                  userInfo.role === 'broker' ? 'Licensed Broker' : 
                                  userInfo.role === 'agent' ? 'Property Agent' : 'Posted by'}
                            </div>
                        </div>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Email:</span>
                        <span class="detail-value">${userInfo.email}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Phone:</span>
                        <span class="detail-value">${userInfo.phone}</span>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button class="modal-action-btn modal-contact-btn" onclick="contactBroker('${property.userId}')">
                        üìû Contact ${userInfo.role === 'landlord' ? 'Owner' : 'Broker'}
                    </button>
                    <button class="modal-action-btn modal-close-btn" onclick="window.closePropertyModal()">
                        ‚úï Close
                    </button>
                </div>
            `;
            
            // Show modal
            document.getElementById('propertyModal').classList.add('show');
            document.body.style.overflow = 'hidden';
        };

        // Change modal image when thumbnail is clicked
        window.changeModalImage = function(imageSrc, thumbnailElement) {
            document.getElementById('mainModalImage').src = imageSrc;
            
            // Update active thumbnail
            document.querySelectorAll('.modal-thumbnail').forEach(thumb => {
                thumb.classList.remove('active');
            });
            thumbnailElement.classList.add('active');
        };

        // Open fullscreen image (optional enhancement)
        window.openFullscreenImage = function(imageSrc) {
            const fullscreenDiv = document.createElement('div');
            fullscreenDiv.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.9);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            const fullscreenImg = document.createElement('img');
            fullscreenImg.src = imageSrc;
            fullscreenImg.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
            `;
            
            fullscreenDiv.appendChild(fullscreenImg);
            fullscreenDiv.onclick = () => fullscreenDiv.remove();
            document.body.appendChild(fullscreenDiv);
        };

        // Close property modal
        window.closePropertyModal = function() {
            document.getElementById('propertyModal').classList.remove('show');
            document.body.style.overflow = 'auto';
            currentModalProperty = null;
        };

        // Remove property from liked list
        window.removeFromLiked = async function(savedId, propertyId) {
            if (!confirm("Remove this property from your liked list?")) return;
            
            try {
                await deleteDoc(doc(db, "savedProperties", savedId));
                
                // Remove from local array
                userSavedProperties = userSavedProperties.filter(p => p.id !== propertyId);
                
                // Update display
                displayLikedProperties(userSavedProperties);
                updateStats(userSavedProperties);
                
                showToast('Property removed from liked list', 'success');
                
                // If no properties left, show empty state
                if (userSavedProperties.length === 0) {
                    showEmptyState();
                }
                
                // Close modal if it's open for this property
                if (currentModalProperty && currentModalProperty.id === propertyId) {
                    window.closePropertyModal();
                }
                
            } catch (error) {
                console.error("Error removing property:", error);
                showToast('Error removing property', 'error');
            }
        };

        // Show empty state
        function showEmptyState() {
            const container = document.getElementById('likedPropertiesContainer');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">‚ù§Ô∏è</div>
                    <h2>No Liked Properties Yet</h2>
                    <p>Start browsing properties and click the ‚ù§Ô∏è button to save your favorites!</p>
                    <a href="buyer_dashboard.html" class="browse-btn">üè† Browse Properties</a>
                </div>
            `;
            
            // Hide similar properties section
            document.getElementById('similarSuggestions').style.display = 'none';
        }

        // Update statistics
        function updateStats(properties) {
            if (!properties || properties.length === 0) {
                document.getElementById('totalSaved').textContent = 0;
                document.getElementById('activeListings').textContent = 0;
                document.getElementById('averagePrice').textContent = '‚Ç±0';
                document.getElementById('savedThisMonth').textContent = 0;
                return;
            }
            
            const total = properties.length;
            const active = properties.filter(p => 
                p.status === 'active' || 
                p.status === 'available' || 
                p.status === 'Active' ||
                (p.status === undefined && p.isActive !== false)
            ).length;
            
            // Calculate average price
            let totalPrice = 0;
            let count = 0;
            properties.forEach(p => {
                const price = p.pricing || p.salePrice || p.monthlyRent || p.annualRent || 0;
                if (price > 0) {
                    totalPrice += price;
                    count++;
                }
            });
            const average = count > 0 ? Math.round(totalPrice / count) : 0;
            
            // Count saved this month
            const currentMonth = new Date().getMonth();
            const savedThisMonth = properties.filter(p => {
                if (!p.savedAt) return false;
                const savedDate = p.savedAt.toDate ? p.savedAt.toDate() : new Date(p.savedAt);
                return savedDate.getMonth() === currentMonth;
            }).length;
            
            document.getElementById('totalSaved').textContent = total;
            document.getElementById('activeListings').textContent = active;
            document.getElementById('averagePrice').textContent = `‚Ç±${average.toLocaleString()}`;
            document.getElementById('savedThisMonth').textContent = savedThisMonth;
        }

        // Load similar properties based on user's saved properties
        async function loadSimilarProperties(savedProperties) {
            if (!savedProperties || savedProperties.length === 0) {
                document.getElementById('similarSuggestions').style.display = 'none';
                return;
            }
            
            try {
                // Get all active properties
                const propertiesQuery = query(collection(db, "properties"));
                const snapshot = await getDocs(propertiesQuery);
                
                allProperties = [];
                snapshot.forEach(doc => {
                    const property = { id: doc.id, ...doc.data() };
                    // Only include active properties not already saved
                    const isActive = property.status === 'active' || 
                                    property.status === 'available' || 
                                    property.status === 'Active' ||
                                    (property.status === undefined && property.isActive !== false);
                    const isAlreadySaved = savedProperties.some(sp => sp.id === property.id);
                    
                    if (isActive && !isAlreadySaved) {
                        allProperties.push(property);
                    }
                });
                
                // Find similar properties based on saved preferences
                const similarProperties = findSimilarProperties(savedProperties, allProperties);
                
                if (similarProperties.length > 0) {
                    // Load user data for similar properties
                    const userIds = new Set(similarProperties.map(p => p.userId));
                    for (const userId of userIds) {
                        if (!userMap.has(userId)) {
                            await loadUserData(userId);
                        }
                    }
                    
                    displaySimilarProperties(similarProperties);
                    document.getElementById('similarSuggestions').style.display = 'block';
                } else {
                    document.getElementById('similarSuggestions').style.display = 'none';
                }
                
            } catch (error) {
                console.error("Error loading similar properties:", error);
                document.getElementById('similarSuggestions').style.display = 'none';
            }
        }

        // Algorithm to find similar properties
        function findSimilarProperties(savedProperties, allProperties) {
            if (!savedProperties || savedProperties.length === 0 || !allProperties || allProperties.length === 0) return [];
            
            // Extract user preferences from saved properties
            const preferences = {
                propertyTypes: new Set(),
                priceRanges: [],
                locations: new Set()
            };
            
            savedProperties.forEach(property => {
                if (property.propertyType) preferences.propertyTypes.add(property.propertyType);
                if (property.location) preferences.locations.add(property.location.split(',')[0].trim());
                
                const price = property.pricing || property.salePrice || property.monthlyRent || property.annualRent || 0;
                if (price > 0) preferences.priceRanges.push(price);
            });
            
            // Calculate average price preference
            const avgPrice = preferences.priceRanges.length > 0 
                ? preferences.priceRanges.reduce((a, b) => a + b, 0) / preferences.priceRanges.length 
                : 0;
            
            // Score each property based on similarity
            const scoredProperties = allProperties.map(property => {
                let score = 0;
                
                // Property type match (30 points)
                if (property.propertyType && preferences.propertyTypes.has(property.propertyType)) {
                    score += 30;
                }
                
                // Location match (40 points)
                if (property.location) {
                    const locationMatch = Array.from(preferences.locations).some(loc => 
                        property.location.toLowerCase().includes(loc.toLowerCase())
                    );
                    if (locationMatch) score += 40;
                }
                
                // Price similarity (30 points)
                const propertyPrice = property.pricing || property.salePrice || property.monthlyRent || property.annualRent || 0;
                if (avgPrice > 0 && propertyPrice > 0) {
                    const priceDiff = Math.abs(propertyPrice - avgPrice) / avgPrice;
                    if (priceDiff < 0.3) score += 30 - (priceDiff * 100); // Up to 30 points based on closeness
                }
                
                return { property, score };
            });
            
            // Sort by score and return top 6
            return scoredProperties
                .sort((a, b) => b.score - a.score)
                .slice(0, 6)
                .map(item => item.property);
        }

 // Display similar properties
function displaySimilarProperties(properties) {
    const container = document.getElementById('similarPropertiesContainer');
    
    if (!properties || properties.length === 0) return;
    
    // Ensure these properties are added to allProperties for modal access
    properties.forEach(property => {
        if (!allProperties.find(p => p.id === property.id)) {
            allProperties.push(property);
        }
    });
    
    container.innerHTML = properties.map(property => {
        const userInfo = userMap.get(property.userId) || {
            displayName: `User ${property.userId ? property.userId.substring(0, 8) : 'Unknown'}`,
            email: 'N/A',
            phone: 'N/A',
            role: 'user'
        };
        
        const userInitials = userInfo.displayName.split(' ').map(n => n[0]).join('').toUpperCase() || 'UU';
        const listingType = getListingType(property);
        const displayPrice = getDisplayPrice(property);
        const priceClass = getPriceClass(property);
        const typeBadgeClass = getTypeBadgeClass(property);
        const typeBadgeText = getTypeBadgeText(property);
        
        // Get main photo
        let mainPhoto;
        if (property.photos && property.photos.length > 0) {
            mainPhoto = property.photos[0];
        } else if (property.imageUrls && property.imageUrls.length > 0) {
            mainPhoto = property.imageUrls[0];
        } else {
            mainPhoto = 'https://via.placeholder.com/400x220/0b2e52/white?text=No+Image';
        }
        
        const bedrooms = property.bedrooms || (listingType === 'rent' && property.propertyType === 'studio' ? 'Studio' : 0);
        
        return `
        <div class="listing-card" onclick="window.showPropertyModal('${property.id}')">
            <div class="listing-image-container">
                <img src="${mainPhoto}" alt="${property.title}" class="listing-image">
                <div class="listing-type-badge ${typeBadgeClass}">${typeBadgeText}</div>
            </div>
            
            <div class="listing-content">
                <div class="listing-header">
                    <div>
                        <h3 class="listing-title">${property.title || 'Untitled Property'}</h3>
                        <div class="listing-location">
                            <span>üìç</span> ${property.location || 'Location not specified'}
                        </div>
                    </div>
                    <div class="listing-price ${priceClass}">${displayPrice}</div>
                </div>
                
                <div class="listing-details">
                    <div class="detail">
                        <span>üõèÔ∏è</span> ${bedrooms} ${bedrooms === 'Studio' ? '' : 'beds'}
                    </div>
                    <div class="detail">
                        <span>üöø</span> ${property.bathrooms || 0} baths
                    </div>
                </div>
                
                <div class="listing-actions">
                    <button class="action-btn view-btn" 
                            onclick="event.stopPropagation(); window.showPropertyModal('${property.id}')">
                        üëÄ View Details
                    </button>
                </div>
            </div>
        </div>
        `;
    }).join('');
}
        // Contact broker function
        window.contactBroker = function(userId) {
            const userInfo = userMap.get(userId);
            if (userInfo) {
                const userType = userInfo.role === 'landlord' ? 'Property Owner' : 'Broker';
                alert(`Contact Information:\n\n${userType}: ${userInfo.displayName}\nEmail: ${userInfo.email}\nPhone: ${userInfo.phone}\n\nYou can contact this ${userType.toLowerCase()} for more information about the property.`);
            } else {
                alert('Contact information not available.');
            }
        };

        // Toast notification function
        function showToast(message, type = 'success') {
            // Remove existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Modal event listeners
        document.getElementById('closeModal').addEventListener('click', window.closePropertyModal);
        document.getElementById('propertyModal').addEventListener('click', function(e) {
            if (e.target === this) window.closePropertyModal();
        });
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') window.closePropertyModal();
        });
    </script>
</body>
</html>