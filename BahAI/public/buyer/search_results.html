<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Search Results - BahAI Real Estate</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="style.css">

<!-- Messaging Modal CSS -->
<style>
    /* ===== MESSAGING MODAL STYLES ===== */
    .message-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 2000;
        align-items: center;
        justify-content: center;
        padding: 20px;
        backdrop-filter: blur(5px);
    }

    .message-modal.show {
        display: flex;
    }

    .message-modal-content {
        background: var(--bg-white);
        border-radius: 16px;
        width: 100%;
        max-width: 600px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: var(--shadow-lg);
    }

    .message-header {
        padding: 25px 30px;
        border-bottom: 1px solid var(--border);
        position: relative;
        background: var(--primary);
        color: white;
        border-radius: 16px 16px 0 0;
    }

    .message-header h2 {
        font-size: 22px;
        font-weight: 600;
        margin-bottom: 5px;
    }

    .message-subtitle {
        font-size: 14px;
        opacity: 0.9;
    }

    .message-close {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        color: white;
        font-size: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .message-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: rotate(90deg);
    }

    .message-broker-card {
        background: var(--bg-light);
        padding: 15px;
        border-radius: 12px;
        margin: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        border: 1px solid var(--border);
    }

    .message-broker-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary), var(--primary-light));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 14px;
        flex-shrink: 0;
    }

    .message-broker-info {
        flex: 1;
        min-width: 0;
    }

    .message-broker-name {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 2px;
    }

    .message-broker-role {
        font-size: 12px;
        color: var(--text-light);
    }

    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: var(--bg-light);
        min-height: 300px;
        max-height: 400px;
    }

    .message-bubble {
        margin-bottom: 15px;
        max-width: 80%;
    }

    .message-bubble.sent {
        margin-left: auto;
        text-align: right;
    }

    .message-bubble-content {
        display: inline-block;
        padding: 12px 16px;
        border-radius: 18px;
        background: var(--bg-white);
        border: 1px solid var(--border);
        text-align: left;
        word-wrap: break-word;
    }

    .message-bubble.sent .message-bubble-content {
        background: var(--primary);
        color: white;
        border: none;
    }

    .message-time {
        font-size: 11px;
        color: var(--text-light);
        margin-top: 4px;
        display: block;
    }

    .message-bubble.sent .message-time {
        color: rgba(255, 255, 255, 0.7);
    }

    .no-messages {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-light);
    }

    .message-input-area {
        padding: 20px;
        border-top: 1px solid var(--border);
        background: var(--bg-white);
        border-radius: 0 0 16px 16px;
    }

    .message-textarea {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid var(--border);
        border-radius: 10px;
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        resize: none;
        min-height: 60px;
        margin-bottom: 10px;
        transition: border-color 0.3s ease;
    }

    .message-textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(11, 46, 82, 0.1);
    }

    .message-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 15px;
    }

    .contact-info {
        font-size: 12px;
        color: var(--text-light);
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .send-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
    }

    .send-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
    }

    .send-btn:disabled {
        background: var(--border);
        cursor: not-allowed;
        transform: none;
    }

    .loading-messages {
        text-align: center;
        padding: 40px 20px;
    }

    .quick-contact-buttons {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .quick-contact-btn {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        text-decoration: none;
        white-space: nowrap;
    }

    .email-btn {
        background: #e8f5e9;
        color: #2e7d32;
        border: 1px solid #c8e6c9;
    }

    .email-btn:hover {
        background: #d4edd5;
        transform: translateY(-1px);
    }

    .call-btn {
        background: #e3f2fd;
        color: #1565c0;
        border: 1px solid #bbdefb;
    }

    .call-btn:hover {
        background: #c5e0fb;
        transform: translateY(-1px);
    }

    /* Mobile responsive styles for messaging */
    @media (max-width: 768px) {
        .message-modal-content {
            max-width: 95%;
        }
        
        .message-actions {
            flex-direction: column;
            align-items: stretch;
        }
        
        .contact-info {
            justify-content: center;
        }
        
        .send-btn {
            width: 100%;
        }
        
        .quick-contact-buttons {
            flex-direction: column;
        }
    }

    @media (max-width: 480px) {
        .message-header {
            padding: 20px;
        }
        
        .message-broker-card {
            margin: 15px;
            flex-direction: column;
            text-align: center;
        }
        
        .message-broker-avatar {
            width: 50px;
            height: 50px;
            font-size: 16px;
        }
    }
</style>
</head>

<body>
<!-- Mobile Menu Toggle -->
<button class="mobile-menu-toggle" id="mobileMenuToggle">‚â°</button>

<!-- Include Sidebar -->
<div id="sidebar-container"></div>

<!-- Messaging Modal -->
<div class="message-modal" id="messageModal">
    <div class="message-modal-content">
        <div class="message-header">
            <h2 id="messageBrokerName">Contact Broker</h2>
            <div class="message-subtitle" id="messageBrokerRole"></div>
            <button class="message-close" id="closeMessageModal">&times;</button>
        </div>
        
        <div class="message-broker-card">
            <div class="message-broker-avatar" id="messageBrokerAvatar">B</div>
            <div class="message-broker-info">
                <div class="message-broker-name" id="messageBrokerFullName">Loading...</div>
                <div class="message-broker-role">
                    <span id="messageBrokerType">Broker</span> ‚Ä¢ 
                    <span id="messageBrokerContact">Contact info loading...</span>
                </div>
            </div>
        </div>
        
        <div class="messages-container" id="messagesContainer">
            <div class="loading-messages">
                <div class="spinner"></div>
                <p>Loading messages...</p>
            </div>
        </div>
        
        <div class="message-input-area">
            <textarea class="message-textarea" 
                    id="messageInput" 
                    placeholder="Type your message here..." 
                    rows="3"></textarea>
            
            <div class="message-actions">
                <div class="contact-info">
                    <span id="brokerEmailInfo">üìß Email: Loading...</span>
                    <span id="brokerPhoneInfo">üìû Phone: Loading...</span>
                </div>
                <button class="send-btn" id="sendMessageBtn">
                    <span>üì® Send</span>
                </button>
            </div>
            
            <div class="quick-contact-buttons">
                <a href="#" class="quick-contact-btn email-btn" id="quickEmailBtn">
                    üìß Send Email
                </a>
                <a href="#" class="quick-contact-btn call-btn" id="quickCallBtn">
                    üìû Make Call
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Main -->
<div class="container">
<!-- Hero Section -->
<div class="hero-section">
    <h1>Search Results</h1>
    <p>Properties matching your search criteria</p>
    <div id="searchSummary" style="font-weight: 500; opacity: 0.9; font-size: 16px; margin-top: 5px;">
        <i class="fas fa-spinner fa-spin"></i> Loading results...
    </div>
</div>

<!-- Search Section -->
<div class="search-section">
    <div class="search-title">
        <i class="fas fa-filter"></i>
        Refine Your Search
    </div>

    <div class="search-grid">
        <!-- Location Filter -->
        <div class="search-group">
            <label class="search-label">Select City/Municipality</label>
            <select class="search-select" id="filterLocation">
                <option value="">All of Batangas</option>
                <option value="Batangas City">Batangas City</option>
                <option value="Lipa City">Lipa City</option>
                <option value="Tanauan City">Tanauan City</option>
                <option value="Bauan">Bauan</option>
                <option value="Balayan">Balayan</option>
                <option value="Calaca">Calaca</option>
                <option value="Lemery">Lemery</option>
                <option value="Nasugbu">Nasugbu</option>
                <option value="San Juan">San Juan</option>
                <option value="Taal">Taal</option>
                <option value="Talisay">Talisay</option>
                <option value="Alitagtag">Alitagtag</option>
                <option value="Cuenca">Cuenca</option>
                <option value="Laurel">Laurel</option>
                <option value="Mataasnakahoy">Mataasnakahoy</option>
                <option value="San Jose">San Jose</option>
                <option value="San Luis">San Luis</option>
                <option value="San Pascual">San Pascual</option>
                <option value="Santo Tomas">Santo Tomas</option>
            </select>
        </div>

        <!-- Transaction Type Filter -->
        <div class="search-group">
            <label class="search-label">Transaction Type</label>
            <select class="search-select" id="filterListingType">
                <option value="">All Types</option>
                <option value="sale">For Sale</option>
                <option value="rent">For Rent</option>
                <option value="lease">For Lease</option>
            </select>
        </div>

        <!-- Property Category Filter (Dynamic based on transaction type) -->
        <div class="search-group">
            <label class="search-label">Property Category</label>
            <select class="search-select" id="filterPropertyCategory">
                <option value="">All Categories</option>
                <!-- Options will be populated dynamically -->
            </select>
        </div>

        <!-- Property Type Filter (Dynamic based on category) -->
        <div class="search-group">
            <label class="search-label">Property Type</label>
            <select class="search-select" id="filterPropertyType">
                <option value="">All Types</option>
                <!-- Options will be populated dynamically -->
            </select>
        </div>

        <!-- Search by Name/Keyword -->
        <div class="search-group">
            <label class="search-label">Search Property</label>
            <input type="text" class="search-input" id="filterName" placeholder="Enter property name or keyword...">
        </div>
    </div>

    <div class="search-actions">
        <button class="search-button" id="applyFilters">
            <i class="fas fa-search"></i>
            Apply Filters
        </button>
        <button class="reset-button" id="resetFilters">
            <i class="fas fa-redo"></i>
            Reset Filters
        </button>
        <button class="reset-button back-button" id="backToDashboard">
            <i class="fas fa-arrow-left"></i>
            Back to Dashboard
        </button>
    </div>
</div>

<!-- Search Results Section -->
<div class="properties-section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
        <div>
            <h2 class="section-title" id="resultsTitle">
                <i class="fas fa-search"></i>
                Search Results
            </h2>
            <p style="color: var(--text-light); font-size: 15px; margin-top: 5px;" id="resultsCount">
                Loading results...
            </p>
        </div>
        <div id="sortOptions" style="display: flex; align-items: center; gap: 10px;">
            <div class="filter-tags" id="activeFilters" style="display: none;">
                <!-- Active filter tags will be added here -->
            </div>
            <div class="results-count-badge" id="resultsBadge" style="display: none;">
                <span id="resultsNumber">0</span> properties
            </div>
        </div>
    </div>

    <!-- Results Grid -->
    <div class="listings-grid" id="listingsContainer">
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Loading search results...</p>
        </div>
    </div>

    <!-- Pagination (if needed in future) -->
    <div id="pagination" style="display: none; margin-top: 30px; text-align: center;"></div>
</div>

</div>

<!-- Sidebar Loader -->
<script>
// Mobile menu functionality
document.getElementById('mobileMenuToggle').addEventListener('click', function() {
    const sidebar = document.querySelector('.sidebar');
    if (sidebar) {
        sidebar.classList.toggle('active');
    }
});

// Close sidebar when clicking on a link (mobile)
document.addEventListener('click', function(e) {
    if (window.innerWidth <= 1024) {
        if (e.target.closest('.sidebar-link')) {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.remove('active');
            }
        }
    }
});

// Load sidebar
fetch('sidebar.html')
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to load sidebar: ' + response.status);
        }
        return response.text();
    })
    .then(html => {
        document.getElementById('sidebar-container').innerHTML = html;

        // Highlight active link
        const links = document.querySelectorAll('.sidebar-link');
        links.forEach(link => {
            if (link.getAttribute('href') === 'search_results.html') {
                link.classList.add('active');
            }
        });
        // Setup logout button
        setupLogoutButton();
    })
    .catch(error => {
        console.error("Error loading sidebar", error);
        document.getElementById("sidebar-container").innerHTML = 
            '<div class="sidebar" style="padding: 20px; background: #f8f9fa; color:#dc3545;">' +
            '<p>Unable to load navigation. Please refresh the page.</p>' +
            '</div>';
    });

// Handle window resize
window.addEventListener('resize', function() {
    const sidebar = document.querySelector('.sidebar');
    if (window.innerWidth > 1024 && sidebar) {
        sidebar.classList.remove('active');
    }
});

function setupLogoutButton() {
    const logoutBtn = document.getElementById("logoutBtn");
    if (!logoutBtn) {
        console.warn("Logout button not found, retrying...");
        setTimeout(setupLogoutButton, 100);
        return;
    }

    // Remove existing event listeners
    const newLogoutBtn = logoutBtn.cloneNode(true);
    logoutBtn.parentNode.replaceChild(newLogoutBtn, logoutBtn);

    // Add new event listener
    newLogoutBtn.addEventListener("click", async function(e) {
        e.preventDefault();
        e.stopPropagation();

        if (confirm("Are you sure you want to logout?")) {
            try {
                await signOut(auth);
                window.location.href = "./login.html";
            } catch (error) {
                console.error("Logout error:", error);
                alert("Error logging out. Please try again.");
            }
        }
    });

    console.log('Logout button initialized successfully');
}

// Back to Dashboard button
document.getElementById('backToDashboard').addEventListener('click', function() {
    window.location.href = 'buyer_dashboard.html';
});

</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import {
    getAuth,
    onAuthStateChanged,
    signOut
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import {
    getFirestore,
    collection,
    query,
    where,
    getDocs,
    getDoc,
    doc,
    addDoc,
    deleteDoc,
    orderBy,
    serverTimestamp,
    updateDoc,
    setDoc,
    onSnapshot
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

// Firebase Config
const firebaseConfig = {
    apiKey: "AIzaSyCIfzneDzWVveG8p_0mywoA9D9F5AyzZX4",
    authDomain: "bahai-1b76d.firebaseapp.com",
    projectId: "bahai-1b76d",
    storageBucket: "bahai-1b76d.firebasestorage.app",
    messagingSenderId: "646878644941",
    appId: "1:646878644941:web:5b4ccc3412250337587784"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const GOOGLE_MAPS_API_KEY = "AIzaSyBwwAkIEixelJysaGrMb9BfTsMwz_C9Noxk";

// Global variables
let allListings = [];
let userMap = new Map();
let searchFilters = {};
let isUserAuthenticated = false;
let currentConversationId = null;
let messageListener = null;

// Property category and type mappings based on transaction type
const PROPERTY_CATEGORIES = {
    'rent': [
        { category: 'Residential Property', types: ['Apartment', 'Condominium', 'Room / Bedspace', 'House', 'Dormitory'] },
        { category: 'Commercial Property', types: ['Office Unit', 'Retail Space / Shop', 'Food Stall / Kiosk'] },
        { category: 'Industrial Property', types: ['Warehouse', 'Factory', 'Storage Unit'] }
    ],
    'lease': [
        { category: 'Commercial Property', types: ['Office Floor', 'Commercial Building', 'Warehouse'] },
        { category: 'Land / Lot', types: ['Agricultural Lot', 'Commercial Lot', 'Industrial Lot'] },
        { category: 'Special Purpose Property', types: ['Resort Property', 'Event Venue', 'School Property', 'Sports Facility'] }
    ],
    'sale': [
        { category: 'Residential Property', types: ['House', 'Townhouse', 'Condominium', 'Apartment'] },
        { category: 'Commercial Property', types: ['Office Space', 'Retail Space / Shop', 'Commercial Building'] },
        { category: 'Land / Lot', types: ['Residential Lot', 'Commercial Lot', 'Agricultural Lot'] }
    ]
};

// --- MESSAGING SYSTEM FUNCTIONS ---

// Initialize messaging event listeners
function initializeMessagingListeners() {
    // Send message button
    const sendBtn = document.getElementById('sendMessageBtn');
    if (sendBtn) {
        sendBtn.addEventListener('click', sendMessage);
    }
    
    // Message input enter key support
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Auto-resize textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
    }
    
    // Close message modal button
    const closeMessageBtn = document.getElementById('closeMessageModal');
    if (closeMessageBtn) {
        closeMessageBtn.addEventListener('click', closeMessageModal);
    }
    
    // Close modal when clicking outside
    const messageModal = document.getElementById('messageModal');
    if (messageModal) {
        messageModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeMessageModal();
            }
        });
    }
}

// Contact broker function (for use in onclick attributes)
window.contactBroker = async function(userId, propertyId = null) {
    const currentUser = auth.currentUser;
    if (!currentUser) {
        alert('Please log in to contact brokers');
        return;
    }

    const userInfo = userMap.get(userId);
    if (!userInfo) {
        alert('Broker information not available');
        return;
    }

    // Generate conversation ID (sorted combination of both user IDs)
    currentConversationId = [currentUser.uid, userId].sort().join('_');
    
    // Get property info for context
    const property = allListings.find(l => l.userId === userId);
    
    // Update messaging modal UI
    updateMessagingModal(userInfo, property);
    
    // Show messaging modal
    const messageModal = document.getElementById('messageModal');
    messageModal.classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // Load existing messages
    loadMessages(currentConversationId, userId);
    
    // Focus on message input
    setTimeout(() => {
        document.getElementById('messageInput').focus();
    }, 300);
};

// Update messaging modal with broker info
function updateMessagingModal(userInfo, property) {
    const brokerName = userInfo.displayName || 'Broker';
    const brokerRole = userInfo.role === 'landlord' ? 'Property Owner' : 
                     userInfo.role === 'broker' ? 'Licensed Broker' : 
                     'Property Contact';
    
    // Set modal title and info
    document.getElementById('messageBrokerName').textContent = `Message ${brokerName}`;
    document.getElementById('messageBrokerRole').textContent = brokerRole;
    document.getElementById('messageBrokerFullName').textContent = brokerName;
    document.getElementById('messageBrokerType').textContent = brokerRole;
    document.getElementById('messageBrokerContact').textContent = userInfo.email || 'Email not available';

    // Set broker avatar initials
    const initials = brokerName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) || 'B';
    document.getElementById('messageBrokerAvatar').textContent = initials;
    
    // Update contact info
    const emailInfo = document.getElementById('brokerEmailInfo');
    const phoneInfo = document.getElementById('brokerPhoneInfo');
    emailInfo.textContent = `üìß ${userInfo.email || 'Email not available'}`;
    phoneInfo.textContent = `üìû ${userInfo.phone || 'Phone not available'}`;
    
    // Setup quick contact buttons
    const quickEmailBtn = document.getElementById('quickEmailBtn');
    const quickCallBtn = document.getElementById('quickCallBtn');
    
    if (userInfo.email) {
        const subject = property ? `Inquiry about: ${property.title}` : 'Property Inquiry';
        const body = property ? `Hello ${brokerName},\n\nI'm interested in your property: ${property.title}\n\nPlease send me more information.` : '';
        quickEmailBtn.href = `mailto:${userInfo.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        quickEmailBtn.style.display = 'flex';
    } else {
        quickEmailBtn.style.display = 'none';
    }
    
    if (userInfo.phone) {
        quickCallBtn.href = `tel:${userInfo.phone}`;
        quickCallBtn.style.display = 'flex';
    } else {
        quickCallBtn.style.display = 'none';
    }
    
    // Set up message input placeholder with property context
    const messageInput = document.getElementById('messageInput');
    if (property) {
        messageInput.placeholder = `Hi ${brokerName}, I'm interested in ${property.title} at ${property.location}. Could you please provide more details about...`;
    } else {
        messageInput.placeholder = `Type your message here...`;
    }
}

// Load messages for a conversation
function loadMessages(conversationId, brokerId) {
    const messagesContainer = document.getElementById('messagesContainer');
    
    // Clear any existing listener
    if (messageListener) {
        messageListener();
        messageListener = null;
    }
    
    // Show loading state
    messagesContainer.innerHTML = `
        <div class="loading-messages">
            <div class="spinner"></div>
            <p>Loading messages...</p>
        </div>
    `;
    
    console.log('üîç Attempting to load messages for conversation:', conversationId);
    
    try {
        // Query messages for this conversation
        const messagesRef = collection(db, 'messages');
        const messagesQuery = query(
            messagesRef,
            where('conversationId', '==', conversationId),
            orderBy('timestamp', 'asc')
        );
        
        console.log('üìã Query created, listening for messages...');
        
        // Listen for real-time updates
        messageListener = onSnapshot(messagesQuery, 
            (snapshot) => {
                console.log('üì® Snapshot received, docs:', snapshot.size);
                
                messagesContainer.innerHTML = '';
                
                if (snapshot.empty) {
                    console.log('üì≠ No messages found in conversation');
                    messagesContainer.innerHTML = `
                        <div class="no-messages">
                            <div style="font-size: 48px; margin-bottom: 16px;">üí¨</div>
                            <h3>No messages yet</h3>
                            <p>Start the conversation by sending a message below.</p>
                        </div>
                    `;
                    return;
                }
                
                const currentUser = auth.currentUser;
                
                snapshot.forEach((doc) => {
                    const message = doc.data();
                    const isSent = message.senderId === currentUser.uid;
                    
                    const messageElement = document.createElement('div');
                    messageElement.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
                    
                    // Format timestamp
                    let timestamp = 'Just now';
                    if (message.timestamp) {
                        const date = message.timestamp.toDate ? message.timestamp.toDate() : new Date();
                        timestamp = formatMessageTime(date);
                    }
                    
                    const messageContent = document.createElement('div');
                    messageContent.className = 'message-bubble-content';
                    
                    let statusIndicator = '';
                    if (isSent) {
                        statusIndicator = `<span class="message-status" style="margin-left: 5px; font-size: 10px;">‚úì</span>`;
                    }
                    
                    messageContent.innerHTML = `
                        <div>${message.text}</div>
                        <span class="message-time">${timestamp}${statusIndicator}</span>
                    `;
                    
                    messageElement.appendChild(messageContent);
                    messagesContainer.appendChild(messageElement);
                });
                
                // Scroll to bottom
                setTimeout(() => {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }, 100);
                
            }, 
            (error) => {
                console.error('‚ùå Error in onSnapshot listener:', error);
                
                messagesContainer.innerHTML = `
                    <div class="no-messages">
                        <div style="font-size: 48px; margin-bottom: 16px;">üí¨</div>
                        <h3>Start a conversation</h3>
                        <p>Send a message to begin chatting with the broker.</p>
                    </div>
                `;
            }
        );
        
    } catch (error) {
        console.error('üí• Error setting up message listener:', error);
        messagesContainer.innerHTML = `
            <div class="no-messages">
                <div style="font-size: 48px; margin-bottom: 16px;">üí¨</div>
                <h3>Ready to chat</h3>
                <p>Send your first message below to start the conversation.</p>
            </div>
        `;
    }
}

// Send message function
async function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const messageText = messageInput.value.trim();
    const sendBtn = document.getElementById('sendMessageBtn');
    
    if (!messageText) {
        messageInput.focus();
        return;
    }
    
    if (!currentConversationId || !auth.currentUser) {
        alert('Unable to send message. Please refresh and try again.');
        return;
    }
    
    // Get broker ID from conversation ID
    const conversationParts = currentConversationId.split('_');
    const brokerId = conversationParts.find(id => id !== auth.currentUser.uid);
    
    if (!brokerId) {
        alert('Unable to identify recipient.');
        return;
    }
    
    // Disable send button and show loading
    const originalText = sendBtn.innerHTML;
    sendBtn.innerHTML = '<div class="spinner" style="border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; width: 16px; height: 16px;"></div>';
    sendBtn.disabled = true;
    messageInput.disabled = true;
    
    try {
        // Get property ID for context
        const property = allListings.find(l => l.userId === brokerId);
        const propertyId = property?.id;
        
        // Create conversation document if it doesn't exist
        const conversationRef = doc(db, 'conversations', currentConversationId);
        const conversationSnap = await getDoc(conversationRef);
        
        const conversationData = {
            participants: [auth.currentUser.uid, brokerId],
            lastMessage: messageText.substring(0, 100),
            lastMessageTime: serverTimestamp(),
            lastSenderId: auth.currentUser.uid,
            unreadCount: {
                [brokerId]: (conversationSnap.exists() ? 
                    (conversationSnap.data().unreadCount?.[brokerId] || 0) + 1 : 1)
            },
            buyerId: auth.currentUser.uid,
            brokerId: brokerId,
            propertyId: propertyId || null,
            propertyTitle: property?.title || null,
            buyerName: auth.currentUser.displayName || auth.currentUser.email,
            createdAt: conversationSnap.exists() ? 
                conversationSnap.data().createdAt : serverTimestamp(),
            updatedAt: serverTimestamp()
        };
        
        // Update or create conversation
        await setDoc(conversationRef, conversationData, { merge: true });
        
        // Add message to messages collection
        const messageData = {
            conversationId: currentConversationId,
            senderId: auth.currentUser.uid,
            receiverId: brokerId,
            text: messageText,
            timestamp: serverTimestamp(),
            read: false,
            createdAt: serverTimestamp(),
            type: 'text',
            propertyId: propertyId || null,
            senderName: auth.currentUser.displayName || auth.currentUser.email
        };
        
        await addDoc(collection(db, 'messages'), messageData);
        
        console.log('‚úÖ Message sent successfully');
        
        // Clear input and reset UI
        messageInput.value = '';
        messageInput.style.height = 'auto';
        messageInput.disabled = false;
        
        // Show success feedback
        sendBtn.innerHTML = '‚úì Sent';
        sendBtn.style.background = '#10b981';
        
        setTimeout(() => {
            sendBtn.innerHTML = 'üì® Send';
            sendBtn.style.background = '';
            sendBtn.disabled = false;
        }, 1500);
        
        // Scroll to bottom of messages
        const messagesContainer = document.getElementById('messagesContainer');
        setTimeout(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }, 100);
        
    } catch (error) {
        console.error('‚ùå Error sending message:', error);
        
        // Reset UI
        sendBtn.innerHTML = originalText;
        sendBtn.disabled = false;
        messageInput.disabled = false;
        
        // Show user-friendly error
        let errorMessage = 'Failed to send message. ';
        if (error.code === 'permission-denied') {
            errorMessage += 'You do not have permission to send messages.';
        } else if (error.code === 'unavailable') {
            errorMessage += 'Network error. Please check your connection.';
        } else {
            errorMessage += 'Please try again.';
        }
        
        alert(errorMessage);
    }
}

// Format message timestamp
function formatMessageTime(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    
    return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
}

// Close messaging modal
function closeMessageModal() {
    const messageModal = document.getElementById('messageModal');
    messageModal.classList.remove('show');
    document.body.style.overflow = 'auto';
    
    // Clean up message listener
    if (messageListener) {
        messageListener();
        messageListener = null;
    }
    
    currentConversationId = null;
    
    // Clear message input
    document.getElementById('messageInput').value = '';
}

// --- HELPER FUNCTIONS ---

function getRoleDisplayText(role) {
    const roleMap = {
        'landlord': 'Property Owner',
        'seller': 'Property Seller',
        'broker': 'Licensed Broker',
        'agent': 'Property Agent',
        'admin': 'Administrator'
    };
    return roleMap[role] || 'Posted by';
}

function getListingType(listing) {
    if (listing.listingType === 'lease' || listing.type === 'lease') {
        return 'lease';
    }

    if (listing.listingType === 'rent' || listing.type === 'rent') {
        return 'rent';
    }

    if (listing.listingType === 'sale' || listing.type === 'sale') {
        return 'sale';
    }

    if (listing.monthlyRent !== undefined && listing.monthlyRent !== null && listing.monthlyRent > 0) {
        return 'rent';
    }

    if (listing.annualRent !== undefined && listing.annualRent !== null && listing.annualRent > 0) {
        return 'lease';
    }

    if ((listing.pricing !== undefined && listing.pricing !== null && listing.pricing > 0) ||
        (listing.salePrice !== undefined && listing.salePrice !== null && listing.salePrice > 0)) {
        return 'sale';
    }

    return 'sale';
}

function getDisplayPrice(listing) {
    const type = getListingType(listing);

    switch (type) {
        case 'rent':
            return '‚Ç±' + (listing.monthlyRent || 0).toLocaleString() + '/month';
        case 'lease':
            const annualRent = listing.annualRent || 0;
            return '‚Ç±' + annualRent.toLocaleString() + '/year';
        case 'sale':
        default:
            return '‚Ç±' + (listing.pricing || listing.salePrice || 0).toLocaleString();
    }
}

function getPriceClass(listing) {
    const type = getListingType(listing);

    switch (type) {
        case 'rent':
            return 'price-rent';
        case 'lease':
            return 'price-lease';
        case 'sale':
        default:
            return 'price-sale';
    }
}

function getTypeBadgeClass(listing) {
    const type = getListingType(listing);

    switch (type) {
        case 'rent':
            return 'type-rent';
        case 'lease':
            return 'type-lease';
        case 'sale':
        default:
            return 'type-sale';
    }
}

function getTypeBadgeText(listing) {
    const type = getListingType(listing);

    switch (type) {
        case 'rent':
            return 'FOR RENT';
        case 'lease':
            return 'FOR LEASE';
        case 'sale':
        default:
            return 'FOR SALE';
    }
}

// Address helper functions from dashboard
function getFullAddress(listing) {
    // If there's already a complete address in 'address' field
    if (listing.address && listing.address.includes(',') && listing.address.length > 10) {
        return listing.address;
    }

    // Build address from components
    const addressParts = [];
    
    // Add the basic location (street/landmark)
    if (listing.location) {
        addressParts.push(listing.location);
    } else if (listing.address) {
        addressParts.push(listing.address);
    }
    
    // Add city
    if (listing.city) {
        addressParts.push(listing.city);
    }
    
    // Add province
    if (listing.province) {
        addressParts.push(listing.province);
    }
    
    // If we have a city but no province, add "Philippines" as default
    if (addressParts.length === 1 && listing.city) {
        addressParts.push("Philippines");
    } else if (addressParts.length === 0) {
        return 'Location not specified';
    }
    
    return addressParts.join(', ');
}

function getCompleteAddress(listing) {
    // Priority: address (full) -> location (street) -> title
    const primaryAddress = listing.address || listing.location || listing.title || '';

    // Always append city and province if available
    let fullAddress = primaryAddress;

    if (listing.city) {
        fullAddress += ', ' + listing.city;
    }

    if (listing.province && listing.province !== 'Calabarzon') {
        fullAddress += ', ' + listing.province;
    }

    if (!listing.province && listing.city) {
        fullAddress += ', Philippines';
    }

    return fullAddress || 'Batangas, Philippines';
}

// ============================= CATEGORY DROPDOWN FUNCTIONS ============================

// Update category dropdown based on selected transaction type
function updateCategoryDropdown() {
    const transactionType = document.getElementById('filterListingType').value;
    const categorySelect = document.getElementById('filterPropertyCategory');
    const typeSelect = document.getElementById('filterPropertyType');

    // Reset both dropdowns
    categorySelect.innerHTML = '<option value="">All Categories</option>';
    typeSelect.innerHTML = '<option value="">All Types</option>';

    if (transactionType && PROPERTY_CATEGORIES[transactionType]) {
        // Populate categories based on transaction type
        PROPERTY_CATEGORIES[transactionType].forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.category;
            option.textContent = cat.category;
            categorySelect.appendChild(option);
        });
    } else {
        // If no transaction type selected, show all possible categories
        const allCategories = new Set();
        Object.values(PROPERTY_CATEGORIES).forEach(cats => {
            cats.forEach(cat => allCategories.add(cat.category));
        });
        allCategories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categorySelect.appendChild(option);
        });
    }

    // Update type dropdown
    updateTypeDropdown();
}

// Update type dropdown based on selected category
function updateTypeDropdown() {
    const transactionType = document.getElementById('filterListingType').value;
    const category = document.getElementById('filterPropertyCategory').value;
    const typeSelect = document.getElementById('filterPropertyType');

    typeSelect.innerHTML = '<option value="">All Types</option>';

    if (transactionType && category && PROPERTY_CATEGORIES[transactionType]) {
        const categoryData = PROPERTY_CATEGORIES[transactionType].find(cat =>
            cat.category === category);
        if (categoryData && categoryData.types) {
            categoryData.types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeSelect.appendChild(option);
            });
        }
    }
}

// Force all type badges to be visible
function forceBadgeVisibility() {
    document.querySelectorAll('.listing-type-badge').forEach(badge => {
        badge.style.opacity = '1';
        badge.style.visibility = 'visible';
        badge.style.display = 'block';
    });
}

// --- INITIALIZATION ---

// Initialize dropdowns when page loads
document.addEventListener('DOMContentLoaded', function() {
    const transactionTypeSelect = document.getElementById('filterListingType');
    const categorySelect = document.getElementById('filterPropertyCategory');

    if (transactionTypeSelect) {
        transactionTypeSelect.addEventListener('change', updateCategoryDropdown);
    }
    if (categorySelect) {
        categorySelect.addEventListener('change', updateTypeDropdown);
    }

    // Initialize with current values
    updateCategoryDropdown();

    // Load filters from URL parameters
    loadFiltersFromURL();
    
    // Initialize messaging listeners
    initializeMessagingListeners();
});

// Load filters from URL parameters
function loadFiltersFromURL() {
    const urlParams = new URLSearchParams(window.location.search);

    if (urlParams.has('filters')) {
        try {
            searchFilters = JSON.parse(decodeURIComponent(urlParams.get("filters")));
            // Set form values from filters
            if (searchFilters.location) {
                document.getElementById("filterLocation").value = searchFilters.location;
            }
            if (searchFilters.transactionType) {
                document.getElementById("filterListingType").value = searchFilters.transactionType;
            }
            if (searchFilters.propertyCategory) {
                document.getElementById("filterPropertyCategory").value = searchFilters.propertyCategory;
            }
            if (searchFilters.propertyType) {
                document.getElementById("filterPropertyType").value = searchFilters.propertyType;
            }
            if (searchFilters.searchTerm) {
                document.getElementById("filterName").value = searchFilters.searchTerm;
            }
            // Update dropdowns
            updateCategoryDropdown();
        } catch (error) {
            console.error("Error parsing filters from URL:", error);
        }
    }
}

// Update active filters display
function updateActiveFiltersDisplay() {
    const activeFiltersContainer = document.getElementById('activeFilters');
    const resultsBadge = document.getElementById('resultsBadge');
    const resultsNumber = document.getElementById('resultsNumber');
    
    if (Object.keys(searchFilters).length > 0) {
        activeFiltersContainer.innerHTML = '';
        
        Object.entries(searchFilters).forEach(([key, value]) => {
            if (value) {
                const filterTag = document.createElement('div');
                filterTag.className = 'filter-tag';
                filterTag.style.cssText = `
                    display: inline-flex;
                    align-items: center;
                    gap: 5px;
                    background: var(--primary-light);
                    color: white;
                    padding: 4px 10px;
                    border-radius: 15px;
                    font-size: 12px;
                    margin-right: 8px;
                    margin-bottom: 8px;
                `;
                
                let displayKey = key;
                if (key === 'transactionType') displayKey = 'Type';
                if (key === 'propertyCategory') displayKey = 'Category';
                if (key === 'propertyType') displayKey = 'Property';
                if (key === 'searchTerm') displayKey = 'Keyword';
                
                filterTag.innerHTML = `
                    <span>${displayKey}: ${value}</span>
                    <button class="remove-filter" data-filter="${key}" style="background: none; border: none; color: white; cursor: pointer; font-size: 14px; margin-left: 4px;">√ó</button>
                `;
                activeFiltersContainer.appendChild(filterTag);
            }
        });
        
        activeFiltersContainer.style.display = 'flex';
        activeFiltersContainer.style.flexWrap = 'wrap';
        
        // Add event listeners to remove buttons
        activeFiltersContainer.querySelectorAll('.remove-filter').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const filterKey = this.getAttribute('data-filter');
                removeFilter(filterKey);
            });
        });
    } else {
        activeFiltersContainer.style.display = 'none';
    }
}

// Remove individual filter
function removeFilter(filterKey) {
    if (searchFilters[filterKey]) {
        delete searchFilters[filterKey];
        
        // Update form
        if (filterKey === 'location') document.getElementById('filterLocation').value = '';
        if (filterKey === 'transactionType') document.getElementById('filterListingType').value = '';
        if (filterKey === 'propertyCategory') document.getElementById('filterPropertyCategory').value = '';
        if (filterKey === 'propertyType') document.getElementById('filterPropertyType').value = '';
        if (filterKey === 'searchTerm') document.getElementById('filterName').value = '';
        
        // Update dropdowns
        updateCategoryDropdown();
        
        // Apply filters and update URL
        applyFilters();
    }
}

// --- HELPER FUNCTIONS FOR AI RECOMMENDATIONS ---

// Simple logSearchEvent function
async function logSearchEvent(userId, filters) {
    try {
        const eventsRef = collection(db, 'events');
        await addDoc(eventsRef, {
            userId: userId,
            eventType: 'search',
            metadata: { filters: filters },
            timestamp: new Date()
        });
        console.log('Logged search event for user ${userId}');
        return true;
    } catch (error) {
        console.error("Failed to log search event:", error);
        return false;
    }
}

// Simple logSaveEvent function
async function logSaveEvent(userId, propertyId) {
    try {
        const eventsRef = collection(db, 'events');
        await addDoc(eventsRef, {
            userId: userId,
            eventType: 'save',
            metadata: { propertyId: propertyId },
            timestamp: new Date()
        });
        console.log('Logged save event for user ${userId}, property ${propertyId}');
        return true;
    } catch (error) {
        console.error("Failed to log save event:", error);
        return false;
    }
}

// --- FILTER FUNCTIONS ---

// Apply filters function for this page
async function applyFilters() {
    // Collect filter values
    const filters = {
        location: document.getElementById('filterLocation').value || undefined,
        transactionType: document.getElementById('filterListingType').value || undefined,
        propertyCategory: document.getElementById('filterPropertyCategory').value || undefined,
        propertyType: document.getElementById('filterPropertyType').value || undefined,
        searchTerm: document.getElementById('filterName').value || undefined
    };
    
    // Clean filters (remove undefined values)
    const cleanFilters = Object.fromEntries(
        Object.entries(filters).filter(([key, value]) => value !== undefined)
    );
    
    // Update searchFilters and reload
    searchFilters = cleanFilters;

    // Load listings with filters
    await loadAllListings();

    // Update URL without reloading
    const newUrl = new URL(window.location);
    newUrl.searchParams.set('filters', encodeURIComponent(JSON.stringify(cleanFilters)));
    window.history.pushState({}, '', newUrl);

    // Log search event for AI recommendations (only if user is logged in)
    try {
        const currentUser = auth.currentUser;
        if (currentUser && Object.keys(cleanFilters).length > 0) {
            await logSearchEvent(currentUser.uid, cleanFilters);
            console.log('‚úîÔ∏è Search event logged for AI recommendations');
        }
    } catch (error) {
        console.log('Could not log search event', error.message);
    }
}

// Reset filters function
function resetFilters() {
    document.getElementById('filterLocation').value = "";
    document.getElementById('filterListingType').value = "";
    document.getElementById('filterPropertyCategory').value = "";
    document.getElementById('filterPropertyType').value = "";
    document.getElementById('filterName').value = "";

    // Reset dropdowns to default state
    updateCategoryDropdown();

    // Clear search filters and reload
    searchFilters = {};
    loadAllListings();

    // Clear URL parameters
    window.history.pushState({}, '', 'search_results.html');
}

// Attach event listeners
document.getElementById('applyFilters').addEventListener('click', applyFilters);
document.getElementById('resetFilters').addEventListener('click', resetFilters);

// --- AUTHENTICATION ---

// Check authentication and load data
onAuthStateChanged(auth, async (user) => {
    if (user) {
        // User is signed in
        isUserAuthenticated = true;
        console.log('User is authenticated:', user.uid);

        // Load listings (with or without filters)
        await loadAllListings();
    } else {
        // User is not signed in, but still allow browsing
        isUserAuthenticated = false;
        console.log('User is not authenticated, allowing guest browsing');

        // Load listings (with or without filters) - guests can still browse
        await loadAllListings();
    }
});

// ============================== LISTINGS FUNCTIONS ==============================

async function loadAllListings() {
    try {
        console.log('[ ] Loading all listings...');

        // Fetch ALL properties
        const listingsQuery = query(collection(db, "properties"));
        const querySnapshot = await getDocs(listingsQuery);

        allListings = [];
        const userIds = new Set();

        querySnapshot.forEach((doc) => {
            const listing = {
                id: doc.id,
                ...doc.data()
            };
            allListings.push(listing);

            // Collect user IDs
            if (listing.userId) {
                userIds.add(listing.userId);
            } else if (listing.ownerId) {
                userIds.add(listing.ownerId);
            }
        });

        console.log(`Found ${allListings.length} listings total`);

        await loadAllUserData(userIds);

        // Display filtered listings
        displayFilteredListings();

    } catch (error) {
        console.error("Error loading listings:", error);
        displayError(error);
    }
}

async function loadAllUserData(userIds) {
    userMap.clear();

    if (userIds.size == 0) {
        console.log("No user IDs found to load");
        return;
    }

    console.log(`Loading user data for ${userIds.size} users...`);

    for (const userId of userIds) {
        await loadUserData(userId);
    }
}

async function loadUserData(userId) {
    try {
        // First try users collection
        const userDoc = await getDoc(doc(db, "users", userId));
        
        if (userDoc.exists()) {
            const userData = userDoc.data();
            const fullName = userData.fullName || 
                userData.firstName + ' ' + (userData.lastName || '') || 
                userData.email?.split('@')[0] || 
                `User ${userId.substring(0, 8)}`;
            
            userMap.set(userId, {
                displayName: fullName.trim(),
                email: userData.email || 'Email not available',
                phone: userData.phone || 'Phone not available',
                role: userData.role || 'user'
            });
            return;
        }
        
        // Then try landlords collection
        const landlordDoc = await getDoc(doc(db, "landlords", userId));
        
        if (landlordDoc.exists()) {
            const landlordData = landlordDoc.data();
            const fullName = landlordData.fullName || 
                landlordData.firstName + ' ' + (landlordData.lastName || '') || 
                landlordData.email?.split('@')[0] || 
                `Landlord ${userId.substring(0, 8)}`;
            
            userMap.set(userId, {
                displayName: fullName.trim(),
                email: landlordData.email || 'Email not available',
                phone: landlordData.phone || 'Phone not available',
                role: 'landlord'
            });
            return;
        }
        
        // Then try brokers collection
        const brokerDoc = await getDoc(doc(db, "brokers", userId));
        
        if (brokerDoc.exists()) {
            const brokerData = brokerDoc.data();
            const fullName = brokerData.fullName || 
                brokerData.firstName + ' ' + (brokerData.lastName || '') || 
                brokerData.email?.split('@')[0] || 
                `Broker ${userId.substring(0, 8)}`;
            
            userMap.set(userId, {
                displayName: fullName.trim(),
                email: brokerData.email || 'Email not available',
                phone: brokerData.phone || 'Phone not available',
                role: 'broker'
            });
            return;
        }
        
        // Default fallback
        userMap.set(userId, {
            displayName: `User ${userId.substring(0, 8)}`,
            email: 'Email not available',
            phone: 'Phone not available',
            role: 'user'
        });
        
    } catch (error) {
        console.error(`Error loading user ${userId}:`, error);
        userMap.set(userId, {
            displayName: `User ${userId.substring(0, 8)}`,
            email: 'Email not available',
            phone: 'Phone not available',
            role: 'user'
        });
    }
}

function displayFilteredListings() {
    // Filter active listings
    let filtered = allListings.filter(listing => {
        return listing.status === 'active' ||
            listing.status === 'available' ||
            listing.status === 'Active' ||
            (listing.status === undefined && listing.isActive !== false);
    });

    // Apply filters if any
    if (Object.keys(searchFilters).length > 0) {
        // Apply location filter
        if (searchFilters.location) {
            filtered = filtered.filter(listing =>
                (listing.location || "").includes(searchFilters.location) ||
                (listing.city || "").includes(searchFilters.location) ||
                (listing.province || "").includes(searchFilters.location)
            );
        }
        
        // Apply transaction type filter
        if (searchFilters.transactionType) {
            filtered = filtered.filter(listing =>
                getListingType(listing) === searchFilters.transactionType.toLowerCase()
            );
        }
        
        // Apply property category filter
        if (searchFilters.propertyCategory) {
            filtered = filtered.filter(listing => {
                const propertyType = (listing.propertyType || "").toLowerCase();
                const propertyCategory = (listing.propertyCategory || "").toLowerCase();
                const listingTitle = (listing.title || "").toLowerCase();
                const listingDescription = (listing.description || "").toLowerCase();
                const searchText = `${propertyType} ${propertyCategory} ${listingTitle} ${listingDescription}`;

                const categoryName = searchFilters.propertyCategory.toLowerCase();

                // Check category-specific keywords
                if (categoryName.includes("residential")) {
                    const residentialKeywords = ['house', 'apartment', 'condo', 'condominium', 'townhouse', 'dormitory', 'room', 'bedspace', 'residential', 'home', 'villa', 'bungalow', 'duplex'];
                    return residentialKeywords.some(keyword =>
                        searchText.includes(keyword) ||
                        propertyType.includes(keyword) ||
                        propertyCategory.includes(keyword)
                    );
                }

                if (categoryName.includes("commercial")) {
                    const commercialKeywords = ['commercial', 'office', 'retail', 'shop', 'kiosk', 'stall', 'store', 'mall', 'business', 'establishment', 'showroom'];
                    return commercialKeywords.some(keyword =>
                        searchText.includes(keyword) ||
                        propertyType.includes(keyword) ||
                        propertyCategory.includes(keyword)
                    );
                }

                if (categoryName.includes("industrial")) {
                    const industrialKeywords = ['industrial', 'warehouse', 'factory', 'storage', 'manufacturing', 'plant', 'facility', 'workshop'];
                    return industrialKeywords.some(keyword =>
                        searchText.includes(keyword) ||
                        propertyType.includes(keyword) ||
                        propertyCategory.includes(keyword)
                    );
                }

                if (categoryName.includes('land') || categoryName.includes('lot')) {
                    const landKeywords = ['land', 'lot', 'plot', 'agricultural', 'farm', 'agriculture', 'property', 'vacant', 'empty', 'beachfront'];
                    return landKeywords.some(keyword =>
                        searchText.includes(keyword) ||
                        propertyType.includes(keyword) ||
                        propertyCategory.includes(keyword)
                    );
                }

                if (categoryName.includes('special') || categoryName.includes('purpose')) {
                    const specialKeywords = ['resort', 'event', 'venue', 'school', 'sports', 'facility', 'special', 'purpose', 'institutional', 'hotel', 'motel', 'inn', 'parking', 'hospitality'];
                    return specialKeywords.some(keyword =>
                        searchText.includes(keyword) ||
                        propertyType.includes(keyword) ||
                        propertyCategory.includes(keyword)
                    );
                }

                if (categoryName.includes('condominium') || categoryName.includes('condo')) {
                    const condoKeywords = ['condominium', 'condo', 'penthouse', 'studio unit', 'loft unit'];
                    return condoKeywords.some(keyword =>
                        searchText.includes(keyword) ||
                        propertyType.includes(keyword) ||
                        propertyCategory.includes(keyword)
                    );
                }

                // Fallback: exact match
                return propertyCategory.includes(categoryName) ||
                    listingTitle.includes(categoryName) ||
                    propertyType.includes(categoryName);
            });
        }
        
        // Apply property type filter
        if (searchFilters.propertyType) {
            filtered = filtered.filter(listing =>
                listing.propertyType === searchFilters.propertyType
            );
        }
        
        // Apply name/keyword filter
        if (searchFilters.searchTerm) {
            const searchTerm = searchFilters.searchTerm.toLowerCase().trim();
            filtered = filtered.filter(listing =>
                (listing.title || "").toLowerCase().includes(searchTerm) ||
                (listing.description || "").toLowerCase().includes(searchTerm)
            );
        }
    }

    // Update search summary
    const searchSummary = document.getElementById('searchSummary');
    const resultsCount = document.getElementById('resultsCount');
    const resultsTitle = document.getElementById('resultsTitle');
    const resultsBadge = document.getElementById('resultsBadge');
    const resultsNumber = document.getElementById('resultsNumber');

    if (Object.keys(searchFilters).length > 0) {
        let summaryText = `Found ${filtered.length} properties`;
        let filterParts = [];

        if (searchFilters.location) filterParts.push(`Location: ${searchFilters.location}`);
        if (searchFilters.transactionType) filterParts.push(`Type: ${searchFilters.transactionType}`);
        if (searchFilters.propertyCategory) filterParts.push(`Category: ${searchFilters.propertyCategory}`);
        if (searchFilters.propertyType) filterParts.push(`Property: ${searchFilters.propertyType}`);
        if (searchFilters.searchTerm) filterParts.push(`Keyword: "${searchFilters.searchTerm}"`);

        if (filterParts.length > 0) {
            summaryText += ` matching ${filterParts.join(', ')}`;
        }

        searchSummary.innerHTML = `<i class="fas fa-check-circle" style="color: #10b981;"></i> ${summaryText}`;
        resultsCount.textContent = summaryText;
        resultsTitle.innerHTML = `<i class="fas fa-search"></i> Search Results (${filtered.length})`;
        
        // Update results badge
        resultsNumber.textContent = filtered.length;
        resultsBadge.style.display = 'inline-flex';
        resultsBadge.style.cssText = `
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            align-items: center;
            gap: 5px;
        `;
    } else {
        searchSummary.innerHTML = `<i class="fas fa-building"></i> Showing ${filtered.length} properties in Batangas`;
        resultsCount.textContent = `Showing ${filtered.length} properties in Batangas`;
        resultsTitle.innerHTML = `<i class="fas fa-building"></i> All Properties in Batangas (${filtered.length})`;
        
        // Update results badge
        resultsNumber.textContent = filtered.length;
        resultsBadge.style.display = 'inline-flex';
        resultsBadge.style.cssText = `
            background: var(--secondary);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            align-items: center;
            gap: 5px;
        `;
    }
    
    // Update active filters display
    updateActiveFiltersDisplay();

    // Display filtered listings
    if (filtered.length === 0) {
        displayNoListings();
    } else {
        displayListings(filtered);
    }
}

async function checkSavedStatus(listings) {
    try {
        const currentUser = auth.currentUser;
        if (!currentUser) return new Map();

        const savedRef = collection(db, 'savedProperties');
        const q = query(savedRef, where('userId', '==', currentUser.uid));
        const snapshot = await getDocs(q);

        const savedMap = new Map();
        snapshot.forEach(doc => {
            savedMap.set(doc.data().propertyId, true);
        });
        return savedMap;
    } catch (error) {
        console.error("Error checking saved status:", error);
        return new Map();
    }
}

async function displayListings(listings) {
    const container = document.getElementById('listingsContainer');
    // Check which properties are already saved (only if user is logged in)
    const savedMap = await checkSavedStatus(listings);
    
    container.innerHTML = listings.map(listing => {
        const isSaved = savedMap.has(listing.id);
        const userInfo = userMap.get(listing.userId) || {
            displayName: listing.userId ? `User ${listing.userId.substring(0, 8)}` : 'Unknown',
            email: 'N/A',
            phone: 'N/A',
            role: 'user'
        };

        const userInitials = userInfo.displayName.split(' ').map(n => n[0]).join('').toUpperCase() || 'UU';
        const listingType = getListingType(listing);
        const displayPrice = getDisplayPrice(listing);
        const priceClass = getPriceClass(listing);
        const typeBadgeClass = getTypeBadgeClass(listing);
        const typeBadgeText = getTypeBadgeText(listing);

        // Get complete address
        const completeAddress = getCompleteAddress(listing);

        let mainPhoto;
        if (listing.photos && listing.photos.length > 0) {
            mainPhoto = listing.photos[0];
        } else if (listing.imageUrls && listing.imageUrls.length > 0) {
            mainPhoto = listing.imageUrls[0];
        } else if (listing.latitude && listing.longitude) {
            mainPhoto = `https://maps.googleapis.com/maps/api/staticmap?center=${listing.latitude},${listing.longitude}&zoom=15&size=400x200&markers=color:red%7C${listing.latitude},${listing.longitude}&key=${GOOGLE_MAPS_API_KEY}`;
        } else {
            mainPhoto = 'https://via.placeholder.com/400x200/0b2e52/white?text=No+Image';
        }

        const bedrooms = listing.bedrooms || (listingType === 'rent' && listing.propertyType === 'studio' ? 'Studio' : 0);
        const bathrooms = listing.bathrooms || 0;
        const area = listing.floorArea || listing.totalArea || 'N/A';

        return `
        <div class="listing-card-wrapper">
            <a href="property_details.html?id=${listing.id}" class="listing-card-link">
                <div class="listing-card">
                    <div class="listing-card-image-container">
                        <img src="${mainPhoto}" alt="${listing.title || 'Property'}" class="listing-image">
                        <div class="listing-type-badge ${typeBadgeClass}">${typeBadgeText}</div>
                        
                        <!-- Save Button - Only show if authenticated -->
                        ${isUserAuthenticated ? `
                        <button class="save-property-btn" 
                                data-property-id="${listing.id}" 
                                data-is-saved="${isSaved}"
                                aria-label="${isSaved ? 'Remove from saved' : 'Save property'}">
                            <span class="save-icon">${isSaved ? '‚ù§Ô∏è' : 'ü§ç'}</span>
                        </button>
                        ` : ''}
                    </div>
                    
                    <div class="listing-content">
                        <div class="listing-header">
                            <div>
                                <h3 class="listing-title">${listing.title || 'Untitled Property'}</h3>
                                <div class="listing-location">
                                    <span class="location-icon">üìç</span>
                                    <span class="location-text">${completeAddress}</span>
                                </div>
                            </div>
                            <div class="listing-price ${priceClass}">${displayPrice}</div>
                        </div>
                        
                        <div class="listing-details">
                            ${bedrooms ? `
                            <div class="detail">
                                <span class="detail-icon">üõè</span>
                                <span class="detail-text">${bedrooms} ${bedrooms === 'Studio' ? '' : 'beds'}</span>
                            </div>
                            ` : ''}
                            
                            ${bathrooms ? `
                            <div class="detail">
                                <span class="detail-icon">üöø</span>
                                <span class="detail-text">${bathrooms} baths</span>
                            </div>
                            ` : ''}
                            
                            ${area && area !== 'N/A' ? `
                            <div class="detail">
                                <span class="detail-icon">üìê</span>
                                <span class="detail-text">${area} sqm</span>
                            </div>
                            ` : ''}
                            
                            ${listingType === 'rent' && listing.securityDeposit ? `
                            <div class="detail">
                                <span class="detail-icon">üí∞</span>
                                <span class="detail-text">Deposit: ‚Ç±${listing.securityDeposit.toLocaleString()}</span>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="listing-broker">
                            <div class="broker-avatar">${userInitials}</div>
                            <div class="broker-info">
                                <div class="broker-name">${userInfo.displayName}</div>
                                <div class="broker-contact">
                                    ${getRoleDisplayText(userInfo.role)} ‚Ä¢ ${listing.propertyType || 'Property'}
                                </div>
                            </div>
                        </div>
                        
                        <div class="listing-actions">
                            <button class="action-btn contact-btn" 
                                    data-user-id="${listing.userId}"
                                    data-user-name="${userInfo.displayName}"
                                    aria-label="Contact ${userInfo.role === 'landlord' ? 'owner' : 'broker'}">
                                <span class="contact-icon">üìû</span>
                                Contact ${userInfo.role === 'landlord' ? 'Owner' : 'Broker'}
                            </button>
                            <button class="action-btn view-btn" aria-label="View property details">
                                <span class="view-icon">üëÅÔ∏è</span>
                                View Details
                            </button>
                        </div>
                    </div>
                </div>
            </a>
        </div>`;
    }).join('');
    
    // Add event listeners to the newly created elements
    setupListingEventListeners();
    
    // Force badges to be visible
    setTimeout(forceBadgeVisibility, 100);
}

function setupListingEventListeners() {
    // Save property buttons
    document.querySelectorAll('.save-property-btn').forEach(btn => {
        // Remove existing and add new listener
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        newBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            const propertyId = this.getAttribute('data-property-id');
            if (propertyId) {
                toggleSaveProperty(propertyId, this);
            }
        });
    });

    // Contact buttons - prevent card click when clicking contact button
    document.querySelectorAll('.action-btn.contact-btn').forEach(btn => {
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        newBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            const userId = this.getAttribute('data-user-id');
            if (userId) {
                window.contactBroker(userId);
            }
        });
    });
}

function displayNoListings() {
    const container = document.getElementById('listingsContainer');
    const resultsTitle = document.getElementById('resultsTitle');
    const resultsCount = document.getElementById('resultsCount');
    const resultsBadge = document.getElementById('resultsBadge');

    if (Object.keys(searchFilters).length > 0) {
        container.innerHTML = `
        <div class="empty-state">
            <div class="empty-state-icon">üîç</div>
            <h3>No Properties Found</h3>
            <p>There are currently no properties matching your search criteria.</p>
            <button class="search-button" onclick="resetFilters()" style="margin-top: 20px;">
                <i class="fas fa-redo"></i>
                Reset Filters
            </button>
            <button class="search-button" onclick="window.location.href='buyer_dashboard.html'" style="margin-top: 10px; background: var(--secondary);">
                <i class="fas fa-arrow-left"></i>
                Back to Dashboard
            </button>
        </div>`;

        resultsTitle.innerHTML = '<i class="fas fa-search"></i> No Results Found';
        resultsCount.textContent = "No properties match your search criteria";
        resultsBadge.style.display = 'none';
    } else {
        container.innerHTML = `
        <div class="empty-state">
            <div class="empty-state-icon">üè†</div>
            <h3>No Properties Available</h3>
            <p>There are currently no properties available in Batangas.</p>
            <button class="search-button" onclick="loadAllListings()" style="margin-top: 20px;">
                <i class="fas fa-redo"></i>
                Try Again
            </button>
        </div>`;

        resultsTitle.innerHTML = '<i class="fas fa-building"></i> All Properties in Batangas';
        resultsCount.textContent = "No properties available";
        resultsBadge.style.display = 'none';
    }
}

function displayError(error) {
    const container = document.getElementById('listingsContainer');
    const resultsBadge = document.getElementById('resultsBadge');
    
    container.innerHTML = `
    <div class="error-state">
        <div class="error-icon">‚ö†Ô∏è</div>
        <h3>Error Loading Properties</h3>
        <p>There was an error loading the property listings.</p>
        <button class="search-button" onclick="loadAllListings()" style="margin-top: 20px;">
            <i class="fas fa-redo"></i>
            Try Again
        </button>
    </div>`;
    
    resultsBadge.style.display = 'none';
}

// ====================== EVENT HANDLERS ============================

async function toggleSaveProperty(propertyId, buttonElement) {
    try {
        const currentUser = auth.currentUser;
        if (!currentUser) {
            alert('Please login to save properties');
            window.location.href = '../login.html';
            return;
        }

        const isSaved = buttonElement.querySelector('.save-icon').textContent.includes("‚ù§Ô∏è");
        if (isSaved) {
            // Remove from saved
            const savedRef = collection(db, 'savedProperties');
            const q = query(savedRef,
                where('userId', '==', currentUser.uid),
                where('propertyId', '==', propertyId)
            );
            const snapshot = await getDocs(q);

            if (!snapshot.empty) {
                await deleteDoc(snapshot.docs[0].ref);
                buttonElement.querySelector('.save-icon').textContent = 'ü§ç';
                buttonElement.setAttribute('data-is-saved', 'false');
                buttonElement.setAttribute('aria-label', 'Save property');
                console.log(`Property ${propertyId} removed from saved`);
                showSaveToast('Removed from saved', false);
            }
        } else {
            // Add to saved
            await addDoc(collection(db, 'savedProperties'), {
                userId: currentUser.uid,
                propertyId: propertyId,
                savedAt: new Date(),
                createdAt: new Date(),
            });

            // Log save event for AI recommendations
            await logSaveEvent(currentUser.uid, propertyId);

            buttonElement.querySelector('.save-icon').textContent = '‚ù§Ô∏è';
            buttonElement.setAttribute('data-is-saved', 'true');
            buttonElement.setAttribute('aria-label', 'Remove from saved');
            console.log(`Property ${propertyId} saved`);
            showSaveToast('Property saved!', false);
        }
    } catch (error) {
        console.error("Error toggling save:", error);
        showSaveToast("Error saving property", true);
    }
}

function showSaveToast(message, isError = false) {
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${isError ? '#ef4444' : '#10b981'};
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    z-index: 9999;
    font-weight: 500;
    box-shadow: var(--shadow-lg);
    animation: slideIn 0.3s ease;
    `;

    document.body.appendChild(toast);

    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// =========================== WINDOW FUNCTIONS ==========================

window.applyFilters = applyFilters;
window.resetFilters = resetFilters;
window.loadAllListings = loadAllListings;
window.toggleSaveProperty = toggleSaveProperty;

// ====================== CSS ANIMATIONS ============================

const style = document.createElement('style');
style.textContent = `
@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Filter tags styling */
.filter-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
}

.filter-tag {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    background: var(--primary-light);
    color: white;
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 12px;
    margin-right: 8px;
    margin-bottom: 8px;
    animation: fadeIn 0.3s ease;
}

.filter-tag .remove-filter {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    font-size: 14px;
    margin-left: 4px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 16px;
    height: 16px;
}

.filter-tag .remove-filter:hover {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
}

/* Results badge */
.results-count-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    animation: fadeIn 0.3s ease;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .properties-section > div:first-child {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
    }
    
    .filter-tags {
        width: 100%;
    }
    
    .results-count-badge {
        align-self: flex-start;
        margin-top: 10px;
    }
}
`;
document.head.appendChild(style);
</script>

</body>
</html>