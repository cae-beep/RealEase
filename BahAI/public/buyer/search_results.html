<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Search Results - BahAI Real Estate</title>
<link
href="https://fonts.googleapis.com/css227family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="search_results.css">
</head>

<body>
<!-- Mobile Menu Toggle -->
<button class="mobile-menu-toggle" id="mobileMenuToggle">‚â°</button>

<!-- Include Sidebar -->
<div id="sidebar-container"></div>

<!-- Main -->
<div class="container">
<!-- Hero Section -->
<div class="hero-section">
<h1>Search Results</h1>
<p>Properties matching your search criteria</p>
<div id="searchSummary" style="font-weight: 500; opacity: 0.9; font-size: 16px;">Loading results...</div>
</div>

<!-- Search Section -->
<div class="search-section">
    <div class="search-title">
    <i class="fas fa-search"></i>
    Refine Your Search
</div>

<div class="search-grid">
    <!-- Location Filter -->
    <div class="search-group">
    <label class="search-label">Select City/Municipality</label>
    <select class="search-select" id="filterLocation">
    <option value="">All of Batangas</option>
    <option value="Batangas City">Batangas City</option>
    <option value="Lipa City">Lipa City</option>
    <option value="Tanauan City">Tanauan City</option>
    <option value="Bauan">Bauan</option>
    <option value="Balayan">Balayan</option>
    <option value="Calaca">Calaca</option>
    <option value="Lemery">Lemery</option>
    <option value="Nasugbu">Nasugbu</option>
    <option value="San Juan">San Juan</option>
    <option value="Taal">Taal</option>
    <option value="Talisay">Talisay</option>
    <option value="Alitagtag">Alitagtag</option>
    <option value="Cuenca">Cuenca</option>
    <option value="Laurel">Laurel</option>
    <option value="Mataasnakahoy">Mataasnakahoy</option>
    <option value="San Jose">San Jose</option>
    <option value="San Luis">San Luis</option>
    <option value="San Pascual">San Pascual</option>
    <option value="Santo Tomas">Santo Tomas</option>
</select>
</div>

<!-- Transaction Type Filter -->
<div class="search-group">
    <label class="search-label">Transaction Type</label>
    <select class="search-select" id="filterListingType">
    <option value="">All Types</option>
    <option value="sale">For Sale</option>
    <option value="rent">For Rent</option>
    <option value="lease">For Lease</option>
    </select>
</div>

<!-- Property Category Filter (Dynamic based on transaction type) -->
<div class="search-group">
    <label class="search-label">Property Category</label>
    <select class="search-select" id="filterPropertyCategory">
    <option value="">All Categories</option>
    <!-- Options will be populated dynamically -->
    </select>
</div>

<!-- Property Type Filter (Dynamic based on category) -->
<div class="search-group">
    <label class="search-label">Property Type</label>
    <select class="search-select" id="filterPropertyType">
    <option value="">All Types</option>
    <!-- Options will be populated dynamically -->
    </select>
</div>

<!-- Search by Name/Keyword -->
<div class="search-group">
    <label class="search-label">Search Property</label>
    <input type="text" class="search-input" id="filterName" placeholder="Enter property name or keyword...">
    </div>
</div>

<div class="search-actions">
<button class="search-button" id="applyFilters">
    <i class="fas fa-search"></i>
    Search Properties
</button>
<button class="reset-button" id="resetFilters">
    <i class="fas fa-redo"></i>
    Reset Filters
</button>
<button class="reset-button back-button" id="backToDashboard">
    <i class="fas fa-arrow-left"></i>
    Back to Dashboard
</button>
</div>
</div>

<!-- Search Results Section -->
<div class="properties-section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <div>
            <h2 class="section-title" id="resultsTitle">
                <i class="fas fa-search"></i>
                Search Results
            </h2>
            <p style="color: var(--text-light); margin-bottom: 25px; font-size: 15px;" id="resultsCount">
                Loading results...
            </p>
        </div>
        <div id="sortOptions" style="display: none;">
            <!-- Sorting options can be added here if needed -->
        </div>
    </div>

    <!-- Results Grid -->
    <div class="listings-grid" id="listingsContainer">
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Loading search results...</p>
        </div>
    </div>
</div>

</div>

<!-- Sidebar Loader -->
<script>
// Mobile menu functionality
document.getElementById('mobileMenuToggle').addEventListener('click', function() {
    const sidebar = document.querySelector('.sidebar');
    if (sidebar) {
        sidebar.classList.toggle('active');
    }
});

// Close sidebar when clicking on a link (mobile)
document.addEventListener('click', function(e) {
    if (window.innerWidth <= 1024) {
        if (e.target.closest('.sidebar-link')) {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.remove('active');
            }
        }
    }
});

// Load sidebar
fetch('sidebar.html')
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to load sidebar: ' + response.status);
        }
        return response.text();
    })
    .then(html => {
        document.getElementById('sidebar-container').innerHTML = html;

        // Highlight active link
        const links = document.querySelectorAll('.sidebar-link');
        links.forEach(link => {
            if (link.getAttribute('href') === 'search_results.html') {
                link.classList.add('active');
            }
        });
        // Setup logout button
        setupLogoutButton();
    })
    .catch(error => {
        console.error("Error loading sidebar", error);
        document.getElementById("sidebar-container").innerHTML = 
            '<div class="sidebar" style="padding: 20px; background: #f8f9fa; color:#dc3545;">' +
            '<p>Unable to load navigation. Please refresh the page.</p>' +
            '</div>';
    });

// Handle window resize
window.addEventListener('resize', function() {
    const sidebar = document.querySelector('.sidebar');
    if (window.innerWidth > 1024 && sidebar) {
        sidebar.classList.remove('active');
    }
});

function setupLogoutButton() {
    const logoutBtn = document.getElementById("logoutBtn");
    if (!logoutBtn) {
        console.warn("Logout button not found, retrying...");
        setTimeout(setupLogoutButton, 100);
        return;
    }

    // Remove existing event listeners
    const newLogoutBtn = logoutBtn.cloneNode(true);
    logoutBtn.parentNode.replaceChild(newLogoutBtn, logoutBtn);

    // Add new event listener
    newLogoutBtn.addEventListener("click", async function(e) {
        e.preventDefault();
        e.stopPropagation();

        if (confirm("Are you sure you want to logout?")) {
            try {
                await signOut(auth);
                window.location.href = "./login.html";
            } catch (error) {
                console.error("Logout error:", error);
                alert("Error logging out. Please try again.");
            }
        }
    });

    console.log('Logout button initialized successfully');
}

// Back to Dashboard button
document.getElementById('backToDashboard').addEventListener('click', function() {
    window.location.href = 'buyer_dashboard.html';
});

</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import {
    getAuth,
    onAuthStateChanged,
    signOut
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import {
    getFirestore,
    collection,
    query,
    where,
    getDocs,
    getDoc,
    doc,
    addDoc,
    deleteDoc
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

// Firebase Config
const firebaseConfig = {
    apiKey: "AIzaSyClfzneDzWVveG8p_0mywoA9D9F5AyzZX4",
    authDomain: "bahai-1b76d.firebaseapp.com",
    projectId: "bahai-1b76d",
    storageBucket: "bahai-1b76d.firebasestorage.app",
    messagingSenderId: "646878644941",
    appId: "1:646878644941:web:5b4ccc3412250337587784"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const GOOGLE_MAPS_API_KEY = "AIzaSyBwwAkIEixelJysaGrMb9BfTsMwz_C9Noxk";

// Global variables
let allListings = [];
let userMap = new Map();
let searchFilters = {};
let isUserAuthenticated = false;

// Property category and type mappings based on transaction type
const PROPERTY_CATEGORIES = {
    'rent': [
        { category: 'Residential Property', types: ['Apartment', 'Condominium', 'Room / Bedspace', 'House', 'Dormitory'] },
        { category: 'Commercial Property', types: ['Office Unit', 'Retail Space / Shop', 'Food Stall / Kiosk'] },
        { category: 'Industrial Property', types: ['Warehouse', 'Factory', 'Storage Unit'] }
    ],
    'lease': [
        { category: 'Commercial Property', types: ['Office Floor', 'Commercial Building', 'Warehouse'] },
        { category: 'Land / Lot', types: ['Agricultural Lot', 'Commercial Lot', 'Industrial Lot'] },
        { category: 'Special Purpose Property', types: ['Resort Property', 'Event Venue', 'School Property', 'Sports Facility'] }
    ],
    'sale': [
        { category: 'Residential Property', types: ['House', 'Townhouse', 'Condominium', 'Apartment'] },
        { category: 'Commercial Property', types: ['Office Space', 'Retail Space / Shop', 'Commercial Building'] },
        { category: 'Land / Lot', types: ['Residential Lot', 'Commercial Lot', 'Agricultural Lot'] }
    ]
};

// --- HELPER FUNCTIONS ---

function getRoleDisplayText(role) {
    const roleMap = {
        'landlord': 'Property Owner',
        'seller': 'Property Seller',
        'broker': 'Licensed Broker',
        'agent': 'Property Agent',
        'admin': 'Administrator'
    };
    return roleMap[role] || 'Posted by';
}

function getListingType(listing) {
    if (listing.listingType === 'lease' || listing.type === 'lease') {
        return 'lease';
    }

    if (listing.listingType === 'rent' || listing.type === 'rent') {
        return 'rent';
    }

    if (listing.listingType === 'sale' || listing.type === 'sale') {
        return 'sale';
    }

    if (listing.monthlyRent !== undefined && listing.monthlyRent !== null && listing.monthlyRent > 0) {
        return 'rent';
    }

    if (listing.annualRent !== undefined && listing.annualRent !== null && listing.annualRent > 0) {
        return 'lease';
    }

    if ((listing.pricing !== undefined && listing.pricing !== null && listing.pricing > 0) ||
        (listing.salePrice !== undefined && listing.salePrice !== null && listing.salePrice > 0)) {
        return 'sale';
    }

    return 'sale';
}

function getDisplayPrice(listing) {
    const type = getListingType(listing);

    switch (type) {
        case 'rent':
            return 'P' + (listing.monthlyRent || 0).toLocaleString() + '/month';
        case 'lease':
            const annualRent = listing.annualRent || 0;
            return 'P' + annualRent.toLocaleString() + '/year';
        case 'sale':
        default:
            return 'P' + (listing.pricing || listing.salePrice || 0).toLocaleString();
    }
}

function getPriceClass(listing) {
    const type = getListingType(listing);

    switch (type) {
        case 'rent':
            return 'price-rent';
        case 'lease':
            return 'price-lease';
        case 'sale':
        default:
            return 'price-sale';
    }
}

function getTypeBadgeClass(listing) {
    const type = getListingType(listing);

    switch (type) {
        case 'rent':
            return 'type-rent';
        case 'lease':
            return 'type-lease';
        case 'sale':
        default:
            return 'type-sale';
    }
}

function getTypeBadgeText(listing) {
    const type = getListingType(listing);

    switch (type) {
        case 'rent':
            return 'FOR RENT';
        case 'lease':
            return 'FOR LEASE';
        case 'sale':
        default:
            return 'FOR SALE';
    }
}

// Address helper functions from dashboard
function getFullAddress(listing) {
    // If there's already a complete address in 'address' field
    if (listing.address && listing.address.includes(',') && listing.address.length > 10) {
        return listing.address;
    }

    // Build address from components
    const addressParts = [];
    
    // Add the basic location (street/landmark)
    if (listing.location) {
        addressParts.push(listing.location);
    } else if (listing.address) {
        addressParts.push(listing.address);
    }
    
    // Add city
    if (listing.city) {
        addressParts.push(listing.city);
    }
    
    // Add province
    if (listing.province) {
        addressParts.push(listing.province);
    }
    
    // If we have a city but no province, add "Philippines" as default
    if (addressParts.length === 1 && listing.city) {
        addressParts.push("Philippines");
    } else if (addressParts.length === 0) {
        return 'Location not specified';
    }
    
    return addressParts.join(', ');
}

function getCompleteAddress(listing) {
    // Priority: address (full) -> location (street) -> title
    const primaryAddress = listing.address || listing.location || listing.title || '';

    // Always append city and province if available
    let fullAddress = primaryAddress;

    if (listing.city) {
        fullAddress += ', ' + listing.city;
    }

    if (listing.province && listing.province !== 'Calabarzon') {
        fullAddress += ', ' + listing.province;
    }

    if (!listing.province && listing.city) {
        fullAddress += ', Philippines';
    }

    return fullAddress || 'Batangas, Philippines';
}

// ============================= CATEGORY DROPDOWN FUNCTIONS ============================

// Update category dropdown based on selected transaction type
function updateCategoryDropdown() {
    const transactionType = document.getElementById('filterListingType').value;
    const categorySelect = document.getElementById('filterPropertyCategory');
    const typeSelect = document.getElementById('filterPropertyType');

    // Reset both dropdowns
    categorySelect.innerHTML = '<option value="">All Categories</option>';
    typeSelect.innerHTML = '<option value="">All Types</option>';

    if (transactionType && PROPERTY_CATEGORIES[transactionType]) {
        // Populate categories based on transaction type
        PROPERTY_CATEGORIES[transactionType].forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.category;
            option.textContent = cat.category;
            categorySelect.appendChild(option);
        });
    } else {
        // If no transaction type selected, show all possible categories
        const allCategories = new Set();
        Object.values(PROPERTY_CATEGORIES).forEach(cats => {
            cats.forEach(cat => allCategories.add(cat.category));
        });
        allCategories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categorySelect.appendChild(option);
        });
    }

    // Update type dropdown
    updateTypeDropdown();
}

// Update type dropdown based on selected category
function updateTypeDropdown() {
    const transactionType = document.getElementById('filterListingType').value;
    const category = document.getElementById('filterPropertyCategory').value;
    const typeSelect = document.getElementById('filterPropertyType');

    typeSelect.innerHTML = '<option value="">All Types</option>';

    if (transactionType && category && PROPERTY_CATEGORIES[transactionType]) {
        const categoryData = PROPERTY_CATEGORIES[transactionType].find(cat =>
            cat.category === category);
        if (categoryData && categoryData.types) {
            categoryData.types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeSelect.appendChild(option);
            });
        }
    }
}

// Force all type badges to be visible
function forceBadgeVisibility() {
    document.querySelectorAll('.listing-type-badge').forEach(badge => {
        badge.style.opacity = '1';
        badge.style.visibility = 'visible';
        badge.style.display = 'block';
    });
}

// --- INITIALIZATION ---

// Initialize dropdowns when page loads
document.addEventListener('DOMContentLoaded', function() {
    const transactionTypeSelect = document.getElementById('filterListingType');
    const categorySelect = document.getElementById('filterPropertyCategory');

    if (transactionTypeSelect) {
        transactionTypeSelect.addEventListener('change', updateCategoryDropdown);
    }
    if (categorySelect) {
        categorySelect.addEventListener('change', updateTypeDropdown);
    }

    // Initialize with current values
    updateCategoryDropdown();

    // Load filters from URL parameters
    loadFiltersFromURL();
});

// Load filters from URL parameters
function loadFiltersFromURL() {
    const urlParams = new URLSearchParams(window.location.search);

    if (urlParams.has('filters')) {
        try {
            searchFilters = JSON.parse(decodeURIComponent(urlParams.get("filters")));
            // Set form values from filters
            if (searchFilters.location) {
                document.getElementById("filterLocation").value = searchFilters.location;
            }
            if (searchFilters.transactionType) {
                document.getElementById("filterListingType").value = searchFilters.transactionType;
            }
            if (searchFilters.propertyCategory) {
                document.getElementById("filterPropertyCategory").value = searchFilters.propertyCategory;
            }
            if (searchFilters.propertyType) {
                document.getElementById("filterPropertyType").value = searchFilters.propertyType;
            }
            if (searchFilters.searchTerm) {
                document.getElementById("filterName").value = searchFilters.searchTerm;
            }
            // Update dropdowns
            updateCategoryDropdown();
        } catch (error) {
            console.error("Error parsing filters from URL:", error);
        }
    }
}

// --- HELPER FUNCTIONS FOR AI RECOMMENDATIONS ---

// Simple logSearchEvent function
async function logSearchEvent(userId, filters) {
    try {
        const eventsRef = collection(db, 'events');
        await addDoc(eventsRef, {
            userId: userId,
            eventType: 'search',
            metadata: { filters: filters },
            timestamp: new Date()
        });
        console.log('Logged search event for user ${userId}');
        return true;
    } catch (error) {
        console.error("Failed to log search event:", error);
        return false;
    }
}

// Simple logSaveEvent function
async function logSaveEvent(userId, propertyId) {
    try {
        const eventsRef = collection(db, 'events');
        await addDoc(eventsRef, {
            userId: userId,
            eventType: 'save',
            metadata: { propertyId: propertyId },
            timestamp: new Date()
        });
        console.log('Logged save event for user ${userId}, property ${propertyId}');
        return true;
    } catch (error) {
        console.error("Failed to log save event:", error);
        return false;
    }
}

// --- FILTER FUNCTIONS ---

// Apply filters function for this page
window.applyFilters = async function() {
    // Collect filter values
    const filters = {
        location: document.getElementById('filterLocation').value || undefined,
        transactionType: document.getElementById('filterListingType').value || undefined,
        propertyCategory: document.getElementById('filterPropertyCategory').value || undefined,
        propertyType: document.getElementById('filterPropertyType').value || undefined,
        searchTerm: document.getElementById('filterName').value || undefined
    };
    
    // Clean filters (remove undefined values)
    const cleanFilters = Object.fromEntries(
        Object.entries(filters).filter(([key, value]) => value !== undefined)
    );
    
    // Update searchFilters and reload
    searchFilters = cleanFilters;

    // Load listings with filters
    await loadAllListings();

    // Update URL without reloading
    const newUrl = new URL(window.location);
    newUrl.searchParams.set('filters', encodeURIComponent(JSON.stringify(cleanFilters)));
    window.history.pushState({}, '', newUrl);

    // Log search event for AI recommendations (only if user is logged in)
    try {
        const currentUser = auth.currentUser;
        if (currentUser && Object.keys(cleanFilters).length > 0) {
            await logSearchEvent(currentUser.uid, cleanFilters);
            console.log('‚úîÔ∏è Search event logged for AI recommendations');
        }
    } catch (error) {
        console.log('Could not log search event', error.message);
    }
};

// Reset filters function
window.resetFilters = function() {
    document.getElementById('filterLocation').value = "";
    document.getElementById('filterListingType').value = "";
    document.getElementById('filterPropertyCategory').value = "";
    document.getElementById('filterPropertyType').value = "";
    document.getElementById('filterName').value = "";

    // Reset dropdowns to default state
    updateCategoryDropdown();

    // Clear search filters and reload
    searchFilters = {};
    loadAllListings();

    // Clear URL parameters
    window.history.pushState({}, '', 'search_results.html');
};

// Attach event listeners
document.getElementById('applyFilters').addEventListener('click', window.applyFilters);
document.getElementById('resetFilters').addEventListener('click', window.resetFilters);

// --- AUTHENTICATION ---

// Check authentication and load data
onAuthStateChanged(auth, async (user) => {
    if (user) {
        // User is signed in
        isUserAuthenticated = true;
        console.log('User is authenticated:', user.uid);

        // Load listings (with or without filters)
        await loadAllListings();
    } else {
        // User is not signed in, but still allow browsing
        isUserAuthenticated = false;
        console.log('User is not authenticated, allowing guest browsing');

        // Load listings (with or without filters) - guests can still browse
        await loadAllListings();
    }
});

// ============================== LISTINGS FUNCTIONS ==============================

async function loadAllListings() {
    try {
        console.log('[ ] Loading all listings...');

        // Fetch ALL properties
        const listingsQuery = query(collection(db, "properties"));
        const querySnapshot = await getDocs(listingsQuery);

        allListings = [];
        const userIds = new Set();

        querySnapshot.forEach((doc) => {
            const listing = {
                id: doc.id,
                ...doc.data()
            };
            allListings.push(listing);

            // Collect user IDs
            if (listing.userId) {
                userIds.add(listing.userId);
            } else if (listing.ownerId) {
                userIds.add(listing.ownerId);
            }
        });

        console.log(`Found ${allListings.length} listings total`);

        await loadAllUserData(userIds);

        // Display filtered listings
        displayFilteredListings();

    } catch (error) {
        console.error("Error loading listings:", error);
        displayError(error);
    }
}

async function loadAllUserData(userIds) {
    userMap.clear();

    if (userIds.size == 0) {
        console.log("No user IDs found to load");
        return;
    }

    console.log(`Loading user data for ${userIds.size} users...`);

    for (const userId of userIds) {
        await loadUserData(userId);
    }
}

async function loadUserData(userId) {
    try {
        // First try users collection
        const userDoc = await getDoc(doc(db, "users", userId));
        
        if (userDoc.exists()) {
            const userData = userDoc.data();
            const fullName = userData.fullName || 
                userData.firstName + ' ' + (userData.lastName || '') || 
                userData.email?.split('@')[0] || 
                `User ${userId.substring(0, 8)}`;
            
            userMap.set(userId, {
                displayName: fullName.trim(),
                email: userData.email || 'Email not available',
                phone: userData.phone || 'Phone not available',
                role: userData.role || 'user'
            });
            return;
        }
        
        // Then try landlords collection
        const landlordDoc = await getDoc(doc(db, "landlords", userId));
        
        if (landlordDoc.exists()) {
            const landlordData = landlordDoc.data();
            const fullName = landlordData.fullName || 
                landlordData.firstName + ' ' + (landlordData.lastName || '') || 
                landlordData.email?.split('@')[0] || 
                `Landlord ${userId.substring(0, 8)}`;
            
            userMap.set(userId, {
                displayName: fullName.trim(),
                email: landlordData.email || 'Email not available',
                phone: landlordData.phone || 'Phone not available',
                role: 'landlord'
            });
            return;
        }
        
        // Then try brokers collection
        const brokerDoc = await getDoc(doc(db, "brokers", userId));
        
        if (brokerDoc.exists()) {
            const brokerData = brokerDoc.data();
            const fullName = brokerData.fullName || 
                brokerData.firstName + ' ' + (brokerData.lastName || '') || 
                brokerData.email?.split('@')[0] || 
                `Broker ${userId.substring(0, 8)}`;
            
            userMap.set(userId, {
                displayName: fullName.trim(),
                email: brokerData.email || 'Email not available',
                phone: brokerData.phone || 'Phone not available',
                role: 'broker'
            });
            return;
        }
        
        // Default fallback
        userMap.set(userId, {
            displayName: `User ${userId.substring(0, 8)}`,
            email: 'Email not available',
            phone: 'Phone not available',
            role: 'user'
        });
        
    } catch (error) {
        console.error(`Error loading user ${userId}:`, error);
        userMap.set(userId, {
            displayName: `User ${userId.substring(0, 8)}`,
            email: 'Email not available',
            phone: 'Phone not available',
            role: 'user'
        });
    }
}

function displayFilteredListings() {
    // Filter active listings
    let filtered = allListings.filter(listing => {
        return listing.status === 'active' ||
            listing.status === 'available' ||
            listing.status === 'Active' ||
            (listing.status === undefined && listing.isActive !== false);
    });

    // Apply filters if any
    if (Object.keys(searchFilters).length > 0) {
        // Apply location filter
        if (searchFilters.location) {
            filtered = filtered.filter(listing =>
                (listing.location || "").includes(searchFilters.location) ||
                (listing.city || "").includes(searchFilters.location) ||
                (listing.province || "").includes(searchFilters.location)
            );
        }
        
        // Apply transaction type filter
        if (searchFilters.transactionType) {
            filtered = filtered.filter(listing =>
                getListingType(listing) === searchFilters.transactionType.toLowerCase()
            );
        }
        
        // Apply property category filter
        if (searchFilters.propertyCategory) {
            filtered = filtered.filter(listing => {
                const propertyType = (listing.propertyType || "").toLowerCase();
                const propertyCategory = (listing.propertyCategory || "").toLowerCase();
                const listingTitle = (listing.title || "").toLowerCase();
                const listingDescription = (listing.description || "").toLowerCase();
                const searchText = `${propertyType} ${propertyCategory} ${listingTitle} ${listingDescription}`;

                const categoryName = searchFilters.propertyCategory.toLowerCase();

                // Check category-specific keywords
                if (categoryName.includes("residential")) {
                    const residentialKeywords = ['house', 'apartment', 'condo', 'condominium', 'townhouse', 'dormitory', 'room', 'bedspace', 'residential', 'home', 'villa', 'bungalow', 'duplex'];
                    return residentialKeywords.some(keyword =>
                        searchText.includes(keyword) ||
                        propertyType.includes(keyword) ||
                        propertyCategory.includes(keyword)
                    );
                }

                if (categoryName.includes("commercial")) {
                    const commercialKeywords = ['commercial', 'office', 'retail', 'shop', 'kiosk', 'stall', 'store', 'mall', 'business', 'establishment', 'showroom'];
                    return commercialKeywords.some(keyword =>
                        searchText.includes(keyword) ||
                        propertyType.includes(keyword) ||
                        propertyCategory.includes(keyword)
                    );
                }

                if (categoryName.includes("industrial")) {
                    const industrialKeywords = ['industrial', 'warehouse', 'factory', 'storage', 'manufacturing', 'plant', 'facility', 'workshop'];
                    return industrialKeywords.some(keyword =>
                        searchText.includes(keyword) ||
                        propertyType.includes(keyword) ||
                        propertyCategory.includes(keyword)
                    );
                }

                if (categoryName.includes('land') || categoryName.includes('lot')) {
                    const landKeywords = ['land', 'lot', 'plot', 'agricultural', 'farm', 'agriculture', 'property', 'vacant', 'empty', 'beachfront'];
                    return landKeywords.some(keyword =>
                        searchText.includes(keyword) ||
                        propertyType.includes(keyword) ||
                        propertyCategory.includes(keyword)
                    );
                }

                if (categoryName.includes('special') || categoryName.includes('purpose')) {
                    const specialKeywords = ['resort', 'event', 'venue', 'school', 'sports', 'facility', 'special', 'purpose', 'institutional', 'hotel', 'motel', 'inn', 'parking', 'hospitality'];
                    return specialKeywords.some(keyword =>
                        searchText.includes(keyword) ||
                        propertyType.includes(keyword) ||
                        propertyCategory.includes(keyword)
                    );
                }

                if (categoryName.includes('condominium') || categoryName.includes('condo')) {
                    const condoKeywords = ['condominium', 'condo', 'penthouse', 'studio unit', 'loft unit'];
                    return condoKeywords.some(keyword =>
                        searchText.includes(keyword) ||
                        propertyType.includes(keyword) ||
                        propertyCategory.includes(keyword)
                    );
                }

                // Fallback: exact match
                return propertyCategory.includes(categoryName) ||
                    listingTitle.includes(categoryName) ||
                    propertyType.includes(categoryName);
            });
        }
        
        // Apply property type filter
        if (searchFilters.propertyType) {
            filtered = filtered.filter(listing =>
                listing.propertyType === searchFilters.propertyType
            );
        }
        
        // Apply name/keyword filter
        if (searchFilters.searchTerm) {
            const searchTerm = searchFilters.searchTerm.toLowerCase().trim();
            filtered = filtered.filter(listing =>
                (listing.title || "").toLowerCase().includes(searchTerm) ||
                (listing.description || "").toLowerCase().includes(searchTerm)
            );
        }
    }

    // Update search summary
    const searchSummary = document.getElementById('searchSummary');
    const resultsCount = document.getElementById('resultsCount');
    const resultsTitle = document.getElementById('resultsTitle');

    if (Object.keys(searchFilters).length > 0) {
        let summaryText = `Found ${filtered.length} properties`;
        let filterParts = [];

        if (searchFilters.location) filterParts.push(`Location: ${searchFilters.location}`);
        if (searchFilters.transactionType) filterParts.push(`Type: ${searchFilters.transactionType}`);
        if (searchFilters.propertyCategory) filterParts.push(`Category: ${searchFilters.propertyCategory}`);
        if (searchFilters.propertyType) filterParts.push(`Property: ${searchFilters.propertyType}`);
        if (searchFilters.searchTerm) filterParts.push(`Keyword: "${searchFilters.searchTerm}"`);

        if (filterParts.length > 0) {
            summaryText += ` matching ${filterParts.join(', ')}`;
        }

        searchSummary.textContent = summaryText;
        resultsCount.textContent = summaryText;
        resultsTitle.innerHTML = `<i class="fas fa-search"></i> Search Results (${filtered.length})`;
    } else {
        searchSummary.textContent = `Showing ${filtered.length} properties in Batangas`;
        resultsCount.textContent = `Showing ${filtered.length} properties in Batangas`;
        resultsTitle.innerHTML = `<i class="fas fa-building"></i> All Properties in Batangas (${filtered.length})`;
    }

    // Display filtered listings
    if (filtered.length === 0) {
        displayNoListings();
    } else {
        displayListings(filtered);
    }
}

async function checkSavedStatus(listings) {
    try {
        const currentUser = auth.currentUser;
        if (!currentUser) return new Map();

        const savedRef = collection(db, 'savedProperties');
        const q = query(savedRef, where('userId', '==', currentUser.uid));
        const snapshot = await getDocs(q);

        const savedMap = new Map();
        snapshot.forEach(doc => {
            savedMap.set(doc.data().propertyId, true);
        });
        return savedMap;
    } catch (error) {
        console.error("Error checking saved status:", error);
        return new Map();
    }
}

async function displayListings(listings) {
    const container = document.getElementById('listingsContainer');
    // Check which properties are already saved (only if user is logged in)
    const savedMap = await checkSavedStatus(listings);
    
    container.innerHTML = listings.map(listing => {
        const isSaved = savedMap.has(listing.id);
        const userInfo = userMap.get(listing.userId) || {
            displayName: listing.userId ? `User ${listing.userId.substring(0, 8)}` : 'Unknown',
            email: 'N/A',
            phone: 'N/A',
            role: 'user'
        };

        const userInitials = userInfo.displayName.split(' ').map(n => n[0]).join('').toUpperCase() || 'UU';
        const listingType = getListingType(listing);
        const displayPrice = getDisplayPrice(listing);
        const priceClass = getPriceClass(listing);
        const typeBadgeClass = getTypeBadgeClass(listing);
        const typeBadgeText = getTypeBadgeText(listing);

        // Get complete address
        const completeAddress = getCompleteAddress(listing);

        let mainPhoto;
        if (listing.photos && listing.photos.length > 0) {
            mainPhoto = listing.photos[0];
        } else if (listing.imageUrls && listing.imageUrls.length > 0) {
            mainPhoto = listing.imageUrls[0];
        } else if (listing.latitude && listing.longitude) {
            mainPhoto = `https://maps.googleapis.com/maps/api/staticmap?center=${listing.latitude},${listing.longitude}&zoom=15&size=400x200&markers=color:red%7C${listing.latitude},${listing.longitude}&key=${GOOGLE_MAPS_API_KEY}`;
        } else {
            mainPhoto = 'https://via.placeholder.com/400x200/0b2e52/white?text=No+Image';
        }

        const bedrooms = listing.bedrooms || (listingType === 'rent' && listing.propertyType === 'studio' ? 'Studio' : 0);
        const bathrooms = listing.bathrooms || 0;
        const area = listing.floorArea || listing.totalArea || 'N/A';

        return `
        <div class="listing-card-wrapper">
            <a href="property_details.html?id=${listing.id}" class="listing-card-link">
                <div class="listing-card">
                    <div class="listing-card-image-container">
                        <img src="${mainPhoto}" alt="${listing.title || 'Property'}" class="listing-image">
                        <div class="listing-type-badge ${typeBadgeClass}">${typeBadgeText}</div>
                        
                        <!-- Save Button - Only show if authenticated -->
                        ${isUserAuthenticated ? `
                        <button class="save-property-btn" 
                                data-property-id="${listing.id}" 
                                data-is-saved="${isSaved}"
                                aria-label="${isSaved ? 'Remove from saved' : 'Save property'}">
                            <span class="save-icon">${isSaved ? '‚ù§Ô∏è' : 'ü§ç'}</span>
                        </button>
                        ` : ''}
                    </div>
                    
                    <div class="listing-content">
                        <div class="listing-header">
                            <div>
                                <h3 class="listing-title">${listing.title || 'Untitled Property'}</h3>
                                <div class="listing-location">
                                    <span class="location-icon">üìç</span>
                                    <span class="location-text">${completeAddress}</span>
                                </div>
                            </div>
                            <div class="listing-price ${priceClass}">${displayPrice}</div>
                        </div>
                        
                        <div class="listing-details">
                            ${bedrooms ? `
                            <div class="detail">
                                <span class="detail-icon">üõè</span>
                                <span class="detail-text">${bedrooms} ${bedrooms === 'Studio' ? '' : 'beds'}</span>
                            </div>
                            ` : ''}
                            
                            ${bathrooms ? `
                            <div class="detail">
                                <span class="detail-icon">üöø</span>
                                <span class="detail-text">${bathrooms} baths</span>
                            </div>
                            ` : ''}
                            
                            ${area && area !== 'N/A' ? `
                            <div class="detail">
                                <span class="detail-icon">üìê</span>
                                <span class="detail-text">${area} sqm</span>
                            </div>
                            ` : ''}
                            
                            ${listingType === 'rent' && listing.securityDeposit ? `
                            <div class="detail">
                                <span class="detail-icon">üí∞</span>
                                <span class="detail-text">Deposit: ‚Ç±${listing.securityDeposit.toLocaleString()}</span>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="listing-broker">
                            <div class="broker-avatar">${userInitials}</div>
                            <div class="broker-info">
                                <div class="broker-name">${userInfo.displayName}</div>
                                <div class="broker-contact">
                                    ${getRoleDisplayText(userInfo.role)} ‚Ä¢ ${listing.propertyType || 'Property'}
                                </div>
                            </div>
                        </div>
                        
                        <div class="listing-actions">
                            <button class="action-btn contact-btn" 
                                    data-user-id="${listing.userId}"
                                    data-user-name="${userInfo.displayName}"
                                    aria-label="Contact ${userInfo.role === 'landlord' ? 'owner' : 'broker'}">
                                <span class="contact-icon">üìû</span>
                                Contact ${userInfo.role === 'landlord' ? 'Owner' : 'Broker'}
                            </button>
                            <button class="action-btn view-btn" aria-label="View property details">
                                <span class="view-icon">üëÅÔ∏è</span>
                                View Details
                            </button>
                        </div>
                    </div>
                </div>
            </a>
        </div>`;
    }).join('');
    
    // Add event listeners to the newly created elements
    setupListingEventListeners();
    
    // Force badges to be visible
    setTimeout(forceBadgeVisibility, 100);
}

function setupListingEventListeners() {
    // Save property buttons
    document.querySelectorAll('.save-property-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            const propertyId = this.getAttribute('data-property-id');
            if (propertyId) {
                toggleSaveProperty(propertyId, this);
            }
        });
    });

    // Contact buttons - prevent card click when clicking contact button
    document.querySelectorAll('.action-btn.contact-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            const userId = this.getAttribute('data-user-id');
            if (userId) {
                contactBroker(userId);
            }
        });
    });
}

function displayNoListings() {
    const container = document.getElementById('listingsContainer');
    const resultsTitle = document.getElementById('resultsTitle');
    const resultsCount = document.getElementById('resultsCount');

    if (Object.keys(searchFilters).length > 0) {
        container.innerHTML = `
        <div class="empty-state">
            <div class="empty-state-icon">üîç</div>
            <h3>No Properties Found</h3>
            <p>There are currently no properties matching your search criteria.</p>
            <button class="search-button" onclick="window.resetFilters()" style="margin-top: 20px;">
                <i class="fas fa-redo"></i>
                Reset Filters
            </button>
            <button class="search-button" onclick="window.location.href='buyer_dashboard.html'" style="margin-top: 10px; background: var(--secondary);">
                <i class="fas fa-arrow-left"></i>
                Back to Dashboard
            </button>
        </div>`;

        resultsTitle.innerHTML = '<i class="fas fa-search"></i> No Results Found';
        resultsCount.textContent = "No properties match your search criteria";
    } else {
        container.innerHTML = `
        <div class="empty-state">
            <div class="empty-state-icon">üè†</div>
            <h3>No Properties Available</h3>
            <p>There are currently no properties available in Batangas.</p>
            <button class="search-button" onclick="loadAllListings()" style="margin-top: 20px;">
                <i class="fas fa-redo"></i>
                Try Again
            </button>
        </div>`;

        resultsTitle.innerHTML = '<i class="fas fa-building"></i> All Properties in Batangas';
        resultsCount.textContent = "No properties available";
    }
}

function displayError(error) {
    const container = document.getElementById('listingsContainer');
    container.innerHTML = `
    <div class="error-state">
        <div class="error-icon">‚ö†Ô∏è</div>
        <h3>Error Loading Properties</h3>
        <p>There was an error loading the property listings.</p>
        <button class="search-button" onclick="loadAllListings()" style="margin-top: 20px;">
            <i class="fas fa-redo"></i>
            Try Again
        </button>
    </div>`;
}

// ====================== EVENT HANDLERS ============================

window.toggleSaveProperty = async function(propertyId, buttonElement) {
    try {
        const currentUser = auth.currentUser;
        if (!currentUser) {
            alert('Please login to save properties');
            window.location.href = '../login.html';
            return;
        }

        const isSaved = buttonElement.querySelector('.save-icon').textContent.includes("‚ù§Ô∏è");
        if (isSaved) {
            // Remove from saved
            const savedRef = collection(db, 'savedProperties');
            const q = query(savedRef,
                where('userId', '==', currentUser.uid),
                where('propertyId', '==', propertyId)
            );
            const snapshot = await getDocs(q);

            if (!snapshot.empty) {
                await deleteDoc(snapshot.docs[0].ref);
                buttonElement.querySelector('.save-icon').textContent = 'ü§ç';
                buttonElement.style.background = 'var(--bg-white)';
                buttonElement.style.color = 'var(--text-dark)';
                console.log(`Property ${propertyId} removed from saved`);
                showSaveToast('Removed from saved', false);
            }
        } else {
            // Add to saved
            await addDoc(collection(db, 'savedProperties'), {
                userId: currentUser.uid,
                propertyId: propertyId,
                savedAt: new Date(),
                createdAt: new Date(),
            });

            // Log save event for AI recommendations
            await logSaveEvent(currentUser.uid, propertyId);

            buttonElement.querySelector('.save-icon').textContent = '‚ù§Ô∏è';
            buttonElement.style.background = 'var(--primary)';
            buttonElement.style.color = 'white';
            console.log(`Property ${propertyId} saved`);
            showSaveToast('Property saved!', false);
        }
    } catch (error) {
        console.error("Error toggling save:", error);
        showSaveToast("Error saving property", true);
    }
};

function showSaveToast(message, isError = false) {
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${isError ? '#ef4444' : '#10b981'};
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    z-index: 9999;
    font-weight: 500;
    box-shadow: var(--shadow-lg);
    animation: slideIn 0.3s ease;
    `;

    document.body.appendChild(toast);

    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// =========================== WINDOW FUNCTIONS ==========================

window.contactBroker = async function(userId) {
    const userInfo = userMap.get(userId);
    if (userInfo) {
        const userType = userInfo.role === 'landlord' ? 'Property Owner' : 'Broker';
        alert(`Contact Information:\n\n${userType}: ${userInfo.displayName}\nEmail: ${userInfo.email}\nPhone: ${userInfo.phone}\n\nYou can contact this ${userType.toLowerCase()} for more information about the property.`);
    } else {
        alert('Contact information not available.');
    }
};

window.loadAllListings = loadAllListings;

// ====================== CSS ANIMATIONS ============================

const style = document.createElement('style');
style.textContent = `
@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
`;
document.head.appendChild(style);
</script>

</body>
</html>