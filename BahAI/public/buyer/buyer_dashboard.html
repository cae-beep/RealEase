<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard - BahAI Real Estate</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- REMOVED: recommendations.css since it doesn't exist -->
<link rel="stylesheet" href="style.css">

<!-- Messaging Modal CSS -->
<style>
    /* ===== MESSAGING MODAL STYLES ===== */
    .message-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 2000;
        align-items: center;
        justify-content: center;
        padding: 20px;
        backdrop-filter: blur(5px);
    }

    .message-modal.show {
        display: flex;
    }

    .message-modal-content {
        background: var(--bg-white);
        border-radius: 16px;
        width: 100%;
        max-width: 600px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: var(--shadow-lg);
    }

    .message-header {
        padding: 25px 30px;
        border-bottom: 1px solid var(--border);
        position: relative;
        background: var(--primary);
        color: white;
        border-radius: 16px 16px 0 0;
    }

    .message-header h2 {
        font-size: 22px;
        font-weight: 600;
        margin-bottom: 5px;
    }

    .message-subtitle {
        font-size: 14px;
        opacity: 0.9;
    }

    .message-close {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        color: white;
        font-size: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .message-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: rotate(90deg);
    }

    .message-broker-card {
        background: var(--bg-light);
        padding: 15px;
        border-radius: 12px;
        margin: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        border: 1px solid var(--border);
    }

    .message-broker-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary), var(--primary-light));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 14px;
        flex-shrink: 0;
    }

    .message-broker-info {
        flex: 1;
        min-width: 0;
    }

    .message-broker-name {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 2px;
    }

    .message-broker-role {
        font-size: 12px;
        color: var(--text-light);
    }

    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: var(--bg-light);
        min-height: 300px;
        max-height: 400px;
    }

    .message-bubble {
        margin-bottom: 15px;
        max-width: 80%;
    }

    .message-bubble.sent {
        margin-left: auto;
        text-align: right;
    }

    .message-bubble-content {
        display: inline-block;
        padding: 12px 16px;
        border-radius: 18px;
        background: var(--bg-white);
        border: 1px solid var(--border);
        text-align: left;
        word-wrap: break-word;
    }

    .message-bubble.sent .message-bubble-content {
        background: var(--primary);
        color: white;
        border: none;
    }

    .message-time {
        font-size: 11px;
        color: var(--text-light);
        margin-top: 4px;
        display: block;
    }

    .message-bubble.sent .message-time {
        color: rgba(255, 255, 255, 0.7);
    }

    .no-messages {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-light);
    }

    .message-input-area {
        padding: 20px;
        border-top: 1px solid var(--border);
        background: var(--bg-white);
        border-radius: 0 0 16px 16px;
    }

    .message-textarea {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid var(--border);
        border-radius: 10px;
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        resize: none;
        min-height: 60px;
        margin-bottom: 10px;
        transition: border-color 0.3s ease;
    }

    .message-textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(11, 46, 82, 0.1);
    }

    .message-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 15px;
    }

    .contact-info {
        font-size: 12px;
        color: var(--text-light);
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .send-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
    }

    .send-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
    }

    .send-btn:disabled {
        background: var(--border);
        cursor: not-allowed;
        transform: none;
    }

    .loading-messages {
        text-align: center;
        padding: 40px 20px;
    }

    .quick-contact-buttons {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .quick-contact-btn {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        text-decoration: none;
        white-space: nowrap;
    }

    .email-btn {
        background: #e8f5e9;
        color: #2e7d32;
        border: 1px solid #c8e6c9;
    }

    .email-btn:hover {
        background: #d4edd5;
        transform: translateY(-1px);
    }

    .call-btn {
        background: #e3f2fd;
        color: #1565c0;
        border: 1px solid #bbdefb;
    }

    .call-btn:hover {
        background: #c5e0fb;
        transform: translateY(-1px);
    }

    /* Mobile responsive styles for messaging */
    @media (max-width: 768px) {
        .message-modal-content {
            max-width: 95%;
        }
        
        .message-actions {
            flex-direction: column;
            align-items: stretch;
        }
        
        .contact-info {
            justify-content: center;
        }
        
        .send-btn {
            width: 100%;
        }
        
        .quick-contact-buttons {
            flex-direction: column;
        }
    }

    @media (max-width: 480px) {
        .message-header {
            padding: 20px;
        }
        
        .message-broker-card {
            margin: 15px;
            flex-direction: column;
            text-align: center;
        }
        
        .message-broker-avatar {
            width: 50px;
            height: 50px;
            font-size: 16px;
        }
    }
</style>
</head>

<body>
<!-- Mobile Menu Toggle -->
<button class="mobile-menu-toggle" id="mobileMenuToggle">‚â°</button>

<!-- Include Sidebar -->
<div id="sidebar-container"></div>

<!-- Messaging Modal -->
<div class="message-modal" id="messageModal">
    <div class="message-modal-content">
        <div class="message-header">
            <h2 id="messageBrokerName">Contact Broker</h2>
            <div class="message-subtitle" id="messageBrokerRole"></div>
            <button class="message-close" id="closeMessageModal">&times;</button>
        </div>
        
        <div class="message-broker-card">
            <div class="message-broker-avatar" id="messageBrokerAvatar">B</div>
            <div class="message-broker-info">
                <div class="message-broker-name" id="messageBrokerFullName">Loading...</div>
                <div class="message-broker-role">
                    <span id="messageBrokerType">Broker</span> ‚Ä¢ 
                    <span id="messageBrokerContact">Contact info loading...</span>
                </div>
            </div>
        </div>
        
        <div class="messages-container" id="messagesContainer">
            <div class="loading-messages">
                <div class="spinner"></div>
                <p>Loading messages...</p>
            </div>
        </div>
        
        <div class="message-input-area">
            <textarea class="message-textarea" 
                    id="messageInput" 
                    placeholder="Type your message here..." 
                    rows="3"></textarea>
            
            <div class="message-actions">
                <div class="contact-info">
                    <span id="brokerEmailInfo">üìß Email: Loading...</span>
                    <span id="brokerPhoneInfo">üìû Phone: Loading...</span>
                </div>
                <button class="send-btn" id="sendMessageBtn">
                    <span>üì® Send</span>
                </button>
            </div>
            
            <div class="quick-contact-buttons">
                <a href="#" class="quick-contact-btn email-btn" id="quickEmailBtn">
                    üìß Send Email
                </a>
                <a href="#" class="quick-contact-btn call-btn" id="quickCallBtn">
                    üìû Make Call
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Main -->
<div class="container">
<!-- Hero Section -->
<div class="hero-section">
<h1>Discover House and Lot for sale and rent in Batangas</h1>
<p>Find your dream property in Batangas - homes, condos, lots, and commercial spaces</p>
<div id="welcomeText" style="font-weight: 500; opacity: 0.9; font-size: 16px;"></div>
</div>

<!-- Search Section -->
<div class="search-section">
<div class="search-title">
    <i class="fas fa-search"></i>
    Find Properties in Batangas
</div>

<div class="search-grid">
<!-- Location Filter -->
<div class="search-group">
    <label class="search-label">Select City/Municipality</label>
    <select class="search-select" id="filterLocation">
    <option value="">All of Batangas</option>
    <option value="Batangas City">Batangas City</option>
    <option value="Lipa City">Lipa City</option>
    <option value="Tanauan City">Tanauan City</option>
    <option value="Bauan">Bauan</option>
    <option value="Balayan">Balayan</option>
    <option value="Calaca">Calaca</option>
    <option value="Lemery">Lemery</option>
    <option value="Nasugbu">Nasugbu</option>
    <option value="San Juan">San Juan</option>
    <option value="Taal">Taal</option>
    <option value="Talisay">Talisay</option>
    <option value="Alitagtag">Alitagtag</option>
    <option value="Cuenca">Cuenca</option>
    <option value="Laurel">Laurel</option>
    <option value="Mataasnakahoy">Mataasnakahoy</option>
    <option value="San Jose">San Jose</option>
    <option value="San Luis">San Luis</option>
    <option value="San Pascual">San Pascual</option>
    <option value="Santo Tomas">Santo Tomas</option>
    </select>
</div>

<!-- Transaction Type Filter -->
<div class="search-group">
    <label class="search-label">Transaction Type</label>
    <select class="search-select" id="filterListingType">
    <option value="">All Types</option>
    <option value="sale">For Sale</option>
    <option value="rent">For Rent</option>
    <option value="lease">For Lease</option>
    </select>
</div>

<!-- Property Category Filter (Dynamic based on transaction type) -->
<div class="search-group">
    <label class="search-label">Property Category</label>
    <select class="search-select" id="filterPropertyCategory">
    <option value="">All Categories</option>
    <!-- Options will be populated dynamically based on transaction type -->
    </select>
</div>

<!-- Property Type Filter (Dynamic based on category) -->
<div class="search-group">
    <label class="search-label">Property Type</label>
    <select class="search-select" id="filterPropertyType">
    <option value="">All Types</option>
    <!-- Options will be populated dynamically based on category -->
    </select>
</div>

<!-- Search by Name/Keyword -->
<div class="search-group">
    <label class="search-label">Search Property</label>
    <input type="text" class="search-input" id="filterName" placeholder="Enter property name or keyword...">
</div>
</div>

<div class="search-actions">
    <button class="search-button" id="applyFilters">
    <i class="fas fa-search"></i>
    Search Properties
    </button>
    <button class="reset-button" id="resetFilters">
    <i class="fas fa-redo"></i>
    Reset Filters
    </button>
</div>

<!-- AI Recommendations Section -->
<div id="recommendedSection" class="recommendations-section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <div>
            <h2 class="section-title">
                <i class="fas fa-robot"></i>
                AI Recommendations For You
            </h2>
            <p style="color: var(--text-light); font-size: 15px; margin-top: 5px;" id="recommendationsSubtitle">
                Based on your saved properties and search history
            </p>
        </div>
        <button id="refreshRecommendationsBtn" class="search-button" style="padding: 8px 16px; font-size: 14px;">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>
    <div id="recommendedListingsContainer" class="recommendations-grid">
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Loading AI recommendations...</p>
        </div>
    </div>
</div>

<!-- Categories Section -->
<div class="categories-section">
    <h2 class="section-title">
        <i class="fas fa-th-large"></i>
        Batangas Property Categories
    </h2>
    <p style="color: var(--text-light); margin-bottom: 25px; font-size: 15px;">
        Browse properties by category in Batangas
    </p>

    <div class="categories-grid" id="categoriesContainer">
        <!-- Categories will be loaded dynamically -->
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Loading categories...</p>
        </div>
    </div>
</div>

<!-- All Properties Section -->
<div class="properties-section">
    <h2 class="section-title">
        <i class="fas fa-building"></i>
        All Properties in Batangas
    </h2>
    <p style="color: var(--text-light); margin-bottom: 25px; font-size: 15px;" id="propertiesCount">
        Loading properties...
    </p>

    <!-- Properties Grid -->
    <div class="listings-grid" id="listingsContainer">
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Loading properties...</p>
        </div>
    </div>
</div>
</div>

<!-- Sidebar Loader -->
<script>
// Mobile menu functionality
document.getElementById('mobileMenuToggle').addEventListener('click', function() {
    const sidebar = document.querySelector('.sidebar');
    if (sidebar) {
        sidebar.classList.toggle('active');
    }
});

// Close sidebar when clicking on a link (mobile)
document.addEventListener('click', function(e) {
    if (window.innerWidth <= 1024) {
        if (e.target.closest('.sidebar-link')) {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.remove('active');
            }
        }
    }
});

// Load sidebar
fetch('sidebar.html')
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to load sidebar: ' + response.status);
        }
        return response.text();
    })
    .then(html => {
        document.getElementById('sidebar-container').innerHTML = html;
        
        // Highlight active link
        const links = document.querySelectorAll('.sidebar-link');
        links.forEach(link => {
            if (link.getAttribute('href') === 'buyer_dashboard.html') {
                link.classList.add('active');
            }
        });
        
        // Setup logout button
        setupLogoutButton();
    })
    .catch(error => {
        console.error('Error loading sidebar:', error);
        document.getElementById('sidebar-container').innerHTML = 
            '<div class="sidebar" style="padding: 20px; background: #f8f9fa; color: #dc3545;">' +
            '<p>Unable to load navigation. Please refresh the page.</p>' +
            '</div>';
    });

window.viewAllProperties = function() {
    window.location.href = 'search_results.html';
};

// Handle window resize
window.addEventListener('resize', function() {
    const sidebar = document.querySelector('.sidebar');
    if (window.innerWidth > 1024 && sidebar) {
        sidebar.classList.remove('active');
    }
});

// Simple logout function
function setupLogoutButton() {
    const logoutBtn = document.getElementById("logoutBtn");
    if (!logoutBtn) {
        setTimeout(setupLogoutButton, 100);
        return;
    }

    // Remove existing event listeners
    const newLogoutBtn = logoutBtn.cloneNode(true);
    logoutBtn.parentNode.replaceChild(newLogoutBtn, logoutBtn);

    // Add new event listener
    newLogoutBtn.addEventListener("click", function(e) {
        e.preventDefault();
        e.stopPropagation();

        if (confirm("Are you sure you want to log out?")) {
            if (typeof window.performLogout === 'function') {
                window.performLogout();
            } else {
                window.location.href = "../login.html";
            }
        }
    });
}
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import {
    getAuth,
    onAuthStateChanged,
    signOut
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import {
    getFirestore,
    collection,
    query,
    where,
    getDocs,
    getDoc,
    doc,
    addDoc,
    deleteDoc,
    onSnapshot,
    orderBy,
    serverTimestamp,
    updateDoc,
    setDoc
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

// Make signOut available globally for the logout button
window.performLogout = async function() {
    try {
        await signOut(auth);
        window.location.href = "../login.html";
    } catch (error) {
        console.error("Logout error:", error);
        alert("Error logging out. Please try again.");
    }
};

// Firebase Config
const firebaseConfig = {
    apiKey: "AIzaSyCIfzneDzWVveG8p_0mywoA9D9F5AyzZX4",
    authDomain: "bahai-1b76d.firebaseapp.com",
    projectId: "bahai-1b76d",
    storageBucket: "bahai-1b76d.firebasestorage.app",
    messagingSenderId: "646878644941",
    appId: "1:646878644941:web:5b4ccc3412250337587784"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Global variables
let allListings = [];
let userMap = new Map();
let selectedCategory = '';
let currentConversationId = null;
let messageListener = null;

// Welcome text element
const welcomeText = document.getElementById("welcomeText");

// --- MESSAGING SYSTEM FUNCTIONS ---

// Initialize messaging event listeners
function initializeMessagingListeners() {
    // Send message button
    const sendBtn = document.getElementById('sendMessageBtn');
    if (sendBtn) {
        sendBtn.addEventListener('click', sendMessage);
    }
    
    // Message input enter key support
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Auto-resize textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
    }
    
    // Close message modal button
    const closeMessageBtn = document.getElementById('closeMessageModal');
    if (closeMessageBtn) {
        closeMessageBtn.addEventListener('click', closeMessageModal);
    }
    
    // Close modal when clicking outside
    const messageModal = document.getElementById('messageModal');
    if (messageModal) {
        messageModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeMessageModal();
            }
        });
    }
}

// Contact broker function (for use in onclick attributes)
window.contactBroker = async function(userId, propertyId = null) {
    const currentUser = auth.currentUser;
    if (!currentUser) {
        alert('Please log in to contact brokers');
        return;
    }

    const userInfo = userMap.get(userId);
    if (!userInfo) {
        alert('Broker information not available');
        return;
    }

    // Generate conversation ID (sorted combination of both user IDs)
    currentConversationId = [currentUser.uid, userId].sort().join('_');
    
    // Get property info for context
    const property = allListings.find(l => l.userId === userId);
    
    // Update messaging modal UI
    updateMessagingModal(userInfo, property);
    
    // Show messaging modal
    const messageModal = document.getElementById('messageModal');
    messageModal.classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // Load existing messages
    loadMessages(currentConversationId, userId);
    
    // Focus on message input
    setTimeout(() => {
        document.getElementById('messageInput').focus();
    }, 300);
};

// Update messaging modal with broker info
function updateMessagingModal(userInfo, property) {
    const brokerName = userInfo.displayName || 'Broker';
    const brokerRole = userInfo.role === 'landlord' ? 'Property Owner' : 
                     userInfo.role === 'broker' ? 'Licensed Broker' : 
                     'Property Contact';
    
    // Set modal title and info
    document.getElementById('messageBrokerName').textContent = `Message ${brokerName}`;
    document.getElementById('messageBrokerRole').textContent = brokerRole;
    document.getElementById('messageBrokerFullName').textContent = brokerName;
    document.getElementById('messageBrokerType').textContent = brokerRole;
    document.getElementById('messageBrokerContact').textContent = userInfo.email || 'Email not available';

    // Set broker avatar initials
    const initials = brokerName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) || 'B';
    document.getElementById('messageBrokerAvatar').textContent = initials;
    
    // Update contact info
    const emailInfo = document.getElementById('brokerEmailInfo');
    const phoneInfo = document.getElementById('brokerPhoneInfo');
    emailInfo.textContent = `üìß ${userInfo.email || 'Email not available'}`;
    phoneInfo.textContent = `üìû ${userInfo.phone || 'Phone not available'}`;
    
    // Setup quick contact buttons
    const quickEmailBtn = document.getElementById('quickEmailBtn');
    const quickCallBtn = document.getElementById('quickCallBtn');
    
    if (userInfo.email) {
        const subject = property ? `Inquiry about: ${property.title}` : 'Property Inquiry';
        const body = property ? `Hello ${brokerName},\n\nI'm interested in your property: ${property.title}\n\nPlease send me more information.` : '';
        quickEmailBtn.href = `mailto:${userInfo.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        quickEmailBtn.style.display = 'flex';
    } else {
        quickEmailBtn.style.display = 'none';
    }
    
    if (userInfo.phone) {
        quickCallBtn.href = `tel:${userInfo.phone}`;
        quickCallBtn.style.display = 'flex';
    } else {
        quickCallBtn.style.display = 'none';
    }
    
    // Set up message input placeholder with property context
    const messageInput = document.getElementById('messageInput');
    if (property) {
        messageInput.placeholder = `Hi ${brokerName}, I'm interested in ${property.title} at ${property.location}. Could you please provide more details about...`;
    } else {
        messageInput.placeholder = `Type your message here...`;
    }
}

// Load messages for a conversation
function loadMessages(conversationId, brokerId) {
    const messagesContainer = document.getElementById('messagesContainer');
    
    // Clear any existing listener
    if (messageListener) {
        messageListener();
        messageListener = null;
    }
    
    // Show loading state
    messagesContainer.innerHTML = `
        <div class="loading-messages">
            <div class="spinner"></div>
            <p>Loading messages...</p>
        </div>
    `;
    
    console.log('üîç Attempting to load messages for conversation:', conversationId);
    
    try {
        // Query messages for this conversation
        const messagesRef = collection(db, 'messages');
        const messagesQuery = query(
            messagesRef,
            where('conversationId', '==', conversationId),
            orderBy('timestamp', 'asc')
        );
        
        console.log('üìã Query created, listening for messages...');
        
        // Listen for real-time updates
        messageListener = onSnapshot(messagesQuery, 
            (snapshot) => {
                console.log('üì® Snapshot received, docs:', snapshot.size);
                
                messagesContainer.innerHTML = '';
                
                if (snapshot.empty) {
                    console.log('üì≠ No messages found in conversation');
                    messagesContainer.innerHTML = `
                        <div class="no-messages">
                            <div style="font-size: 48px; margin-bottom: 16px;">üí¨</div>
                            <h3>No messages yet</h3>
                            <p>Start the conversation by sending a message below.</p>
                        </div>
                    `;
                    return;
                }
                
                const currentUser = auth.currentUser;
                
                snapshot.forEach((doc) => {
                    const message = doc.data();
                    const isSent = message.senderId === currentUser.uid;
                    
                    const messageElement = document.createElement('div');
                    messageElement.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
                    
                    // Format timestamp
                    let timestamp = 'Just now';
                    if (message.timestamp) {
                        const date = message.timestamp.toDate ? message.timestamp.toDate() : new Date();
                        timestamp = formatMessageTime(date);
                    }
                    
                    const messageContent = document.createElement('div');
                    messageContent.className = 'message-bubble-content';
                    
                    let statusIndicator = '';
                    if (isSent) {
                        statusIndicator = `<span class="message-status" style="margin-left: 5px; font-size: 10px;">‚úì</span>`;
                    }
                    
                    messageContent.innerHTML = `
                        <div>${message.text}</div>
                        <span class="message-time">${timestamp}${statusIndicator}</span>
                    `;
                    
                    messageElement.appendChild(messageContent);
                    messagesContainer.appendChild(messageElement);
                });
                
                // Scroll to bottom
                setTimeout(() => {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }, 100);
                
            }, 
            (error) => {
                console.error('‚ùå Error in onSnapshot listener:', error);
                
                messagesContainer.innerHTML = `
                    <div class="no-messages">
                        <div style="font-size: 48px; margin-bottom: 16px;">üí¨</div>
                        <h3>Start a conversation</h3>
                        <p>Send a message to begin chatting with the broker.</p>
                    </div>
                `;
            }
        );
        
    } catch (error) {
        console.error('üí• Error setting up message listener:', error);
        messagesContainer.innerHTML = `
            <div class="no-messages">
                <div style="font-size: 48px; margin-bottom: 16px;">üí¨</div>
                <h3>Ready to chat</h3>
                <p>Send your first message below to start the conversation.</p>
            </div>
        `;
    }
}

// Send message function
async function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const messageText = messageInput.value.trim();
    const sendBtn = document.getElementById('sendMessageBtn');
    
    if (!messageText) {
        messageInput.focus();
        return;
    }
    
    if (!currentConversationId || !auth.currentUser) {
        alert('Unable to send message. Please refresh and try again.');
        return;
    }
    
    // Get broker ID from conversation ID
    const conversationParts = currentConversationId.split('_');
    const brokerId = conversationParts.find(id => id !== auth.currentUser.uid);
    
    if (!brokerId) {
        alert('Unable to identify recipient.');
        return;
    }
    
    // Disable send button and show loading
    const originalText = sendBtn.innerHTML;
    sendBtn.innerHTML = '<div class="spinner" style="border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; width: 16px; height: 16px;"></div>';
    sendBtn.disabled = true;
    messageInput.disabled = true;
    
    try {
        // Get property ID for context
        const property = allListings.find(l => l.userId === brokerId);
        const propertyId = property?.id;
        
        // Create conversation document if it doesn't exist
        const conversationRef = doc(db, 'conversations', currentConversationId);
        const conversationSnap = await getDoc(conversationRef);
        
        const conversationData = {
            participants: [auth.currentUser.uid, brokerId],
            lastMessage: messageText.substring(0, 100),
            lastMessageTime: serverTimestamp(),
            lastSenderId: auth.currentUser.uid,
            unreadCount: {
                [brokerId]: (conversationSnap.exists() ? 
                    (conversationSnap.data().unreadCount?.[brokerId] || 0) + 1 : 1)
            },
            buyerId: auth.currentUser.uid,
            brokerId: brokerId,
            propertyId: propertyId || null,
            propertyTitle: property?.title || null,
            buyerName: auth.currentUser.displayName || auth.currentUser.email,
            createdAt: conversationSnap.exists() ? 
                conversationSnap.data().createdAt : serverTimestamp(),
            updatedAt: serverTimestamp()
        };
        
        // Update or create conversation
        await setDoc(conversationRef, conversationData, { merge: true });
        
        // Add message to messages collection
        const messageData = {
            conversationId: currentConversationId,
            senderId: auth.currentUser.uid,
            receiverId: brokerId,
            text: messageText,
            timestamp: serverTimestamp(),
            read: false,
            createdAt: serverTimestamp(),
            type: 'text',
            propertyId: propertyId || null,
            senderName: auth.currentUser.displayName || auth.currentUser.email
        };
        
        await addDoc(collection(db, 'messages'), messageData);
        
        console.log('‚úÖ Message sent successfully');
        
        // Clear input and reset UI
        messageInput.value = '';
        messageInput.style.height = 'auto';
        messageInput.disabled = false;
        
        // Show success feedback
        sendBtn.innerHTML = '‚úì Sent';
        sendBtn.style.background = '#10b981';
        
        setTimeout(() => {
            sendBtn.innerHTML = 'üì® Send';
            sendBtn.style.background = '';
            sendBtn.disabled = false;
        }, 1500);
        
        // Scroll to bottom of messages
        const messagesContainer = document.getElementById('messagesContainer');
        setTimeout(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }, 100);
        
    } catch (error) {
        console.error('‚ùå Error sending message:', error);
        
        // Reset UI
        sendBtn.innerHTML = originalText;
        sendBtn.disabled = false;
        messageInput.disabled = false;
        
        // Show user-friendly error
        let errorMessage = 'Failed to send message. ';
        if (error.code === 'permission-denied') {
            errorMessage += 'You do not have permission to send messages.';
        } else if (error.code === 'unavailable') {
            errorMessage += 'Network error. Please check your connection.';
        } else {
            errorMessage += 'Please try again.';
        }
        
        alert(errorMessage);
    }
}

// Format message timestamp
function formatMessageTime(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    
    return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
}

// Close messaging modal
function closeMessageModal() {
    const messageModal = document.getElementById('messageModal');
    messageModal.classList.remove('show');
    document.body.style.overflow = 'auto';
    
    // Clean up message listener
    if (messageListener) {
        messageListener();
        messageListener = null;
    }
    
    currentConversationId = null;
    
    // Clear message input
    document.getElementById('messageInput').value = '';
}

// --- MAIN APPLICATION LOGIC ---

// Property category and type mappings based on transaction type
const PROPERTY_CATEGORIES = {
    'rent': [
        { category: 'Residential Property', types: ['Apartment', 'Condominium', 'Room / Bedspace', 'House', 'Dormitory'] },
        { category: 'Commercial Property', types: ['Office Unit', 'Retail Space / Shop', 'Food Stall / Kiosk'] },
        { category: 'Industrial Property', types: ['Warehouse', 'Factory', 'Storage Unit'] }
    ],
    'lease': [
        { category: 'Commercial Property', types: ['Office Floor', 'Commercial Building', 'Warehouse'] },
        { category: 'Land / Lot', types: ['Agricultural Lot', 'Commercial Lot', 'Industrial Lot'] },
        { category: 'Special Purpose Property', types: ['Resort Property', 'Event Venue', 'School Property', 'Sports Facility'] }
    ],
    'sale': [
        { category: 'Residential Property', types: ['House', 'Townhouse', 'Condominium', 'Apartment'] },
        { category: 'Commercial Property', types: ['Office Space', 'Retail Space / Shop', 'Commercial Building'] },
        { category: 'Land / Lot', types: ['Residential Lot', 'Commercial Lot', 'Agricultural Lot'] }
    ]
};

// Define the 6 categories with their property types
const BATANGAS_PROPERTY_CATEGORIES = [
    {
        name: 'Residential Property',
        icon: 'üè†',
        description: 'Properties intended for living or dwelling',
        propertyTypes: ['House', 'Apartment', 'Condominium', 'Townhouse', 'Dormitory', 'Room / Bedspace', 'Bungalow', 'Duplex']
    },
    {
        name: 'Commercial Property',
        icon: 'üè¢',
        description: 'Properties used for business and income generation',
        propertyTypes: ['Office Unit', 'Office Floor', 'Office Space', 'Retail Space / Shop', 'Commercial Building', 'Food Stall / Kiosk', 'Showroom']
    },
    {
        name: 'Industrial Property',
        icon: 'üè≠',
        description: 'Properties for storage, production, and logistics',
        propertyTypes: ['Warehouse', 'Factory', 'Storage Unit', 'Workshop']
    },
    {
        name: 'Land / Lot',
        icon: 'üå≥',
        description: 'Undeveloped or semi-developed land for future use',
        propertyTypes: ['Residential Lot', 'Commercial Lot', 'Agricultural Land', 'Industrial Lot', 'Development Land', 'Vacant Lot', 'Beachfront Property']
    },
    {
        name: 'Special Purpose Property',
        icon: 'üéØ',
        description: 'Properties with specific or institutional functions',
        propertyTypes: ['Resort Property', 'Event Venue', 'School Property', 'Sports Facility', 'Parking Area', 'Hospitality Property']
    },
    {
        name: 'Condominium',
        icon: 'üèôÔ∏è',
        description: 'Condominium units and complexes',
        propertyTypes: ['Condominium Unit', 'Penthouse', 'Studio Unit', 'Loft Unit']
    }
];

// Google Maps API Key
const GOOGLE_MAPS_API_KEY = "AIzaSyBwwAkIEixeUysaGrMb9BtTsMwz_C9Noxk";

// Python Backend URL
const PYTHON_API_URL = "https://us-central1-bahai-1b76d.cloudfunctions.net/personalized_recommendations";

// --- HELPER FUNCTIONS ---

function getRoleDisplayText(role) {
    const roleMap = {
        'landlord': 'Property Owner',
        'seller': 'Property Seller',
        'broker': 'Licensed Broker',
        'agent': 'Property Agent',
        'admin': 'Administrator'
    };
    return roleMap[role] || 'Posted by';
}

function getListingType(listing) {
    if (listing.listingType === 'lease' || listing.type === 'lease') {
        return 'lease';
    }

    if (listing.listingType === 'rent' || listing.type === 'rent') {
        return 'rent';
    }

    if (listing.listingType === 'sale' || listing.type === 'sale') {
        return 'sale';
    }

    if (listing.monthlyRent !== undefined && listing.monthlyRent !== null && listing.monthlyRent > 0) {
        return 'rent';
    }

    if (listing.annualRent !== undefined && listing.annualRent !== null && listing.annualRent > 0) {
        return 'lease';
    }

    if ((listing.pricing !== undefined && listing.pricing !== null && listing.pricing > 0) ||
        (listing.salePrice !== undefined && listing.salePrice !== null && listing.salePrice > 0)) {
        return 'sale';
    }

    return 'sale';
}

function getDisplayPrice(listing) {
    const type = getListingType(listing);

    switch (type) {
        case 'rent':
            return `‚Ç±${(listing.monthlyRent || 0).toLocaleString()}/month`;
        case 'lease':
            const annualRent = listing.annualRent || 0;
            return `‚Ç±${annualRent.toLocaleString()}/year`;
        case 'sale':
        default:
            return `‚Ç±${(listing.pricing || listing.salePrice || 0).toLocaleString()}`;
    }
}

function getNumericPrice(listing) {
    const type = getListingType(listing);

    switch (type) {
        case 'rent':
            return listing.monthlyRent || 0;
        case 'lease':
            return listing.annualRent || 0;
        case 'sale':
        default:
            return listing.pricing || listing.salePrice || 0;
    }
}

function getPriceClass(listing) {
    const type = getListingType(listing);

    switch (type) {
        case 'rent':
            return 'price-rent';
        case 'lease':
            return 'price-lease';
        case 'sale':
        default:
            return 'price-sale';
    }
}

function getTypeBadgeClass(listing) {
    const type = getListingType(listing);

    switch (type) {
        case 'rent':
            return 'type-rent';
        case 'lease':
            return 'type-lease';
        case 'sale':
        default:
            return 'type-sale';
    }
}

function getTypeBadgeText(listing) {
    const type = getListingType(listing);

    switch (type) {
        case 'rent':
            return 'FOR RENT';
        case 'lease':
            return 'FOR LEASE';
        case 'sale':
        default:
            return 'FOR SALE';
    }
}

function getCompleteAddress(listing) {
    const primaryAddress = listing.address || listing.location || listing.title || '';
    
    let fullAddress = primaryAddress;
    
    if (listing.city) {
        fullAddress += ', ' + listing.city;
    }
    
    if (listing.province && listing.province !== 'Calabarzon') {
        fullAddress += ', ' + listing.province;
    }
    
    if (!listing.province && listing.city) {
        fullAddress += ', Philippines';
    }
    
    return fullAddress || 'Batangas, Philippines';
}

// --- CATEGORY DROPDOWN FUNCTIONS ---

// Update category dropdown based on selected transaction type
function updateCategoryDropdown() {
    const transactionType = document.getElementById('filterListingType').value;
    const categorySelect = document.getElementById('filterPropertyCategory');
    const typeSelect = document.getElementById('filterPropertyType');

    // Reset both dropdowns
    categorySelect.innerHTML = '<option value="">All Categories</option>';
    typeSelect.innerHTML = '<option value="">All Types</option>';

    if (transactionType && PROPERTY_CATEGORIES[transactionType]) {
        // Populate categories based on transaction type
        PROPERTY_CATEGORIES[transactionType].forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.category;
            option.textContent = cat.category;
            categorySelect.appendChild(option);
        });
    } else {
        // If no transaction type selected, show all possible categories
        const allCategories = new Set();
        Object.values(PROPERTY_CATEGORIES).forEach(cats => {
            cats.forEach(cat => allCategories.add(cat.category));
        });
        allCategories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categorySelect.appendChild(option);
        });
    }
    
    updateTypeDropdown();
}

// Update type dropdown based on selected category
function updateTypeDropdown() {
    const transactionType = document.getElementById('filterListingType').value;
    const category = document.getElementById('filterPropertyCategory').value;
    const typeSelect = document.getElementById('filterPropertyType');

    typeSelect.innerHTML = '<option value="">All Types</option>';

    if (transactionType && category && PROPERTY_CATEGORIES[transactionType]) {
        const categoryData = PROPERTY_CATEGORIES[transactionType].find(cat => cat.category === category);
        if (categoryData && categoryData.types) {
            categoryData.types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeSelect.appendChild(option);
            });
        }
    }
}

// --- FILTER FUNCTIONS ---

// Apply filters - redirects to search results page
async function applyFilters() {
    const filters = {};
    const location = document.getElementById('filterLocation').value;
    const transactionType = document.getElementById('filterListingType').value;
    const propertyCategory = document.getElementById('filterPropertyCategory').value;
    const propertyType = document.getElementById('filterPropertyType').value;
    const searchTerm = document.getElementById('filterName').value;

    if (location) filters.location = location;
    if (transactionType) filters.transactionType = transactionType;
    if (propertyCategory) filters.propertyCategory = propertyCategory;
    if (propertyType) filters.propertyType = propertyType;
    if (searchTerm) filters.searchTerm = searchTerm;

    // Log search event for recommendations
    try {
        const currentUser = auth.currentUser;
        if (currentUser && Object.keys(filters).length > 0) {
            await logSearchEvent(currentUser.uid, filters);
        }
    } catch (error) {
        console.log('Could not log search event:', error.message);
    }

    // Redirect to search results page with filters as URL parameters
    const queryString = Object.keys(filters).length > 0
        ? `?filters=${encodeURIComponent(JSON.stringify(filters))}`
        : '';

    window.location.href = `search_results.html${queryString}`;
}

// Simple logSearchEvent function
async function logSearchEvent(userId, filters) {
    try {
        const eventsRef = collection(db, 'events');
        await addDoc(eventsRef, {
            userId: userId,
            eventType: 'search',
            metadata: { filters: filters },
            timestamp: new Date()
        });
        return true;
    } catch (error) {
        console.error("Failed to log search event:", error);
        return false;
    }
}

// Simple logSaveEvent function
async function logSaveEvent(userId, propertyId) {
    try {
        const eventsRef = collection(db, 'events');
        await addDoc(eventsRef, {
            userId: userId,
            eventType: 'save',
            metadata: { propertyId: propertyId },
            timestamp: new Date()
        });
        return true;
    } catch (error) {
        console.error("Failed to log save event:", error);
        return false;
    }
}

// Reset filters function
function resetFilters() {
    document.getElementById('filterLocation').value = "";
    document.getElementById('filterListingType').value = "";
    document.getElementById('filterPropertyCategory').value = "";
    document.getElementById('filterPropertyType').value = "";
    document.getElementById('filterName').value = "";
    selectedCategory = "";
    
    // Reset dropdowns to default state
    updateCategoryDropdown();
    
    // Update UI
    updateCategoryUI();
    
    // Show all active listings
    displayFilteredListings();
}

// --- CATEGORIES FUNCTIONS ---

async function loadCategories() {
    const container = document.getElementById('categoriesContainer');

    try {
        // Calculate counts for each category based on actual listings
        const activeListings = allListings.filter(listing => 
            listing.status === 'active' ||
            listing.status === 'available' ||
            listing.status === 'Active' ||
            (listing.status === undefined && listing.isActive !== false)
        );

        // Create categories with calculated counts
        const categories = BATANGAS_PROPERTY_CATEGORIES.map((category, index) => {
            let count = 0;

            // Count properties for this category using better matching logic
            activeListings.forEach(listing => {
                const propertyType = (listing.propertyType || '').toLowerCase();
                const propertyCategory = (listing.propertyCategory || '').toLowerCase();
                const listingTitle = (listing.title || '').toLowerCase();
                const listingDescription = (listing.description || '').toLowerCase();
                const searchText = `${propertyType} ${propertyCategory} ${listingTitle} ${listingDescription}`;

                // Check if property matches this category
                let matchesCategory = false;

                // First, check if property type matches any of this category's property types
                for (const type of category.propertyTypes) {
                    const typeLower = type.toLowerCase();
                    // Direct property type match
                    if (propertyType === typeLower || propertyType.includes(typeLower)) {
                        matchesCategory = true;
                        break;
                    }
                }

                // If no direct match, check using category-specific keywords
                if (!matchesCategory) {
                    switch(category.name) {
                        case 'Residential Property':
                            const residentialKeywords = ['house', 'apartment', 'condo', 'condominium', 'townhouse', 'dormitory', 'room', 'bedspace', 'residential', 'home', 'villa', 'bungalow', 'duplex'];
                            matchesCategory = residentialKeywords.some(keyword => 
                                searchText.includes(keyword) || 
                                propertyType.includes(keyword) || 
                                propertyCategory.includes(keyword)
                            );
                            break;
                        case 'Commercial Property':
                            const commercialKeywords = ['commercial', 'office', 'retail', 'shop', 'kiosk', 'stall', 'store', 'mall', 'business', 'establishment', 'showroom'];
                            matchesCategory = commercialKeywords.some(keyword => 
                                searchText.includes(keyword) || 
                                propertyType.includes(keyword) || 
                                propertyCategory.includes(keyword)
                            );
                            break;
                        case 'Industrial Property':
                            const industrialKeywords = ['industrial', 'warehouse', 'factory', 'storage', 'manufacturing', 'plant', 'facility', 'workshop'];
                            matchesCategory = industrialKeywords.some(keyword => 
                                searchText.includes(keyword) || 
                                propertyType.includes(keyword) || 
                                propertyCategory.includes(keyword)
                            );
                            break;
                        case 'Land / Lot':
                            const landKeywords = ['land', 'lot', 'plot', 'agricultural', 'farm', 'agriculture', 'property', 'vacant', 'empty', 'beachfront'];
                            matchesCategory = landKeywords.some(keyword => 
                                searchText.includes(keyword) || 
                                propertyType.includes(keyword) || 
                                propertyCategory.includes(keyword)
                            );
                            break;
                        case 'Special Purpose Property':
                            const specialKeywords = ['resort', 'event', 'venue', 'school', 'sports', 'facility', 'special', 'purpose', 'institutional', 'hotel', 'motel', 'inn', 'parking', 'hospitality'];
                            matchesCategory = specialKeywords.some(keyword => 
                                searchText.includes(keyword) || 
                                propertyType.includes(keyword) || 
                                propertyCategory.includes(keyword)
                            );
                            break;
                        case 'Condominium':
                            const condoKeywords = ['condominium', 'condo', 'penthouse', 'studio unit', 'loft unit'];
                            matchesCategory = condoKeywords.some(keyword => 
                                searchText.includes(keyword) || 
                                propertyType.includes(keyword) || 
                                propertyCategory.includes(keyword)
                            );
                            break;
                    }
                }

                if (matchesCategory) {
                    count++;
                }
            });

            return {
                ...category,
                count: count,
                number: index + 1
            };
        });

        // Render categories
        container.innerHTML = categories.map(category => `
            <div class="category-card ${selectedCategory === category.name ? 'active' : ''}" 
                 data-category="${category.name}">
                <div class="category-icon">${category.icon}</div>
                <div class="category-name">${category.name}</div>
                <div class="category-count">${category.count} Properties</div>
                <div style="margin-top: 15px; text-align: left; font-size: 13px; color: ${selectedCategory === category.name ? 'rgba(255,255,255,0.9)' : 'var(--text-light)'}">
                    <div style="margin-bottom: 8px; font-style: italic;">${category.description}</div>
                </div>
            </div>
        `).join('');

        // Add event listeners to category cards
        document.querySelectorAll('.category-card[data-category]').forEach(card => {
            card.addEventListener('click', function() {
                const categoryName = this.getAttribute('data-category');
                filterByCategory(categoryName);
            });
        });

    } catch (error) {
        console.error("Error loading categories:", error);
        container.innerHTML = `
            <div class="error-state">
                <div class="error-icon">‚ö†Ô∏è</div>
                <p>Error loading categories</p>
            </div>
        `;
    }
}

// Filter by category function
async function filterByCategory(categoryName) {
    const filters = { propertyCategory: categoryName };

    // Log category click as a search event for recommendations
    try {
        const currentUser = auth.currentUser;
        if (currentUser) {
            await logSearchEvent(currentUser.uid, filters);
        }
    } catch (error) {
        console.log('Could not log category search event.', error.message);
    }

    // Store in localStorage for search results page
    localStorage.setItem('categoryFilter', categoryName);

    // Redirect to search results page with category filter
    const queryString = `?filters=${encodeURIComponent(JSON.stringify(filters))}`;
    window.location.href = `search_results.html${queryString}`;
}

// Update category UI
function updateCategoryUI() {
    document.querySelectorAll('.category-card').forEach(card => {
        const categoryName = card.getAttribute('data-category');
        if (categoryName === selectedCategory) {
            card.classList.add('active');
        } else {
            card.classList.remove('active');
        }
    });
}

// --- LISTINGS FUNCTIONS ---

async function loadAllListings() {
    try {
        console.log('üîÑ Loading all listings for Batangas...');
        
        // Fetch ALL properties
        const listingsQuery = query(collection(db, "properties"));
        const querySnapshot = await getDocs(listingsQuery);
        
        allListings = [];
        const userIds = new Set();
        
        querySnapshot.forEach((doc) => {
            const listing = {
                id: doc.id,
                ...doc.data()
            };
            allListings.push(listing);
            
            // Collect user IDs
            if (listing.userId) {
                userIds.add(listing.userId);
            } else if (listing.ownerId) {
                userIds.add(listing.ownerId);
            }
        });
        
        console.log(`   Found ${allListings.length} listings total`);
        
        await loadAllUserData(userIds);
        
        // Display all active listings initially
        displayFilteredListings();
        
        // Update categories after loading listings
        loadCategories();
        
    } catch (error) {
        console.error("   Error loading listings:", error);
        displayError(error);
    }
}

async function loadAllUserData(userIds) {
    userMap.clear();
    
    if (userIds.size === 0) return;
    
    for (const userId of userIds) {
        await loadUserData(userId);
    }
}

async function loadUserData(userId) {
    try {
        console.log(`üîç Attempting to load user: ${userId}`);
        
        // Only check users collection (both landlords and brokers are in users collection)
        const userDoc = await getDoc(doc(db, "users", userId));
        
        if (userDoc.exists()) {
            const userData = userDoc.data();
            console.log(`‚úÖ Found user ${userId} in database. Data:`, {
                fullName: userData.fullName,
                firstName: userData.firstName,
                lastName: userData.lastName,
                email: userData.email,
                role: userData.role
            });
            
            // Extract fullName with proper fallback
            let fullName = userData.fullName || '';
            
            // If no fullName, try to construct from firstName and lastName
            if (!fullName && (userData.firstName || userData.lastName)) {
                fullName = `${userData.firstName || ''} ${userData.lastName || ''}`.trim();
            }
            
            // If still no name, use email or default
            if (!fullName) {
                fullName = userData.email?.split('@')[0] || `User ${userId.substring(0, 8)}`;
            }
            
            const userInfo = {
                displayName: fullName.trim(),
                email: userData.email || 'Email not available',
                phone: userData.phone || 'Phone not available',
                role: userData.role || 'user'
            };
            
            userMap.set(userId, userInfo);
            
            console.log(`‚úÖ Loaded user ${userId}: "${userInfo.displayName}" (${userInfo.role})`);
            return;
        }
        
        // Default fallback if user not found
        console.warn(`‚ùå User ${userId} not found in users collection`);
        userMap.set(userId, {
            displayName: `User ${userId.substring(0, 8)}`,
            email: 'Email not available',
            phone: 'Phone not available',
            role: 'user'
        });
        
    } catch (error) {
        console.error(`‚ùå Error loading user ${userId}:`, error);
        userMap.set(userId, {
            displayName: `User ${userId.substring(0, 8)}`,
            email: 'Email not available',
            phone: 'Phone not available',
            role: 'user'
        });
    }
}

async function checkSavedStatus(listings) {
    try {
        const currentUser = auth.currentUser;
        if (!currentUser) return new Map();
        
        const savedRef = collection(db, 'savedProperties');
        const q = query(savedRef, where('userId', '==', currentUser.uid));
        const snapshot = await getDocs(q);
        
        const savedMap = new Map();
        snapshot.forEach(doc => {
            savedMap.set(doc.data().propertyId, true);
        });
        
        return savedMap;
    } catch (error) {
        console.error("Error checking saved status:", error);
        return new Map();
    }
}

// Display filtered listings - DASHBOARD ONLY SHOWS ALL ACTIVE PROPERTIES
function displayFilteredListings() {
    // Filter only active listings
    let filtered = allListings.filter(listing => {
        return listing.status === 'active' || 
               listing.status === 'available' || 
               listing.status === 'Active' || 
               (listing.status === undefined && listing.isActive !== false);
    });

    // Apply selected category filter ONLY (no search filters in dashboard)
    if (selectedCategory) {
        const categoryData = BATANGAS_PROPERTY_CATEGORIES.find(cat => cat.name === selectedCategory);
        if (categoryData) {
            filtered = filtered.filter(listing => {
                const propertyType = (listing.propertyType || '').toLowerCase();
                const propertyCategory = (listing.propertyCategory || '').toLowerCase();
                const listingTitle = (listing.title || '').toLowerCase();
                const listingDescription = (listing.description || '').toLowerCase();
                const searchText = `${propertyType} ${propertyCategory} ${listingTitle} ${listingDescription}`;

                // Check if property matches any of the category's property types
                for (const type of categoryData.propertyTypes) {
                    const typeLower = type.toLowerCase();
                    // Direct match
                    if (propertyType === typeLower || propertyCategory === typeLower) {
                        return true;
                    }
                    // Partial match
                    if (propertyType.includes(typeLower) || typeLower.includes(propertyType)) {
                        return true;
                    }
                    // Keyword match in search text
                    if (searchText.includes(typeLower)) {
                        return true;
                    }
                }

                // Special keyword matching for each category
                if (selectedCategory === 'Residential Property') {
                    const residentialKeywords = ['house', 'apartment', 'condo', 'condominium', 'townhouse', 'dormitory', 'room', 'bedspace', 'residential', 'home', 'villa'];
                    return residentialKeywords.some(keyword => searchText.includes(keyword));
                }

                if (selectedCategory === 'Commercial Property') {
                    const commercialKeywords = ['commercial', 'office', 'retail', 'shop', 'kiosk', 'stall', 'store', 'mall', 'business', 'establishment'];
                    return commercialKeywords.some(keyword => searchText.includes(keyword));
                }

                if (selectedCategory === 'Industrial Property') {
                    const industrialKeywords = ['industrial', 'warehouse', 'factory', 'storage', 'manufacturing', 'plant', 'facility'];
                    return industrialKeywords.some(keyword => searchText.includes(keyword));
                }

                if (selectedCategory === 'Land / Lot') {
                    const landKeywords = ['land', 'lot', 'plot', 'agricultural', 'farm', 'agriculture', 'property', 'vacant', 'empty'];
                    return landKeywords.some(keyword => searchText.includes(keyword));
                }

                if (selectedCategory === 'Special Purpose Property') {
                    const specialKeywords = ['resort', 'event', 'venue', 'school', 'sports', 'facility', 'special', 'purpose', 'institutional', 'hotel', 'motel', 'inn'];
                    return specialKeywords.some(keyword => searchText.includes(keyword));
                }

                return false;
            });
        }
    }

    // Update properties count text
    const propertiesCount = document.getElementById('propertiesCount');
    if (propertiesCount) {
        if (selectedCategory) {
            propertiesCount.textContent = `Showing ${filtered.length} ${selectedCategory} properties in Batangas`;
        } else {
            propertiesCount.textContent = `Showing ${filtered.length} properties in Batangas`;
        }
    }

    // Display filtered listings
    if (filtered.length === 0) {
        displayNoListings();
    } else {
        displayListings(filtered);
    }
}

async function displayListings(listings) {
  const container = document.getElementById('listingsContainer');
  
  // Check which properties are already saved
  const savedMap = await checkSavedStatus(listings);
  
  container.innerHTML = listings.map(listing => {
    const isSaved = savedMap.has(listing.id);
    const userInfo = userMap.get(listing.userId) || {
      displayName: `User ${listing.userId ? listing.userId.substring(0, 8) : 'Unknown'}`,
      email: 'N/A',
      phone: 'N/A',
      role: 'user'
    };
    
    const userInitials = userInfo.displayName.split(' ').map(n => n[0]).join('').toUpperCase() || 'UU';
    const listingType = getListingType(listing);
    const displayPrice = getDisplayPrice(listing);
    const priceClass = getPriceClass(listing);
    const typeBadgeClass = getTypeBadgeClass(listing);
    const typeBadgeText = getTypeBadgeText(listing);
    
    let mainPhoto;
    if (listing.photos && listing.photos.length > 0) {
      mainPhoto = listing.photos[0];
    } else if (listing.imageUrls && listing.imageUrls.length > 0) {
      mainPhoto = listing.imageUrls[0];
    } else if (listing.latitude && listing.longitude) {
      mainPhoto = `https://maps.googleapis.com/maps/api/staticmap?center=${listing.latitude},${listing.longitude}&zoom=15&size=400x200&markers=color:red%7C${listing.latitude},${listing.longitude}&key=${GOOGLE_MAPS_API_KEY}`;
    } else {
      mainPhoto = 'https://via.placeholder.com/400x200/0b2e52/white?text=No+Image';
    }
    
    const bedrooms = listing.bedrooms || (listingType === 'rent' && listing.propertyType === 'studio' ? 'Studio' : 0);
    const bathrooms = listing.bathrooms || 0;
    const area = listing.floorArea || listing.totalArea || 'N/A';
    
    return `
<div class="listing-card-wrapper">
    <a href="property_details.html?id=${listing.id}" class="listing-card-link">
        <div class="listing-card">
            <div class="listing-card-image-container">
                <img src="${mainPhoto}" alt="${listing.title}" class="listing-image">
                <div class="listing-type-badge ${typeBadgeClass}">${typeBadgeText}</div>
                
                <!-- Save Button - Heart icon for saving properties -->
                <button class="save-property-btn"
                    data-property-id="${listing.id}"
                    data-is-saved="${isSaved}"
                    aria-label="${isSaved ? 'Remove from saved' : 'Save property'}">
                    <span class="save-icon">${isSaved ? '‚ù§Ô∏è' : 'ü§ç'}</span>
                </button>
            </div>
            <div class="listing-content">
                <div class="listing-header">
                    <div>
                        <h3 class="listing-title">${listing.title || 'Untitled Property'}</h3>
                        <div class="listing-location">
                            <span class="location-icon">üìç</span>
                            <span class="location-text">${getCompleteAddress(listing)}</span>
                        </div>
                    </div>
                    <div class="listing-price ${priceClass}">${displayPrice}</div>
                </div>

                <div class="listing-details">
                    <div class="detail">
                        <span class="detail-icon">üõèÔ∏è</span>
                        <span class="detail-text">${bedrooms} ${bedrooms === 'Studio' ? '' : 'beds'}</span>
                    </div>
                    <div class="detail">
                        <span class="detail-icon">üöø</span>
                        <span class="detail-text">${bathrooms} baths</span>
                    </div>
                    <div class="detail">
                        <span class="detail-icon">üìê</span>
                        <span class="detail-text">${area} sqm</span>
                    </div>
                    ${listingType === 'rent' && listing.securityDeposit ? `
                    <div class="detail">
                        <span class="detail-icon">üí∞</span>
                        <span class="detail-text">Deposit: ‚Ç±${listing.securityDeposit.toLocaleString()}</span>
                    </div>` : ''}
                </div>

                <div class="listing-broker">
                    <div class="broker-avatar" aria-label="Broker avatar">${userInitials}</div>
                    <div class="broker-info">
                        <div class="broker-name" title="${userInfo.displayName}">${userInfo.displayName}</div>
                        <div class="broker-contact">
                            ${getRoleDisplayText(userInfo.role)} ‚Ä¢ ${listing.propertyType || 'Property'}
                        </div>
                    </div>
                </div>

                <div class="listing-status status-${listing.status || 'active'}">
                    ${listing.status || 'active'}
                </div>

                <div class="listing-actions">
                    <button class="action-btn contact-btn" 
                            data-user-id="${listing.userId}"
                            aria-label="Contact ${userInfo.role === 'landlord' ? 'owner' : 'broker'}">
                        <span class="contact-icon">üìû</span>
                        Contact ${userInfo.role === 'landlord' ? 'Owner' : 'Broker'}
                    </button>
                    <span class="action-btn view-btn" aria-label="View property details">
                        <span class="view-icon">üëÅÔ∏è</span>
                        View Details
                    </span>
                </div>
            </div>
        </div>
    </a>
</div>
    `;
  }).join('');
  
  // Setup event listeners for save buttons and contact buttons
  setTimeout(setupListingEventListeners, 100);
  
  // Force badges to be visible
  setTimeout(forceBadgeVisibility, 100);
}

function displayNoListings() {
    const container = document.getElementById('listingsContainer');
    container.innerHTML = `
        <div class="empty-state">
            <div class="empty-state-icon">üè†</div>
            <h3>No Properties Found in Batangas</h3>
            <p>There are currently no properties available in Batangas.</p>
            <button class="search-button" id="tryAgainBtn" style="margin-top: 20px;">
                <i class="fas fa-redo"></i>
                Try Again
            </button>
        </div>
    `;
    
    // Add event listener to Try Again button
    const tryAgainBtn = document.getElementById('tryAgainBtn');
    if (tryAgainBtn) {
        tryAgainBtn.addEventListener('click', loadAllListings);
    }
}

function displayError(error) {
    const container = document.getElementById('listingsContainer');
    container.innerHTML = `
        <div class="error-state">
            <div class="error-icon">‚ö†Ô∏è</div>
            <h3>Error Loading Properties</h3>
            <p>There was an error loading the property listings.</p>
            <button class="search-button" id="tryAgainBtn2" style="margin-top: 20px;">
                <i class="fas fa-redo"></i>
                Try Again
            </button>
        </div>
    `;
    
    // Add event listener to Try Again button
    const tryAgainBtn = document.getElementById('tryAgainBtn2');
    if (tryAgainBtn) {
        tryAgainBtn.addEventListener('click', loadAllListings);
    }
}

// --- EVENT HANDLERS ---

async function toggleSaveProperty(propertyId, buttonElement) {
    try {
        const currentUser = auth.currentUser;
        if (!currentUser) {
            alert('Please login to save properties');
            return;
        }
        
        const isSaved = buttonElement.querySelector('.save-icon').textContent.includes('‚ù§Ô∏è');
        
        if (isSaved) {
            // Remove from saved
            const savedRef = collection(db, 'savedProperties');
            const q = query(savedRef,
                where('userId', '==', currentUser.uid),
                where('propertyId', '==', propertyId)
            );
            const snapshot = await getDocs(q);
            
            if (!snapshot.empty) {
                await deleteDoc(snapshot.docs[0].ref);
                buttonElement.innerHTML = '<span class="save-icon">ü§ç</span>';
                buttonElement.setAttribute('data-is-saved', 'false');
                buttonElement.setAttribute('aria-label', 'Save property');
                console.log(`Property ${propertyId} removed from saved`);
                showSaveToast('Removed from saved', false);
            }
        } else {
            // Add to saved
            await addDoc(collection(db, 'savedProperties'), {
                userId: currentUser.uid,
                propertyId: propertyId,
                savedAt: new Date(),
                createdAt: new Date()
            });
            
            // Log save event
            await logSaveEvent(currentUser.uid, propertyId);
            
            buttonElement.innerHTML = '<span class="save-icon">‚ù§Ô∏è</span>';
            buttonElement.setAttribute('data-is-saved', 'true');
            buttonElement.setAttribute('aria-label', 'Remove from saved');
            console.log(`Property ${propertyId} saved`);
            showSaveToast('Property saved!', false);
        }

    } catch (error) {
        console.error("Error toggling save:", error);
        showSaveToast("Error saving property", true);
    }
}

function showSaveToast(message, isError = false) {
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${isError ? '#ef4444' : '#10b981'};
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        z-index: 9999;
        font-weight: 500;
        box-shadow: var(--shadow-lg);
        animation: slideIn 0.3s ease;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Force all type badges to be visible
function forceBadgeVisibility() {
    document.querySelectorAll('.listing-type-badge').forEach(badge => {
        badge.style.opacity = '1';
        badge.style.visibility = 'visible';
        badge.style.display = 'block';
    });
    
    document.querySelectorAll('.listing-ai-badge, .listing-match-badge').forEach(badge => {
        badge.style.opacity = '1';
        badge.style.visibility = 'visible';
        badge.style.display = 'block';
    });
}

// --- EVENT LISTENER SETUP ---

function setupEventListeners() {
    // Search and filter buttons
    const applyFiltersBtn = document.getElementById('applyFilters');
    const resetFiltersBtn = document.getElementById('resetFilters');
    
    if (applyFiltersBtn) {
        applyFiltersBtn.addEventListener('click', applyFilters);
    }
    
    if (resetFiltersBtn) {
        resetFiltersBtn.addEventListener('click', resetFilters);
    }
    
    // Refresh recommendations button
    const refreshRecoBtn = document.getElementById('refreshRecommendationsBtn');
    if (refreshRecoBtn) {
        refreshRecoBtn.addEventListener('click', async function() {
            try {
                // Show loading state
                const recoContainer = document.getElementById('recommendedListingsContainer');
                if (recoContainer) {
                    recoContainer.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px;">
                            <div class="spinner" style="border: 4px solid var(--bg-light); 
                                border-top: 4px solid var(--primary); border-radius: 50%; 
                                width: 40px; height: 40px; animation: spin 1s linear infinite; 
                                margin: 0 auto 20px;"></div>
                            <p style="color: var(--text-light);">Refreshing AI recommendations...</p>
                        </div>
                    `;
                }
                
                await loadRecommendationsFromPython();
            } catch (error) {
                console.log("Could not refresh recommendations:", error);
            }
        });
    }
    
    // Initialize messaging listeners
    initializeMessagingListeners();
}

function setupListingEventListeners() {
    // Save property buttons
    document.querySelectorAll('#listingsContainer .save-property-btn').forEach(btn => {
        // Remove existing event listeners
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        // Add new event listener
        newBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            const propertyId = this.getAttribute('data-property-id');
            if (propertyId) {
                toggleSaveProperty(propertyId, this);
            }
        });
    });
    
    // Contact buttons - prevent card click when clicking contact button
    document.querySelectorAll('#listingsContainer .action-btn.contact-btn').forEach(btn => {
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        newBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            const userId = this.getAttribute('data-user-id');
            if (userId) {
                window.contactBroker(userId);
            }
        });
    });
}

// --- RECOMMENDATIONS FUNCTIONS (USING PYTHON BACKEND) ---

async function loadRecommendationsFromPython() {
    try {
        const currentUser = auth.currentUser;
        if (!currentUser) {
            console.log('User not authenticated, skipping recommendations');
            showRecentPropertiesFallback();
            return;
        }

        const userId = currentUser.uid;
        console.log('Loading recommendations from Python API for user:', userId);

        // Show loading state
        const recoContainer = document.getElementById('recommendedListingsContainer');
        if (recoContainer) {
            recoContainer.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px;">
                    <div class="spinner" style="border: 4px solid var(--bg-light); border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                    <p style="color: var(--text-light);">Finding properties you'll love...</p>
                </div>
            `;
        }

        // Call Python backend API
        let response;
        try {
            response = await fetch(`${PYTHON_API_URL}?user_id=${userId}`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                }
            });

            if (!response.ok) {
                throw new Error(`API request failed with status ${response.status}`);
            }

            const responseText = await response.text();
            console.log('API Response status:', response.status);
            console.log('API Response text (first 500 chars):', responseText.substring(0, 500));

            // Check if response is empty
            if (!responseText || responseText.trim() === '') {
                console.log('Empty response from API, showing fallback');
                showRecentPropertiesFallback();
                return;
            }

            let data;
            try {
                data = JSON.parse(responseText);
            } catch (parseError) {
                console.error('Failed to parse JSON response:', parseError);
                console.error('Response text:', responseText);
                showRecentPropertiesFallback();
                return;
            }

            // Debug the response structure
            console.log('Parsed API data:', {
                success: data.success,
                has_history: data.has_history,
                saved_count: data.saved_count,
                recommendation_type: data.recommendation_type,
                recommendations_count: data.recommendations ? data.recommendations.length : 0,
                message: data.message,
                user_message: data.user_message
            });

            // Update the subtitle based on response
            const subtitle = document.getElementById('recommendationsSubtitle');
            if (subtitle) {
                if (data.user_message) {
                    subtitle.textContent = data.user_message;
                } else if (data.message) {
                    subtitle.textContent = data.message;
                }
            }

            // Check if we have AI recommendations
            if (data.recommendation_type === 'ai' && data.recommendations && Array.isArray(data.recommendations) && data.recommendations.length > 0) {
                console.log(`Received ${data.recommendations.length} AI recommendations`);
                
                // Map recommendations to actual listings
                const recommendedListings = data.recommendations
                    .map(rec => {
                        // Find the matching listing - check both id and property_id
                        const listing = allListings.find(l => l.id === rec.id || l.id === rec.property_id);
                        if (listing) {
                            return {
                                ...listing,
                                recoScore: rec.match_score || rec.similarity_score || 0,
                                similarity_score: rec.similarity_score || rec.match_score || 0,
                                similar_to: rec.match_reason || "Similar to your preferences"
                            };
                        }
                        console.log('Could not find listing for recommendation:', rec.id || rec.property_id);
                        return null;
                    })
                    .filter(l => l !== null)
                    .slice(0, 5); // Take top 5

                if (recommendedListings.length > 0) {
                    console.log(`Mapped ${recommendedListings.length} recommendations to listings`);
                    displayRecommendedListingsPython(recommendedListings, 'personalized');
                } else {
                    console.log('No listings matched the recommendations, showing fallback');
                    showRecentPropertiesFallback();
                }
            } else if (data.recommendation_type === 'partial' && data.recommendations && Array.isArray(data.recommendations) && data.recommendations.length > 0) {
                // User has some history but not enough for full AI
                console.log(`Received ${data.recommendations.length} partial recommendations`);
                
                // Map recommendations to actual listings
                const recommendedListings = data.recommendations
                    .map(rec => {
                        // Find the matching listing - check both id and property_id
                        const listing = allListings.find(l => l.id === rec.id || l.id === rec.property_id);
                        if (listing) {
                            return {
                                ...listing,
                                recoScore: rec.match_score || rec.similarity_score || 0,
                                similarity_score: rec.similarity_score || rec.match_score || 0,
                                similar_to: rec.match_reason || `You've saved ${data.saved_count} properties. Save ${3 - data.saved_count} more for AI recommendations!`
                            };
                        }
                        return null;
                    })
                    .filter(l => l !== null)
                    .slice(0, 5);

                if (recommendedListings.length > 0) {
                    displayRecommendedListingsPython(recommendedListings, 'partial');
                    
                    // Add a progress message
                    setTimeout(() => {
                        const section = document.getElementById('recommendedSection');
                        if (section) {
                            let progressDiv = section.querySelector('.progress-prompt');
                            if (!progressDiv && data.saved_count < 3) {
                                progressDiv = document.createElement('div');
                                progressDiv.className = 'progress-prompt';
                                progressDiv.style.cssText = `
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    color: white;
                                    padding: 15px 20px;
                                    border-radius: 8px;
                                    margin-top: 20px;
                                    text-align: center;
                                    animation: fadeIn 0.5s ease;
                                `;
                                progressDiv.innerHTML = `
                                    <div style="display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap;">
                                        <div style="flex: 1; max-width: 600px;">
                                            <strong>üí° Get AI Recommendations!</strong>
                                            <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">
                                                You've saved ${data.saved_count} properties. Save ${3 - data.saved_count} more to receive personalized AI recommendations based on your preferences.
                                            </p>
                                        </div>
                                    </div>
                                `;
                                section.appendChild(progressDiv);
                            }
                        }
                    }, 100);
                } else {
                    showRecentPropertiesFallback();
                }
            } else {
                console.log('No recommendations in response, showing fallback. Reason:', data.message);
                showRecentPropertiesFallback();
            }

        } catch (fetchError) {
            console.error('Fetch error:', fetchError);
            showRecentPropertiesFallback();
            return;
        }

    } catch (error) {
        console.error('Error loading recommendations:', error);
        showRecentPropertiesFallback();
    }
}

// Fallback function for recent listings
async function showRecentPropertiesFallback() {
  try {
    console.log('Showing recent properties as fallback');
    
    // Get recent active properties (sorted by creation date if available)
    const activeListings = allListings.filter(listing => 
      listing.status === 'active' ||
      listing.status === 'available' ||
      listing.status === 'Active' ||
      (listing.status === undefined && listing.isActive !== false)
    );
    
    // Sort by date if available, otherwise take first 5
    const recentListings = activeListings
      .sort((a, b) => {
        const dateA = a.createdAt || a.uploadedAt || 0;
        const dateB = b.createdAt || b.uploadedAt || 0;
        return dateB - dateA; // Newest first
      })
      .slice(0, 5); // Take only top 5
    
if (recentListings.length > 0) {
    displayRecommendedListingsPython(recentListings, 'recent');
      
      // Add a prompt message below the section (without button)
      setTimeout(() => {
        const section = document.getElementById('recommendedSection');
        if (section) {
          let promptDiv = section.querySelector('.recent-prompt');
          if (!promptDiv) {
            promptDiv = document.createElement('div');
            promptDiv.className = 'recent-prompt';
            promptDiv.style.cssText = `
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
              padding: 15px 20px;
              border-radius: 8px;
              margin-top: 20px;
              text-align: center;
              animation: fadeIn 0.5s ease;
            `;
            promptDiv.innerHTML = `
              <div style="display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap;">
                <div style="flex: 1; max-width: 600px;">
                  <strong>üí° Get AI Recommendations!</strong>
                  <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">
                    Save 3+ properties you like to receive personalized AI recommendations based on your preferences.
                  </p>
                </div>
              </div>
            `;
            section.appendChild(promptDiv);
          }
        }
      }, 100);
    } else {
      // If no recent listings, show a message
      const recoContainer = document.getElementById('recommendedListingsContainer');
      if (recoContainer) {
        recoContainer.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 40px 20px;">
            <div style="font-size: 48px; margin-bottom: 20px;">üè†</div>
            <h3 style="color: var(--text-dark); margin-bottom: 10px;">Start Your Property Journey</h3>
            <p style="color: var(--text-light); max-width: 500px; margin: 0 auto 20px;">
              Browse properties and save your favorites. After saving 3+ properties, 
              our AI will learn your preferences and show personalized recommendations!
            </p>
          </div>
        `;
      }
    }
  } catch (error) {
    console.error('Error loading recent listings:', error);
    const recoContainer = document.getElementById('recommendedListingsContainer');
    if (recoContainer) {
      recoContainer.innerHTML = `
        <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 40px 20px;">
          <div style="font-size: 48px; margin-bottom: 20px;">‚ö†Ô∏è</div>
          <h3 style="color: var(--text-dark); margin-bottom: 10px;">Explore Properties</h3>
          <p style="color: var(--text-light); max-width: 500px; margin: 0 auto 20px;">
            Browse through our listings and save properties you're interested in.
          </p>
        </div>
      `;
    }
  }
}

// Function to display recommendations from Python
function displayRecommendedListingsPython(recommendations, type = 'personalized') {
  const recoContainer = document.getElementById('recommendedListingsContainer');
  const sectionTitle = document.querySelector('#recommendedSection .section-title');
  const sectionSubtitle = document.querySelector('#recommendationsSubtitle');
  
  if (!recoContainer) return;
  
  // Update section title based on recommendation type
  if (sectionTitle) {
    if (type === 'personalized') {
      sectionTitle.innerHTML = '<i class="fas fa-robot"></i> AI Recommendations For You';
      if (sectionSubtitle) {
        sectionSubtitle.textContent = 'Based on your saved properties and search history';
      }
    } else if (type === 'partial') {
      sectionTitle.innerHTML = '<i class="fas fa-star"></i> Getting Started';
      if (sectionSubtitle) {
        sectionSubtitle.textContent = 'Save more properties to unlock AI recommendations';
      }
    } else {
      sectionTitle.innerHTML = '<i class="fas fa-clock"></i> Recent Properties';
      if (sectionSubtitle) {
        sectionSubtitle.textContent = 'Browse these recently listed properties. Save some to get AI recommendations!';
      }
    }
  }
  
  if (!recommendations || recommendations.length === 0) {
    recoContainer.innerHTML = `
      <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 40px 20px;">
        <div style="font-size: 48px; margin-bottom: 20px;">üè†</div>
        <h3 style="color: var(--text-dark); margin-bottom: 10px;">Start Building Your Preferences</h3>
        <p style="color: var(--text-light); max-width: 500px; margin: 0 auto 20px;">
          Save properties you like or search for properties to get personalized AI recommendations!
        </p>
      </div>`;
    return;
  }

  // Check which properties are already saved
  checkSavedStatus(recommendations).then(savedMap => {
    recoContainer.innerHTML = recommendations.map(property => {
      const isSaved = savedMap.has(property.id);
      const userInfo = userMap.get(property.userId) || {
        displayName: `User ${property.userId ? property.userId.substring(0, 8) : 'Unknown'}`,
        email: 'N/A',
        phone: 'N/A',
        role: 'user'
      };
      
      const userInitials = userInfo.displayName.split(' ').map(n => n[0]).join('').toUpperCase() || 'UU';
      const listingType = getListingType(property);
      const displayPrice = getDisplayPrice(property);
      const priceClass = getPriceClass(property);
      const typeBadgeClass = getTypeBadgeClass(property);
      const typeBadgeText = getTypeBadgeText(property);
      
      const photo = property.photos?.[0] || property.imageUrls?.[0] || `https://via.placeholder.com/400x200/0b2e52/white?text=${encodeURIComponent(property.title || 'Property')}`;
      const matchScore = property.recoScore ? Math.round(property.recoScore) : null;
      
      const bedrooms = property.bedrooms || (listingType === 'rent' && property.propertyType === 'studio' ? 'Studio' : 0);
      const bathrooms = property.bathrooms || 0;
      const area = property.floorArea || property.totalArea || 'N/A';
      
      // Add different badge for AI vs Recent vs Partial
      let recommendationBadge = '';
      if (type === 'personalized') {
        recommendationBadge = `<div class="listing-ai-badge">‚ú® AI Pick</div>`;
      } else if (type === 'partial') {
        recommendationBadge = `<div class="listing-partial-badge" style="position: absolute; top: 10px; right: 10px; background: #f59e0b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; z-index: 2;">SAVE MORE</div>`;
      } else {
        recommendationBadge = `<div class="listing-recent-badge" style="position: absolute; top: 10px; right: 10px; background: #6b7280; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; z-index: 2;">RECENT</div>`;
      }
      
      return `
        <div class="listing-card-wrapper">
            <a href="property_details.html?id=${property.id}" class="listing-card-link">
                <div class="listing-card">
                    <div class="listing-card-image-container" style="position: relative;">
                        <img src="${photo}" alt="${property.title || 'Property'}" class="listing-image">
                        ${matchScore && matchScore > 50 ? `
                            <div class="listing-match-badge">
                                ${matchScore}% Match
                            </div>
                        ` : ''}
                        ${recommendationBadge}
                        <div class="listing-type-badge ${typeBadgeClass}">${typeBadgeText}</div>
                        
                        <!-- Save Button - Heart icon for saving properties -->
                        <button class="save-property-btn"
                            data-property-id="${property.id}"
                            data-is-saved="${isSaved}"
                            aria-label="${isSaved ? 'Remove from saved' : 'Save property'}">
                            <span class="save-icon">${isSaved ? '‚ù§Ô∏è' : 'ü§ç'}</span>
                        </button>
                    </div>
                    <div class="listing-content">
                        <div class="listing-header">
                            <div>
                                <h3 class="listing-title">${property.title || 'Untitled Property'}</h3>
                                <div class="listing-location">
                                    <span class="location-icon">üìç</span>
                                    <span class="location-text">${getCompleteAddress(property)}</span>
                                </div>
                            </div>
                            <div class="listing-price ${priceClass}">${displayPrice}</div>
                        </div>
                        
                        <div class="listing-details">
                            ${bedrooms ? `
                                <div class="detail">
                                    <span class="detail-icon">üõèÔ∏è</span>
                                    <span class="detail-text">${bedrooms} ${bedrooms === 'Studio' ? '' : 'beds'}</span>
                                </div>
                            ` : ''}
                            ${bathrooms ? `
                                <div class="detail">
                                    <span class="detail-icon">üöø</span>
                                    <span class="detail-text">${bathrooms} baths</span>
                                </div>
                            ` : ''}
                            ${area && area !== 'N/A' ? `
                                <div class="detail">
                                    <span class="detail-icon">üìê</span>
                                    <span class="detail-text">${area} sqm</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="listing-broker">
                            <div class="broker-avatar" aria-label="Broker avatar">${userInitials}</div>
                            <div class="broker-info">
                                <div class="broker-name" title="${userInfo.displayName}">${userInfo.displayName}</div>
                                <div class="broker-contact">
                                    ${getRoleDisplayText(userInfo.role)} ‚Ä¢ ${property.propertyType || 'Property'}
                                </div>
                            </div>
                        </div>
                        
                        <div class="listing-status status-${property.status || 'active'}">
                            ${property.status || 'active'}
                        </div>
                        
                        <div class="listing-actions">
                            <button class="action-btn contact-btn" 
                                    data-user-id="${property.userId}"
                                    aria-label="Contact ${userInfo.role === 'landlord' ? 'owner' : 'broker'}">
                                <span class="contact-icon">üìû</span>
                                Contact ${userInfo.role === 'landlord' ? 'Owner' : 'Broker'}
                            </button>
                            <span class="action-btn view-btn" aria-label="View property details">
                                <span class="view-icon">üëÅÔ∏è</span>
                                View Details
                            </span>
                        </div>
                    </div>
                </div>
            </a>
        </div>
      `;
    }).join('');
    
    // Setup event listeners for save buttons and contact buttons in recommendations
    setTimeout(() => {
        setupRecommendationsEventListeners();
    }, 100);
    
    // Force badges to be visible
    setTimeout(forceBadgeVisibility, 100);
  });
}

function setupRecommendationsEventListeners() {
    // Save property buttons in recommendations
    const recoContainer = document.getElementById('recommendedListingsContainer');
    if (recoContainer) {
        recoContainer.querySelectorAll('.save-property-btn').forEach(btn => {
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            newBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                const propertyId = this.getAttribute('data-property-id');
                if (propertyId) {
                    toggleSaveProperty(propertyId, this);
                }
            });
        });
        
        // Contact buttons in recommendations
        recoContainer.querySelectorAll('.action-btn.contact-btn').forEach(btn => {
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            newBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                const userId = this.getAttribute('data-user-id');
                if (userId) {
                    window.contactBroker(userId);
                }
            });
        });
    }
}
// --- INITIALIZATION ---

// Initialize dropdowns
function initializeDropdowns() {
    const transactionTypeSelect = document.getElementById('filterListingType');
    const categorySelect = document.getElementById('filterPropertyCategory');

    if (transactionTypeSelect) {
        transactionTypeSelect.addEventListener('change', updateCategoryDropdown);
    }
    
    if (categorySelect) {
        categorySelect.addEventListener('change', updateTypeDropdown);
    }

    // Initialize with current values
    if (transactionTypeSelect && categorySelect) {
        updateCategoryDropdown();
    }
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    initializeDropdowns();
    
    // Check authentication and load user data
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = "../login.html";
            return;
        }

        try {
            console.log('üë§ Logged in user UID:', user.uid);

            // Load user data for welcome message
            const userRef = doc(db, "users", user.uid);
            const userSnap = await getDoc(userRef);

            if (userSnap.exists()) {
                const userData = userSnap.data();
                welcomeText.textContent = `Welcome back, ${userData.fullName || userData.email || 'User'}!`;
            } else {
                welcomeText.textContent = "Welcome to BahAI Real Estate!";
            }
        } catch (error) {
            console.error("Error loading user:", error);
            welcomeText.textContent = "Welcome to BahAI Real Estate!";
        }

        // Load listings and categories
        loadAllListings();
        
        // Load recommendations from Python backend
        setTimeout(() => {
            loadRecommendationsFromPython().catch(error => {
                console.log("Python recommendations failed to load:", error);
            });
        }, 1000);

        // Setup event listeners
        setupEventListeners();
    });
});

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .listing-ai-badge {
        position: absolute;
        top: 10px;
        left: 10px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        z-index: 2;
    }
    
    .listing-match-badge {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background: #10b981;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        z-index: 2;
    }
`;
document.head.appendChild(style);

// ================================ WINDOW FUNCTIONS (for backward compatibility) =============================

window.applyFilters = applyFilters;
window.resetFilters = resetFilters;
window.toggleSaveProperty = toggleSaveProperty;
window.loadAllListings = loadAllListings;
window.filterByCategory = filterByCategory;
window.loadRecommendationsFromPython = loadRecommendationsFromPython;
</script>

</body>
</html>