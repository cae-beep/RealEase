<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard - BahAI Real Estate</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    :root {
      --primary: #0b2e52;
      --primary-dark: #001F3F;
      --primary-light: #002f3f;
      --secondary: #1976d2;
      --accent: #ff9800;
      --text-dark: #1a202c;
      --text-light: #718096;
      --bg-light: #f8fafc;
      --bg-white: #ffffff;
      --border: #e2e8f0;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --rent-color: #10b981;
      --sale-color: #3b82f6;
      --lease-color: #8e44ad;
    }
   
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', Arial, sans-serif;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      color: var(--text-dark);
      display: flex;
      min-height: 100vh;
    }

    .mobile-menu-toggle {
      display: none;
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1001;
      background: var(--primary);
      color: white;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 12px;
      font-size: 24px;
      cursor: pointer;
      box-shadow: var(--shadow-lg);
    }

    .container {
      flex: 1;
      margin-left: 280px;
      padding: 30px;
      transition: margin-left 0.3s ease;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      gap: 20px;
    }

    .page-header h1 {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 8px;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1.2;
    }

    .page-header p {
      color: var(--text-light);
      font-size: 16px;
      line-height: 1.4;
    }

    .add-button {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .add-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      background: linear-gradient(135deg, var(--primary-dark), var(--primary));
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--bg-white);
      padding: 25px;
      border-radius: 16px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 8px;
      line-height: 1;
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-light);
      font-weight: 500;
    }

    .stat-trend {
      font-size: 12px;
      margin-top: 5px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .trend-up {
      color: #10b981;
    }

    .trend-down {
      color: #ef4444;
    }

    .filters-section {
      background: var(--bg-white);
      padding: 25px;
      border-radius: 16px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      margin-bottom: 30px;
    }

    .filters-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .filter-count {
      font-size: 14px;
      color: var(--text-light);
      font-weight: 400;
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .filter-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-dark);
    }

    .filter-select, .filter-input {
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      font-family: 'Inter', sans-serif;
      transition: all 0.3s ease;
      background: var(--bg-white);
      width: 100%;
    }

    .filter-select:focus, .filter-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(11, 46, 82, 0.1);
    }

    .filter-select[multiple] {
      height: 120px;
      padding: 10px;
    }

    /* AMENITIES STYLES - UPDATED */
    .amenities-group {
      grid-column: 1 / -1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .amenities-container {
      background: var(--bg-white);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
    }

    .amenities-container:focus-within {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(11, 46, 82, 0.1);
    }

    .amenities-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
    }

    .amenity-option {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      border-radius: 10px;
      border: 2px solid var(--border);
      background: var(--bg-light);
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      user-select: none;
      flex-shrink: 0;
      white-space: nowrap;
    }

    .amenity-option:hover {
      border-color: var(--primary-light);
      background: rgba(11, 46, 82, 0.05);
      transform: translateY(-2px);
    }

    .amenity-option input[type="checkbox"] {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }

    .amenity-checkbox {
      width: 20px;
      height: 20px;
      border: 2px solid var(--text-light);
      border-radius: 6px;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .amenity-checkbox::after {
      content: '‚úì';
      color: white;
      font-weight: bold;
      font-size: 14px;
      opacity: 0;
      transform: scale(0);
      transition: all 0.2s ease;
    }

    .amenity-option input[type="checkbox"]:checked ~ .amenity-checkbox {
      background: var(--primary);
      border-color: var(--primary);
    }

    .amenity-option input[type="checkbox"]:checked ~ .amenity-checkbox::after {
      opacity: 1;
      transform: scale(1);
    }

    .amenity-option input[type="checkbox"]:checked ~ .amenity-label {
      color: var(--primary);
      font-weight: 600;
    }

    .amenity-option input[type="checkbox"]:checked ~ .amenity-label .amenity-icon {
      transform: scale(1.1);
    }

    .amenity-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--text-dark);
      transition: color 0.2s ease;
    }

    .amenity-icon {
      font-size: 18px;
      transition: transform 0.2s ease;
    }

    .amenities-counter {
      text-align: center;
      padding: 10px;
      background: var(--bg-light);
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 14px;
      color: var(--text-dark);
      border: 1px solid var(--border);
    }

    .amenities-counter #selectedCount {
      font-weight: 700;
      color: var(--primary);
      font-size: 16px;
    }

    .amenities-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .amenity-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .select-all {
      background: var(--primary);
      color: white;
    }

    .select-all:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .clear-all {
      background: var(--bg-white);
      color: var(--text-dark);
      border: 2px solid var(--border);
    }

    .clear-all:hover {
      background: var(--bg-light);
      border-color: var(--text-light);
    }

    .filter-actions {
      display: flex;
      gap: 12px;
      align-items: end;
      grid-column: 1 / -1;
    }

    .apply-filters, .reset-filters {
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      white-space: nowrap;
    }

    .apply-filters {
      background: var(--primary);
      color: white;
    }

    .apply-filters:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .reset-filters {
      background: var(--bg-light);
      color: var(--text-dark);
      border: 1px solid var(--border);
    }

    .reset-filters:hover {
      background: var(--border);
    }

    .listings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 25px;
    }

    .listing-card {
      background: var(--bg-white);
      border-radius: 16px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      overflow: hidden;
      cursor: pointer;
    }

    .listing-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }

    .listing-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-bottom: 1px solid var(--border);
    }

    .listing-content {
      padding: 20px;
    }

    .listing-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
      gap: 10px;
    }

    .listing-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 5px;
      line-height: 1.3;
      word-wrap: break-word;
    }

    .listing-price {
      font-size: 20px;
      font-weight: 700;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .price-rent {
      color: var(--rent-color);
    }

    .price-sale {
      color: var(--sale-color);
    }

    .price-lease {
      color: var(--lease-color);
    }

    .listing-location {
      color: var(--text-light);
      font-size: 14px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 5px;
      line-height: 1.4;
    }

    .listing-details {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .detail {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
      color: var(--text-light);
      white-space: nowrap;
    }

    .listing-broker {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 15px;
      padding: 10px;
      background: var(--bg-light);
      border-radius: 8px;
    }

    .broker-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
      flex-shrink: 0;
    }

    .broker-info {
      flex: 1;
      min-width: 0;
    }

    .broker-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-dark);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .broker-contact {
      font-size: 12px;
      color: var(--text-light);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .listing-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      white-space: nowrap;
    }

    .status-active {
      background: #d1fae5;
      color: #065f46;
    }

    .status-pending {
      background: #fef3c7;
      color: #92400e;
    }

    .status-sold {
      background: #e5e7eb;
      color: #374151;
    }

    .status-inactive {
      background: #fca5a5;
      color: #7f1d1d;
    }

    .listing-type-badge {
      position: absolute;
      top: 12px;
      left: 12px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      color: white;
    }

    .type-rent {
      background: var(--rent-color);
    }

    .type-sale {
      background: var(--sale-color);
    }

    .type-lease {
      background: var(--lease-color);
    }

    .listing-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .action-btn {
      flex: 1;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
    }

    .contact-btn {
      background: var(--secondary);
      color: white;
    }

    .contact-btn:hover {
      background: #1565c0;
      transform: translateY(-1px);
    }

    .view-btn {
      background: var(--bg-light);
      color: var(--text-dark);
      border: 1px solid var(--border);
    }

    .view-btn:hover {
      background: var(--border);
      transform: translateY(-1px);
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
      padding: 20px;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal-content {
      background: var(--bg-white);
      border-radius: 16px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
    }

    .modal-header {
      padding: 30px 40px;
      border-bottom: 1px solid var(--border);
      position: relative;
    }

    .modal-title-section h2 {
      font-size: 24px;
      margin-bottom: 10px;
      color: var(--text-dark);
      line-height: 1.3;
    }

    .modal-subtitle {
      color: var(--text-light);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
      line-height: 1.4;
    }

    .modal-price-section {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .modal-price {
      font-size: 32px;
      font-weight: 700;
    }

    .modal-status {
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      color: white;
    }

    .close-modal {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--bg-light);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-modal:hover {
      background: var(--border);
      transform: scale(1.1);
    }

    #propertyMap {
      width: 100%;
      height: 300px;
      border-radius: 12px;
      margin-top: 10px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-light);
      grid-column: 1 / -1;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 20px;
      margin-bottom: 10px;
      color: var(--text-dark);
    }

    .loading-state {
      text-align: center;
      padding: 40px 20px;
      grid-column: 1 / -1;
    }

    .spinner {
      border: 4px solid var(--bg-light);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error-state {
      text-align: center;
      padding: 40px 20px;
      grid-column: 1 / -1;
      background: var(--bg-white);
      border-radius: 16px;
      box-shadow: var(--shadow);
    }

    .error-icon {
      font-size: 48px;
      margin-bottom: 20px;
      color: #ef4444;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .container {
        margin-left: 0;
        padding: 25px;
      }
     
      .mobile-menu-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
      }
     
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
     
      .listings-grid {
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
      }
     
      .topbar {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
     
      .add-button {
        align-self: flex-start;
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }
     
      .mobile-menu-toggle {
        top: 15px;
        left: 15px;
        width: 45px;
        height: 45px;
        font-size: 20px;
      }
     
      .page-header h1 {
        font-size: 24px;
      }
     
      .page-header p {
        font-size: 14px;
      }
     
      .stats-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
     
      .stat-card {
        padding: 20px;
      }
     
      .stat-value {
        font-size: 32px;
      }
     
      .filters-section {
        padding: 20px;
      }
     
      .filters-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
     
      .filter-actions {
        flex-direction: column;
        align-items: stretch;
      }
     
      .apply-filters, .reset-filters {
        width: 100%;
      }
     
      .amenities-grid {
        grid-template-columns: repeat(2, 1fr);
        display: grid;
      }
     
      .amenity-option {
        flex-direction: column;
        text-align: center;
        padding: 12px;
        min-width: 140px;
      }
     
      .listings-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
     
      .listing-content {
        padding: 15px;
      }
     
      .listing-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
     
      .listing-price {
        font-size: 18px;
      }
     
      .listing-details {
        gap: 12px;
      }
     
      .listing-actions {
        flex-direction: column;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 15px;
      }
     
      .mobile-menu-toggle {
        top: 10px;
        left: 10px;
        width: 40px;
        height: 40px;
        font-size: 18px;
      }
     
      .page-header h1 {
        font-size: 22px;
      }
     
      .stat-card {
        padding: 15px;
      }
     
      .stat-value {
        font-size: 28px;
      }
     
      .filters-section {
        padding: 15px;
      }
     
      .amenities-grid {
        grid-template-columns: 1fr;
      }
     
      .amenity-option {
        min-width: 100%;
      }
     
      .listing-content {
        padding: 12px;
      }
     
      .listing-title {
        font-size: 16px;
      }
     
      .listing-price {
        font-size: 16px;
      }
     
      .listing-details {
        gap: 8px;
      }
     
      .detail {
        font-size: 12px;
      }
     
      .broker-name {
        font-size: 13px;
      }
     
      .action-btn {
        padding: 8px 12px;
        font-size: 13px;
      }
    }
</style>
</head>

<body>
<button class="mobile-menu-toggle" id="mobileMenuToggle">‚ò∞</button>
<div id="sidebar-container"></div>

<div class="modal-overlay" id="listingModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title-section">
        <h2 class="modal-title" id="modalTitle">Property Details</h2>
        <div class="modal-subtitle">
          <span>üìç</span>
          <span id="modalLocation">Loading location...</span>
        </div>
      </div>
      <div class="modal-price-section">
        <div class="modal-price" id="modalPrice">‚Ç±0</div>
        <div class="modal-status" id="modalStatus">Active</div>
      </div>
      <button class="close-modal" id="closeModal">&times;</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<div class="container">
  <div class="topbar">
    <div class="page-header">
      <h1>Landlord Dashboard</h1>
      <div id="welcomeMessage" style="font-size:16px; color:var(--text-dark); font-weight:500; margin-bottom:8px;"></div>
      <p>Manage and view all your property listings (Sale, Rent, and Lease)</p>
    </div>
    <a href="rent_property.html" class="add-button">
      <span>‚ûï</span> Add New Property
    </a>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-value" id="totalListings">0</div>
      <div class="stat-label">Total Active Listings</div>
      <div class="stat-trend trend-up">‚Üë All properties</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="forSaleCount">0</div>
      <div class="stat-label">For Sale</div>
      <div class="stat-trend trend-up">‚Üë Properties for sale</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="forRentCount">0</div>
      <div class="stat-label">For Rent</div>
      <div class="stat-trend trend-up">‚Üë Properties for rent</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="forLeaseCount">0</div>
      <div class="stat-label">For Lease</div>
      <div class="stat-trend trend-up">‚Üë Properties for lease</div>
    </div>
  </div>

  <!-- Enhanced Filters Section -->
  <div class="filters-section">
    <div class="filters-title">
      Filter Properties
      <span class="filter-count" id="filterCount">Showing all properties</span>
    </div>
    <div class="filters-grid">
      <!-- Property Status -->
      <div class="filter-group">
        <label class="filter-label">Property Status</label>
        <select class="filter-select" id="filterStatus">
          <option value="">All Status</option>
          <option value="active">Active</option>
          <option value="pending">Pending</option>
          <option value="sold">Sold/Leased</option>
          <option value="inactive">Inactive</option>
        </select>
      </div>

      <!-- Listing Type (Sale/Rent/Lease) -->
      <div class="filter-group">
        <label class="filter-label">Listing Type</label>
        <select class="filter-select" id="filterListingType">
          <option value="">All Listings</option>
          <option value="sale">For Sale</option>
          <option value="rent">For Rent</option>
          <option value="lease">For Lease</option>
        </select>
      </div>

      <!-- Property Category -->
      <div class="filter-group">
        <label class="filter-label">Property Category</label>
        <select class="filter-select" id="filterCategory">
          <option value="">All Categories</option>
          <option value="residential">Residential</option>
          <option value="commercial">Commercial</option>
          <option value="land">Land/Lot</option>
          <option value="industrial">Industrial/Storage</option>
          <option value="special">Special Purpose</option>
        </select>
      </div>

      <!-- Property Type (Dynamic based on Category) -->
      <div class="filter-group">
        <label class="filter-label">Property Type</label>
        <select class="filter-select" id="filterType">
          <option value="">All Types</option>
          <!-- Options will be populated by JavaScript -->
        </select>
      </div>

      <!-- Price Range -->
      <div class="filter-group">
        <label class="filter-label">Price Range</label>
        <div class="price-range-inputs" style="display: flex; gap: 10px;">
          <input type="number" class="filter-input" id="priceMin" placeholder="Min ‚Ç±" style="flex: 1;" min="0">
          <input type="number" class="filter-input" id="priceMax" placeholder="Max ‚Ç±" style="flex: 1;" min="0">
        </div>
      </div>

      <!-- Bedrooms -->
      <div class="filter-group">
        <label class="filter-label">Bedrooms</label>
        <select class="filter-select" id="filterBedrooms">
          <option value="">Any</option>
          <option value="studio">Studio</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5+</option>
        </select>
      </div>

      <!-- Bathrooms -->
      <div class="filter-group">
        <label class="filter-label">Bathrooms</label>
        <select class="filter-select" id="filterBathrooms">
          <option value="">Any</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4+</option>
        </select>
      </div>

      <!-- Floor Area -->
      <div class="filter-group">
        <label class="filter-label">Floor Area (sqm)</label>
        <div class="area-range-inputs" style="display: flex; gap: 10px;">
          <input type="number" class="filter-input" id="areaMin" placeholder="Min sqm" style="flex: 1;" min="0">
          <input type="number" class="filter-input" id="areaMax" placeholder="Max sqm" style="flex: 1;" min="0">
        </div>
      </div>

      <!-- Location -->
      <div class="filter-group">
        <label class="filter-label">Location</label>
        <input type="text" class="filter-input" id="filterLocation" placeholder="City, Province, or Address">
      </div>

      <!-- Sort By -->
      <div class="filter-group">
        <label class="filter-label">Sort By</label>
        <select class="filter-select" id="filterSort">
          <option value="newest">Newest First</option>
          <option value="price_low">Price: Low to High</option>
          <option value="price_high">Price: High to Low</option>
          <option value="area_large">Largest Area</option>
          <option value="area_small">Smallest Area</option>
        </select>
      </div>

      <!-- AMENITIES - UPDATED POSITION -->
      <div class="amenities-group">
        <label class="filter-label">Amenities</label>
        <div class="amenities-container">
          <div class="amenities-grid">
            <label class="amenity-option">
              <input type="checkbox" name="amenities" value="parking">
              <span class="amenity-checkbox"></span>
              <span class="amenity-label">
                <span class="amenity-icon">üöó</span>
                Parking
              </span>
            </label>
            
            <label class="amenity-option">
              <input type="checkbox" name="amenities" value="wifi">
              <span class="amenity-checkbox"></span>
              <span class="amenity-label">
                <span class="amenity-icon">üì∂</span>
                WiFi
              </span>
            </label>
            
            <label class="amenity-option">
              <input type="checkbox" name="amenities" value="ac">
              <span class="amenity-checkbox"></span>
              <span class="amenity-label">
                <span class="amenity-icon">‚ùÑÔ∏è</span>
                Air Conditioning
              </span>
            </label>
            
            <label class="amenity-option">
              <input type="checkbox" name="amenities" value="furnished">
              <span class="amenity-checkbox"></span>
              <span class="amenity-label">
                <span class="amenity-icon">üõãÔ∏è</span>
                Furnished
              </span>
            </label>
            
            <label class="amenity-option">
              <input type="checkbox" name="amenities" value="security">
              <span class="amenity-checkbox"></span>
              <span class="amenity-label">
                <span class="amenity-icon">üëÆ</span>
                24/7 Security
              </span>
            </label>
            
            <label class="amenity-option">
              <input type="checkbox" name="amenities" value="pool">
              <span class="amenity-checkbox"></span>
              <span class="amenity-label">
                <span class="amenity-icon">üèä</span>
                Swimming Pool
              </span>
            </label>
            
            <label class="amenity-option">
              <input type="checkbox" name="amenities" value="gym">
              <span class="amenity-checkbox"></span>
              <span class="amenity-label">
                <span class="amenity-icon">üí™</span>
                Gym
              </span>
            </label>
            
            <label class="amenity-option">
              <input type="checkbox" name="amenities" value="elevator">
              <span class="amenity-checkbox"></span>
              <span class="amenity-label">
                <span class="amenity-icon">üõó</span>
                Elevator
              </span>
            </label>
            
            <label class="amenity-option">
              <input type="checkbox" name="amenities" value="laundry">
              <span class="amenity-checkbox"></span>
              <span class="amenity-label">
                <span class="amenity-icon">üß∫</span>
                Laundry
              </span>
            </label>
            
            <label class="amenity-option">
              <input type="checkbox" name="amenities" value="kitchen">
              <span class="amenity-checkbox"></span>
              <span class="amenity-label">
                <span class="amenity-icon">üç≥</span>
                Kitchen
              </span>
            </label>
          </div>

          <div class="amenities-counter">
            <span id="selectedCount">0</span> amenities selected
          </div>
          
          <div class="amenities-actions">
            <button type="button" class="amenity-btn select-all" id="selectAllAmenities">
              Select All
            </button>
            <button type="button" class="amenity-btn clear-all" id="clearAllAmenities">
              Clear All
            </button>
          </div>
        </div>
      </div>

      <!-- Filter Actions -->
      <div class="filter-actions">
        <button class="apply-filters" id="applyFilters">üîç Apply Filters</button>
        <button class="reset-filters" id="resetFilters">üîÑ Reset All</button>
      </div>
    </div>
  </div>

  <div class="listings-grid" id="listingsContainer">
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Loading properties...</p>
    </div>
  </div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBwwAkIEixeUysaGrMb9BtTsMwz_C9Noxk" async defer></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut  } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { getFirestore, collection, query, where, getDocs, getDoc, doc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCIfzneDzWVveG8p_0mywoA9D9F5AyzZX4",
  authDomain: "bahai-1b76d.firebaseapp.com",
  projectId: "bahai-1b76d",
  storageBucket: "bahai-1b76d.firebasestorage.app",
  messagingSenderId: "646878644941",
  appId: "1:646878644941:web:5b4ccc3412250337587784"
};
const REQUIRED_ROLE = "landlord"; 
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const GOOGLE_MAPS_API_KEY = "AIzaSyBwwAkIEixeUysaGrMb9BtTsMwz_C9Noxk";

// Property type mapping based on your categories
const propertyTypesByCategory = {
  sale: {
    residential: [
      { value: "house", label: "House" },
      { value: "townhouse", label: "Townhouse" },
      { value: "condo", label: "Condominium" },
      { value: "apartment", label: "Apartment" }
    ],
    commercial: [
      { value: "office_space", label: "Office Space" },
      { value: "retail_space", label: "Retail Space / Shop" },
      { value: "building", label: "Building" }
    ],
    land: [
      { value: "residential_lot", label: "Residential Lot" },
      { value: "commercial_lot", label: "Commercial Lot" },
      { value: "agricultural_lot", label: "Agricultural Lot" }
    ]
  },
  rent: {
    residential: [
      { value: "apartment_unit", label: "Apartment Unit" },
      { value: "boarding_house", label: "Boarding House" },
      { value: "condo_unit", label: "Condominium Unit" },
      { value: "room", label: "Room / Bedspace" }
    ],
    commercial: [
      { value: "office_unit", label: "Office Unit" },
      { value: "retail_space_rent", label: "Retail Space" },
      { value: "food_stall", label: "Food Stall / Kiosk" }
    ],
    industrial: [
      { value: "warehouse", label: "Warehouse" },
      { value: "storage_unit", label: "Storage Unit" },
      { value: "factory", label: "Factory" },
      { value: "workshop", label: "Workshop" }
    ]
  },
  lease: {
    commercial: [
      { value: "office_floor", label: "Office Floor" },
      { value: "retail_space_lease", label: "Retail Space" },
      { value: "building_lease", label: "Building Lease" },
      { value: "commercial_unit", label: "Commercial Unit" }
    ],
    land: [
      { value: "commercial_lot_lease", label: "Commercial Lot" },
      { value: "agricultural_land", label: "Agricultural Land" },
      { value: "development_land", label: "Development Land" },
      { value: "vacant_lot", label: "Vacant Lot" }
    ],
    special: [
      { value: "resort_property", label: "Resort Property" },
      { value: "event_venue", label: "Event Venue" },
      { value: "parking_area", label: "Parking Area" },
      { value: "school_property", label: "School Property" },
      { value: "sports_facility", label: "Sports Facility" }
    ]
  }
};

let allListings = [];
let userMap = new Map();

function getRoleDisplayText(role) {
  const roleMap = {
    'landlord': 'Property Owner',
    'seller': 'Property Seller', 
    'broker': 'Licensed Broker',
    'agent': 'Property Agent',
    'admin': 'Administrator'
  };
  return roleMap[role] || 'Posted by';
}

// Enhanced listing type detection
function getListingType(listing) {
  // Check explicit listing type first
  if (listing.listingType === 'sale' || listing.type === 'sale') {
    return 'sale';
  }
  
  if (listing.listingType === 'lease' || listing.type === 'lease') {
    return 'lease';
  }
  
  // Check for rent indicators
  if (listing.monthlyRent !== undefined && listing.monthlyRent !== null && listing.monthlyRent > 0) {
    return 'rent';
  }
  
  // Check for lease indicators (annual rent)
  if (listing.annualRent !== undefined && listing.annualRent !== null && listing.annualRent > 0) {
    return 'lease';
  }
  
  // Default to sale if no type specified
  return 'sale';
}

function getDisplayPrice(listing) {
  const type = getListingType(listing);
  
  switch (type) {
    case 'rent':
      return `‚Ç±${(listing.monthlyRent || 0).toLocaleString()}/month`;
    
    case 'lease':
      const annualRent = listing.annualRent || 0;
      return `‚Ç±${annualRent.toLocaleString()}/year`;
    
    case 'sale':
    default:
      return `‚Ç±${(listing.pricing || listing.salePrice || 0).toLocaleString()}`;
  }
}

function getNumericPrice(listing) {
  const type = getListingType(listing);
  
  switch (type) {
    case 'rent':
      return listing.monthlyRent || 0;
    
    case 'lease':
      return listing.annualRent || 0;
    
    case 'sale':
    default:
      return listing.pricing || listing.salePrice || 0;
  }
}

function getPriceClass(listing) {
  const type = getListingType(listing);
  
  switch (type) {
    case 'rent':
      return 'price-rent';
    
    case 'lease':
      return 'price-lease';
    
    case 'sale':
    default:
      return 'price-sale';
  }
}

function getTypeBadgeClass(listing) {
  const type = getListingType(listing);
  
  switch (type) {
    case 'rent':
      return 'type-rent';
    
    case 'lease':
      return 'type-lease';
    
    case 'sale':
    default:
      return 'type-sale';
  }
}

function getTypeBadgeText(listing) {
  const type = getListingType(listing);
  
  switch (type) {
    case 'rent':
      return 'FOR RENT';
    
    case 'lease':
      return 'FOR LEASE';
    
    case 'sale':
    default:
      return 'FOR SALE';
  }
}

// Initialize amenities counter and buttons
function initializeAmenities() {
  const amenitiesCheckboxes = document.querySelectorAll('input[name="amenities"]');
  const selectedCount = document.getElementById('selectedCount');
  const selectAllBtn = document.getElementById('selectAllAmenities');
  const clearAllBtn = document.getElementById('clearAllAmenities');
  
  // Update counter
  function updateCounter() {
    const checkedCount = document.querySelectorAll('input[name="amenities"]:checked').length;
    selectedCount.textContent = checkedCount;
  }
  
  // Add event listeners to checkboxes
  amenitiesCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', updateCounter);
  });
  
  // Select All functionality
  selectAllBtn.addEventListener('click', function() {
    amenitiesCheckboxes.forEach(checkbox => {
      checkbox.checked = true;
    });
    updateCounter();
  });
  
  // Clear All functionality
  clearAllBtn.addEventListener('click', function() {
    amenitiesCheckboxes.forEach(checkbox => {
      checkbox.checked = false;
    });
    updateCounter();
  });
  
  // Initialize counter
  updateCounter();
}

// Initialize filter functionality
function initializeFilters() {
  // Update property types when category changes
  document.getElementById('filterCategory').addEventListener('change', updatePropertyTypeOptions);
  document.getElementById('filterListingType').addEventListener('change', updatePropertyTypeOptions);
  
  // Apply filters button
  document.getElementById('applyFilters').addEventListener('click', applyEnhancedFilters);
  
  // Reset filters button
  document.getElementById('resetFilters').addEventListener('click', resetEnhancedFilters);
  
  // Initialize amenities functionality
  initializeAmenities();
  
  // Initialize property type options
  updatePropertyTypeOptions();
}

function updatePropertyTypeOptions() {
  const listingType = document.getElementById('filterListingType').value;
  const category = document.getElementById('filterCategory').value;
  const typeSelect = document.getElementById('filterType');
  
  // Clear existing options
  typeSelect.innerHTML = '<option value="">All Types</option>';
  
  // If no listing type or category selected, show all types
  if (!listingType && !category) {
    // Show all property types
    const allTypes = new Set();
    Object.values(propertyTypesByCategory).forEach(listingTypes => {
      Object.values(listingTypes).forEach(types => {
        types.forEach(type => {
          allTypes.add(JSON.stringify({ value: type.value, label: type.label }));
        });
      });
    });
    
    Array.from(allTypes).forEach(typeStr => {
      const type = JSON.parse(typeStr);
      const option = document.createElement('option');
      option.value = type.value;
      option.textContent = type.label;
      typeSelect.appendChild(option);
    });
    return;
  }
  
  // If listing type selected but no category
  if (listingType && !category && propertyTypesByCategory[listingType]) {
    const categories = propertyTypesByCategory[listingType] || {};
    const allTypes = [];
    Object.values(categories).forEach(types => {
      allTypes.push(...types);
    });
    
    allTypes.forEach(type => {
      const option = document.createElement('option');
      option.value = type.value;
      option.textContent = type.label;
      typeSelect.appendChild(option);
    });
    return;
  }
  
  // If both listing type and category selected
  if (listingType && category && propertyTypesByCategory[listingType]?.[category]) {
    propertyTypesByCategory[listingType][category].forEach(type => {
      const option = document.createElement('option');
      option.value = type.value;
      option.textContent = type.label;
      typeSelect.appendChild(option);
    });
  }
}

function applyEnhancedFilters() {
  const statusFilter = document.getElementById('filterStatus').value;
  const listingTypeFilter = document.getElementById('filterListingType').value;
  const categoryFilter = document.getElementById('filterCategory').value;
  const typeFilter = document.getElementById('filterType').value;
  const priceMin = parseFloat(document.getElementById('priceMin').value) || 0;
  const priceMax = parseFloat(document.getElementById('priceMax').value) || Infinity;
  const bedroomsFilter = document.getElementById('filterBedrooms').value;
  const bathroomsFilter = document.getElementById('filterBathrooms').value;
  const areaMin = parseFloat(document.getElementById('areaMin').value) || 0;
  const areaMax = parseFloat(document.getElementById('areaMax').value) || Infinity;
  const locationFilter = document.getElementById('filterLocation').value.toLowerCase().trim();
  const sortBy = document.getElementById('filterSort').value;

  // Get selected amenities from checkboxes
  const amenitiesFilter = [];
  document.querySelectorAll('input[name="amenities"]:checked').forEach(checkbox => {
    amenitiesFilter.push(checkbox.value);
  });

  console.log('üîç Applying enhanced filters:', {
    statusFilter,
    listingTypeFilter,
    categoryFilter,
    typeFilter,
    priceRange: `${priceMin}-${priceMax}`,
    bedroomsFilter,
    bathroomsFilter,
    areaRange: `${areaMin}-${areaMax}`,
    locationFilter,
    amenitiesFilter,
    sortBy
  });

  let filtered = allListings.filter(listing => {
    // Status Filter
    if (statusFilter && listing.status !== statusFilter) {
      return false;
    }
    
    // Listing Type Filter
    if (listingTypeFilter) {
      const actualType = getListingType(listing);
      if (actualType !== listingTypeFilter) {
        return false;
      }
    }
    
    // Category Filter
    if (categoryFilter && listing.propertyCategory !== categoryFilter) {
      return false;
    }
    
    // Property Type Filter
    if (typeFilter && listing.propertyType !== typeFilter) {
      return false;
    }
    
    // Price Range Filter
    const price = getNumericPrice(listing);
    if (price < priceMin || price > priceMax) {
      return false;
    }
    
    // Bedrooms Filter
    if (bedroomsFilter) {
      const listingBedrooms = listing.bedrooms?.toString() || '0';
      if (bedroomsFilter === 'studio') {
        if (listing.propertyType !== 'studio' && listingBedrooms !== '0') {
          return false;
        }
      } else if (bedroomsFilter === '5' && parseInt(listingBedrooms) < 5) {
        return false;
      } else if (listingBedrooms !== bedroomsFilter) {
        return false;
      }
    }
    
    // Bathrooms Filter
    if (bathroomsFilter) {
      const listingBathrooms = listing.bathrooms?.toString() || '0';
      if (bathroomsFilter === '4' && parseInt(listingBathrooms) < 4) {
        return false;
      } else if (listingBathrooms !== bathroomsFilter) {
        return false;
      }
    }
    
    // Area Filter
    const area = listing.floorArea || listing.totalArea || 0;
    if (area < areaMin || area > areaMax) {
      return false;
    }
    
    // Location Filter
    if (locationFilter) {
      const listingLocation = (listing.location || '').toLowerCase();
      const listingCity = (listing.city || '').toLowerCase();
      const listingProvince = (listing.province || '').toLowerCase();
      if (!listingLocation.includes(locationFilter) &&
          !listingCity.includes(locationFilter) &&
          !listingProvince.includes(locationFilter)) {
        return false;
      }
    }
    
    // Amenities Filter
    if (amenitiesFilter.length > 0 && listing.amenities) {
      const listingAmenities = Array.isArray(listing.amenities) 
        ? listing.amenities.map(a => a.toLowerCase())
        : [];
      
      // Check if listing has all selected amenities
      const hasAllAmenities = amenitiesFilter.every(amenity => 
        listingAmenities.some(la => la.includes(amenity))
      );
      
      if (!hasAllAmenities) {
        return false;
      }
    }
    
    return true;
  });

  // Apply sorting
  filtered = sortListings(filtered, sortBy);

  console.log(`‚úÖ Filtered results: ${filtered.length} of ${allListings.length}`);
  updateFilterCount(filtered.length, allListings.length);

  if (filtered.length === 0) {
    displayNoListings();
  } else {
    displayListings(filtered);
  }
}

function sortListings(listings, sortBy) {
  return [...listings].sort((a, b) => {
    switch (sortBy) {
      case 'price_low':
        return getNumericPrice(a) - getNumericPrice(b);
      
      case 'price_high':
        return getNumericPrice(b) - getNumericPrice(a);
      
      case 'area_large':
        return ((b.floorArea || b.totalArea || 0) - (a.floorArea || a.totalArea || 0));
      
      case 'area_small':
        return ((a.floorArea || a.totalArea || 0) - (b.floorArea || b.totalArea || 0));
      
      case 'newest':
      default:
        const dateA = a.createdAt?.toDate?.() || new Date(a.createdAt?.seconds * 1000) || new Date(0);
        const dateB = b.createdAt?.toDate?.() || new Date(b.createdAt?.seconds * 1000) || new Date(0);
        return dateB - dateA;
    }
  });
}

function resetEnhancedFilters() {
  // Clear all filter inputs
  document.getElementById('filterStatus').value = '';
  document.getElementById('filterListingType').value = '';
  document.getElementById('filterCategory').value = '';
  document.getElementById('filterType').value = '';
  document.getElementById('priceMin').value = '';
  document.getElementById('priceMax').value = '';
  document.getElementById('filterBedrooms').value = '';
  document.getElementById('filterBathrooms').value = '';
  document.getElementById('areaMin').value = '';
  document.getElementById('areaMax').value = '';
  document.getElementById('filterLocation').value = '';
  document.getElementById('filterSort').value = 'newest';
  
  // Clear all amenities checkboxes
  document.querySelectorAll('input[name="amenities"]').forEach(checkbox => {
    checkbox.checked = false;
  });
  
  // Update amenities counter
  document.getElementById('selectedCount').textContent = '0';
  
  // Reset property type options
  updatePropertyTypeOptions();
  
  // Show all listings
  updateFilterCount(allListings.length, allListings.length);
  displayListings(allListings);
  
  console.log('üîÑ All filters reset');
}

async function loadAllListings() {
  const container = document.getElementById('listingsContainer');
  
  try {
    console.log('üöÄ Loading all listings for landlord dashboard...');
    
    const listingsQuery = query(
      collection(db, "properties")
    );
    const querySnapshot = await getDocs(listingsQuery);
    
    allListings = [];
    const userIds = new Set();
    
    querySnapshot.forEach((doc) => {
      const listing = {
        id: doc.id,
        ...doc.data()
      };
      allListings.push(listing);
      
      // Collect user IDs for user data lookup
      if (listing.userId) {
        userIds.add(listing.userId);
      } else if (listing.ownerId) {
        userIds.add(listing.ownerId);
      }
    });

    console.log(`üìä Found ${allListings.length} listings total`);
    console.log('üë• User IDs to fetch:', Array.from(userIds));
    
    await loadAllUserData(userIds);
    
    if (allListings.length === 0) {
      displayNoListings();
    } else {
      displayListings(allListings);
      updateStats(allListings);
      updateFilterCount(allListings.length, allListings.length);
    }
    
  } catch (error) {
    console.error("‚ùå Error loading listings:", error);
    
    // If permission denied, show specific error
    if (error.code === 'permission-denied') {
      displayError(new Error('Permission denied. Please contact administrator.'));
    } else {
      displayError(error);
    }
  }
}

async function loadAllUserData(userIds) {
  userMap.clear();
  
  if (userIds.size === 0) {
    console.log('‚ÑπÔ∏è No user IDs found to load');
    return;
  }
  
  console.log(`üîç Loading user data for ${userIds.size} users...`);
  
  for (const userId of userIds) {
    await loadUserData(userId);
  }
  
  console.log('‚úÖ User data loaded:', Array.from(userMap.entries()));
}

async function loadUserData(userId) {
  try {
    console.log(`üìã Loading data for user: ${userId}`);
    
    // First try users collection
    const userDoc = await getDoc(doc(db, "users", userId));
    
    if (userDoc.exists()) {
      const userData = userDoc.data();
      console.log(`‚úÖ Found user document for ${userId}:`, userData);
      
      const fullName = userData.fullName || 
                       userData.email?.split('@')[0] || 
                       `User ${userId.substring(0, 8)}`;
      
      userMap.set(userId, {
        displayName: fullName,
        email: userData.email || 'Email not available',
        phone: userData.phone || 'Phone not available',
        role: userData.role || 'user'
      });
      
      console.log(`‚úÖ Loaded ${userData.role || 'user'}: ${fullName}`);
      return;
    }
    
    // Try brokers collection
    console.log(`üîÑ User not found in 'users' collection, trying 'brokers'...`);
    const brokerDoc = await getDoc(doc(db, "brokers", userId));
    
    if (brokerDoc.exists()) {
      const brokerData = brokerDoc.data();
      console.log(`‚úÖ Found broker document for ${userId}:`, brokerData);
      
      const fullName = brokerData.fullName || `Broker ${userId.substring(0, 8)}`;
      
      userMap.set(userId, {
        displayName: fullName,
        email: brokerData.email || 'Email not available',
        phone: brokerData.phone || 'Phone not available',
        role: 'broker'
      });
      
      console.log(`‚úÖ Loaded broker: ${fullName}`);
      return;
    }
    
    // If not found anywhere
    console.log(`‚ùå User ${userId} not found in any collection`);
    userMap.set(userId, {
      displayName: `User ${userId.substring(0, 8)}`,
      email: 'Email not available',
      phone: 'Phone not available',
      role: 'user'
    });
    
  } catch (error) {
    console.error(`üí• Error loading user ${userId}:`, error);
    
    userMap.set(userId, {
      displayName: `User ${userId.substring(0, 8)}`,
      email: 'Email not available',
      phone: 'Phone not available',
      role: 'user'
    });
  }
}

function displayListings(listings) {
  const container = document.getElementById('listingsContainer');
  
  if (listings.length === 0) {
    displayNoListings();
    return;
  }
  
  container.innerHTML = listings.map(listing => {
    const userInfo = userMap.get(listing.userId) || {
      displayName: `User ${listing.userId ? listing.userId.substring(0, 8) : 'Unknown'}`,
      email: 'N/A',
      phone: 'N/A',
      role: 'user'
    };
    
    const userInitials = userInfo.displayName.split(' ').map(n => n[0]).join('').toUpperCase() || 'UU';
    const listingType = getListingType(listing);
    const displayPrice = getDisplayPrice(listing);
    const priceClass = getPriceClass(listing);
    const typeBadgeClass = getTypeBadgeClass(listing);
    const typeBadgeText = getTypeBadgeText(listing);
    
    let mainPhoto;
    if (listing.photos && listing.photos.length > 0) {
      mainPhoto = listing.photos[0];
    } else if (listing.imageUrls && listing.imageUrls.length > 0) {
      mainPhoto = listing.imageUrls[0];
    } else if (listing.latitude && listing.longitude) {
      mainPhoto = `https://maps.googleapis.com/maps/api/staticmap?center=${listing.latitude},${listing.longitude}&zoom=15&size=400x200&markers=color:red%7C${listing.latitude},${listing.longitude}&key=${GOOGLE_MAPS_API_KEY}`;
    } else {
      mainPhoto = 'https://via.placeholder.com/400x200/0b2e52/white?text=No+Image';
    }
    
    const bedrooms = listing.bedrooms || (listingType === 'rent' && listing.propertyType === 'studio' ? 'Studio' : 0);
    const bathrooms = listing.bathrooms || 0;
    const area = listing.floorArea || listing.totalArea || 'N/A';
    
    return `
    <div class="listing-card" onclick="showListingDetails('${listing.id}')">
      <div style="position: relative;">
        <img src="${mainPhoto}" alt="${listing.title}" class="listing-image">
        <div class="listing-type-badge ${typeBadgeClass}">${typeBadgeText}</div>
      </div>
      <div class="listing-content">
        <div class="listing-header">
          <div>
            <h3 class="listing-title">${listing.title || 'Untitled Property'}</h3>
            <div class="listing-location">
              <span>üìç</span> ${listing.location || 'Location not specified'}
            </div>
          </div>
          <div class="listing-price ${priceClass}">${displayPrice}</div>
        </div>
        
        <div class="listing-details">
          <div class="detail">
            <span>üõèÔ∏è</span> ${bedrooms} ${bedrooms === 'Studio' ? '' : 'beds'}
          </div>
          <div class="detail">
            <span>üöø</span> ${bathrooms} baths
          </div>
          <div class="detail">
            <span>üìê</span> ${area} sqm
          </div>
          ${listingType === 'rent' && listing.securityDeposit ? `
            <div class="detail">
              <span>üí∞</span> Deposit: ‚Ç±${listing.securityDeposit.toLocaleString()}
            </div>
          ` : ''}
        </div>
        
        <div class="listing-broker">
          <div class="broker-avatar">${userInitials}</div>
          <div class="broker-info">
            <div class="broker-name">${userInfo.displayName}</div>
            <div class="broker-contact">
              ${getRoleDisplayText(userInfo.role)} ‚Ä¢ ${listing.propertyType || 'Property'}
            </div>
          </div>
        </div>
        
        <div class="listing-status status-${listing.status || 'active'}">
          ${listing.status || 'active'}
        </div>
        
        <div class="listing-actions">
          <button class="action-btn contact-btn" onclick="event.stopPropagation(); contactBroker('${listing.userId}')">
            üìû Contact ${userInfo.role === 'landlord' ? 'Owner' : 'Broker'}
          </button>
          <button class="action-btn view-btn" onclick="event.stopPropagation(); showListingDetails('${listing.id}')">
            üëÄ View Details
          </button>
        </div>
      </div>
    </div>
    `;
  }).join('');
}

function displayNoListings() {
  const container = document.getElementById('listingsContainer');
  container.innerHTML = `
    <div class="empty-state">
      <div class="empty-state-icon">üè†</div>
      <h3>No Properties Found</h3>
      <p>There are currently no property listings matching your criteria.</p>
      <button class="add-button" onclick="resetEnhancedFilters()" style="margin-top: 20px;">
        üîÑ Reset Filters
      </button>
    </div>
  `;
}

function displayError(error) {
  const container = document.getElementById('listingsContainer');
  container.innerHTML = `
    <div class="error-state">
      <div class="error-icon">‚ö†Ô∏è</div>
      <h3>Error Loading Properties</h3>
      <p>There was an error loading the property listings.</p>
      <button class="add-button" onclick="loadAllListings()" style="margin-top: 20px;">
        üîÑ Try Again
      </button>
    </div>
  `;
}

function updateStats(listings) {
  const total = listings.length;
  
  // Count by listing type
  const forSaleCount = listings.filter(l => getListingType(l) === 'sale').length;
  const forRentCount = listings.filter(l => getListingType(l) === 'rent').length;
  const forLeaseCount = listings.filter(l => getListingType(l) === 'lease').length;
  
  // Count active listings
  const activeListings = listings.filter(l => l.status === 'active').length;

  document.getElementById('totalListings').textContent = activeListings;
  document.getElementById('forSaleCount').textContent = forSaleCount;
  document.getElementById('forRentCount').textContent = forRentCount;
  document.getElementById('forLeaseCount').textContent = forLeaseCount;
}

function updateFilterCount(filtered, total) {
  const countEl = document.getElementById('filterCount');
  if (filtered === total) {
    countEl.textContent = `Showing all ${total} properties`;
  } else {
    countEl.textContent = `Showing ${filtered} of ${total} properties`;
  }
}

window.showListingDetails = function(id) {
  const listing = allListings.find(l => l.id === id);
  if (!listing) return;

  const modal = document.getElementById('listingModal');
  const modalTitle = document.getElementById('modalTitle');
  const modalLocation = document.getElementById('modalLocation');
  const modalPrice = document.getElementById('modalPrice');
  const modalStatus = document.getElementById('modalStatus');
  const modalBody = document.getElementById('modalBody');

  const userInfo = userMap.get(listing.userId) || {
    displayName: `User ${listing.userId ? listing.userId.substring(0, 8) : 'Unknown'}`,
    email: 'N/A',
    phone: 'N/A',
    role: 'user'
  };

  const listingType = getListingType(listing);
  const displayPrice = getDisplayPrice(listing);
  const typeBadgeClass = getTypeBadgeClass(listing);
  const typeBadgeText = getTypeBadgeText(listing);

  modalTitle.textContent = listing.title || 'Untitled Property';
  modalLocation.textContent = listing.location || 'Location not specified';
  modalPrice.textContent = displayPrice;
  modalPrice.className = `modal-price ${getPriceClass(listing)}`;
  modalStatus.textContent = typeBadgeText;
  modalStatus.className = `modal-status ${typeBadgeClass}`;

  const photos = listing.photos || listing.imageUrls || [];
  const mainPhoto = photos.length > 0 ? photos[0] : 'https://via.placeholder.com/800x400/0b2e52/white?text=No+Image';

  let pricingDetails = '';
  if (listingType === 'rent') {
    pricingDetails = `
      <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border);">
        <span style="color: var(--text-light);">Monthly Rent:</span>
        <span style="font-weight: 600; color: var(--rent-color);">‚Ç±${(listing.monthlyRent || 0).toLocaleString()}</span>
      </div>
      ${listing.securityDeposit ? `
      <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border);">
        <span style="color: var(--text-light);">Security Deposit:</span>
        <span style="font-weight: 600;">‚Ç±${listing.securityDeposit.toLocaleString()}</span>
      </div>
      ` : ''}
      ${listing.minimumStay ? `
      <div style="display: flex; justify-content: space-between; padding: 10px 0;">
        <span style="color: var(--text-light);">Minimum Stay:</span>
        <span style="font-weight: 600;">${listing.minimumStay} month(s)</span>
      </div>
      ` : ''}
    `;
  } else if (listingType === 'lease') {
    pricingDetails = `
      <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border);">
        <span style="color: var(--text-light);">Annual Rent:</span>
        <span style="font-weight: 600; color: var(--lease-color);">‚Ç±${(listing.annualRent || 0).toLocaleString()}</span>
      </div>
      ${listing.securityBond ? `
      <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border);">
        <span style="color: var(--text-light);">Security Bond:</span>
        <span style="font-weight: 600;">‚Ç±${listing.securityBond.toLocaleString()}</span>
      </div>
      ` : ''}
      ${listing.leaseDuration ? `
      <div style="display: flex; justify-content: space-between; padding: 10px 0;">
        <span style="color: var(--text-light);">Lease Duration:</span>
        <span style="font-weight: 600;">${listing.leaseDuration} year(s)</span>
      </div>
      ` : ''}
    `;
  } else {
    pricingDetails = `
      <div style="display: flex; justify-content: space-between; padding: 10px 0;">
        <span style="color: var(--text-light);">Sale Price:</span>
        <span style="font-weight: 600; color: var(--sale-color);">‚Ç±${(listing.pricing || listing.salePrice || 0).toLocaleString()}</span>
      </div>
    `;
  }

  modalBody.innerHTML = `
    <div style="padding: 30px 40px;">
      <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px; margin-bottom: 30px;">
        <div class="main-image">
          <img src="${mainPhoto}" alt="${listing.title}" style="width: 100%; height: 300px; object-fit: cover; border-radius: 12px;">
          ${photos.length > 1 ? `
            <div style="display: flex; gap: 10px; margin-top: 10px; overflow-x: auto;">
              ${photos.slice(1, 5).map(photo => `
                <img src="${photo}" style="width: 80px; height: 60px; object-fit: cover; border-radius: 6px; cursor: pointer;"
                     onclick="document.querySelector('.main-image img').src='${photo}'">
              `).join('')}
            </div>
          ` : ''}
        </div>
        <div style="background: var(--bg-light); padding: 25px; border-radius: 12px;">
          <h3 style="margin-bottom: 15px; color: var(--text-dark);">${userInfo.role === 'landlord' ? 'Property Owner' : 'Broker'} Information</h3>
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
            <div class="broker-avatar" style="width: 50px; height: 50px; font-size: 18px;">${userInfo.displayName.split(' ').map(n => n[0]).join('').toUpperCase()}</div>
            <div>
              <div style="font-weight: 600; color: var(--text-dark);">${userInfo.displayName}</div>
              <div style="font-size: 14px; color: var(--text-light);">${getRoleDisplayText(userInfo.role)}</div>
            </div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 10px;">
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
              <span style="color: var(--text-light);">Email:</span>
              <span style="font-weight: 600; font-size: 12px;">${userInfo.email}</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
              <span style="color: var(--text-light);">Phone:</span>
              <span style="font-weight: 600;">${userInfo.phone}</span>
            </div>
          </div>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
        <div>
          <h3 style="margin-bottom: 15px; color: var(--text-dark);">Property Details</h3>
          <div style="background: var(--bg-light); padding: 20px; border-radius: 12px;">
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border);">
              <span style="color: var(--text-light);">Listing Type:</span>
              <span style="font-weight: 600; color: ${listingType === 'rent' ? 'var(--rent-color)' : listingType === 'lease' ? 'var(--lease-color)' : 'var(--sale-color)'};">${typeBadgeText}</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border);">
              <span style="color: var(--text-light);">Property Type:</span>
              <span style="font-weight: 600;">${listing.propertyType || 'N/A'}</span>
            </div>
            ${listing.propertyCategory ? `
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border);">
              <span style="color: var(--text-light);">Category:</span>
              <span style="font-weight: 600; text-transform: capitalize;">${listing.propertyCategory}</span>
            </div>
            ` : ''}
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border);">
              <span style="color: var(--text-light);">Bedrooms:</span>
              <span style="font-weight: 600;">${listing.bedrooms || (listingType === 'rent' && listing.propertyType === 'studio' ? 'Studio' : 0)}</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border);">
              <span style="color: var(--text-light);">Bathrooms:</span>
              <span style="font-weight: 600;">${listing.bathrooms || 0}</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px 0;">
              <span style="color: var(--text-light);">Area:</span>
              <span style="font-weight: 600;">${listing.floorArea || listing.totalArea || 'N/A'} sqm</span>
            </div>
          </div>
          
          <h3 style="margin: 20px 0 15px; color: var(--text-dark);">Pricing Details</h3>
          <div style="background: var(--bg-light); padding: 20px; border-radius: 12px;">
            ${pricingDetails}
          </div>
          
          ${listing.amenities && listing.amenities.length > 0 ? `
            <h3 style="margin: 20px 0 15px; color: var(--text-dark);">Amenities</h3>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
              ${listing.amenities.map(amenity => `
                <span style="background: white; padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border); font-size: 14px;">
                  ${amenity}
                </span>
              `).join('')}
            </div>
          ` : ''}
        </div>
        
        <div>
          <h3 style="margin-bottom: 15px; color: var(--text-dark);">Description</h3>
          <div style="background: var(--bg-light); padding: 20px; border-radius: 12px; line-height: 1.6;">
            ${listing.description || 'No description available.'}
          </div>
          
          ${listing.leaseType ? `
            <h3 style="margin: 20px 0 15px; color: var(--text-dark);">Lease Terms</h3>
            <div style="background: var(--bg-light); padding: 20px; border-radius: 12px;">
              <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border);">
                <span style="color: var(--text-light);">Lease Type:</span>
                <span style="font-weight: 600; text-transform: capitalize;">${listing.leaseType}</span>
              </div>
              ${listing.renewalOption ? `
              <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border);">
                <span style="color: var(--text-light);">Renewal Option:</span>
                <span style="font-weight: 600;">${listing.renewalOption}</span>
              </div>
              ` : ''}
              ${listing.paymentTerms ? `
              <div style="display: flex; justify-content: space-between; padding: 10px 0;">
                <span style="color: var(--text-light);">Payment Terms:</span>
                <span style="font-weight: 600;">${listing.paymentTerms}</span>
              </div>
              ` : ''}
            </div>
          ` : ''}
        </div>
      </div>

      ${listing.latitude && listing.longitude ? `
        <div style="margin-top: 30px;">
          <h3 style="margin-bottom: 15px; color: var(--text-dark);">üìç Property Location</h3>
          <div id="propertyMap"></div>
          <a href="https://www.google.com/maps/dir/?api=1&destination=${listing.latitude},${listing.longitude}"
             target="_blank"
             class="action-btn contact-btn"
             style="margin-top: 15px; width: auto; display: inline-flex;">
             üß≠ Get Directions
          </a>
        </div>
      ` : ''}

      <div style="display: flex; gap: 15px; margin-top: 30px; padding-top: 25px; border-top: 1px solid var(--border);">
        <button class="action-btn contact-btn" onclick="contactBroker('${listing.userId}')" style="flex: 1;">
          üìû Contact ${userInfo.role === 'landlord' ? 'Owner' : 'Broker'}
        </button>
        <button class="action-btn view-btn" onclick="closeModal()" style="flex: 1;">
          Close
        </button>
      </div>
    </div>
  `;

  modal.classList.add('show');
  document.body.style.overflow = 'hidden';

  if (listing.latitude && listing.longitude) {
    setTimeout(() => {
      if (window.google && window.google.maps) {
        initPropertyMap(listing.latitude, listing.longitude, listing.title);
      }
    }, 100);
  }
};

function initPropertyMap(lat, lng, title) {
  const mapElement = document.getElementById("propertyMap");
  if (!mapElement) return;

  const map = new google.maps.Map(mapElement, {
    center: { lat: lat, lng: lng },
    zoom: 16,
    mapTypeControl: true,
    streetViewControl: true
  });

  new google.maps.Marker({
    position: { lat: lat, lng: lng },
    map: map,
    title: title,
    animation: google.maps.Animation.DROP
  });
}

window.contactBroker = function(userId) {
  const userInfo = userMap.get(userId);
  if (userInfo) {
    const userType = userInfo.role === 'landlord' ? 'Property Owner' : 'Broker';
    alert(`Contact Information:\n\n${userType}: ${userInfo.displayName}\nEmail: ${userInfo.email}\nPhone: ${userInfo.phone}\n\nYou can contact this ${userType.toLowerCase()} for more information about the property.`);
  } else {
    alert('Contact information not available.');
  }
};

window.closeModal = function() {
  const modal = document.getElementById('listingModal');
  modal.classList.remove('show');
  document.body.style.overflow = 'auto';
};

document.getElementById('closeModal').addEventListener('click', closeModal);

document.getElementById('listingModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeModal();
});

// Mobile menu toggle
document.getElementById('mobileMenuToggle').addEventListener('click', function() {
  const sidebar = document.querySelector('.sidebar');
  if (sidebar) {
    sidebar.style.transform = sidebar.style.transform === 'translateX(0px)' ?
      'translateX(-100%)' : 'translateX(0px)';
  }
});

// Load sidebar
fetch('sidebar.html')
  .then(response => response.text())
  .then(html => {
    document.getElementById('sidebar-container').innerHTML = html;
    const links = document.querySelectorAll('.sidebar-link');
    links.forEach(link => {
      if (link.getAttribute('href') === 'landlord_dashboard.html') {
        link.classList.add('active');
      }
    });
  })
  .catch(error => console.error('Error loading sidebar:', error));

// Window resize handler
window.addEventListener('resize', function() {
  const sidebar = document.querySelector('.sidebar');
  if (window.innerWidth > 1024 && sidebar) {
    sidebar.style.transform = 'translateX(0)';
  } else if (window.innerWidth <= 1024 && sidebar) {
    sidebar.style.transform = 'translateX(-100%)';
  }
});

// Authentication and main initialization
onAuthStateChanged(auth, async (user) => {
  const loginPage = "../login.html";

  if (!user) {
    window.location.href = loginPage;
    return;
  }

  try {
    const userRef = doc(db, "users", user.uid);
    const userSnap = await getDoc(userRef);

    if (!userSnap.exists()) {
      await signOut(auth);
      window.location.href = loginPage;
      return;
    }

    const userData = userSnap.data();

    // Check if user is landlord
    if (userData.role !== REQUIRED_ROLE) {
      await signOut(auth);
      alert("Unauthorized access. You have been logged out.");
      window.location.href = loginPage;
      return;
    }

    console.log("üë§ Authorized user:", user.uid, userData.role);
    const welcomeEl = document.getElementById('welcomeMessage');
    welcomeEl.textContent = `Welcome, ${userData.fullName || userData.email.split('@')[0]}`;

    // Initialize filters and load listings
    initializeFilters();
    await loadAllListings();

  } catch (err) {
    console.error("Auth guard error:", err);
    await signOut(auth);
    window.location.href = loginPage;
  }
});
</script>

</body>
</html>


