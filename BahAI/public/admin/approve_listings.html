<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Approve Listings - RealEase Admin</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: #f4f6f8;
    }
    header {
      background-color: #3f51b5;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
    }
    .container {
      display: flex;
    }
    nav {
      width: 250px;
      background-color: #263238;
      color: white;
      height: 100vh;
      padding-top: 20px;
    }
    nav a {
      display: block;
      color: white;
      padding: 12px 20px;
      text-decoration: none;
      font-size: 16px;
    }
    nav a:hover {
      background-color: #455a64;
    }
    nav a.active {
      background-color: #3f51b5;
    }
    main {
      flex: 1;
      padding: 20px;
    }
    h1 {
      color: #3f51b5;
      margin-top: 0;
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .tab {
      background: #ddd;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      color: #333;
    }
    .tab.active {
      background: #3f51b5;
      color: white;
    }
    .listing-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 15px;
    }
    .listing-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .listing-header h3 {
      margin: 0;
      color: #3f51b5;
    }
    .listing-details p {
      margin: 5px 0;
      color: #555;
    }
    .image-gallery {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .image-gallery img {
      width: 120px;
      height: 100px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid #ccc;
      cursor: pointer;
    }
    video {
      width: 100%;
      border-radius: 8px;
      margin-top: 10px;
      max-height: 240px;
    }
    iframe {
      width: 100%;
      height: 240px;
      border-radius: 8px;
      margin-top: 10px;
    }
    .actions {
      margin-top: 10px;
    }
    button {
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      color: white;
      font-size: 14px;
      margin-right: 5px;
    }
    .approve { background: #4CAF50; }
    .reject { background: #f44336; }
    .neutral { background: #888; }
  </style>
</head>
<body>

<header>RealEase - Admin Dashboard</header>

<div class="container">
  <nav>
    <a href="admin_home.html">üè† Dashboard</a>
    <a href="#">‚ûï Add User</a>
    <a href="approve_listings.html" class="active">‚≠ê Approve Listings</a>
    <a href="#">üë• Manage Users</a>
    <a href="#">üìä Reports</a>
    <a href="#">üìú Audit Log</a>
    <a href="#">üè† Buyer Listings</a>
    <a href="#">üè¢ Seller Listings</a>
    <a href="#" id="logoutBtn">üö™ Logout</a>
  </nav>

  <main>
    <h1>Manage Property Listings</h1>

    <div class="tabs">
      <button class="tab active" data-status="pending">Pending</button>
      <button class="tab" data-status="approved">Approved</button>
      <button class="tab" data-status="rejected">Rejected</button>
    </div>

    <div id="listingContainer">Loading...</div>
  </main>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { 
    getFirestore, collection, query, where, getDocs, getDoc, updateDoc, doc 
  } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
  import { 
    getAuth, signOut, onAuthStateChanged 
  } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

  // üî• Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyCIfzneDzWVveG8p_0mywoA9D9F5AyzZX4",
    authDomain: "bahai-1b76d.firebaseapp.com",
    projectId: "bahai-1b76d",
    storageBucket: "bahai-1b76d.firebasestorage.app",
    messagingSenderId: "646878644941",
    appId: "1:646878644941:web:5b4ccc3412250337587784"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const listingContainer = document.getElementById("listingContainer");
  const tabs = document.querySelectorAll(".tab");
  let currentStatus = "pending";

  // ‚úÖ Load listings by status
  async function loadListings(status) {
    listingContainer.innerHTML = `<p>Loading...</p>`;
    const q = query(collection(db, "properties"), where("status", "==", status));
    const querySnapshot = await getDocs(q);

    listingContainer.innerHTML = "";

    if (querySnapshot.empty) {
      listingContainer.innerHTML = `<p>No ${status} listings right now.</p>`;
      return;
    }

    for (const docSnap of querySnapshot.docs) {
      const data = docSnap.data();
      const card = document.createElement("div");
      card.classList.add("listing-card");

      // üßæ Fetch user's full name
      let userName = "Unknown";
      if (data.userId) {
        const userRef = doc(db, "users", data.userId);
        const userDoc = await getDoc(userRef);
        if (userDoc.exists()) {
          userName = userDoc.data().fullName || userDoc.data().email || "Unnamed User";
        }
      }

      // üñºÔ∏è Image Preview
      let imageHTML = "";
      if (data.imageBase64Array && data.imageBase64Array.length > 0) {
        imageHTML = `
          <div class="image-gallery">
            ${data.imageBase64Array.map(img => `<img src="${img}" alt="Property Image">`).join("")}
          </div>`;
      }

      // üé• Video Preview
      let videoHTML = "";
      if (data.videoUrl) {
        if (data.videoUrl.includes("youtube.com") || data.videoUrl.includes("youtu.be")) {
          const videoId = data.videoUrl.split("v=")[1]?.split("&")[0] || data.videoUrl.split("/").pop();
          videoHTML = `<iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen></iframe>`;
        } else {
          videoHTML = `<video controls src="${data.videoUrl}"></video>`;
        }
      }

      // üè† Card Template
      const listingType = data.listingType === "sale" ? "For Sale" : "For Rent";

      card.innerHTML = `
        <div class="listing-header">
          <h3>${data.title || "Untitled"}</h3>
          <span>Status: <strong>${data.status}</strong></span>
        </div>
        <div class="listing-details">
          <p><strong>Type:</strong> ${data.propertyType || "-"}</p>
          <p><strong>Listing:</strong> ${listingType}</p>
          <p><strong>Rent:</strong> ‚Ç±${data.monthlyRent || 0}</p>
          <p><strong>Deposit:</strong> ‚Ç±${data.deposit || 0}</p>
          <p><strong>Min Stay:</strong> ${data.minStay || "-"} months</p>
          <p><strong>Description:</strong> ${data.description || "-"}</p>
          <p><strong>Posted By:</strong> ${userName}</p>
        </div>
        ${imageHTML}
        ${videoHTML}
        <div class="actions">
          ${
            status === "pending"
              ? `
                <button class="approve">Approve</button>
                <button class="reject">Reject</button>
              `
              : `<button class="neutral">No Action</button>`
          }
        </div>
      `;

      // üü¢ Approve/Reject Actions
      if (status === "pending") {
        card.querySelector(".approve").addEventListener("click", async () => {
          await updateDoc(doc(db, "properties", docSnap.id), { status: "approved" });
          alert(`‚úÖ Approved: ${data.title}`);
          loadListings(currentStatus);
        });

        card.querySelector(".reject").addEventListener("click", async () => {
          await updateDoc(doc(db, "properties", docSnap.id), { status: "rejected" });
          alert(`‚ùå Rejected: ${data.title}`);
          loadListings(currentStatus);
        });
      }

      listingContainer.appendChild(card);
    }
  }

  // üß≠ Tab switching
  tabs.forEach((tab) => {
    tab.addEventListener("click", () => {
      tabs.forEach(t => t.classList.remove("active"));
      tab.classList.add("active");
      currentStatus = tab.getAttribute("data-status");
      loadListings(currentStatus);
    });
  });

  // üëÆ Admin check
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "admin_login.html";
      return;
    }

    const userDocs = await getDocs(query(collection(db, "users"), where("email", "==", user.email)));
    let role = "";
    userDocs.forEach((d) => role = d.data().role);

    if (role !== "admin") {
      alert("Access denied. Admins only.");
      window.location.href = "index.html";
      return;
    }

    loadListings(currentStatus);
  });

  // üö™ Logout
  document.getElementById("logoutBtn").addEventListener("click", async () => {
    await signOut(auth);
    window.location.href = "admin_login.html";
  });
</script>
</body>
</html>
