<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Dashboard - BahAI Real Estate</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* Updated CSS to match user/property management UI */
:root {
  --primary: #0b2e52;
  --primary-dark: #001F3F;
  --primary-light: #1976d2;
  --secondary: #3b82f6;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --info: #0ea5e9;
  --text-dark: #1a202c;
  --text-light: #718096;
  --bg-light: #f8fafc;
  --bg-white: #ffffff;
  --border: #e2e8f0;
  --shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.1);
  --sidebar-width: 260px;
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', Arial, sans-serif;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  color: var(--text-dark);
  display: flex;
  min-height: 100vh;
}

/* ==================== IMPROVED SIDEBAR STYLES ==================== */
.sidebar {
  width: var(--sidebar-width);
  height: 100vh;
  background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
  position: fixed;
  left: 0;
  top: 0;
  padding: 25px 0;
  box-shadow: 4px 0 20px rgba(0, 0, 0, 0.15);
  overflow-y: auto;
  z-index: 1000;
  transition: var(--transition);
  display: flex;
  flex-direction: column;
}

.sidebar-header {
  padding: 0 25px 30px;
  margin-bottom: 20px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.logo {
  display: flex;
  align-items: center;
  gap: 14px;
  color: white;
  text-decoration: none;
  transition: var(--transition);
  padding: 10px;
  border-radius: 12px;
}

.logo:hover {
  background: rgba(255, 255, 255, 0.1);
  transform: translateY(-2px);
}

.logo-icon {
  width: 48px;
  height: 48px;
  background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 20px;
  color: var(--primary);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  transition: var(--transition);
}

.logo:hover .logo-icon {
  transform: scale(1.05);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
}

.logo-text {
  display: flex;
  flex-direction: column;
  flex: 1;
}

.logo-title {
  font-size: 22px;
  font-weight: 800;
  line-height: 1.1;
  margin-bottom: 4px;
  letter-spacing: -0.3px;
  background: linear-gradient(135deg, #ffffff 0%, #e6f3ff 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.logo-subtitle {
  font-size: 11px;
  opacity: 0.9;
  color: rgba(255, 255, 255, 0.8);
  font-weight: 500;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}

/* Navigation */
.sidebar-nav {
  list-style: none;
  padding: 0;
  flex: 1;
}

.sidebar-nav li {
  margin: 5px 15px;
}

.sidebar-link {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 16px 20px;
  color: rgba(255, 255, 255, 0.85);
  text-decoration: none;
  transition: var(--transition);
  font-weight: 500;
  font-size: 15px;
  border-radius: 12px;
  position: relative;
  overflow: hidden;
}

.sidebar-link::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  height: 100%;
  width: 4px;
  background: white;
  transform: translateX(-10px);
  transition: var(--transition);
  border-radius: 0 4px 4px 0;
}

.sidebar-link:hover {
  background: rgba(255, 255, 255, 0.12);
  color: white;
  transform: translateX(5px);
}

.sidebar-link:hover::before {
  transform: translateX(0);
}

.sidebar-link.active {
  background: rgba(255, 255, 255, 0.18);
  color: white;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.sidebar-link.active::before {
  transform: translateX(0);
  background: linear-gradient(135deg, #ffffff 0%, #3b82f6 100%);
  box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
}

.sidebar-icon {
  width: 22px;
  height: 22px;
  display: inline-block;
  font-size: 18px;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
}

.sidebar-link:hover .sidebar-icon {
  transform: scale(1.1);
}

.sidebar-link.active .sidebar-icon {
  transform: scale(1.1);
}

/* Sidebar footer */
.sidebar-footer {
  padding: 20px 25px 0;
  margin-top: 20px;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  font-size: 12px;
  color: rgba(255, 255, 255, 0.6);
  text-align: center;
}

.sidebar-footer a {
  color: rgba(255, 255, 255, 0.8);
  text-decoration: none;
  transition: var(--transition);
}

.sidebar-footer a:hover {
  color: white;
  text-decoration: underline;
}

/* Main container */
.container {
  flex: 1;
  margin-left: var(--sidebar-width);
  padding: 30px;
  transition: var(--transition);
}

.dashboard-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  flex-wrap: wrap;
  gap: 20px;
}

.header-left h1 {
  font-size: 32px;
  font-weight: 800;
  color: var(--text-dark);
  margin-bottom: 10px;
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: -0.5px;
}

.header-left p {
  color: var(--text-light);
  font-size: 16px;
  max-width: 600px;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 15px;
}

.notification-btn {
  position: relative;
  width: 50px;
  height: 50px;
  background: white;
  border: none;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: var(--shadow);
  transition: var(--transition);
  color: var(--text-dark);
}

.notification-btn:hover {
  background: var(--secondary);
  color: white;
  transform: translateY(-3px) scale(1.05);
  box-shadow: 0 6px 16px rgba(59, 130, 246, 0.3);
}

.notification-badge {
  position: absolute;
  top: -6px;
  right: -6px;
  background: linear-gradient(135deg, var(--danger), #dc2626);
  color: white;
  border-radius: 50%;
  width: 22px;
  height: 22px;
  font-size: 12px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid white;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
}

.user-profile {
  position: relative;
  display: flex;
  align-items: center;
  gap: 12px;
  background: white;
  padding: 12px 20px;
  border-radius: 12px;
  box-shadow: var(--shadow);
  cursor: pointer;
  transition: var(--transition);
  min-width: 200px;
}

.user-profile:hover {
  background: linear-gradient(135deg, #f8fafc, #e9ecef);
  transform: translateY(-3px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
}

.user-avatar {
  width: 44px;
  height: 44px;
  border-radius: 12px;
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 700;
  font-size: 18px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.user-info {
  display: flex;
  flex-direction: column;
  flex: 1;
}

.user-name {
  font-weight: 700;
  color: var(--text-dark);
  font-size: 14px;
}

.user-role {
  font-size: 12px;
  color: var(--text-light);
  font-weight: 500;
}

.user-profile i {
  color: var(--text-light);
  transition: var(--transition);
}

.user-profile:hover i {
  color: var(--primary);
}

/* SIMPLIFIED User Dropdown Menu */
.user-dropdown {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 10px;
  background: white;
  border-radius: 14px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
  min-width: 180px; /* Reduced width */
  z-index: 1000;
  display: none;
  overflow: hidden;
  border: 1px solid var(--border);
  animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.user-dropdown.show {
  display: block;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.dropdown-item {
  padding: 14px 16px; /* Reduced padding */
  display: flex;
  align-items: center;
  gap: 10px;
  color: var(--text-dark);
  text-decoration: none;
  transition: var(--transition);
  border-bottom: 1px solid var(--border);
  font-weight: 500;
  font-size: 14px; /* Smaller font */
}

.dropdown-item:last-child {
  border-bottom: none;
}

.dropdown-item:hover {
  background: var(--bg-light);
  color: var(--primary);
  padding-left: 20px;
}

.dropdown-item i {
  width: 18px;
  color: var(--text-light);
  font-size: 14px;
}

.dropdown-item:hover i {
  color: var(--primary);
}

.dropdown-item.logout {
  color: var(--danger);
}

.dropdown-item.logout:hover {
  background: linear-gradient(135deg, #fee2e2, #fecaca);
  color: #991b1b;
}

.dropdown-item.logout i {
  color: var(--danger);
}

/* Stats Grid - Updated to 3 cards (removed featured) */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 24px;
  margin-bottom: 35px;
}

.stat-card {
  background: white;
  padding: 25px;
  border-radius: 18px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--primary), var(--primary-light));
}

.stat-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
}

.stat-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.stat-title {
  font-size: 15px;
  color: var(--text-light);
  font-weight: 600;
}

.stat-icon {
  width: 50px;
  height: 50px;
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.stat-icon.blue {
  background: linear-gradient(135deg, var(--secondary), #2563eb);
  color: white;
}

.stat-icon.teal {
  background: linear-gradient(135deg, var(--success), #059669);
  color: white;
}

.stat-icon.green {
  background: linear-gradient(135deg, #10b981, #047857);
  color: white;
}

.stat-icon.purple {
  background: linear-gradient(135deg, #8b5cf6, #7c3aed);
  color: white;
}

.stat-value {
  font-size: 38px;
  font-weight: 800;
  color: var(--primary);
  margin-bottom: 10px;
  line-height: 1;
}

.stat-growth {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  font-weight: 600;
}

.stat-growth.positive {
  color: var(--success);
}

.stat-growth.positive::before {
  content: '‚Üë';
}

.stat-growth.negative {
  color: var(--danger);
}

.stat-growth.negative::before {
  content: '‚Üì';
}

.content-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 28px;
}

.card {
  background: white;
  border-radius: 18px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  overflow: hidden;
  transition: var(--transition);
}

.card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
}

.card-header {
  padding: 25px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: linear-gradient(135deg, var(--bg-light) 0%, #e9f2ff 100%);
}

.card-title-group {
  display: flex;
  align-items: center;
  gap: 15px;
}

.card-icon {
  width: 44px;
  height: 44px;
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 20px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.card-title {
  font-size: 20px;
  font-weight: 700;
  color: var(--text-dark);
}

.card-actions {
  display: flex;
  align-items: center;
  gap: 10px;
}

.refresh-btn {
  background: linear-gradient(135deg, var(--secondary), #2563eb);
  color: white;
  border: none;
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: var(--transition);
  box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2);
}

.refresh-btn:hover {
  background: linear-gradient(135deg, #2563eb, #1d4ed8);
  transform: rotate(180deg) scale(1.1);
}

.card-content {
  padding: 25px;
}

.activity-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.activity-item {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  padding: 18px;
  background: var(--bg-light);
  border-radius: 14px;
  border: 1px solid var(--border);
  transition: var(--transition);
  cursor: pointer;
}

.activity-item:hover {
  background: #f1f5f9;
  border-color: var(--primary-light);
  transform: translateX(8px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.activity-content {
  flex: 1;
}

.activity-main {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 8px;
}

.activity-action {
  font-weight: 700;
  color: var(--text-dark);
  font-size: 15px;
}

.activity-status {
  padding: 5px 12px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.activity-status.success {
  background: linear-gradient(135deg, #d1fae5, #a7f3d0);
  color: #065f46;
  border: 1px solid #10b981;
}

.activity-status.pending {
  background: linear-gradient(135deg, #fef3c7, #fde68a);
  color: #92400e;
  border: 1px solid #f59e0b;
}

.activity-status.approved {
  background: linear-gradient(135deg, #dbeafe, #bfdbfe);
  color: #1e40af;
  border: 1px solid #3b82f6;
}

.activity-status.completed {
  background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
  color: #4338ca;
  border: 1px solid #6366f1;
}

.activity-details {
  font-size: 14px;
  color: var(--text-light);
  line-height: 1.5;
}

.activity-time {
  font-size: 13px;
  color: #94a3b8;
  white-space: nowrap;
  font-weight: 500;
  background: white;
  padding: 4px 10px;
  border-radius: 8px;
  border: 1px solid var(--border);
}

/* Updated Quick Stats Grid - removed bedrooms/bathrooms */
.quick-stats-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
}

.quick-stat-item {
  background: var(--bg-light);
  padding: 22px;
  border-radius: 14px;
  border: 1px solid var(--border);
  transition: var(--transition);
}

.quick-stat-item:hover {
  background: #f1f5f9;
  border-color: var(--primary-light);
  transform: translateY(-3px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.quick-stat-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 18px;
}

.quick-stat-icon {
  width: 40px;
  height: 40px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  background: white;
  border: 2px solid var(--border);
  color: var(--primary);
}

.quick-stat-name {
  font-weight: 700;
  color: var(--text-dark);
  font-size: 14px;
}

.quick-stat-value {
  font-size: 28px;
  font-weight: 800;
  color: var(--primary);
  margin-bottom: 6px;
  line-height: 1;
}

.quick-stat-detail {
  font-size: 13px;
  color: var(--text-light);
  font-weight: 500;
}

/* Toast notifications */
.toast {
  position: fixed;
  bottom: 30px;
  right: 30px;
  background: white;
  color: var(--text-dark);
  padding: 18px 25px;
  border-radius: 14px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
  display: flex;
  align-items: center;
  gap: 14px;
  z-index: 3000;
  animation: slideInRight 0.3s ease;
  border-left: 5px solid var(--primary);
  max-width: 400px;
}

.toast.success {
  border-left-color: var(--success);
}

.toast.error {
  border-left-color: var(--danger); 
}

.toast.info {
  border-left-color: var(--info);
}

@keyframes slideInRight {
  from { transform: translateX(100px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

/* Loading overlay */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 4000;
  display: none;
}

.loading-overlay.show {
  display: flex;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.loading-spinner {
  width: 70px;
  height: 70px;
  border: 4px solid rgba(11, 46, 82, 0.1);
  border-top: 4px solid var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* IMPROVED Notification Panel */
.notification-panel {
  position: fixed;
  top: 100px;
  right: 30px;
  background: white;
  border-radius: 18px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
  width: 400px;
  max-height: 500px;
  overflow-y: auto;
  z-index: 1001;
  display: none;
  border: 1px solid var(--border);
  animation: slideInRight 0.3s ease;
}

.notification-panel.show {
  display: block;
}

.notification-header {
  padding: 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--bg-light);
}

.notification-header h3 {
  font-size: 18px;
  font-weight: 700;
  color: var(--text-dark);
}

.notification-list {
  padding: 0;
}

.notification-item {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: flex-start;
  gap: 14px;
  transition: var(--transition);
  cursor: pointer;
}

.notification-item:hover {
  background: var(--bg-light);
}

.notification-item.unread {
  background: #f0f9ff;
}

.notification-item.unread .notification-title {
  font-weight: 700;
}

.notification-icon {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  flex-shrink: 0;
  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
}

.notification-icon.new-user {
  background: linear-gradient(135deg, var(--secondary), #2563eb);
  color: white;
}

.notification-icon.new-property {
  background: linear-gradient(135deg, var(--success), #059669);
  color: white;
}

.notification-icon.property-sold {
  background: linear-gradient(135deg, var(--warning), #d97706);
  color: white;
}

.notification-icon.property-updated {
  background: linear-gradient(135deg, #8b5cf6, #7c3aed);
  color: white;
}

.notification-content {
  flex: 1;
}

.notification-title {
  font-weight: 700;
  color: var(--text-dark);
  font-size: 14px;
  margin-bottom: 4px;
}

.notification-desc {
  font-size: 13px;
  color: var(--text-light);
  line-height: 1.4;
  margin-bottom: 6px;
}

.notification-time {
  font-size: 11px;
  color: #94a3b8;
  font-weight: 500;
}

.notification-actions {
  padding: 16px;
  border-top: 1px solid var(--border);
  text-align: center;
  background: var(--bg-light);
}

.notification-actions a {
  color: var(--primary);
  text-decoration: none;
  font-size: 14px;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  border-radius: 8px;
  transition: var(--transition);
}

.notification-actions a:hover {
  background: var(--bg-light);
  color: var(--primary-light);
}

/* Mobile menu toggle */
.mobile-menu-toggle {
  display: none;
  position: fixed;
  top: 20px;
  left: 20px;
  z-index: 1001;
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
  border: none;
  width: 56px;
  height: 56px;
  border-radius: 14px;
  font-size: 24px;
  cursor: pointer;
  box-shadow: var(--shadow-lg);
  transition: var(--transition);
}

.mobile-menu-toggle:hover {
  transform: scale(1.1);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
}

/* Sidebar Overlay for Mobile */
.sidebar-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 999;
  backdrop-filter: blur(2px);
}

.sidebar.active + .sidebar-overlay {
  display: block;
}

/* ========== RESPONSIVE DESIGN IMPROVEMENTS ========== */

@media (max-width: 1400px) {
  .content-grid {
    gap: 24px;
  }
  
  .stats-grid {
    gap: 20px;
  }
  
  .quick-stats-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}

@media (max-width: 1200px) {
  .content-grid {
    grid-template-columns: 1fr;
  }
  
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .quick-stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 1024px) {
  .sidebar {
    transform: translateX(-100%);
    width: 300px;
  }

  .sidebar.active {
    transform: translateX(0);
  }

  .container {
    margin-left: 0;
    padding: 25px 20px;
  }

  .mobile-menu-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .dashboard-header {
    margin-bottom: 25px;
  }
  
  .header-left h1 {
    font-size: 28px;
  }
  
  .header-left p {
    font-size: 15px;
  }
  
  .stat-card {
    padding: 22px;
  }
  
  .stat-value {
    font-size: 34px;
  }
  
  .stat-icon {
    width: 46px;
    height: 46px;
    font-size: 22px;
  }
}

@media (max-width: 900px) {
  .stats-grid {
    grid-template-columns: 1fr;
  }
  
  .quick-stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .card-header {
    padding: 22px;
  }
  
  .card-content {
    padding: 22px;
  }
}

@media (max-width: 768px) {
  .container {
    padding: 20px 15px;
  }

  .dashboard-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 15px;
    margin-bottom: 20px;
  }

  .header-right {
    width: 100%;
    justify-content: space-between;
    gap: 10px;
  }
  
  .user-profile {
    min-width: auto;
    width: 100%;
    max-width: 300px;
    padding: 10px 15px;
  }
  
  .user-avatar {
    width: 40px;
    height: 40px;
    font-size: 16px;
  }
  
  .notification-btn {
    width: 46px;
    height: 46px;
  }

  .stats-grid {
    gap: 16px;
    margin-bottom: 25px;
  }
  
  .content-grid {
    gap: 18px;
  }
  
  .card {
    border-radius: 16px;
  }
  
  .card-header {
    padding: 20px;
    flex-direction: column;
    align-items: flex-start;
    gap: 15px;
  }
  
  .card-title-group {
    width: 100%;
  }
  
  .card-actions {
    align-self: flex-end;
    width: 100%;
    justify-content: flex-end;
  }
  
  .card-content {
    padding: 20px;
  }
  
  .activity-item {
    padding: 16px;
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }
  
  .activity-main {
    width: 100%;
    justify-content: space-between;
  }
  
  .activity-time {
    align-self: flex-end;
    margin-top: 8px;
  }
  
  .quick-stats-grid {
    gap: 16px;
  }
  
  .quick-stat-item {
    padding: 18px;
  }
  
  .quick-stat-value {
    font-size: 26px;
  }
  
  .header-left h1 {
    font-size: 26px;
  }
  
  .header-left p {
    font-size: 14px;
  }
  
  .notification-panel {
    position: fixed;
    top: 90px;
    right: 15px;
    left: 15px;
    width: auto;
    max-height: 70vh;
  }
  
  .stat-value {
    font-size: 32px;
  }
  
  .stat-title, .quick-stat-name {
    word-break: break-word;
    overflow-wrap: break-word;
  }
}

@media (max-width: 576px) {
  .container {
    padding: 18px 12px;
  }
  
  .quick-stats-grid {
    grid-template-columns: 1fr;
  }
  
  .activity-item {
    padding: 14px;
  }
  
  .activity-action {
    font-size: 14px;
  }
  
  .activity-details {
    font-size: 13px;
  }
  
  .activity-time {
    font-size: 12px;
  }
  
  .quick-stat-header {
    margin-bottom: 15px;
  }
  
  .quick-stat-icon {
    width: 36px;
    height: 36px;
    font-size: 16px;
  }
  
  .quick-stat-name {
    font-size: 13px;
  }
  
  .stat-card {
    padding: 20px;
  }
  
  .stat-value {
    font-size: 30px;
  }
  
  .stat-title {
    font-size: 14px;
  }
  
  .stat-growth {
    font-size: 13px;
  }
  
  .card-header {
    padding: 18px;
  }
  
  .card-title {
    font-size: 18px;
  }
  
  .card-icon {
    width: 40px;
    height: 40px;
    font-size: 18px;
  }
  
  .mobile-menu-toggle {
    top: 15px;
    left: 15px;
    width: 50px;
    height: 50px;
    font-size: 22px;
  }
  
  .header-left h1 {
    font-size: 24px;
  }
  
  .header-left p {
    font-size: 13px;
  }
}

@media (max-width: 480px) {
  .container {
    padding: 15px 10px;
  }

  .stat-card {
    padding: 18px;
  }
  
  .quick-stat-item {
    padding: 16px;
  }

  .stat-value {
    font-size: 28px;
  }

  .quick-stat-value {
    font-size: 24px;
  }
  
  .activity-status {
    font-size: 10px;
    padding: 4px 10px;
  }
  
  .stat-icon {
    width: 42px;
    height: 42px;
    font-size: 20px;
  }
  
  .dashboard-header {
    gap: 12px;
  }
  
  .user-profile {
    padding: 8px 12px;
  }
  
  .user-name {
    font-size: 13px;
  }
  
  .user-role {
    font-size: 11px;
  }
  
  .header-left h1 {
    font-size: 22px;
    margin-bottom: 6px;
  }
  
  .header-left p {
    font-size: 12px;
    line-height: 1.4;
  }
  
  .notification-badge {
    width: 20px;
    height: 20px;
    font-size: 11px;
    top: -4px;
    right: -4px;
  }
  
  .user-dropdown {
    min-width: 160px;
    right: 10px;
  }
}

@media (max-width: 400px) {
  .container {
    padding: 12px 8px;
  }
  
  .stats-grid {
    gap: 12px;
  }
  
  .content-grid {
    gap: 14px;
  }
  
  .stat-card {
    padding: 16px;
  }
  
  .stat-value {
    font-size: 26px;
  }
  
  .card-header {
    padding: 16px;
  }
  
  .card-content {
    padding: 16px;
  }
  
  .activity-item {
    padding: 12px;
  }
  
  .quick-stat-item {
    padding: 14px;
  }
  
  .quick-stat-value {
    font-size: 22px;
  }
  
  .mobile-menu-toggle {
    width: 46px;
    height: 46px;
    font-size: 20px;
  }
  
  .sidebar {
    width: 280px;
  }
  
  .user-profile {
    padding: 6px 10px;
  }
  
  .user-avatar {
    width: 36px;
    height: 36px;
    font-size: 14px;
  }
}

@media (max-width: 360px) {
  .header-right {
    flex-direction: column;
    align-items: stretch;
  }
  
  .notification-btn {
    align-self: flex-end;
  }
  
  .user-profile {
    order: -1;
  }
  
  .stat-icon {
    width: 38px;
    height: 38px;
    font-size: 18px;
  }
  
  .stat-title {
    font-size: 13px;
  }
  
  .activity-main {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  
  .activity-status {
    align-self: flex-start;
  }
  
  .stat-value {
    font-size: 24px;
  }
  
  .quick-stat-value {
    font-size: 20px;
  }
}

/* Prevent text overflow on mobile */
.stat-title,
.quick-stat-name,
.activity-action,
.activity-details {
  word-break: break-word;
  overflow-wrap: break-word;
}

/* Improve touch targets on mobile */
.sidebar-link,
.activity-item,
.quick-stat-item,
.refresh-btn,
.notification-btn,
.dropdown-item {
  cursor: pointer;
}

/* Make sure dropdowns don't go off-screen */
.user-dropdown {
  max-width: calc(100vw - 40px);
  right: 10px;
}

/* Improve sidebar scrolling on mobile */
.sidebar {
  -webkit-overflow-scrolling: touch;
}

/* Better animation for mobile menu */
.sidebar {
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
</style>
</head>

<body>
<button class="mobile-menu-toggle" id="mobileMenuToggle">
  <i class="fas fa-bars"></i>
</button>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
</div>

<!-- Notification Panel -->
<div class="notification-panel" id="notificationPanel">
  <div class="notification-header">
    <h3>Notifications</h3>
    <button onclick="hideNotifications()" style="background: none; border: none; color: var(--text-light); cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 10px; transition: var(--transition);">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="notification-list" id="notificationList">
    <!-- Notifications will be loaded here -->
  </div>
  <div class="notification-actions">
    <a href="#" onclick="markAllAsRead()">
      <i class="fas fa-check-double"></i>
      Mark all as read
    </a>
  </div>
</div>

<!-- SIMPLIFIED User Dropdown Menu -->
<div class="user-dropdown" id="userDropdown">
  <a href="#" class="dropdown-item" onclick="viewProfile()">
    <i class="fas fa-user"></i>
    <span>My Profile</span>
  </a>
  <a href="admin_settings.html" class="dropdown-item">
    <i class="fas fa-cog"></i>
    <span>Settings</span>
  </a>
  <div class="dropdown-item" onclick="showHelp()">
    <i class="fas fa-question-circle"></i>
    <span>Help</span>
  </div>
  <a href="#" class="dropdown-item logout" onclick="logout()">
    <i class="fas fa-sign-out-alt"></i>
    <span>Logout</span>
  </a>
</div>

<!-- Sidebar Overlay (for mobile) -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <a href="admin_dashboard.html" class="logo">
      <div class="logo-icon">BA</div>
      <div class="logo-text">
        <div class="logo-title">BahAI</div>
        <div class="logo-subtitle">Admin Dashboard</div>
      </div>
    </a>
  </div>

  <ul class="sidebar-nav">
    <li>
      <a href="admin_dashboard.html" class="sidebar-link active">
        <span class="sidebar-icon"><i class="fas fa-chart-line"></i></span>
        Dashboard Overview
      </a>
    </li>
    <li>
      <a href="admin_users.html" class="sidebar-link">
        <span class="sidebar-icon"><i class="fas fa-users"></i></span>
        User Management
      </a>
    </li>
    <li>
      <a href="admin_properties.html" class="sidebar-link">
        <span class="sidebar-icon"><i class="fas fa-building"></i></span>
        Property Listings
      </a>
    </li>
    <li>
      <a href="admin_analytics.html" class="sidebar-link">
        <span class="sidebar-icon"><i class="fas fa-chart-bar"></i></span>
        Reports & Analytics
      </a>
    </li>
    <li>
      <a href="admin_settings.html" class="sidebar-link">
        <span class="sidebar-icon"><i class="fas fa-cog"></i></span>
        Settings
      </a>
    </li>
    <!-- LOGOUT BUTTON ADDED HERE -->
    <li>
      <a href="#" class="sidebar-link" onclick="logout()">
        <span class="sidebar-icon"><i class="fas fa-sign-out-alt"></i></span>
        Logout
      </a>
    </li>
  </ul>

  <div class="sidebar-footer">
    <div style="margin-bottom: 8px; opacity: 0.7;"></div>
    <div>¬© 2026 BahAI Admin</div>
  </div>
</div>

<div class="container">
  <div class="dashboard-header">
    <div class="header-left">
      <h1>Admin Dashboard</h1>
      <p>Monitor and analyze your real estate platform performance</p>
    </div>
    <div class="header-right">
      <button class="notification-btn" onclick="toggleNotifications()">
        <i class="fas fa-bell"></i>
        <span class="notification-badge" id="notificationCount">0</span>
      </button>
      <div class="user-profile" onclick="toggleUserDropdown()">
        <div class="user-avatar" id="userInitials">AD</div>
        <div class="user-info">
          <span class="user-name" id="userName">Admin User</span>
          <span class="user-role">System Admin</span>
        </div>
        <i class="fas fa-chevron-down"></i>
      </div>
    </div>
  </div>

  <div class="stats-grid">
    <!-- Total Users Card -->
    <div class="stat-card">
      <div class="stat-header">
        <span class="stat-title">Total Users</span>
        <div class="stat-icon blue"><i class="fas fa-users"></i></div>
      </div>
      <div class="stat-value" id="totalUsers">0</div>
      <div class="stat-growth positive">
        <span id="userGrowth">Loading...</span>
      </div>
    </div>

    <!-- Total Properties Card -->
    <div class="stat-card">
      <div class="stat-header">
        <span class="stat-title">Total Properties</span>
        <div class="stat-icon teal"><i class="fas fa-building"></i></div>
      </div>
      <div class="stat-value" id="totalProperties">0</div>
      <div class="stat-growth positive">
        <span id="propertyGrowth">Loading...</span>
      </div>
    </div>

    <!-- Active Listings Card -->
    <div class="stat-card">
      <div class="stat-header">
        <span class="stat-title">Active Listings</span>
        <div class="stat-icon green"><i class="fas fa-chart-line"></i></div>
      </div>
      <div class="stat-value" id="activeListings">0</div>
      <div class="stat-growth positive">
        <span id="listingsGrowth">Loading...</span>
      </div>
    </div>
  </div>

  <div class="content-grid">
    <!-- Recent Properties Card -->
    <div class="card">
      <div class="card-header">
        <div class="card-title-group">
          <div class="card-icon"><i class="fas fa-chart-line"></i></div>
          <h3 class="card-title">Recent Properties</h3>
        </div>
        <div class="card-actions">
          <button class="refresh-btn" onclick="loadDashboardData()" title="Refresh">
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>
      </div>
      <div class="card-content">
        <div class="activity-list" id="recentProperties">
          <div class="activity-item">
            <div class="activity-content">
              <div class="activity-main">
                <span class="activity-action">Loading properties...</span>
                <span class="activity-status pending">LOADING</span>
              </div>
              <div class="activity-details">
                Please wait while we fetch recent properties
              </div>
            </div>
            <span class="activity-time">Just now</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Platform Statistics Card -->
    <div class="card">
      <div class="card-header">
        <div class="card-title-group">
          <div class="card-icon"><i class="fas fa-chart-bar"></i></div>
          <h3 class="card-title">Platform Statistics</h3>
        </div>
      </div>
      <div class="card-content">
        <div class="quick-stats-grid" id="quickStats">
          <!-- Property Types -->
          <div class="quick-stat-item">
            <div class="quick-stat-header">
              <div class="quick-stat-icon"><i class="fas fa-home"></i></div>
              <span class="quick-stat-name">Property Types</span>
            </div>
            <div class="quick-stat-value" id="propertyTypes">0</div>
            <div class="quick-stat-detail">different types</div>
          </div>
          
          <!-- Locations -->
          <div class="quick-stat-item">
            <div class="quick-stat-header">
              <div class="quick-stat-icon"><i class="fas fa-map-marker-alt"></i></div>
              <span class="quick-stat-name">Locations</span>
            </div>
            <div class="quick-stat-value" id="uniqueLocations">0</div>
            <div class="quick-stat-detail">unique areas</div>
          </div>
          
          <!-- Average Price -->
          <div class="quick-stat-item">
            <div class="quick-stat-header">
              <div class="quick-stat-icon"><i class="fas fa-money-bill-wave"></i></div>
              <span class="quick-stat-name">Avg. Price</span>
            </div>
            <div class="quick-stat-value" id="averagePrice">‚Ç±0</div>
            <div class="quick-stat-detail">per property</div>
          </div>
          
          <!-- Recent Activity -->
          <div class="quick-stat-item">
            <div class="quick-stat-header">
              <div class="quick-stat-icon"><i class="fas fa-history"></i></div>
              <span class="quick-stat-name">Recent Activity</span>
            </div>
            <div class="quick-stat-value" id="recentActivity">0</div>
            <div class="quick-stat-detail">last 7 days</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Firebase SDK v9 (modular) -->
<script type="module">
// Import Firebase modules
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  getDocs,
  onSnapshot,
  query,
  orderBy,
  where,
  limit,
  Timestamp
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyCIfzneDzWVveG8p_0mywoA9D9F5AyzZX4",
  authDomain: "bahai-1b76d.firebaseapp.com",
  projectId: "bahai-1b76d",
  storageBucket: "bahai-1b76d.firebasestorage.app",
  messagingSenderId: "646878644941",
  appId: "1:646878644941:web:5b4ccc3412250337587784",
  measurementId: "G-PDW1PRZTM9"
};

// Global variables
let app;
let db;
let firebaseInitialized = false;
let allUsers = [];
let allProperties = [];
let allNotifications = [];

// Toast notification function
function showToast(message, type = 'info', duration = 3000) {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    ${type === 'success' ? '<i class="fas fa-check-circle" style="color: var(--success);"></i>' : 
      type === 'error' ? '<i class="fas fa-exclamation-circle" style="color: var(--danger);"></i>' : 
      '<i class="fas fa-info-circle" style="color: var(--info);"></i>'}
    <span>${message}</span>
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(100px)';
    setTimeout(() => {
      document.body.removeChild(toast);
    }, 300);
  }, duration);
}

// Show/hide loading overlay
function showLoading() {
  document.getElementById('loadingOverlay').classList.add('show');
}

function hideLoading() {
  document.getElementById('loadingOverlay').classList.remove('show');
}

// Initialize Firebase
async function initializeFirebase() {
  try {
    console.log('üîß Initializing Firebase...');
    showLoading();
    
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    firebaseInitialized = true;
    
    console.log('‚úÖ Firebase initialized successfully');
    
    // Check if user is logged in
    if (!checkAuth()) {
      return;
    }
    
    // Load user profile from settings
    loadUserProfile();
    
    // Load dashboard data immediately
    await loadDashboardData();
    
    // Set up real-time listeners
    setupRealtimeListeners();
    
    hideLoading();
    
  } catch (error) {
    console.error('‚ùå Firebase initialization failed:', error);
    hideLoading();
    showToast('Failed to connect to database. Please check your connection.', 'error');
  }
}

// Check if user is logged in
function checkAuth() {
  const isLoggedIn = localStorage.getItem('adminLoggedIn');
  
  if (!isLoggedIn || isLoggedIn !== 'true') {
    console.log('Not logged in, redirecting to login page');
    window.location.href = 'admin_login.html';
    return false;
  }
  
  return true;
}

// Load user profile from settings
function loadUserProfile() {
  const adminName = localStorage.getItem('adminName') || 'Administrator';
  
  // Update UI
  document.getElementById('userName').textContent = adminName;
  
  // Set avatar initials
  const initials = adminName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
  document.getElementById('userInitials').textContent = initials;
  
  console.log(`üë§ User profile loaded: ${adminName}`);
}

// Set up real-time Firebase listeners
function setupRealtimeListeners() {
  try {
    console.log('üîî Setting up real-time listeners...');
    
    // Real-time listener for users
    const usersUnsubscribe = onSnapshot(collection(db, "users"), (snapshot) => {
      const users = [];
      snapshot.forEach((doc) => {
        users.push({ id: doc.id, ...doc.data() });
      });
      
      allUsers = users;
      updateUserStats();
      
      // Check for new users
      snapshot.docChanges().forEach(change => {
        if (change.type === "added") {
          const newUser = { id: change.doc.id, ...change.doc.data() };
          console.log('üë§ New user detected:', newUser.email || newUser.id);
          
          // Add accurate notification for new user
          const userDate = getDateFromFirestore(newUser.createdAt) || new Date();
          addNotification({
            id: `user_${newUser.id}_${Date.now()}`,
            type: 'new-user',
            title: 'New User Registered',
            description: `${newUser.name || newUser.email || 'New user'} joined the platform`,
            time: userDate,
            relatedId: newUser.id,
            unread: true
          });
        }
      });
    });
    
    // Real-time listener for properties
    const propertiesUnsubscribe = onSnapshot(collection(db, "properties"), (snapshot) => {
      const properties = [];
      snapshot.forEach((doc) => {
        properties.push({ id: doc.id, ...doc.data() });
      });
      
      allProperties = properties;
      updatePropertyStats();
      updatePlatformStatistics();
      updateRecentProperties();
      
      // Check for new/updated properties
      snapshot.docChanges().forEach(change => {
        if (change.type === "added") {
          const newProperty = { id: change.doc.id, ...change.doc.data() };
          console.log('üè¢ New property detected:', newProperty.title || newProperty.id);
          
          // Add accurate notification for new property
          const propDate = getDateFromFirestore(newProperty.createdAt) || new Date();
          addNotification({
            id: `property_${newProperty.id}_${Date.now()}`,
            type: 'new-property',
            title: 'New Property Listed',
            description: `${newProperty.title || 'New property'} has been added`,
            time: propDate,
            relatedId: newProperty.id,
            unread: true
          });
        } else if (change.type === "modified") {
          const updatedProperty = { id: change.doc.id, ...change.doc.data() };
          
          // Check if property was sold
          if (updatedProperty.status === 'sold') {
            const propDate = getDateFromFirestore(updatedProperty.updatedAt) || new Date();
            addNotification({
              id: `sold_${updatedProperty.id}_${Date.now()}`,
              type: 'property-sold',
              title: 'Property Sold',
              description: `${updatedProperty.title || 'Property'} has been sold`,
              time: propDate,
              relatedId: updatedProperty.id,
              unread: true
            });
          }
        }
      });
    });
    
    console.log('‚úÖ Real-time listeners activated');
    
  } catch (error) {
    console.error('‚ùå Error setting up real-time listeners:', error);
  }
}

// Load all dashboard data from Firebase
async function loadDashboardData() {
  try {
    if (!firebaseInitialized) {
      await initializeFirebase();
      return;
    }
    
    showLoading();
    
    console.log('üìä Loading dashboard data...');
    
    // Reset UI to loading state
    document.getElementById('totalUsers').textContent = '...';
    document.getElementById('totalProperties').textContent = '...';
    document.getElementById('activeListings').textContent = '...';
    
    // Load users and properties
    await Promise.all([
      loadAllUsers(),
      loadAllProperties()
    ]);
    
    // Calculate all statistics
    calculateAllStatistics();
    
    // Update UI
    updateUserStats();
    updatePropertyStats();
    updatePlatformStatistics();
    updateRecentProperties();
    updateNotifications();
    
    hideLoading();
    showToast('‚úÖ Dashboard refreshed successfully', 'success', 2000);
    
  } catch (error) {
    console.error("‚ùå Error loading dashboard data:", error);
    hideLoading();
    showToast('‚ùå Failed to load dashboard data', 'error');
  }
}

// Load all users from Firebase
async function loadAllUsers() {
  try {
    console.log('üë• Loading users...');
    const usersQuery = collection(db, "users");
    const usersSnapshot = await getDocs(usersQuery);
    
    allUsers = [];
    usersSnapshot.forEach((doc) => {
      allUsers.push({ id: doc.id, ...doc.data() });
    });
    
    console.log(`‚úÖ Loaded ${allUsers.length} users`);
    
  } catch (error) {
    console.error("‚ùå Error loading users:", error);
    allUsers = [];
  }
}

// Load all properties from Firebase
async function loadAllProperties() {
  try {
    console.log('üè¢ Loading properties...');
    const propertiesQuery = collection(db, "properties");
    const propertiesSnapshot = await getDocs(propertiesQuery);
    
    allProperties = [];
    propertiesSnapshot.forEach((doc) => {
      allProperties.push({ id: doc.id, ...doc.data() });
    });
    
    console.log(`‚úÖ Loaded ${allProperties.length} properties`);
    
  } catch (error) {
    console.error("‚ùå Error loading properties:", error);
    allProperties = [];
  }
}

// Calculate all statistics
function calculateAllStatistics() {
  console.log('üìä Calculating statistics...');
  
  // User statistics
  const totalUsers = allUsers.length;
  const newUsersLast7Days = allUsers.filter(user => {
    const userDate = getDateFromFirestore(user.createdAt);
    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - 7);
    return userDate > weekAgo;
  }).length;
  
  // Property statistics
  const totalProperties = allProperties.length;
  const activeListings = allProperties.filter(prop => 
    prop.status !== 'sold' && prop.status !== 'archived'
  ).length;
  
  const newPropertiesLast7Days = allProperties.filter(prop => {
    const propDate = getDateFromFirestore(prop.createdAt);
    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - 7);
    return propDate > weekAgo;
  }).length;
  
  // Update main stats
  document.getElementById('totalUsers').textContent = totalUsers;
  document.getElementById('totalProperties').textContent = totalProperties;
  document.getElementById('activeListings').textContent = activeListings;
  
  // Update growth indicators
  document.getElementById('userGrowth').textContent = `${newUsersLast7Days} new this week`;
  document.getElementById('propertyGrowth').textContent = `${newPropertiesLast7Days} new this week`;
  
  const activePercentage = totalProperties > 0 ? 
    Math.round((activeListings / totalProperties) * 100) : 0;
  document.getElementById('listingsGrowth').textContent = `${activePercentage}% active`;
  
  console.log('‚úÖ Statistics calculated:', {
    totalUsers,
    totalProperties,
    activeListings
  });
}

// Update user statistics
function updateUserStats() {
  const totalUsers = allUsers.length;
  document.getElementById('totalUsers').textContent = totalUsers;
}

// Update property statistics
function updatePropertyStats() {
  const totalProperties = allProperties.length;
  const activeListings = allProperties.filter(prop => 
    prop.status !== 'sold' && prop.status !== 'archived'
  ).length;
  
  document.getElementById('totalProperties').textContent = totalProperties;
  document.getElementById('activeListings').textContent = activeListings;
}

// Update platform statistics
function updatePlatformStatistics() {
  try {
    if (allProperties.length === 0) {
      resetPlatformStats();
      return;
    }

    // 1. Count unique property types
    const propertyTypes = [...new Set(allProperties
      .map(p => p.propertyType || p.type)
      .filter(Boolean))];
    document.getElementById('propertyTypes').textContent = propertyTypes.length;

    // 2. Count unique locations
    const locations = [...new Set(allProperties
      .map(p => p.location || p.city || p.address)
      .filter(Boolean))];
    document.getElementById('uniqueLocations').textContent = locations.length;

    // 3. Calculate average price
    const validPrices = allProperties
      .map(p => {
        const price = p.price || p.pricePerMonth || p.rentalPrice || 0;
        return parseFloat(price) || 0;
      })
      .filter(price => price > 0);
    
    const avgPrice = validPrices.length > 0 
      ? Math.round(validPrices.reduce((sum, price) => sum + price, 0) / validPrices.length)
      : 0;
    
    document.getElementById('averagePrice').textContent = `‚Ç±${avgPrice.toLocaleString()}`;

    // 4. Recent activity (properties added in last 7 days)
    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - 7);
    
    const recentActivity = allProperties.filter(prop => {
      const propDate = getDateFromFirestore(prop.createdAt);
      return propDate > weekAgo;
    }).length;
    
    document.getElementById('recentActivity').textContent = recentActivity;

  } catch (error) {
    console.error("‚ùå Error updating platform statistics:", error);
    resetPlatformStats();
  }
}

function resetPlatformStats() {
  document.getElementById('propertyTypes').textContent = '0';
  document.getElementById('uniqueLocations').textContent = '0';
  document.getElementById('averagePrice').textContent = '‚Ç±0';
  document.getElementById('recentActivity').textContent = '0';
}

// Update recent properties display
function updateRecentProperties() {
  try {
    const recentProperties = allProperties
      .sort((a, b) => {
        const dateA = getDateFromFirestore(a.createdAt || a.dateAdded || a.timestamp);
        const dateB = getDateFromFirestore(b.createdAt || b.dateAdded || b.timestamp);
        return dateB - dateA;
      })
      .slice(0, 5);
    
    displayRecentProperties(recentProperties);
    
  } catch (error) {
    console.error("‚ùå Error updating recent properties:", error);
    displayRecentPropertiesError();
  }
}

// Display recent properties
function displayRecentProperties(properties) {
  const container = document.getElementById('recentProperties');
  
  if (properties.length === 0) {
    container.innerHTML = `
      <div class="activity-item" onclick="window.location.href='admin_properties.html'">
        <div class="activity-content">
          <div class="activity-main">
            <span class="activity-action">No properties found</span>
            <span class="activity-status pending">EMPTY</span>
          </div>
          <div class="activity-details">
            No properties have been added yet
          </div>
        </div>
        <span class="activity-time">No data</span>
      </div>
    `;
    return;
  }

  container.innerHTML = properties.map(prop => {
    const propName = prop.title || prop.propertyName || `Property ${prop.id.substring(0, 8)}`;
    const location = prop.location || prop.city || prop.address || 'Location not specified';
    const price = prop.price ? `‚Ç±${parseInt(prop.price).toLocaleString()}` : 
                 prop.pricePerMonth ? `‚Ç±${parseInt(prop.pricePerMonth).toLocaleString()}/month` : 
                 'Price not set';
    
    // Determine status
    let status = 'pending';
    let statusText = 'PENDING';
    
    if (prop.status === 'sold' || prop.sold) {
      status = 'success';
      statusText = 'SOLD';
    } else if (prop.status === 'active' || prop.status === 'available') {
      status = 'approved';
      statusText = 'ACTIVE';
    } else if (prop.status === 'rented') {
      status = 'pending';
      statusText = 'RENTED';
    }
    
    // Format date with actual time
    const propDate = getDateFromFirestore(prop.createdAt || prop.dateAdded || prop.timestamp);
    const timeAgo = formatDateTime(propDate);
    
    return `
      <div class="activity-item" onclick="window.location.href='admin_properties.html#property-${prop.id}'">
        <div class="activity-content">
          <div class="activity-main">
            <span class="activity-action">${propName}</span>
            <span class="activity-status ${status}">${statusText}</span>
          </div>
          <div class="activity-details">
            ${location} ‚Ä¢ ${price} ‚Ä¢ ${prop.propertyType || prop.type || 'Property'}
          </div>
        </div>
        <span class="activity-time">${timeAgo}</span>
      </div>
    `;
  }).join('');
}

function displayRecentPropertiesError() {
  const container = document.getElementById('recentProperties');
  container.innerHTML = `
    <div class="activity-item" onclick="loadDashboardData()">
      <div class="activity-content">
        <div class="activity-main">
          <span class="activity-action">Error loading properties</span>
          <span class="activity-status pending">ERROR</span>
        </div>
        <div class="activity-details">
          Click to retry loading properties
        </div>
      </div>
      <span class="activity-time">Just now</span>
    </div>
  `;
}

// Update notifications
function updateNotifications() {
  try {
    // Generate accurate notifications from current data
    const newNotifications = generateAccurateNotifications();
    
    // Combine with existing notifications
    allNotifications = [...newNotifications, ...allNotifications];
    
    // Sort by time (newest first) and remove duplicates
    const uniqueIds = new Set();
    allNotifications = allNotifications
      .filter(notification => {
        if (uniqueIds.has(notification.id)) {
          return false;
        }
        uniqueIds.add(notification.id);
        return true;
      })
      .sort((a, b) => new Date(b.time) - new Date(a.time));
    
    // Limit to 50 notifications
    if (allNotifications.length > 50) {
      allNotifications = allNotifications.slice(0, 50);
    }
    
    // Update notification badge
    updateNotificationBadge();
    
    // Display notifications if panel is open
    if (document.getElementById('notificationPanel').classList.contains('show')) {
      displayNotifications(allNotifications);
    }
    
  } catch (error) {
    console.error("‚ùå Error updating notifications:", error);
  }
}

// Generate accurate notifications with real timestamps
function generateAccurateNotifications() {
  const notifications = [];
  
  // Get recent users (last 7 days) with actual timestamps
  const weekAgo = new Date();
  weekAgo.setDate(weekAgo.getDate() - 7);
  
  const recentUsers = allUsers.filter(user => {
    const userDate = getDateFromFirestore(user.createdAt);
    return userDate > weekAgo;
  }).slice(0, 10); // Get up to 10 recent users
  
  // Get recent properties (last 7 days) with actual timestamps
  const recentProperties = allProperties.filter(prop => {
    const propDate = getDateFromFirestore(prop.createdAt);
    return propDate > weekAgo;
  }).slice(0, 10); // Get up to 10 recent properties
  
  // Add user notifications with accurate dates
  recentUsers.forEach(user => {
    const userDate = getDateFromFirestore(user.createdAt) || new Date();
    notifications.push({
      id: `user_${user.id}_${userDate.getTime()}`,
      type: 'new-user',
      title: 'New User Registered',
      description: `${user.name || user.email || 'New user'} joined the platform`,
      time: userDate,
      relatedId: user.id,
      unread: true
    });
  });
  
  // Add property notifications with accurate dates
  recentProperties.forEach(prop => {
    const propDate = getDateFromFirestore(prop.createdAt) || new Date();
    notifications.push({
      id: `property_${prop.id}_${propDate.getTime()}`,
      type: 'new-property',
      title: 'New Property Added',
      description: `${prop.title || 'New property'} (${prop.propertyType || 'Property'})`,
      time: propDate,
      relatedId: prop.id,
      unread: true
    });
  });
  
  // Check for recently sold properties
  const soldProperties = allProperties.filter(prop => 
    prop.status === 'sold' || prop.sold
  ).slice(0, 5);
  
  soldProperties.forEach(prop => {
    const soldDate = getDateFromFirestore(prop.updatedAt) || getDateFromFirestore(prop.createdAt) || new Date();
    notifications.push({
      id: `sold_${prop.id}_${soldDate.getTime()}`,
      type: 'property-sold',
      title: 'Property Sold',
      description: `${prop.title || 'Property'} has been sold`,
      time: soldDate,
      relatedId: prop.id,
      unread: true
    });
  });
  
  // Sort by time (newest first)
  return notifications.sort((a, b) => new Date(b.time) - new Date(a.time));
}

// Add notification
function addNotification(notification) {
  // Add to beginning of array (newest first)
  allNotifications.unshift(notification);
  
  // Sort again to ensure proper order (newest first)
  allNotifications.sort((a, b) => new Date(b.time) - new Date(a.time));
  
  // Remove duplicates
  const uniqueIds = new Set();
  allNotifications = allNotifications.filter(notification => {
    if (uniqueIds.has(notification.id)) {
      return false;
    }
    uniqueIds.add(notification.id);
    return true;
  });
  
  // Limit to 50 notifications
  if (allNotifications.length > 50) {
    allNotifications = allNotifications.slice(0, 50);
  }
  
  // Update notification badge
  updateNotificationBadge();
  
  // Update notification panel if it's open
  if (document.getElementById('notificationPanel').classList.contains('show')) {
    displayNotifications(allNotifications);
  }
  
  // Show toast for important notifications
  showToast(notification.description, 'info', 2000);
}

// Update notification badge
function updateNotificationBadge() {
  const unreadCount = allNotifications.filter(n => n.unread).length;
  const badgeElement = document.getElementById('notificationCount');
  
  if (badgeElement) {
    badgeElement.textContent = unreadCount;
    
    // Hide badge if zero
    if (unreadCount === 0) {
      badgeElement.style.display = 'none';
    } else {
      badgeElement.style.display = 'flex';
    }
  }
}

// Display notifications in panel with accurate dates
function displayNotifications(notifications) {
  const container = document.getElementById('notificationList');
  
  // Ensure notifications are sorted by time (newest first)
  const sortedNotifications = [...notifications].sort((a, b) => {
    const timeA = new Date(a.time);
    const timeB = new Date(b.time);
    return timeB - timeA; // Newest first
  });
  
  if (sortedNotifications.length === 0) {
    container.innerHTML = `
      <div class="notification-item">
        <div class="notification-content">
          <div class="notification-title">No notifications</div>
          <div class="notification-desc">You're all caught up!</div>
          <div class="notification-time">No recent activity</div>
        </div>
      </div>
    `;
    return;
  }
  
  container.innerHTML = sortedNotifications.map(notif => {
    const formattedTime = formatDateTime(new Date(notif.time));
    const iconClass = notif.type === 'new-user' ? 'new-user' : 
                     notif.type === 'property-sold' ? 'property-sold' : 
                     notif.type === 'new-property' ? 'new-property' : 'property-updated';
    
    const iconSymbol = notif.type === 'new-user' ? '<i class="fas fa-user-plus"></i>' :
                      notif.type === 'property-sold' ? '<i class="fas fa-tag"></i>' :
                      notif.type === 'new-property' ? '<i class="fas fa-home"></i>' : 
                      '<i class="fas fa-edit"></i>';
    
    return `
      <div class="notification-item ${notif.unread ? 'unread' : ''}" 
           data-id="${notif.id}"
           onclick="handleNotificationClick('${notif.type}', '${notif.relatedId || ''}')">
        <div class="notification-icon ${iconClass}">${iconSymbol}</div>
        <div class="notification-content">
          <div class="notification-title">${notif.title}</div>
          <div class="notification-desc">${notif.description}</div>
          <div class="notification-time">${formattedTime}</div>
        </div>
      </div>
    `;
  }).join('');
}

// Helper: Get date from Firestore timestamp
function getDateFromFirestore(timestamp) {
  if (!timestamp) return new Date();
  
  if (timestamp.toDate && typeof timestamp.toDate === 'function') {
    return timestamp.toDate();
  }
  
  if (timestamp.seconds) {
    return new Date(timestamp.seconds * 1000);
  }
  
  if (timestamp instanceof Date) {
    return timestamp;
  }
  
  if (typeof timestamp === 'string') {
    return new Date(timestamp);
  }
  
  if (typeof timestamp === 'number') {
    return new Date(timestamp);
  }
  
  return new Date();
}

// Helper: Format date and time properly
function formatDateTime(date) {
  if (!date || !(date instanceof Date)) {
    return 'Unknown time';
  }
  
  const now = new Date();
  const diffMs = now - date;
  const diffSec = Math.floor(diffMs / 1000);
  const diffMin = Math.floor(diffSec / 60);
  const diffHour = Math.floor(diffMin / 60);
  const diffDay = Math.floor(diffHour / 24);
  
  // If within 24 hours, show relative time
  if (diffDay === 0) {
    if (diffHour > 0) return `${diffHour} hour${diffHour > 1 ? 's' : ''} ago`;
    if (diffMin > 0) return `${diffMin} minute${diffMin > 1 ? 's' : ''} ago`;
    return 'Just now';
  }
  
  // If within 7 days, show day name
  if (diffDay < 7) {
    return `${diffDay} day${diffDay > 1 ? 's' : ''} ago`;
  }
  
  // Otherwise show full date
  const options = { 
    month: 'short', 
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  };
  
  return date.toLocaleDateString('en-US', options);
}

// UI Functions
function toggleNotifications() {
  const panel = document.getElementById('notificationPanel');
  panel.classList.toggle('show');
  
  // Hide user dropdown if open
  document.getElementById('userDropdown').classList.remove('show');
  
  // Load notifications when opening panel
  if (panel.classList.contains('show')) {
    displayNotifications(allNotifications);
  }
}

function hideNotifications() {
  document.getElementById('notificationPanel').classList.remove('show');
}

function toggleUserDropdown() {
  const dropdown = document.getElementById('userDropdown');
  dropdown.classList.toggle('show');
  
  // Hide notification panel if open
  document.getElementById('notificationPanel').classList.remove('show');
}

function viewProfile() {
  window.location.href = 'admin_settings.html';
  document.getElementById('userDropdown').classList.remove('show');
}

function markAllAsRead() {
  allNotifications.forEach(notification => {
    notification.unread = false;
  });
  
  updateNotificationBadge();
  
  // Update display if panel is open
  if (document.getElementById('notificationPanel').classList.contains('show')) {
    displayNotifications(allNotifications);
  }
  
  showToast('‚úÖ All notifications marked as read', 'success');
}

// Handle notification click
function handleNotificationClick(type, relatedId) {
  // Mark as read
  const notificationElement = event.currentTarget;
  const notificationId = notificationElement.dataset.id;
  
  if (notificationId) {
    const notification = allNotifications.find(n => n.id === notificationId);
    if (notification) {
      notification.unread = false;
      notificationElement.classList.remove('unread');
      updateNotificationBadge();
    }
  }
  
  // Navigate based on type
  if (type === 'new-user' && relatedId) {
    window.location.href = `admin_users.html#user-${relatedId}`;
  } else if ((type === 'new-property' || type === 'property-sold' || type === 'property-updated') && relatedId) {
    window.location.href = `admin_properties.html#property-${relatedId}`;
  }
  
  // Close notification panel on mobile
  if (window.innerWidth <= 768) {
    hideNotifications();
  }
}

function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebarOverlay');
  sidebar.classList.toggle('active');
  if (overlay) {
    overlay.style.display = sidebar.classList.contains('active') ? 'block' : 'none';
  }
}

function logout() {
  if (confirm('‚ö†Ô∏è Are you sure you want to logout?')) {
    localStorage.removeItem('adminLoggedIn');
    localStorage.removeItem('adminEmail');
    localStorage.removeItem('adminName');
    
    showToast('üîí Logging out...', 'info');
    
    setTimeout(() => {
      window.location.href = 'admin_login.html';
    }, 1000);
  }
}

function showHelp() {
  alert('Help & Support\n\nFor assistance, please contact:\n‚Ä¢ Email: support@bahai.com\n‚Ä¢ Phone: +63 123 456 7890\n\nDocumentation is available in the Settings page.');
  document.getElementById('userDropdown').classList.remove('show');
}

// Event Listeners
document.getElementById('mobileMenuToggle').addEventListener('click', toggleSidebar);

// Close dropdowns when clicking outside
document.addEventListener('click', (event) => {
  const userDropdown = document.getElementById('userDropdown');
  const userProfile = document.querySelector('.user-profile');
  const notificationPanel = document.getElementById('notificationPanel');
  const notificationBtn = document.querySelector('.notification-btn');
  const sidebar = document.getElementById('sidebar');
  const mobileToggle = document.getElementById('mobileMenuToggle');
  const sidebarOverlay = document.getElementById('sidebarOverlay');
  
  // Close user dropdown if clicked outside
  if (userDropdown.classList.contains('show') && 
      !userProfile.contains(event.target) && 
      !userDropdown.contains(event.target)) {
    userDropdown.classList.remove('show');
  }
  
  // Close notification panel if clicked outside
  if (notificationPanel.classList.contains('show') && 
      !notificationBtn.contains(event.target) && 
      !notificationPanel.contains(event.target)) {
    notificationPanel.classList.remove('show');
  }
  
  // Close sidebar on mobile when clicking outside
  if (window.innerWidth <= 1024 && 
      sidebar.classList.contains('active') && 
      !sidebar.contains(event.target) && 
      !mobileToggle.contains(event.target) &&
      !event.target.classList.contains('sidebar-link') &&
      sidebarOverlay && event.target === sidebarOverlay) {
    sidebar.classList.remove('active');
    sidebarOverlay.style.display = 'none';
  }
});

// Initialize the dashboard when page loads
document.addEventListener('DOMContentLoaded', () => {
  console.log('üöÄ Admin Dashboard Initializing...');
  
  // Check authentication first
  if (!checkAuth()) {
    return;
  }
  
  // Initialize Firebase and load data
  initializeFirebase();
  
  // Set refresh button functionality
  const refreshButton = document.querySelector('.card-header button');
  if (refreshButton) {
    refreshButton.addEventListener('click', (e) => {
      e.stopPropagation();
      loadDashboardData();
    });
  }
  
  console.log('‚úÖ Admin Dashboard Ready');
});

// Make functions available globally
window.toggleNotifications = toggleNotifications;
window.hideNotifications = hideNotifications;
window.toggleUserDropdown = toggleUserDropdown;
window.markAllAsRead = markAllAsRead;
window.toggleSidebar = toggleSidebar;
window.logout = logout;
window.showHelp = showHelp;
window.loadDashboardData = loadDashboardData;
window.handleNotificationClick = handleNotificationClick;
window.viewProfile = viewProfile;
</script>
</body>
</html>