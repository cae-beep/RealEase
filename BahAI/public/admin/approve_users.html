<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Approve Users - Admin Panel</title>
<style>
body {
font-family: "Segoe UI", Arial, sans-serif;
background-color: #f4f6f8;
margin: 0;
display: flex;
flex-direction: column;
}
header {
background-color: #3f51b5;
color: white;
padding: 15px;
text-align: center;
font-size: 22px;
font-weight: 600;
letter-spacing: 0.5px;
}
.container {
display: flex;
}
nav {
width: 250px;
background-color: #263238;
color: white;
height: 100vh;
padding-top: 20px;
position: sticky;
top: 0;
}
nav a {
display: block;
color: white;
padding: 12px 20px;
text-decoration: none;
font-size: 16px;
transition: 0.2s;
}
nav a:hover {
background-color: #455a64;
}
nav a.active {
background-color: #3f51b5;
font-weight: bold;
}
main {
flex: 1;
padding: 20px;
overflow-y: auto;
}
.tabs {
display: flex;
justify-content: center;
gap: 15px;
margin-bottom: 25px;
flex-wrap: wrap;
}
.tab {
background-color: #e0e0e0;
border: none;
border-radius: 6px;
padding: 8px 18px;
cursor: pointer;
font-size: 15px;
transition: all 0.2s ease;
}
.tab.active {
background-color: #3f51b5;
color: white;
box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
.user-card {
background: white;
border-radius: 10px;
box-shadow: 0 2px 10px rgba(0,0,0,0.1);
margin-bottom: 20px;
padding: 20px;
transition: all 0.3s ease;
}
.user-card:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.user-header {
display: flex;
justify-content: space-between;
align-items: center;
flex-wrap: wrap;
margin-bottom: 12px;
}
.user-header h3 {
margin: 0;
color: #3f51b5;
font-size: 18px;
}
.user-info {
background: #f5f5f5;
padding: 15px;
border-radius: 8px;
margin: 15px 0;
}
.user-info p {
margin: 8px 0;
}
.confidence-score {
display: inline-block;
padding: 8px 16px;
border-radius: 20px;
font-weight: bold;
margin: 10px 0;
}
.confidence-high {
background-color: #4caf50;
color: white;
}
.confidence-medium {
background-color: #ff9800;
color: white;
}
.confidence-low {
background-color: #f44336;
color: white;
}
.rejection-reason {
background-color: #ffebee;
border-left: 4px solid #f44336;
padding: 12px;
margin: 10px 0;
border-radius: 4px;
}
.kyc-images {
display: flex;
gap: 15px;
flex-wrap: wrap;
margin: 15px 0;
}
.kyc-image-container {
text-align: center;
}
.kyc-image-container p {
margin: 5px 0;
font-weight: bold;
color: #555;
}
.kyc-images img {
width: 200px;
height: 150px;
object-fit: cover;
border-radius: 6px;
border: 2px solid #ddd;
cursor: pointer;
transition: 0.2s;
}
.kyc-images img:hover {
transform: scale(1.05);
border-color: #3f51b5;
}
.buttons {
margin-top: 15px;
display: flex;
gap: 10px;
flex-wrap: wrap;
}
.approve-btn, .reject-btn, .reset-btn {
padding: 10px 16px;
border: none;
border-radius: 6px;
cursor: pointer;
color: white;
font-size: 14px;
font-weight: 600;
transition: 0.2s;
}
.approve-btn {
background-color: #4CAF50;
}
.approve-btn:hover {
background-color: #388E3C;
}
.reject-btn {
background-color: #f44336;
}
.reject-btn:hover {
background-color: #d32f2f;
}
.reset-btn {
background-color: #2196F3;
}
.reset-btn:hover {
background-color: #1976D2;
}
.status-label {
padding: 6px 12px;
border-radius: 5px;
font-weight: bold;
font-size: 13px;
}
.pending {
background-color: #ff9800;
color: white;
}
.approved {
background-color: #4caf50;
color: white;
}
.rejected {
background-color: #f44336;
color: white;
}
.not_submitted {
background-color: #9e9e9e;
color: white;
}
#modal {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0,0,0,0.8);
justify-content: center;
align-items: center;
z-index: 1000;
}
#modal img {
max-width: 90%;
max-height: 90%;
border-radius: 10px;
box-shadow: 0 0 20px rgba(0,0,0,0.5);
}
.modal-close {
position: absolute;
top: 20px;
right: 40px;
font-size: 40px;
color: white;
cursor: pointer;
}
.stats-bar {
display: flex;
gap: 20px;
justify-content: center;
margin-bottom: 20px;
flex-wrap: wrap;
}
.stat-card {
background: white;
padding: 15px 25px;
border-radius: 8px;
box-shadow: 0 2px 5px rgba(0,0,0,0.1);
text-align: center;
min-width: 120px;
}
.stat-number {
font-size: 32px;
font-weight: bold;
color: #3f51b5;
}
.stat-label {
font-size: 14px;
color: #666;
margin-top: 5px;
}
</style>
</head>
<body>
<header>üë§ Approve Users - Admin Panel</header>
<div class="container">
<nav>
<a href="admin_home.html">üè† Dashboard</a>
<a href="#">‚ûï Add User</a>
<a href="approve_users.html" class="active">üë§ Approve Users</a>
<a href="approve_listings.html">‚≠ê Approve Listings</a>
<a href="#">üë• Manage Users</a>
<a href="#">üìä Reports</a>
<a href="#">üìú Audit Log</a>
<a href="#">üè† Buyer Listings</a>
<a href="#">üè¢ Seller Listings</a>
<a href="#" id="logoutBtn">üö™ Logout</a>
</nav>

<main>
<div class="stats-bar">
<div class="stat-card">
<div class="stat-number" id="pendingCount">0</div>
<div class="stat-label">Pending</div>
</div>
<div class="stat-card">
<div class="stat-number" id="approvedCount">0</div>
<div class="stat-label">Approved</div>
</div>
<div class="stat-card">
<div class="stat-number" id="rejectedCount">0</div>
<div class="stat-label">Rejected</div>
</div>
</div>

<div class="tabs">
<button id="pendingTab" class="tab active">Pending</button>
<button id="approvedTab" class="tab">Approved</button>
<button id="rejectedTab" class="tab">Rejected</button>
<button id="notSubmittedTab" class="tab">Not Submitted</button>
</div>
<div id="usersList"></div>
</main>
</div>

<div id="modal">
<span class="modal-close">&times;</span>
<img id="modalImg" src="" alt="Zoomed Image">
</div>

<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
(function() {
emailjs.init("bVvu68ObSuhdkBNzj");
})();
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import {
getFirestore, collection, onSnapshot, query, where, updateDoc, doc, getDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyCIfzneDzWVveG8p_0mywoA9D9F5AyzZX4",
authDomain: "bahai-1b76d.firebaseapp.com",
projectId: "bahai-1b76d",
storageBucket: "bahai-1b76d.appspot.com",
messagingSenderId: "646878644941",
appId: "1:646878644941:web:5b4ccc3412250337587784"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const usersList = document.getElementById("usersList");
const tabs = {
pending: document.getElementById("pendingTab"),
approved: document.getElementById("approvedTab"),
rejected: document.getElementById("rejectedTab"),
not_submitted: document.getElementById("notSubmittedTab"),
};

let currentStatus = "pending";
let userCounts = {pending: 0, approved: 0, rejected: 0, not_submitted: 0};

// Update stats
function updateStats() {
document.getElementById("pendingCount").textContent = userCounts.pending;
document.getElementById("approvedCount").textContent = userCounts.approved;
document.getElementById("rejectedCount").textContent = userCounts.rejected;
}

// Load user counts
function loadUserCounts() {
["pending", "approved", "rejected", "not_submitted"].forEach(status => {
const q = query(collection(db, "users"), where("kycStatus", "==", status));
onSnapshot(q, (snapshot) => {
userCounts[status] = snapshot.size;
updateStats();
});
});
}

function getConfidenceClass(confidence) {
if (confidence >= 65) return "confidence-high";
if (confidence >= 40) return "confidence-medium";
return "confidence-low";
}

function loadUsers(status) {
usersList.innerHTML = "<p>Loading users...</p>";
const q = query(collection(db, "users"), where("kycStatus", "==", status));
onSnapshot(q, (snapshot) => {
if (snapshot.empty) {
usersList.innerHTML = `<p>No ${status} users found.</p>`;
return;
}
usersList.innerHTML = "";
snapshot.forEach((docSnap) => {
const data = docSnap.data();
const card = document.createElement("div");
card.classList.add("user-card");

// Get KYC document URLs
const kycDocs = data.kycDocuments || {};
const verificationDetails = data.kycVerificationDetails || {};
const confidence = verificationDetails.faceMatchConfidence;

card.innerHTML = `
<div class="user-header">
<h3>${data.fullName || "Unnamed User"}</h3>
<span class="status-label ${status}">${status.toUpperCase().replace('_', ' ')}</span>
</div>

<div class="user-info">
<p><strong>üìß Email:</strong> ${data.email || "No email"}</p>
<p><strong>üì± Phone:</strong> ${data.phone || "N/A"}</p>
<p><strong>üë§ Role:</strong> ${data.role || "N/A"}</p>
<p><strong>üìÖ Submitted:</strong> ${data.kycVerificationDate ? new Date(data.kycVerificationDate.seconds * 1000).toLocaleString() : "N/A"}</p>
${confidence ? `
<p><strong>ü§ñ AI Confidence Score:</strong>
<span class="confidence-score ${getConfidenceClass(confidence)}">
${confidence.toFixed(2)}%
</span>
${confidence >= 65 ? "‚úÖ High Match" : confidence >= 40 ? "‚ö†Ô∏è Medium Match" : "‚ùå Low Match"}
</p>
` : ""}
${data.kycRejectionReason ? `
<div class="rejection-reason">
<strong>‚ùå Rejection Reason:</strong><br>
${data.kycRejectionReason}
</div>
` : ""}
</div>

${kycDocs.governmentId || kycDocs.selfieWithId ? `
<div class="kyc-images">
${kycDocs.governmentId ? `
<div class="kyc-image-container">
<p>üÜî Government ID</p>
<img src="${kycDocs.governmentId}" alt="Government ID" data-url="${kycDocs.governmentId}">
</div>
` : ""}
${kycDocs.governmentIdBack ? `
<div class="kyc-image-container">
<p>üÜî ID Back</p>
<img src="${kycDocs.governmentIdBack}" alt="ID Back" data-url="${kycDocs.governmentIdBack}">
</div>
` : ""}
${kycDocs.selfieWithId ? `
<div class="kyc-image-container">
<p>ü§≥ Selfie with ID</p>
<img src="${kycDocs.selfieWithId}" alt="Selfie" data-url="${kycDocs.selfieWithId}">
</div>
` : ""}
${kycDocs.prcDocument ? `
<div class="kyc-image-container">
<p>üìú PRC License</p>
<img src="${kycDocs.prcDocument}" alt="PRC Document" data-url="${kycDocs.prcDocument}">
</div>
` : ""}
</div>
` : "<p><em>No KYC documents uploaded yet.</em></p>"}

<div class="buttons">
${status === "pending" || status === "rejected" ? `
<button class="approve-btn" data-id="${docSnap.id}">‚úÖ Approve</button>
<button class="reject-btn" data-id="${docSnap.id}">‚ùå Reject</button>
` : ""}
${status === "approved" ? `
<button class="reject-btn" data-id="${docSnap.id}">‚ùå Revoke Approval</button>
` : ""}
${status === "rejected" || status === "approved" ? `
<button class="reset-btn" data-id="${docSnap.id}">üîÑ Reset KYC</button>
` : ""}
</div>
`;
usersList.appendChild(card);
});

// Add event listeners
document.querySelectorAll(".approve-btn").forEach((btn) =>
btn.addEventListener("click", () => updateKYCStatus(btn.dataset.id, "approved"))
);
document.querySelectorAll(".reject-btn").forEach((btn) =>
btn.addEventListener("click", () => updateKYCStatus(btn.dataset.id, "rejected"))
);
document.querySelectorAll(".reset-btn").forEach((btn) =>
btn.addEventListener("click", () => resetKYC(btn.dataset.id))
);
document.querySelectorAll(".kyc-images img").forEach((img) =>
img.addEventListener("click", () => showModal(img.dataset.url))
);
});
}

async function updateKYCStatus(uid, status) {
const reason = status === "rejected" ? prompt("Enter rejection reason:") : null;
if (status === "rejected" && !reason) return;

const userRef = doc(db, "users", uid);
const userSnap = await getDoc(userRef);

if (!userSnap.exists()) {
alert("‚ùå User not found!");
return;
}

const userData = userSnap.data();
const updateData = {
kycStatus: status,
kycVerificationDate: serverTimestamp()
};

if (status === "rejected" && reason) {
updateData.kycRejectionReason = reason;
} else if (status === "approved") {
updateData.kycRejectionReason = null;
}

await updateDoc(userRef, updateData);
alert(`‚úÖ User marked as ${status}!`);

// Send email notification
const templateParams = {
name: userData.fullName,
email: userData.email,
status: status.toUpperCase(),
statusColor: status === "approved" ? "#28a745" : "#dc3545",
message: status === "approved"
? "Congratulations! Your KYC verification has been approved by our admin team. You can now access all features."
: `Your KYC verification was rejected. Reason: ${reason}. Please resubmit with valid documents.`,
};

emailjs
.send("service_flz1q7c", "template_7lbi9sg", templateParams)
.then(() => alert(`üìß Email sent to ${userData.email}`))
.catch((error) => {
console.error("EmailJS error:", error);
alert("‚ö†Ô∏è Status updated but email failed to send.");
});
}

async function resetKYC(uid) {
if (!confirm("Reset this user's KYC status? They will need to resubmit documents.")) return;

const userRef = doc(db, "users", uid);
await updateDoc(userRef, {
kycStatus: "not_submitted",
kycRejectionReason: null,
kycVerificationDate: null,
kycVerificationDetails: null,
});

alert("üîÑ KYC status reset. User can now resubmit.");
}

// Tab switching
Object.entries(tabs).forEach(([status, btn]) => {
btn.addEventListener("click", () => {
Object.values(tabs).forEach(b => b.classList.remove("active"));
btn.classList.add("active");
currentStatus = status;
loadUsers(status);
});
});

// Auth check
onAuthStateChanged(auth, (user) => {
if (!user) {
window.location.href = "admin_login.html";
} else {
loadUsers("pending");
loadUserCounts();
}
});

// Logout
document.getElementById("logoutBtn").addEventListener("click", async () => {
await signOut(auth);
window.location.href = "admin_login.html";
});

// Modal for image zoom
const modal = document.getElementById("modal");
const modalImg = document.getElementById("modalImg");
const modalClose = document.querySelector(".modal-close");

function showModal(src) {
modalImg.src = src;
modal.style.display = "flex";
}

modal.addEventListener("click", (e) => {
if (e.target === modal || e.target === modalClose) {
modal.style.display = "none";
}
});
</script>
</body>
</html>