<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Reports & Analytics - BahAI Real Estate Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* Updated CSS to match dashboard UI */
:root {
  --primary: #0b2e52;
  --primary-dark: #001F3F;
  --primary-light: #1976d2;
  --secondary: #3b82f6;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --info: #0ea5e9;
  --text-dark: #1a202c;
  --text-light: #718096;
  --bg-light: #f8fafc;
  --bg-white: #ffffff;
  --border: #e2e8f0;
  --shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.1);
  --sidebar-width: 260px;
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', Arial, sans-serif;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  color: var(--text-dark);
  display: flex;
  min-height: 100vh;
  overflow-x: hidden;
}

/* ==================== IMPROVED SIDEBAR STYLES ==================== */
.sidebar {
  width: var(--sidebar-width);
  height: 100vh;
  background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
  position: fixed;
  left: 0;
  top: 0;
  padding: 25px 0;
  box-shadow: 4px 0 20px rgba(0, 0, 0, 0.15);
  overflow-y: auto;
  z-index: 1000;
  transition: var(--transition);
  display: flex;
  flex-direction: column;
}

.sidebar-header {
  padding: 0 25px 30px;
  margin-bottom: 20px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.logo {
  display: flex;
  align-items: center;
  gap: 14px;
  color: white;
  text-decoration: none;
  transition: var(--transition);
  padding: 10px;
  border-radius: 12px;
}

.logo:hover {
  background: rgba(255, 255, 255, 0.1);
  transform: translateY(-2px);
}

.logo-icon {
  width: 48px;
  height: 48px;
  background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 20px;
  color: var(--primary);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  transition: var(--transition);
}

.logo:hover .logo-icon {
  transform: scale(1.05);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
}

.logo-text {
  display: flex;
  flex-direction: column;
  flex: 1;
}

.logo-title {
  font-size: 22px;
  font-weight: 800;
  line-height: 1.1;
  margin-bottom: 4px;
  letter-spacing: -0.3px;
  background: linear-gradient(135deg, #ffffff 0%, #e6f3ff 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.logo-subtitle {
  font-size: 11px;
  opacity: 0.9;
  color: rgba(255, 255, 255, 0.8);
  font-weight: 500;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}

/* Navigation */
.sidebar-nav {
  list-style: none;
  padding: 0;
  flex: 1;
}

.sidebar-nav li {
  margin: 5px 15px;
}

.sidebar-link {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 16px 20px;
  color: rgba(255, 255, 255, 0.85);
  text-decoration: none;
  transition: var(--transition);
  font-weight: 500;
  font-size: 15px;
  border-radius: 12px;
  position: relative;
  overflow: hidden;
}

.sidebar-link::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  height: 100%;
  width: 4px;
  background: white;
  transform: translateX(-10px);
  transition: var(--transition);
  border-radius: 0 4px 4px 0;
}

.sidebar-link:hover {
  background: rgba(255, 255, 255, 0.12);
  color: white;
  transform: translateX(5px);
}

.sidebar-link:hover::before {
  transform: translateX(0);
}

.sidebar-link.active {
  background: rgba(255, 255, 255, 0.18);
  color: white;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.sidebar-link.active::before {
  transform: translateX(0);
  background: linear-gradient(135deg, #ffffff 0%, #3b82f6 100%);
  box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
}

.sidebar-icon {
  width: 22px;
  height: 22px;
  display: inline-block;
  font-size: 18px;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
}

.sidebar-link:hover .sidebar-icon {
  transform: scale(1.1);
}

.sidebar-link.active .sidebar-icon {
  transform: scale(1.1);
}

/* Sidebar footer */
.sidebar-footer {
  padding: 20px 25px 0;
  margin-top: 20px;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  font-size: 12px;
  color: rgba(255, 255, 255, 0.6);
  text-align: center;
}

.sidebar-footer a {
  color: rgba(255, 255, 255, 0.8);
  text-decoration: none;
  transition: var(--transition);
}

.sidebar-footer a:hover {
  color: white;
  text-decoration: underline;
}

/* Main container */
.container {
  flex: 1;
  margin-left: var(--sidebar-width);
  padding: 30px;
  transition: var(--transition);
  width: calc(100% - var(--sidebar-width));
}

.dashboard-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  flex-wrap: wrap;
  gap: 20px;
}

.header-left h1 {
  font-size: 32px;
  font-weight: 800;
  color: var(--text-dark);
  margin-bottom: 10px;
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: -0.5px;
}

.header-left p {
  color: var(--text-light);
  font-size: 16px;
  max-width: 600px;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 15px;
  flex-wrap: wrap;
}

.notification-btn {
  position: relative;
  width: 50px;
  height: 50px;
  background: white;
  border: none;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: var(--shadow);
  transition: var(--transition);
  color: var(--text-dark);
  flex-shrink: 0;
}

.notification-btn:hover {
  background: var(--secondary);
  color: white;
  transform: translateY(-3px) scale(1.05);
  box-shadow: 0 6px 16px rgba(59, 130, 246, 0.3);
}

.notification-badge {
  position: absolute;
  top: -6px;
  right: -6px;
  background: linear-gradient(135deg, var(--danger), #dc2626);
  color: white;
  border-radius: 50%;
  width: 22px;
  height: 22px;
  font-size: 12px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid white;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
}

.user-profile {
  position: relative;
  display: flex;
  align-items: center;
  gap: 12px;
  background: white;
  padding: 12px 20px;
  border-radius: 12px;
  box-shadow: var(--shadow);
  cursor: pointer;
  transition: var(--transition);
  min-width: 200px;
  flex-shrink: 0;
}

.user-profile:hover {
  background: linear-gradient(135deg, #f8fafc, #e9ecef);
  transform: translateY(-3px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
}

.user-avatar {
  width: 44px;
  height: 44px;
  border-radius: 12px;
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 700;
  font-size: 18px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  flex-shrink: 0;
}

.user-info {
  display: flex;
  flex-direction: column;
  flex: 1;
  min-width: 0;
}

.user-name {
  font-weight: 700;
  color: var(--text-dark);
  font-size: 14px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.user-role {
  font-size: 12px;
  color: var(--text-light);
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.user-profile i {
  color: var(--text-light);
  transition: var(--transition);
  flex-shrink: 0;
}

.user-profile:hover i {
  color: var(--primary);
}

/* Period Selector - Updated to match dashboard */
.period-selector {
  display: flex;
  gap: 8px;
  background: white;
  padding: 8px;
  border-radius: 14px;
  box-shadow: var(--shadow);
  flex-wrap: wrap;
  overflow-x: auto;
}

.period-btn {
  padding: 10px 20px;
  border: none;
  background: transparent;
  color: var(--text-light);
  font-weight: 600;
  font-size: 14px;
  border-radius: 10px;
  cursor: pointer;
  transition: var(--transition);
  white-space: nowrap;
  flex-shrink: 0;
}

.period-btn.active {
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  color: white;
  box-shadow: 0 4px 12px rgba(11, 46, 82, 0.2);
}

.period-btn:hover:not(.active) {
  background: var(--bg-light);
  color: var(--primary);
}

/* User Dropdown Menu */
.user-dropdown {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 10px;
  background: white;
  border-radius: 14px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
  min-width: 220px;
  z-index: 1000;
  display: none;
  overflow: hidden;
  border: 1px solid var(--border);
  animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.user-dropdown.show {
  display: block;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.dropdown-item {
  padding: 16px 20px;
  display: flex;
  align-items: center;
  gap: 12px;
  color: var(--text-dark);
  text-decoration: none;
  transition: var(--transition);
  border-bottom: 1px solid var(--border);
  font-weight: 500;
}

.dropdown-item:last-child {
  border-bottom: none;
}

.dropdown-item:hover {
  background: linear-gradient(135deg, #f8fafc, #e9ecef);
  color: var(--primary);
  padding-left: 25px;
}

.dropdown-item i {
  width: 20px;
  color: var(--text-light);
  font-size: 16px;
}

.dropdown-item:hover i {
  color: var(--primary);
}

.dropdown-item.logout {
  color: var(--danger);
}

.dropdown-item.logout:hover {
  background: linear-gradient(135deg, #fee2e2, #fecaca);
  color: #991b1b;
}

.dropdown-item.logout i {
  color: var(--danger);
}

/* Analytics Grid - Updated to match dashboard cards */
.analytics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 24px;
  margin-bottom: 35px;
}

.analytics-card {
  background: white;
  padding: 25px;
  border-radius: 18px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}

.analytics-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--primary), var(--primary-light));
}

.analytics-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
}

.analytics-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.analytics-title {
  font-size: 15px;
  color: var(--text-light);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.analytics-icon {
  width: 50px;
  height: 50px;
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  flex-shrink: 0;
}

.analytics-icon.blue {
  background: linear-gradient(135deg, var(--secondary), #2563eb);
  color: white;
}

.analytics-icon.green {
  background: linear-gradient(135deg, var(--success), #059669);
  color: white;
}

.analytics-icon.orange {
  background: linear-gradient(135deg, var(--warning), #d97706);
  color: white;
}

.analytics-icon.purple {
  background: linear-gradient(135deg, #8b5cf6, #7c3aed);
  color: white;
}

.analytics-value {
  font-size: 38px;
  font-weight: 800;
  color: var(--primary);
  margin-bottom: 10px;
  line-height: 1;
  word-break: break-word;
}

/* Add this to your existing CSS in the appropriate section */

/* Chart Body - Adjusted to ensure proper layout */
.chart-body {
  flex: 1;
  min-height: 220px;
  position: relative;
  margin-bottom: 10px;
  display: flex;
  flex-direction: column;
}

/* Pie Chart Container - Fixed to not overlap */
.pie-chart-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 12px;
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid var(--border);
  flex-shrink: 0;
  max-height: 150px;
  overflow-y: auto;
  overflow-x: hidden;
  padding-right: 5px;
  position: relative;
  z-index: 1;
}

/* Make sure chart canvas doesn't overflow */
#typeChart, #statusChart {
  max-height: 220px !important;
  width: 100% !important;
}

/* For the charts grid layout */
.charts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(550px, 1fr));
  gap: 28px;
  margin-bottom: 40px; /* Reduced from 60px to create more space */
}

/* Ensure data table has enough top margin */
.data-table {
  background: white;
  border-radius: 18px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  overflow: hidden;
  margin-bottom: 30px;
  transition: var(--transition);
  margin-top: 30px; /* Add explicit top margin */
  position: relative;
  z-index: 2;
}

.analytics-change {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  font-weight: 600;
  flex-wrap: wrap;
}

.analytics-change.positive {
  color: var(--success);
}

.analytics-change.positive::before {
  content: 'â†‘';
}

.analytics-change.negative {
  color: var(--danger);
}

.analytics-change.negative::before {
  content: 'â†“';
}

/* Charts Grid - Updated */
.charts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(550px, 1fr));
  gap: 28px;
  margin-bottom: 60px;
}

/* Chart card - increased height */
.chart-card {
  background: white;
  border-radius: 18px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  padding: 20px;
  height: 480px; /* Increased from 420px to 480px */
  display: flex;
  flex-direction: column;
  transition: var(--transition);
  overflow: hidden;
}

/* Chart header - keep as is */
.chart-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  flex-shrink: 0;
}

/* Chart body - increased height to fill the larger box */
.chart-body {
  flex: 1;
  min-height: 320px; /* Increased from previous */
  position: relative;
  margin-bottom: 10px;
  display: flex;
  flex-direction: column;
}

/* Pie chart container - position at bottom of larger box */
.pie-chart-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 12px;
  margin-top: auto; /* Push to bottom of flex container */
  padding-top: 15px;
  border-top: 1px solid var(--border);
  flex-shrink: 0;
  max-height: 150px;
  overflow-y: auto;
  overflow-x: hidden;
  padding-right: 5px;
  position: relative;
  z-index: 1;
}

/* Chart canvas - keep same size, centered in larger space */
canvas {
  max-height: 260px !important;
  width: 100% !important;
  margin: 0 auto;
}

/* For many items layout */
.pie-chart-container.many-items .pie-item {
  padding: 8px 12px;
  min-height: auto;
}

.pie-chart-container.many-items .pie-item-value {
  margin: 0 8px;
  font-size: 16px;
}

.pie-chart-container.many-items .pie-item-percentage {
  font-size: 9px;
  padding: 2px 6px;
}

/* Responsive adjustments */
@media (max-width: 1400px) {
  .charts-grid {
    grid-template-columns: 1fr;
  }
  
  .chart-card {
    height: 480px; /* Keep increased height */
  }
}

@media (max-width: 1024px) {
  .chart-card {
    min-height: 420px;
    height: auto;
  }
  
  .chart-body {
    min-height: 280px;
  }
}

@media (max-width: 768px) {
  .chart-card {
    height: 450px;
  }
  
  .chart-body {
    min-height: 250px;
    height: 250px;
  }
  
  .pie-chart-container {
    max-height: 120px;
  }
}

@media (max-width: 576px) {
  .chart-card {
    padding: 15px;
    height: 420px;
  }
  
  .chart-body {
    min-height: 230px;
  }
}

@media (max-width: 480px) {
  .chart-card {
    padding: 15px;
    height: 380px;
  }
  
  .chart-body {
    min-height: 200px;
  }
}
/* FIXED: Pie Chart Container */
.pie-chart-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 12px;
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid var(--border);
  flex-shrink: 0;
  max-height: 150px;
  overflow-y: auto;
  padding-right: 5px;
}

/* Chart Body - Adjusted to accommodate smaller pie chart containers */
.chart-body {
  flex: 1;
  min-height: 200px;
  position: relative;
  margin-bottom: 10px;
}

/* Pie items - Smaller font sizes for better fit */
.pie-item-label {
  font-weight: 600;
  color: var(--text-dark);
  font-size: 11px;
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: 0.3px;
  line-height: 1.3;
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  padding: 0 5px;
}

.pie-item-value {
  font-size: 20px;
  font-weight: 800;
  color: var(--text-dark);
  margin-bottom: 4px;
  line-height: 1;
}

.pie-item-percentage {
  font-size: 10px;
  color: var(--text-light);
  font-weight: 500;
  background: white;
  padding: 3px 8px;
  border-radius: 8px;
  border: 1px solid var(--border);
  width: fit-content;
  margin: 0 auto;
}

/* For many items layout - make items more compact */
.pie-chart-container.many-items .pie-item {
  padding: 8px 12px;
  min-height: auto;
}

.pie-chart-container.many-items .pie-item-value {
  margin: 0 8px;
  font-size: 16px;
}

.pie-chart-container.many-items .pie-item-percentage {
  font-size: 9px;
  padding: 2px 6px;
}

.pie-item-percentage {
  font-size: 11px;
  color: var(--text-light);
  font-weight: 500;
  background: white;
  padding: 4px 10px;
  border-radius: 10px;
  border: 1px solid var(--border);
  width: fit-content;
  margin: 0 auto;
}

.pie-chart-container.many-items .pie-item-percentage {
  margin: 0;
  font-size: 10px;
  padding: 3px 8px;
}

/* Scrollbar styling */
.pie-chart-container::-webkit-scrollbar {
  width: 6px;
}

.pie-chart-container::-webkit-scrollbar-track {
  background: var(--bg-light);
  border-radius: 3px;
}

.pie-chart-container::-webkit-scrollbar-thumb {
  background: var(--primary-light);
  border-radius: 3px;
}

.pie-chart-container::-webkit-scrollbar-thumb:hover {
  background: var(--primary);
}

/* Status Summary - Updated */
.status-summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 24px;
  margin-bottom: 35px;
}

.status-card {
  background: white;
  padding: 30px;
  border-radius: 18px;
  box-shadow: var(--shadow);
  text-align: center;
  border-top: 5px solid;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}

.status-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
}

.status-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
  z-index: 1;
}

.status-card > * {
  position: relative;
  z-index: 2;
}

.status-card.active {
  border-color: #10b981;
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(16, 185, 129, 0.02));
}

.status-card.pending {
  border-color: #f59e0b;
  background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(245, 158, 11, 0.02));
}

.status-card.sold {
  border-color: #ef4444;
  background: linear-gradient(135deg, rgba(239, 68, 68, 0.05), rgba(239, 68, 68, 0.02));
}

.status-count {
  font-size: 48px;
  font-weight: 800;
  margin: 20px 0;
  font-family: 'Inter', sans-serif;
  color: var(--primary);
}

.status-label {
  font-size: 16px;
  color: var(--text-dark);
  text-transform: uppercase;
  letter-spacing: 1px;
  font-weight: 700;
  margin-bottom: 10px;
}

.data-table {
  background: white;
  border-radius: 18px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  overflow: hidden;
  margin-bottom: 30px;
  transition: var(--transition);
  margin-top: 40px; /* Increased from 30px */
  position: relative;
  z-index: 2;
}

.data-table:hover {
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
}

.table-header {
  padding: 25px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: linear-gradient(135deg, var(--bg-light) 0%, #e9f2ff 100%);
  flex-wrap: wrap;
  gap: 15px;
}

.table-title-group {
  display: flex;
  align-items: center;
  gap: 15px;
}

.table-icon {
  width: 44px;
  height: 44px;
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 20px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  flex-shrink: 0;
}

.table-title {
  font-size: 20px;
  font-weight: 700;
  color: var(--text-dark);
}

.table-actions {
  display: flex;
  align-items: center;
  gap: 10px;
}

.export-btn {
  background: linear-gradient(135deg, var(--secondary), #2563eb);
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 10px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2);
  white-space: nowrap;
}

.export-btn:hover {
  background: linear-gradient(135deg, #2563eb, #1d4ed8);
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(59, 130, 246, 0.3);
}

.table-wrapper {
  max-height: 450px;
  overflow-y: auto;
  overflow-x: auto;
}

table {
  width: 100%;
  border-collapse: collapse;
  min-width: 800px;
}

thead {
  background: var(--bg-light);
  position: sticky;
  top: 0;
  z-index: 10;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

th {
  padding: 18px 20px;
  text-align: left;
  font-weight: 700;
  color: var(--text-dark);
  font-size: 14px;
  border-bottom: 2px solid var(--border);
  white-space: nowrap;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

td {
  padding: 18px 20px;
  border-bottom: 1px solid var(--border);
  font-size: 14px;
  vertical-align: middle;
}

tbody tr {
  transition: var(--transition);
}

tbody tr:hover {
  background: linear-gradient(90deg, rgba(11, 46, 82, 0.03), rgba(11, 46, 82, 0.01));
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.3px;
  min-width: 80px;
}

.badge.active {
  background: linear-gradient(135deg, #d1fae5, #a7f3d0);
  color: #065f46;
  border: 1px solid #10b981;
}

.badge.pending {
  background: linear-gradient(135deg, #fef3c7, #fde68a);
  color: #92400e;
  border: 1px solid #f59e0b;
}

.badge.sold {
  background: linear-gradient(135deg, #fee2e2, #fecaca);
  color: #991b1b;
  border: 1px solid #ef4444;
}

.badge.featured {
  background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
  color: #4338ca;
  border: 1px solid #6366f1;
}

/* Loading Overlay */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 4000;
  display: none;
}

.loading-overlay.show {
  display: flex;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.loading-spinner {
  width: 70px;
  height: 70px;
  border: 4px solid rgba(11, 46, 82, 0.1);
  border-top: 4px solid var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Toast notifications */
.toast {
  position: fixed;
  bottom: 30px;
  right: 30px;
  background: white;
  color: var(--text-dark);
  padding: 18px 25px;
  border-radius: 14px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
  display: flex;
  align-items: center;
  gap: 14px;
  z-index: 3000;
  animation: slideInRight 0.3s ease;
  border-left: 5px solid var(--primary);
  max-width: 400px;
}

.toast.success {
  border-left-color: var(--success);
}

.toast.error {
  border-left-color: var(--danger);
}

.toast.info {
  border-left-color: var(--info);
}

@keyframes slideInRight {
  from { transform: translateX(100px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

/* Notification Panel - UPDATED TO MATCH DASHBOARD */
.notification-panel {
  position: fixed;
  top: 100px;
  right: 30px;
  background: white;
  border-radius: 18px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
  width: 400px;
  max-height: 500px;
  overflow-y: auto;
  z-index: 1001;
  display: none;
  border: 1px solid var(--border);
  animation: slideInRight 0.3s ease;
}

.notification-panel.show {
  display: block;
}

.notification-header {
  padding: 25px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(135deg, var(--bg-light) 0%, #e9f2ff 100%);
}

.notification-header h3 {
  font-size: 18px;
  font-weight: 700;
  color: var(--text-dark);
}

.notification-list {
  padding: 0;
}

.notification-item {
  padding: 18px 25px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: flex-start;
  gap: 16px;
  transition: var(--transition);
  cursor: pointer;
}

.notification-item:hover {
  background: var(--bg-light);
}

.notification-item.unread {
  background: #f0f9ff;
}

.notification-item.unread .notification-title {
  font-weight: 700;
}

.notification-icon {
  width: 40px;
  height: 40px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  flex-shrink: 0;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.notification-icon.new-user {
  background: linear-gradient(135deg, var(--secondary), #2563eb);
  color: white;
}

.notification-icon.new-property {
  background: linear-gradient(135deg, var(--success), #059669);
  color: white;
}

.notification-icon.property-sold {
  background: linear-gradient(135deg, var(--warning), #d97706);
  color: white;
}

.notification-icon.property-updated {
  background: linear-gradient(135deg, #8b5cf6, #7c3aed);
  color: white;
}

.notification-content {
  flex: 1;
}

.notification-title {
  font-weight: 700;
  color: var(--text-dark);
  font-size: 15px;
  margin-bottom: 5px;
}

.notification-desc {
  font-size: 14px;
  color: var(--text-light);
  line-height: 1.4;
}

.notification-time {
  font-size: 12px;
  color: #94a3b8;
  margin-top: 8px;
  font-weight: 500;
}

.notification-actions {
  padding: 20px;
  border-top: 1px solid var(--border);
  text-align: center;
}

.notification-actions a {
  color: var(--primary);
  text-decoration: none;
  font-size: 15px;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  border-radius: 10px;
  transition: var(--transition);
}

.notification-actions a:hover {
  background: var(--bg-light);
  color: var(--primary-light);
}

/* Mobile menu toggle */
.mobile-menu-toggle {
  display: none;
  position: fixed;
  top: 20px;
  left: 20px;
  z-index: 1001;
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
  border: none;
  width: 56px;
  height: 56px;
  border-radius: 14px;
  font-size: 24px;
  cursor: pointer;
  box-shadow: var(--shadow-lg);
  transition: var(--transition);
}

.mobile-menu-toggle:hover {
  transform: scale(1.1);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
}

/* Scrollbar Styling */
.table-wrapper::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

.table-wrapper::-webkit-scrollbar-track {
  background: var(--bg-light);
  border-radius: 4px;
}

.table-wrapper::-webkit-scrollbar-thumb {
  background: var(--primary-light);
  border-radius: 4px;
}

.table-wrapper::-webkit-scrollbar-thumb:hover {
  background: var(--primary);
}

/* Chart.js Fixes */
.chartjs-render-monitor {
  position: absolute !important;
  width: 100% !important;
  height: 100% !important;
  left: 0 !important;
  top: 0 !important;
}

/* ==================== RESPONSIVE DESIGN ==================== */
/* Large screens (1400px and above) */
@media (max-width: 1400px) {
  .charts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(550px, 1fr));
  gap: 28px;
  margin-bottom: 50px; /* Increased from 40px to accommodate taller cards */
}
  
  .chart-card {
    height: 420px;
  }
}

/* Medium screens (1200px) */
@media (max-width: 1200px) {
  .analytics-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .pie-chart-container {
    grid-template-columns: repeat(3, 1fr);
  }
  
  .status-summary {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .charts-grid {
    grid-template-columns: 1fr;
  }
}

/* Tablets (1024px) */
@media (max-width: 1024px) {
  .sidebar {
    transform: translateX(-100%);
    width: 300px;
  }

  .sidebar.active {
    transform: translateX(0);
  }

  .container {
    margin-left: 0;
    padding: 25px;
    width: 100%;
  }

  .mobile-menu-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .charts-grid {
    grid-template-columns: 1fr;
  }
  
  .chart-card {
    min-height: 380px;
    height: auto;
  }
  
  .analytics-card, .status-card {
    padding: 20px;
  }
  
  .analytics-value {
    font-size: 32px;
  }
  
  .status-count {
    font-size: 40px;
  }
  
  .pie-chart-container {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* Small tablets (768px) */
@media (max-width: 768px) {
  .container {
    padding: 20px 15px;
  }

  .analytics-grid {
    grid-template-columns: 1fr;
    gap: 20px;
  }

  .dashboard-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 15px;
  }

  .header-left h1 {
    font-size: 28px;
  }
  
  .header-left p {
    font-size: 14px;
  }

  .header-right {
    width: 100%;
    justify-content: space-between;
  }

  .period-selector {
    width: 100%;
    justify-content: flex-start;
  }

  .chart-body {
    min-height: 250px;
    height: 250px;
  }

  .pie-chart-container {
    grid-template-columns: 1fr;
  }

  .pie-chart-container.many-items {
    grid-template-columns: 1fr;
  }

  .status-summary {
    grid-template-columns: 1fr;
    gap: 20px;
  }
  
  .status-card {
    padding: 25px 20px;
  }
  
  .status-count {
    font-size: 36px;
  }
  
  .status-label {
    font-size: 14px;
  }

  .table-wrapper {
    max-height: 350px;
  }

  th, td {
    padding: 14px 15px;
    font-size: 13px;
  }
  
  .analytics-value {
    font-size: 28px;
  }
  
  .user-profile {
    min-width: auto;
    width: 100%;
    padding: 10px 15px;
  }
  
  .user-avatar {
    width: 40px;
    height: 40px;
    font-size: 16px;
  }
  
  .notification-panel {
    position: fixed;
    top: 90px;
    right: 15px;
    left: 15px;
    width: auto;
    max-height: 70vh;
  }
  
  .charts-grid {
    gap: 20px;
    margin-bottom: 40px;
  }
  
  .chart-card {
    height: 380px;
    padding: 15px;
  }
  
  .chart-title {
    font-size: 18px;
  }
  
  .chart-icon {
    width: 40px;
    height: 40px;
    font-size: 18px;
  }
  
  .table-header {
    padding: 20px;
  }
  
  .table-title {
    font-size: 18px;
  }
  
  .export-btn {
    padding: 8px 15px;
    font-size: 13px;
  }
  
  .period-btn {
    padding: 8px 16px;
    font-size: 13px;
  }
}

/* Mobile phones (576px) */
@media (max-width: 576px) {
  .container {
    padding: 15px;
  }
  
  .dashboard-header {
    gap: 12px;
  }
  
  .header-left h1 {
    font-size: 24px;
    margin-bottom: 5px;
  }
  
  .pie-chart-container {
    grid-template-columns: 1fr;
  }
  
  .chart-card {
    padding: 15px;
    height: 350px;
  }
  
  .analytics-card {
    padding: 18px 15px;
  }
  
  .analytics-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
    margin-bottom: 15px;
  }
  
  .analytics-icon {
    width: 40px;
    height: 40px;
    font-size: 18px;
  }
  
  .analytics-value {
    font-size: 26px;
  }
  
  .analytics-change {
    font-size: 12px;
  }
  
  .status-card {
    padding: 20px 15px;
  }
  
  .status-count {
    font-size: 32px;
  }
  
  .status-label {
    font-size: 13px;
  }
  
  .table-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 15px;
    padding: 15px;
  }
  
  .table-actions {
    align-self: stretch;
    justify-content: flex-end;
  }
  
  .charts-grid {
    margin-bottom: 35px;
  }
  
  .period-selector {
    padding: 6px;
  }
  
  .period-btn {
    padding: 8px 12px;
    font-size: 12px;
    flex: 1;
    min-width: 120px;
    text-align: center;
  }
  
  .user-profile {
    padding: 8px 12px;
  }
  
  .user-info {
    min-width: 100px;
  }
}

/* Small mobile phones (480px) */
@media (max-width: 480px) {
  .analytics-card {
    padding: 15px;
  }

  .analytics-value {
    font-size: 24px;
  }

  .analytics-icon {
    width: 35px;
    height: 35px;
    font-size: 16px;
  }
  
  .analytics-title {
    font-size: 13px;
  }

  .chart-card {
    padding: 15px;
    height: 320px;
  }
  
  .chart-title {
    font-size: 16px;
  }
  
  .chart-icon {
    width: 35px;
    height: 35px;
    font-size: 16px;
  }

  .status-count {
    font-size: 28px;
  }
  
  .status-label {
    font-size: 12px;
    letter-spacing: 0.5px;
  }
  
  .table-header {
    padding: 15px;
  }
  
  .table-title-group {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }
  
  .table-title {
    font-size: 16px;
  }
  
  th, td {
    padding: 12px 10px;
    font-size: 12px;
  }
  
  .badge {
    padding: 6px 10px;
    font-size: 11px;
    min-width: 70px;
  }
  
  .export-btn {
    padding: 8px 12px;
    font-size: 12px;
  }
  
  .notification-panel {
    top: 80px;
    right: 10px;
    left: 10px;
    max-height: 60vh;
  }
  
  .notification-item {
    padding: 15px;
  }
  
  .toast {
    left: 15px;
    right: 15px;
    max-width: none;
  }
  
  .period-btn {
    min-width: 110px;
    padding: 8px 10px;
  }
  
  .mobile-menu-toggle {
    width: 50px;
    height: 50px;
    font-size: 20px;
    top: 15px;
    left: 15px;
  }
}

/* Extra small mobile phones (360px) */
@media (max-width: 360px) {
  .container {
    padding: 12px;
  }
  
  .header-left h1 {
    font-size: 22px;
  }
  
  .user-profile {
    min-width: auto;
    padding: 8px 10px;
  }
  
  .user-avatar {
    width: 35px;
    height: 35px;
    font-size: 14px;
  }
  
  .user-name {
    font-size: 13px;
  }
  
  .user-role {
    font-size: 11px;
  }
  
  .notification-btn {
    width: 45px;
    height: 45px;
  }
  
  .period-btn {
    min-width: 90px;
    font-size: 11px;
    padding: 6px 8px;
  }
  
  .analytics-value {
    font-size: 22px;
  }
  
  .status-count {
    font-size: 24px;
  }
  
  .chart-card {
    height: 300px;
    padding: 12px;
  }
  
  .chart-body {
    min-height: 180px;
  }
  
  .pie-chart-container {
    max-height: 120px;
  }
  
  .pie-item-label {
    font-size: 10px;
  }
  
  .pie-item-value {
    font-size: 16px;
  }
  
  .table-wrapper {
    max-height: 300px;
  }
}
</style>
</head>

<body>
<button class="mobile-menu-toggle" id="mobileMenuToggle">
  <i class="fas fa-bars"></i>
</button>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
</div>

<!-- Notification Panel - SAME AS DASHBOARD -->
<div class="notification-panel" id="notificationPanel">
  <div class="notification-header">
    <h3>Notifications</h3>
    <button onclick="hideNotifications()" style="background: none; border: none; color: var(--text-light); cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 10px; transition: var(--transition);">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="notification-list" id="notificationList">
    <!-- Notifications will be loaded here -->
  </div>
  <div class="notification-actions">
    <a href="#" onclick="markAllAsRead()">
      <i class="fas fa-check-double"></i>
      Mark all as read
    </a>
  </div>
</div>

<!-- User Dropdown Menu -->
<div class="user-dropdown" id="userDropdown">
  <a href="#" class="dropdown-item" onclick="viewProfile()">
    <i class="fas fa-user"></i>
    <span>My Profile</span>
  </a>
  <a href="admin_settings.html" class="dropdown-item">
    <i class="fas fa-cog"></i>
    <span>Settings</span>
  </a>
  <div class="dropdown-item" onclick="showHelp()">
    <i class="fas fa-question-circle"></i>
    <span>Help</span>
  </div>
  <a href="#" class="dropdown-item logout" onclick="logout()">
    <i class="fas fa-sign-out-alt"></i>
    <span>Logout</span>
  </a>
</div>

<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <a href="admin_dashboard.html" class="logo">
      <div class="logo-icon">BA</div>
      <div class="logo-text">
        <div class="logo-title">BahAI</div>
        <div class="logo-subtitle">Admin Dashboard</div>
      </div>
    </a>
  </div>

  <ul class="sidebar-nav">
    <li>
      <a href="admin_dashboard.html" class="sidebar-link">
        <span class="sidebar-icon"><i class="fas fa-chart-line"></i></span>
        Dashboard Overview
      </a>
    </li>
    <li>
      <a href="admin_users.html" class="sidebar-link">
        <span class="sidebar-icon"><i class="fas fa-users"></i></span>
        User Management
      </a>
    </li>
    <li>
      <a href="admin_properties.html" class="sidebar-link">
        <span class="sidebar-icon"><i class="fas fa-building"></i></span>
        Property Listings
      </a>
    </li>
    <li>
      <a href="admin_analytics.html" class="sidebar-link active">
        <span class="sidebar-icon"><i class="fas fa-chart-bar"></i></span>
        Reports & Analytics
      </a>
    </li>
    <li>
      <a href="admin_settings.html" class="sidebar-link">
        <span class="sidebar-icon"><i class="fas fa-cog"></i></span>
        Settings
      </a>
    </li>
    <!-- ADDED LOGOUT LINK IN SIDEBAR -->
    <li>
      <a href="#" class="sidebar-link" onclick="logout()">
        <span class="sidebar-icon"><i class="fas fa-sign-out-alt"></i></span>
        Logout
      </a>
    </li>
  </ul>

  <div class="sidebar-footer">
    <div style="margin-bottom: 8px; opacity: 0.7;"></div>
    <div>Â© 2026 BahAI Admin</div>
  </div>
</div>

<div class="container">
  <div class="dashboard-header">
    <div class="header-left">
      <h1>Reports & Analytics</h1>
      <p>View comprehensive platform analytics and statistics</p>
    </div>
    <div class="header-right">
      <button class="notification-btn" onclick="toggleNotifications()">
        <i class="fas fa-bell"></i>
        <span class="notification-badge" id="notificationCount">0</span>
      </button>
      <div class="user-profile" onclick="toggleUserDropdown()">
        <div class="user-avatar" id="userInitials">AD</div>
        <div class="user-info">
          <span class="user-name" id="userName">Admin User</span>
          <span class="user-role">System Admin</span>
        </div>
        <i ></i>
      </div>
    </div>
  </div>

  <div class="period-selector">
    <button class="period-btn active" data-period="month" id="periodMonth">
      <i class="fas fa-calendar-alt"></i> This Month
    </button>
    <button class="period-btn" data-period="quarter" id="periodQuarter">
      <i class="fas fa-chart-bar"></i> This Quarter
    </button>
    <button class="period-btn" data-period="year" id="periodYear">
      <i class="fas fa-chart-line"></i> This Year
    </button>
    <button class="period-btn" data-period="all" id="periodAll">
      <i class="fas fa-history"></i> All Time
    </button>
  </div>

  <!-- Status Summary -->
  <div class="status-summary" id="statusSummary">
    <div class="status-card active">
      <div class="status-label">Active Properties</div>
      <div class="status-count" id="summaryActive">0</div>
      <div class="analytics-change" id="activeChange">
        <span class="positive">â†‘ 0.0%</span> from last period
      </div>
    </div>
    <div class="status-card pending">
      <div class="status-label">Pending Properties</div>
      <div class="status-count" id="summaryPending">0</div>
      <div class="analytics-change" id="pendingChange">
        <span class="positive">â†‘ 0.0%</span> from last period
      </div>
    </div>
    <div class="status-card sold">
      <div class="status-label">Sold Properties</div>
      <div class="status-count" id="summarySold">0</div>
      <div class="analytics-change" id="soldChange">
        <span class="positive">â†‘ 0.0%</span> from last period
      </div>
    </div>
  </div>

  <div class="analytics-grid">
    <div class="analytics-card">
      <div class="analytics-header">
        <span class="analytics-title">Total Revenue</span>
        <div class="analytics-icon green"><i class="fas fa-money-bill-wave"></i></div>
      </div>
      <div class="analytics-value" id="totalRevenue">â‚±0</div>
      <div class="analytics-change positive" id="revenueChange">
        <span>â†‘</span>
        <span>0.0%</span> from last period
      </div>
    </div>

    <div class="analytics-card">
      <div class="analytics-header">
        <span class="analytics-title">Total Properties</span>
        <div class="analytics-icon blue"><i class="fas fa-building"></i></div>
      </div>
      <div class="analytics-value" id="totalProperties">0</div>
      <div class="analytics-change positive" id="propertiesChange">
        <span>â†‘</span>
        <span>0.0%</span> from last period
      </div>
    </div>

    <div class="analytics-card">
      <div class="analytics-header">
        <span class="analytics-title">Avg. Price</span>
        <div class="analytics-icon orange"><i class="fas fa-chart-bar"></i></div>
      </div>
      <div class="analytics-value" id="averagePrice">â‚±0</div>
      <div class="analytics-change positive" id="priceChange">
        <span>â†‘</span>
        <span>0.0%</span> from last period
      </div>
    </div>

    <div class="analytics-card">
      <div class="analytics-header">
        <span class="analytics-title">Featured Properties</span>
        <div class="analytics-icon purple"><i class="fas fa-star"></i></div>
      </div>
      <div class="analytics-value" id="featuredProperties">0</div>
      <div class="analytics-change positive" id="featuredChange">
        <span>â†‘</span>
        <span>0.0%</span> from last period
      </div>
    </div>
  </div>

  <div class="charts-grid">
    <div class="chart-card">
      <div class="chart-header">
        <div class="chart-title-group">
          <div class="chart-icon"><i class="fas fa-home"></i></div>
          <h3 class="chart-title">Properties by Type</h3>
        </div>
      </div>
      <div class="chart-body">
        <canvas id="typeChart"></canvas>
        <div class="pie-chart-container" id="typeLegend">
          <!-- Type legend will be populated by JavaScript -->
        </div>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-header">
        <div class="chart-title-group">
          <div class="chart-icon"><i class="fas fa-chart-pie"></i></div>
          <h3 class="chart-title">Properties by Status</h3>
        </div>
      </div>
      <div class="chart-body">
        <canvas id="statusChart"></canvas>
        <div class="pie-chart-container" id="statusLegend">
          <!-- Status legend will be populated by JavaScript -->
        </div>
      </div>
    </div>
  </div>

  <div class="data-table">
    <div class="table-header">
      <div class="table-title-group">
        <div class="table-icon"><i class="fas fa-chart-line"></i></div>
        <h3 class="table-title">Top Properties by Price</h3>
      </div>
      <div class="table-actions">
        <button class="export-btn" onclick="exportData()">
          <i class="fas fa-download"></i>
          Export CSV
        </button>
      </div>
    </div>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Property</th>
            <th>Type</th>
            <th>Location</th>
            <th>Status</th>
            <th>Price</th>
            <th>Added</th>
          </tr>
        </thead>
        <tbody id="topPropertiesTable">
          <tr>
            <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-light);">
              <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                <div class="loading-spinner" style="width: 30px; height: 30px;"></div>
                Loading analytics data...
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Firebase SDK v9 (modular) -->
<script type="module">
// Import Firebase modules - ADDED REAL-TIME LISTENERS
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  getDocs,
  onSnapshot,
  query,
  orderBy,
  where,
  limit,
  Timestamp
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyCIfzneDzWVveG8p_0mywoA9D9F5AyzZX4",
  authDomain: "bahai-1b76d.firebaseapp.com",
  projectId: "bahai-1b76d",
  storageBucket: "bahai-1b76d.firebasestorage.app",
  messagingSenderId: "646878644941",
  appId: "1:646878644941:web:5b4ccc3412250337587784",
  measurementId: "G-PDW1PRZTM9"
};

// Global variables - ADDED USERS AND NOTIFICATIONS
let app;
let db;
let firebaseInitialized = false;
let allProperties = [];
let allUsers = [];
let allNotifications = [];
let typeChart = null;
let statusChart = null;

// Toast notification function - SAME AS DASHBOARD
function showToast(message, type = 'info', duration = 3000) {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    ${type === 'success' ? '<i class="fas fa-check-circle" style="color: var(--success);"></i>' : 
      type === 'error' ? '<i class="fas fa-exclamation-circle" style="color: var(--danger);"></i>' : 
      '<i class="fas fa-info-circle" style="color: var(--info);"></i>'}
    <span>${message}</span>
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(100px)';
    setTimeout(() => {
      document.body.removeChild(toast);
    }, 300);
  }, duration);
}

// Show/hide loading overlay
function showLoading() {
  document.getElementById('loadingOverlay').classList.add('show');
}

function hideLoading() {
  document.getElementById('loadingOverlay').classList.remove('show');
}

// Load user profile from settings
function loadUserProfile() {
  const adminName = localStorage.getItem('adminName') || 'Administrator';
  
  // Update UI
  document.getElementById('userName').textContent = adminName;
  
  // Set avatar initials
  const initials = adminName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
  document.getElementById('userInitials').textContent = initials;
  
  console.log(`ðŸ‘¤ User profile loaded: ${adminName}`);
}

// Check if user is logged in
function checkAuth() {
  const isLoggedIn = localStorage.getItem('adminLoggedIn');
  
  if (!isLoggedIn || isLoggedIn !== 'true') {
    console.log('Not logged in, redirecting to login page');
    window.location.href = 'admin_login.html';
    return false;
  }
  
  // Load user profile
  loadUserProfile();
  
  // Initialize Firebase and load analytics
  initializeFirebase();
  
  return true;
}

// Initialize Firebase - UPDATED WITH REAL-TIME LISTENERS
async function initializeFirebase() {
  try {
    console.log('ðŸ”§ Initializing Firebase for Analytics...');
    showLoading();
    
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    firebaseInitialized = true;
    
    console.log('âœ… Firebase initialized successfully');
    
    // Load all data from Firestore
    await Promise.all([
      loadAllUsers(),
      loadAllProperties()
    ]);
    
    // Setup real-time listeners
    setupRealtimeListeners();
    
    // Calculate analytics
    calculateAllAnalytics();
    
    // Create charts
    createTypeChart();
    createStatusChart();
    
    // Load top properties
    displayTopProperties();
    
    hideLoading();
    showToast(`Analytics updated with ${allProperties.length} properties`, 'success', 2000);
    
  } catch (error) {
    console.error('âŒ Firebase initialization failed:', error);
    hideLoading();
    showToast('Failed to connect to database. Please refresh the page.', 'error');
    setDefaultValues();
  }
}

// Load all users from Firebase
async function loadAllUsers() {
  try {
    console.log('ðŸ‘¥ Loading users...');
    const usersQuery = collection(db, "users");
    const usersSnapshot = await getDocs(usersQuery);
    
    allUsers = [];
    usersSnapshot.forEach((doc) => {
      allUsers.push({ id: doc.id, ...doc.data() });
    });
    
    console.log(`âœ… Loaded ${allUsers.length} users`);
    
  } catch (error) {
    console.error("âŒ Error loading users:", error);
    allUsers = [];
  }
}

// Load all properties from Firebase
async function loadAllProperties() {
  try {
    console.log('ðŸ¢ Loading properties...');
    const propertiesQuery = collection(db, "properties");
    const propertiesSnapshot = await getDocs(propertiesQuery);
    
    allProperties = [];
    propertiesSnapshot.forEach((doc) => {
      const data = doc.data();
      allProperties.push({
        id: doc.id,
        title: data.title || 'Untitled Property',
        price: parseFloat(data.price || data.pricing || 0),
        propertyType: data.propertyType || 'Not specified',
        bedrooms: data.bedrooms || 0,
        bathrooms: data.bathrooms || 0,
        squareFootage: data.squareFootage || data.squareFeet || 'N/A',
        status: data.status || 'active',
        location: data.location || 'Location not specified',
        description: data.description || 'No description available',
        featured: data.featured || false,
        ownerId: data.ownerId || null,
        userId: data.userId || null,
        createdAt: getDateFromFirestore(data.createdAt),
        updatedAt: getDateFromFirestore(data.updatedAt)
      });
    });
    
    console.log(`âœ… Loaded ${allProperties.length} properties`);
    
  } catch (error) {
    console.error('âŒ Error loading properties:', error);
    allProperties = [];
  }
}

// Set up real-time Firebase listeners - SAME AS DASHBOARD
function setupRealtimeListeners() {
  try {
    console.log('ðŸ”” Setting up real-time listeners...');
    
    // Real-time listener for users
    const usersUnsubscribe = onSnapshot(collection(db, "users"), (snapshot) => {
      const users = [];
      snapshot.forEach((doc) => {
        users.push({ id: doc.id, ...doc.data() });
      });
      
      allUsers = users;
      
      // Check for new users
      snapshot.docChanges().forEach(change => {
        if (change.type === "added") {
          const newUser = { id: change.doc.id, ...change.doc.data() };
          console.log('ðŸ‘¤ New user detected:', newUser.email || newUser.id);
          
          // Add accurate notification for new user
          const userDate = getDateFromFirestore(newUser.createdAt) || new Date();
          addNotification({
            id: `user_${newUser.id}_${Date.now()}`,
            type: 'new-user',
            title: 'New User Registered',
            description: `${newUser.name || newUser.email || 'New user'} joined the platform`,
            time: userDate,
            relatedId: newUser.id,
            unread: true
          });
        }
      });
    });
    
    // Real-time listener for properties
    const propertiesUnsubscribe = onSnapshot(collection(db, "properties"), (snapshot) => {
      const properties = [];
      snapshot.forEach((doc) => {
        const data = doc.data();
        properties.push({
          id: doc.id,
          ...data,
          createdAt: getDateFromFirestore(data.createdAt),
          updatedAt: getDateFromFirestore(data.updatedAt)
        });
      });
      
      allProperties = properties;
      
      // Update analytics when properties change
      calculateAllAnalytics();
      createTypeChart();
      createStatusChart();
      displayTopProperties();
      
      // Check for new/updated properties
      snapshot.docChanges().forEach(change => {
        if (change.type === "added") {
          const newProperty = { id: change.doc.id, ...change.doc.data() };
          console.log('ðŸ¢ New property detected:', newProperty.title || newProperty.id);
          
          // Add accurate notification for new property
          const propDate = getDateFromFirestore(newProperty.createdAt) || new Date();
          addNotification({
            id: `property_${newProperty.id}_${Date.now()}`,
            type: 'new-property',
            title: 'New Property Listed',
            description: `${newProperty.title || 'New property'} has been added`,
            time: propDate,
            relatedId: newProperty.id,
            unread: true
          });
        } else if (change.type === "modified") {
          const updatedProperty = { id: change.doc.id, ...change.doc.data() };
          
          // Check if property was sold
          if (updatedProperty.status === 'sold') {
            const propDate = getDateFromFirestore(updatedProperty.updatedAt) || new Date();
            addNotification({
              id: `sold_${updatedProperty.id}_${Date.now()}`,
              type: 'property-sold',
              title: 'Property Sold',
              description: `${updatedProperty.title || 'Property'} has been sold`,
              time: propDate,
              relatedId: updatedProperty.id,
              unread: true
            });
          }
        }
      });
    });
    
    console.log('âœ… Real-time listeners activated');
    
  } catch (error) {
    console.error('âŒ Error setting up real-time listeners:', error);
  }
}

// Calculate all analytics
function calculateAllAnalytics() {
  // Calculate statistics
  const totalProperties = allProperties.length;
  const activeProperties = allProperties.filter(p => p.status === 'active').length;
  const pendingProperties = allProperties.filter(p => p.status === 'pending').length;
  const soldProperties = allProperties.filter(p => p.status === 'sold').length;
  const featuredProperties = allProperties.filter(p => p.featured).length;
  
  // Calculate total revenue (sum of prices for sold properties)
  const soldPropertiesData = allProperties.filter(p => p.status === 'sold');
  const totalRevenue = soldPropertiesData.reduce((sum, property) => sum + (property.price || 0), 0);
  
  // Calculate average price
  const totalPrice = allProperties.reduce((sum, property) => sum + (property.price || 0), 0);
  const averagePrice = totalProperties > 0 ? totalPrice / totalProperties : 0;
  
  // Update status summary
  document.getElementById('summaryActive').textContent = activeProperties.toLocaleString();
  document.getElementById('summaryPending').textContent = pendingProperties.toLocaleString();
  document.getElementById('summarySold').textContent = soldProperties.toLocaleString();
  
  // Calculate change percentages (simulated for now)
  const activeChange = activeProperties > 0 ? 12.5 : 0;
  const pendingChange = pendingProperties > 0 ? 4.3 : 0;
  const soldChange = soldProperties > 0 ? 23.6 : 0;
  const revenueChange = totalRevenue > 0 ? 18.5 : 0;
  const propertiesChange = totalProperties > 0 ? 15.2 : 0;
  const priceChange = averagePrice > 0 ? 8.8 : 0;
  const featuredChange = featuredProperties > 0 ? 25.3 : 0;
  
  // Update change indicators
  updateChangeIndicator('activeChange', activeChange);
  updateChangeIndicator('pendingChange', pendingChange);
  updateChangeIndicator('soldChange', soldChange);
  
  // Update analytics cards
  document.getElementById('totalRevenue').textContent = `â‚±${formatPrice(totalRevenue)}`;
  updateChangeIndicator('revenueChange', revenueChange);
  
  document.getElementById('totalProperties').textContent = totalProperties.toLocaleString();
  updateChangeIndicator('propertiesChange', propertiesChange);
  
  document.getElementById('averagePrice').textContent = `â‚±${formatPrice(averagePrice)}`;
  updateChangeIndicator('priceChange', priceChange);
  
  document.getElementById('featuredProperties').textContent = featuredProperties.toLocaleString();
  updateChangeIndicator('featuredChange', featuredChange);
  
  console.log('ðŸ“Š Analytics Updated:', {
    totalProperties,
    activeProperties,
    pendingProperties,
    soldProperties,
    totalRevenue: `â‚±${formatPrice(totalRevenue)}`,
    averagePrice: `â‚±${formatPrice(averagePrice)}`,
    featuredProperties
  });
}

// Helper: Get date from Firestore timestamp - SAME AS DASHBOARD
function getDateFromFirestore(timestamp) {
  if (!timestamp) return new Date();
  
  if (timestamp.toDate && typeof timestamp.toDate === 'function') {
    return timestamp.toDate();
  }
  
  if (timestamp.seconds) {
    return new Date(timestamp.seconds * 1000);
  }
  
  if (timestamp instanceof Date) {
    return timestamp;
  }
  
  if (typeof timestamp === 'string') {
    return new Date(timestamp);
  }
  
  if (typeof timestamp === 'number') {
    return new Date(timestamp);
  }
  
  return new Date();
}

// Helper: Format time ago - SAME AS DASHBOARD
function formatDateTime(date) {
  if (!date || !(date instanceof Date)) {
    return 'Unknown time';
  }
  
  const now = new Date();
  const diffMs = now - date;
  const diffSec = Math.floor(diffMs / 1000);
  const diffMin = Math.floor(diffSec / 60);
  const diffHour = Math.floor(diffMin / 60);
  const diffDay = Math.floor(diffHour / 24);
  
  // If within 24 hours, show relative time
  if (diffDay === 0) {
    if (diffHour > 0) return `${diffHour} hour${diffHour > 1 ? 's' : ''} ago`;
    if (diffMin > 0) return `${diffMin} minute${diffMin > 1 ? 's' : ''} ago`;
    return 'Just now';
  }
  
  // If within 7 days, show day name
  if (diffDay < 7) {
    return `${diffDay} day${diffDay > 1 ? 's' : ''} ago`;
  }
  
  // Otherwise show full date
  const options = { 
    month: 'short', 
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  };
  
  return date.toLocaleDateString('en-US', options);
}

// Helper: Format time ago (for backward compatibility)
function getTimeAgo(date) {
  return formatDateTime(date);
}

// Format price with commas
function formatPrice(price) {
  return Math.round(price).toLocaleString('en-PH', { 
    minimumFractionDigits: 0, 
    maximumFractionDigits: 0 
  });
}

// Update change indicator
function updateChangeIndicator(elementId, changeValue) {
  const element = document.getElementById(elementId);
  if (!element) return;
  
  const isPositive = changeValue >= 0;
  const changeText = `${Math.abs(changeValue).toFixed(1)}%`;
  
  element.className = `analytics-change ${isPositive ? 'positive' : 'negative'}`;
  element.innerHTML = `
    <span>${isPositive ? 'â†‘' : 'â†“'}</span>
    <span>${changeText}</span> from last period
  `;
}

// Create type chart
function createTypeChart() {
  const ctx = document.getElementById('typeChart').getContext('2d');
  
  if (typeChart) {
    typeChart.destroy();
  }
  
  // Count properties by type
  const typeCounts = {};
  allProperties.forEach(property => {
    const type = property.propertyType || 'Unknown';
    typeCounts[type] = (typeCounts[type] || 0) + 1;
  });
  
  const types = Object.keys(typeCounts);
  const counts = Object.values(typeCounts);
  const total = counts.reduce((a, b) => a + b, 0);
  
  // Colors for different property types
  const colors = [
    'rgb(59, 130, 246)',   // Blue - Condo
    'rgb(16, 185, 129)',   // Green - House
    'rgb(245, 158, 11)',   // Orange - Lot
    'rgb(239, 68, 68)',    // Red - Apartment
    'rgb(139, 92, 246)',   // Purple - Villa
    'rgb(14, 165, 233)',   // Sky Blue - Commercial
    'rgb(20, 184, 166)',   // Teal - Townhouse
    'rgb(251, 191, 36)',   // Yellow - Others
    'rgb(244, 63, 94)',    // Rose
    'rgb(120, 113, 108)'   // Stone
  ];
  
  typeChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: types,
      datasets: [{
        data: counts,
        backgroundColor: colors.slice(0, types.length),
        borderWidth: 3,
        borderColor: 'white',
        hoverBorderWidth: 4,
        hoverBorderColor: 'white',
        hoverOffset: 15
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(255, 255, 255, 0.95)',
          titleColor: '#1a202c',
          bodyColor: '#4a5568',
          borderColor: '#e2e8f0',
          borderWidth: 1,
          padding: 12,
          boxPadding: 6,
          usePointStyle: true,
          callbacks: {
            label: function(context) {
              const value = context.raw;
              const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
              return `${context.label}: ${value} (${percentage}%)`;
            }
          }
        }
      },
      cutout: '60%',
      animation: {
        animateScale: true,
        animateRotate: true,
        duration: 1000,
        easing: 'easeOutQuart'
      }
    }
  });
  
  // Update type legend
  updateTypeLegend(types, counts, colors, total);
}

function updateTypeLegend(types, counts, colors, total) {
  const legendContainer = document.getElementById('typeLegend');
  
  // Add 'many-items' class if there are more than 4 types
  if (types.length > 4) {
    legendContainer.classList.add('many-items');
  } else {
    legendContainer.classList.remove('many-items');
  }
  
  let legendHTML = '';
  
  types.forEach((type, index) => {
    const value = counts[index];
    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
    const color = colors[index];
    
    // Truncate long type names with ellipsis
    const displayType = type.length > 20 ? type.substring(0, 19) + '...' : type;
    
    legendHTML += `
      <div class="pie-item" style="border-left: 4px solid ${color}" 
           onclick="filterByType('${type.replace(/'/g, "\\'")}')"
           title="${type}">
        <span class="pie-item-label">
          ${displayType}
        </span>
        <span class="pie-item-value">${value}</span>
        <span class="pie-item-percentage">${percentage}%</span>
      </div>
    `;
  });
  
  legendContainer.innerHTML = legendHTML;
}

// Create status chart
function createStatusChart() {
  const ctx = document.getElementById('statusChart').getContext('2d');
  
  if (statusChart) {
    statusChart.destroy();
  }
  
  // Count properties by status
  const statusCounts = {
    active: 0,
    pending: 0,
    sold: 0,
    rented: 0
  };
  
  allProperties.forEach(property => {
    const status = property.status || 'active';
    if (statusCounts.hasOwnProperty(status)) {
      statusCounts[status]++;
    } else {
      statusCounts.active++; // Default to active if unknown status
    }
  });
  
  const statuses = Object.keys(statusCounts).filter(s => statusCounts[s] > 0);
  const counts = statuses.map(s => statusCounts[s]);
  const total = counts.reduce((a, b) => a + b, 0);
  
  const colors = [
    'rgb(16, 185, 129)',   // Green for active
    'rgb(245, 158, 11)',   // Orange for pending
    'rgb(239, 68, 68)',    // Red for sold
    'rgb(59, 130, 246)'    // Blue for rented
  ];
  
  statusChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: statuses.map(s => s.charAt(0).toUpperCase() + s.slice(1)),
      datasets: [{
        data: counts,
        backgroundColor: colors.slice(0, statuses.length),
        borderWidth: 3,
        borderColor: 'white',
        hoverBorderWidth: 4,
        hoverBorderColor: 'white',
        hoverOffset: 15
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(255, 255, 255, 0.95)',
          titleColor: '#1a202c',
          bodyColor: '#4a5568',
          borderColor: '#e2e8f0',
          borderWidth: 1,
          padding: 12,
          boxPadding: 6,
          usePointStyle: true,
          callbacks: {
            label: function(context) {
              const value = context.raw;
              const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
              return `${context.label}: ${value} (${percentage}%)`;
            }
          }
        }
      },
      cutout: '60%',
      animation: {
        animateScale: true,
        animateRotate: true,
        duration: 1000,
        easing: 'easeOutQuart'
      }
    }
  });
  
  // Update status legend
  updateStatusLegend(statuses, counts, colors, total);
}

function updateStatusLegend(statuses, counts, colors, total) {
  const legendContainer = document.getElementById('statusLegend');
  
  // Add 'many-items' class if there are more than 4 statuses
  if (statuses.length > 4) {
    legendContainer.classList.add('many-items');
  } else {
    legendContainer.classList.remove('many-items');
  }
  
  let legendHTML = '';
  
  statuses.forEach((status, index) => {
    const value = counts[index];
    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
    const color = colors[index];
    const statusClass = status.toLowerCase();
    
    // Format status name
    const displayStatus = status.charAt(0).toUpperCase() + status.slice(1);
    
    legendHTML += `
      <div class="pie-item ${statusClass}" style="border-left: 4px solid ${color}" 
           onclick="filterByStatus('${status.replace(/'/g, "\\'")}')"
           title="${status}">
        <span class="pie-item-label">${displayStatus}</span>
        <span class="pie-item-value">${value}</span>
        <span class="pie-item-percentage">${percentage}%</span>
      </div>
    `;
  });
  
  legendContainer.innerHTML = legendHTML;
}

// Display top properties
function displayTopProperties() {
  const tbody = document.getElementById('topPropertiesTable');
  
  if (allProperties.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-light);">
          No properties found in database
        </td>
      </tr>
    `;
    return;
  }
  
  // Sort properties by price (highest first) and take top 10
  const topProperties = [...allProperties]
    .sort((a, b) => (b.price || 0) - (a.price || 0))
    .slice(0, 10);
  
  tbody.innerHTML = topProperties.map(property => {
    const statusClass = property.status || 'active';
    const statusLabel = statusClass.charAt(0).toUpperCase() + statusClass.slice(1);
    const propertyType = property.propertyType || 'Unknown';
    const typeDisplay = propertyType.length > 20 ? propertyType.substring(0, 19) + '...' : propertyType;
    const titleDisplay = property.title.length > 30 ? property.title.substring(0, 29) + '...' : property.title;
    const locationDisplay = property.location.length > 25 ? property.location.substring(0, 24) + '...' : property.location;
    const timeAgo = getTimeAgo(property.createdAt);
    
    return `
      <tr onclick="window.location.href='admin_properties.html#property-${property.id}'" style="cursor: pointer;">
        <td style="font-weight: 600;" title="${property.title}">
          ${titleDisplay}
        </td>
        <td title="${propertyType}">
          ${typeDisplay}
        </td>
        <td title="${property.location}">
          ${locationDisplay}
        </td>
        <td>
          <span class="badge ${statusClass}">${statusLabel}</span>
        </td>
        <td style="font-weight: 800; color: var(--primary);">
          â‚±${formatPrice(property.price || 0)}
        </td>
        <td style="color: var(--text-light); font-size: 13px;">
          ${timeAgo}
        </td>
      </tr>
    `;
  }).join('');
}

// Set default values when Firebase fails
function setDefaultValues() {
  document.getElementById('summaryActive').textContent = '0';
  document.getElementById('summaryPending').textContent = '0';
  document.getElementById('summarySold').textContent = '0';
  
  document.getElementById('totalRevenue').textContent = 'â‚±0';
  document.getElementById('totalProperties').textContent = '0';
  document.getElementById('averagePrice').textContent = 'â‚±0';
  document.getElementById('featuredProperties').textContent = '0';
  
  const tbody = document.getElementById('topPropertiesTable');
  tbody.innerHTML = `
    <tr>
      <td colspan="6" style="text-align: center; padding: 40px; color: var(--danger);">
        Error loading analytics data. Please check your internet connection.
      </td>
    </tr>
  `;
}

// Update notifications - SAME AS DASHBOARD
function updateNotifications() {
  try {
    // Generate accurate notifications from current data
    const newNotifications = generateAccurateNotifications();
    
    // Combine with existing notifications
    allNotifications = [...newNotifications, ...allNotifications];
    
    // Sort by time (newest first)
    allNotifications.sort((a, b) => new Date(b.time) - new Date(a.time));
    
    // Limit to 50 notifications
    if (allNotifications.length > 50) {
      allNotifications = allNotifications.slice(0, 50);
    }
    
    // Update notification badge
    updateNotificationBadge();
    
    // Display notifications if panel is open
    if (document.getElementById('notificationPanel').classList.contains('show')) {
      displayNotifications(allNotifications);
    }
    
  } catch (error) {
    console.error("âŒ Error updating notifications:", error);
  }
}

// Generate accurate notifications with real timestamps - SAME AS DASHBOARD
function generateAccurateNotifications() {
  const notifications = [];
  
  // Get recent users (last 7 days) with actual timestamps
  const weekAgo = new Date();
  weekAgo.setDate(weekAgo.getDate() - 7);
  
  const recentUsers = allUsers.filter(user => {
    const userDate = getDateFromFirestore(user.createdAt);
    return userDate > weekAgo;
  }).slice(0, 10); // Get up to 10 recent users
  
  // Get recent properties (last 7 days) with actual timestamps
  const recentProperties = allProperties.filter(prop => {
    const propDate = getDateFromFirestore(prop.createdAt);
    return propDate > weekAgo;
  }).slice(0, 10); // Get up to 10 recent properties
  
  // Add user notifications with accurate dates
  recentUsers.forEach(user => {
    const userDate = getDateFromFirestore(user.createdAt) || new Date();
    notifications.push({
      id: `user_${user.id}_${userDate.getTime()}`,
      type: 'new-user',
      title: 'New User Registered',
      description: `${user.name || user.email || 'New user'} joined the platform`,
      time: userDate,
      relatedId: user.id,
      unread: true
    });
  });
  
  // Add property notifications with accurate dates
  recentProperties.forEach(prop => {
    const propDate = getDateFromFirestore(prop.createdAt) || new Date();
    notifications.push({
      id: `property_${prop.id}_${propDate.getTime()}`,
      type: 'new-property',
      title: 'New Property Added',
      description: `${prop.title || 'New property'} (${prop.propertyType || 'Property'})`,
      time: propDate,
      relatedId: prop.id,
      unread: true
    });
  });
  
  // Check for recently sold properties
  const soldProperties = allProperties.filter(prop => 
    prop.status === 'sold'
  ).slice(0, 5);
  
  soldProperties.forEach(prop => {
    const soldDate = getDateFromFirestore(prop.updatedAt) || getDateFromFirestore(prop.createdAt) || new Date();
    notifications.push({
      id: `sold_${prop.id}_${soldDate.getTime()}`,
      type: 'property-sold',
      title: 'Property Sold',
      description: `${prop.title || 'Property'} has been sold`,
      time: soldDate,
      relatedId: prop.id,
      unread: true
    });
  });
  
  // Sort by time (newest first)
  return notifications.sort((a, b) => b.time - a.time);
}

// Add notification - SAME AS DASHBOARD
function addNotification(notification) {
  // Add to beginning of array (newest first)
  allNotifications.unshift(notification);
  
  // Sort again to ensure proper order (newest first)
  allNotifications.sort((a, b) => new Date(b.time) - new Date(a.time));
  
  // Limit to 50 notifications
  if (allNotifications.length > 50) {
    allNotifications = allNotifications.slice(0, 50);
  }
  
  // Update notification badge
  updateNotificationBadge();
  
  // Update notification panel if it's open
  if (document.getElementById('notificationPanel').classList.contains('show')) {
    displayNotifications(allNotifications);
  }
  
  // Show toast for important notifications
  showToast(notification.description, 'info', 2000);
}

// Update notification badge - SAME AS DASHBOARD
function updateNotificationBadge() {
  const unreadCount = allNotifications.filter(n => n.unread).length;
  const badgeElement = document.getElementById('notificationCount');
  
  if (badgeElement) {
    badgeElement.textContent = unreadCount;
    
    // Hide badge if zero
    if (unreadCount === 0) {
      badgeElement.style.display = 'none';
    } else {
      badgeElement.style.display = 'flex';
    }
  }
}

// Display notifications in panel with accurate dates - SAME AS DASHBOARD
function displayNotifications(notifications) {
  const container = document.getElementById('notificationList');
  
  if (notifications.length === 0) {
    container.innerHTML = `
      <div class="notification-item">
        <div class="notification-content">
          <div class="notification-title">No notifications</div>
          <div class="notification-desc">You're all caught up!</div>
          <div class="notification-time">No recent activity</div>
        </div>
      </div>
    `;
    return;
  }
  
  container.innerHTML = notifications.map(notif => {
    const formattedTime = formatDateTime(new Date(notif.time));
    const iconClass = notif.type === 'new-user' ? 'new-user' : 
                     notif.type === 'property-sold' ? 'property-sold' : 
                     notif.type === 'new-property' ? 'new-property' : 'property-updated';
    
    const iconSymbol = notif.type === 'new-user' ? '<i class="fas fa-user-plus"></i>' :
                      notif.type === 'property-sold' ? '<i class="fas fa-tag"></i>' :
                      notif.type === 'new-property' ? '<i class="fas fa-home"></i>' : 
                      '<i class="fas fa-edit"></i>';
    
    return `
      <div class="notification-item ${notif.unread ? 'unread' : ''}" 
           data-id="${notif.id}"
           onclick="handleNotificationClick('${notif.type}', '${notif.relatedId || ''}')">
        <div class="notification-icon ${iconClass}">${iconSymbol}</div>
        <div class="notification-content">
          <div class="notification-title">${notif.title}</div>
          <div class="notification-desc">${notif.description}</div>
          <div class="notification-time">${formattedTime}</div>
        </div>
      </div>
    `;
  }).join('');
}

// UI Functions - SAME AS DASHBOARD
function toggleNotifications() {
  const panel = document.getElementById('notificationPanel');
  panel.classList.toggle('show');
  
  // Hide user dropdown if open
  document.getElementById('userDropdown').classList.remove('show');
  
  // Load notifications when opening panel
  if (panel.classList.contains('show')) {
    displayNotifications(allNotifications);
  }
}

function hideNotifications() {
  document.getElementById('notificationPanel').classList.remove('show');
}

function toggleUserDropdown() {
  const dropdown = document.getElementById('userDropdown');
  dropdown.classList.toggle('show');
  
  // Hide notification panel if open
  document.getElementById('notificationPanel').classList.remove('show');
}

function viewProfile() {
  window.location.href = 'admin_settings.html';
  document.getElementById('userDropdown').classList.remove('show');
}

function markAllAsRead() {
  allNotifications.forEach(notification => {
    notification.unread = false;
  });
  
  updateNotificationBadge();
  
  // Update display if panel is open
  if (document.getElementById('notificationPanel').classList.contains('show')) {
    displayNotifications(allNotifications);
  }
  
  showToast('âœ… All notifications marked as read', 'success');
}

// Handle notification click - SAME AS DASHBOARD
function handleNotificationClick(type, relatedId) {
  // Mark as read
  const notificationElement = event.currentTarget;
  const notificationId = notificationElement.dataset.id;
  
  if (notificationId) {
    const notification = allNotifications.find(n => n.id === notificationId);
    if (notification) {
      notification.unread = false;
      notificationElement.classList.remove('unread');
      updateNotificationBadge();
    }
  }
  
  // Navigate based on type
  if (type === 'new-user' && relatedId) {
    window.location.href = `admin_users.html#user-${relatedId}`;
  } else if ((type === 'new-property' || type === 'property-sold' || type === 'property-updated') && relatedId) {
    window.location.href = `admin_properties.html#property-${relatedId}`;
  }
  
  // Close notification panel on mobile
  if (window.innerWidth <= 768) {
    hideNotifications();
  }
}

function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  sidebar.classList.toggle('active');
}

function logout() {
  if (confirm('âš ï¸ Are you sure you want to logout?')) {
    localStorage.removeItem('adminLoggedIn');
    localStorage.removeItem('adminEmail');
    localStorage.removeItem('adminName');
    
    showToast('ðŸ”’ Logging out...', 'info');
    
    setTimeout(() => {
      window.location.href = 'admin_login.html';
    }, 1000);
  }
}

function showHelp() {
  alert('Help & Support\n\nFor assistance, please contact:\nâ€¢ Email: support@bahai.com\nâ€¢ Phone: +63 123 456 7890\n\nDocumentation is available in the Settings page.');
  document.getElementById('userDropdown').classList.remove('show');
}

// Period selector functionality
document.querySelectorAll('.period-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    const period = this.getAttribute('data-period');
    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    
    // Reload analytics with new period filter
    loadAnalyticsByPeriod(period);
  });
});

async function loadAnalyticsByPeriod(period) {
  console.log(`Loading analytics for period: ${period}`);
  showLoading();
  
  try {
    // In a real app, you would filter data by date range based on period
    // For now, we'll just reload all data
    await Promise.all([
      loadAllUsers(),
      loadAllProperties()
    ]);
    
    calculateAllAnalytics();
    createTypeChart();
    createStatusChart();
    displayTopProperties();
    
    showToast(`Analytics updated for ${period} period`, 'success', 2000);
  } catch (error) {
    console.error('Error loading period analytics:', error);
    showToast('Failed to load period analytics', 'error');
  } finally {
    hideLoading();
  }
}

// Filter functions
function filterByType(type) {
  showToast(`Filtering by type: ${type}`, 'info');
  // In a real app, you would filter the data and update charts
}

function filterByStatus(status) {
  showToast(`Filtering by status: ${status}`, 'info');
  // In a real app, you would filter the data and update charts
}

// Export data to CSV
function exportData() {
  showToast('Preparing data for export...', 'info');
  
  // Create CSV content
  let csvContent = "data:text/csv;charset=utf-8,";
  csvContent += "Property,Type,Location,Status,Price,Bedrooms,Bathrooms,Featured\n";
  
  allProperties.forEach(property => {
    const row = [
      `"${property.title}"`,
      property.propertyType,
      `"${property.location}"`,
      property.status,
      property.price,
      property.bedrooms,
      property.bathrooms,
      property.featured ? 'Yes' : 'No'
    ];
    csvContent += row.join(",") + "\n";
  });
  
  // Create download link
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", `bahai-analytics-${new Date().toISOString().split('T')[0]}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  showToast('Data exported successfully!', 'success');
}

// Event Listeners
document.getElementById('mobileMenuToggle').addEventListener('click', toggleSidebar);

// Close dropdowns when clicking outside - SAME AS DASHBOARD
document.addEventListener('click', (event) => {
  const userDropdown = document.getElementById('userDropdown');
  const userProfile = document.querySelector('.user-profile');
  const notificationPanel = document.getElementById('notificationPanel');
  const notificationBtn = document.querySelector('.notification-btn');
  const sidebar = document.getElementById('sidebar');
  const mobileToggle = document.getElementById('mobileMenuToggle');
  
  // Close user dropdown if clicked outside
  if (userDropdown.classList.contains('show') && 
      !userProfile.contains(event.target) && 
      !userDropdown.contains(event.target)) {
    userDropdown.classList.remove('show');
  }
  
  // Close notification panel if clicked outside
  if (notificationPanel.classList.contains('show') && 
      !notificationBtn.contains(event.target) && 
      !notificationPanel.contains(event.target)) {
    notificationPanel.classList.remove('show');
  }
  
  // Close sidebar on mobile when clicking outside
  if (window.innerWidth <= 1024 && 
      sidebar.classList.contains('active') && 
      !sidebar.contains(event.target) && 
      !mobileToggle.contains(event.target) &&
      !event.target.classList.contains('sidebar-link')) {
    sidebar.classList.remove('active');
  }
});

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
  console.log('ðŸ“Š Analytics Dashboard Initializing...');
  checkAuth();
});

// Auto-refresh analytics every 10 minutes
setInterval(() => {
  if (firebaseInitialized && localStorage.getItem('adminLoggedIn') === 'true') {
    console.log('Auto-refreshing analytics data...');
    calculateAllAnalytics();
  }
}, 10 * 60 * 1000); // 10 minutes

// Make functions available globally - UPDATED TO MATCH DASHBOARD
window.toggleNotifications = toggleNotifications;
window.hideNotifications = hideNotifications;
window.toggleUserDropdown = toggleUserDropdown;
window.markAllAsRead = markAllAsRead;
window.toggleSidebar = toggleSidebar;
window.logout = logout;
window.showHelp = showHelp;
window.filterByType = filterByType;
window.filterByStatus = filterByStatus;
window.exportData = exportData;
window.handleNotificationClick = handleNotificationClick;
window.viewProfile = viewProfile;
</script>
</body>
</html>